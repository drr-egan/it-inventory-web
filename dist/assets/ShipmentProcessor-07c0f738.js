var xe=Object.defineProperty,ue=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var se=Object.getOwnPropertySymbols;var ye=Object.prototype.hasOwnProperty,pe=Object.prototype.propertyIsEnumerable;var oe=(g,x,l)=>x in g?xe(g,x,{enumerable:!0,configurable:!0,writable:!0,value:l}):g[x]=l,M=(g,x)=>{for(var l in x||(x={}))ye.call(x,l)&&oe(g,l,x[l]);if(se)for(var l of se(x))pe.call(x,l)&&oe(g,l,x[l]);return g},O=(g,x)=>ue(g,he(x));var B=(g,x,l)=>new Promise((k,C)=>{var P=v=>{try{p(l.next(v))}catch(S){C(S)}},L=v=>{try{p(l.throw(v))}catch(S){C(S)}},p=v=>v.done?k(v.value):Promise.resolve(v.value).then(P,L);p((l=l.apply(g,x)).next())});import{j as e,d as A}from"./index-f876f9d0.js";import{r as b}from"./react-vendor-3371026b.js";import{w as ge,h as J,d as re,T as ae}from"./firebase-vendor-fdbb15af.js";import{M as ve}from"./MaterialButton-32075127.js";import{M as R}from"./MaterialInput-bd6bc315.js";const Se=({items:g,checkoutHistory:x,user:l})=>{const[k,C]=b.useState([]),[P,L]=b.useState(""),[p,v]=b.useState([]),[S,Q]=b.useState(!1),[U,_]=b.useState(""),[I,H]=b.useState(""),[G,V]=b.useState(""),[X,K]=b.useState(""),[W,Y]=b.useState(""),[F,z]=b.useState(""),[Z,ce]=b.useState([]),ne=t=>{k.findIndex(o=>o.id===t.id)>=0?(C(o=>o.filter(n=>n.id!==t.id)),v(o=>o.filter(n=>n.inventoryItem.id!==t.id))):(C(o=>[...o,t]),le(t))},le=t=>{const a=x.filter(o=>{var n,c,h,f;return((n=o.itemName)==null?void 0:n.toLowerCase())===((c=t.name)==null?void 0:c.toLowerCase())||((h=o.item)==null?void 0:h.toLowerCase())===((f=t.name)==null?void 0:f.toLowerCase())});if(a.length>0){const o={inventoryItem:t,checkoutRecords:a,confirmedQuantity:a.reduce((n,c)=>n+(c.quantity||1),0),confirmedPrice:t.price||0};v(n=>[...n,o])}else{const o={inventoryItem:t,checkoutRecords:[],confirmedQuantity:1,confirmedPrice:t.price||0};v(n=>[...n,o])}},ee=(t,a,o)=>{v(n=>n.map(c=>c.inventoryItem.id===t?O(M({},c),{[a]:parseFloat(o)||0}):c))},ie=()=>B(void 0,null,function*(){if(p.length===0){z("❌ Please select at least one item from inventory");return}Q(!0),z("⏳ Processing receipt and generating cost allocation...");try{const t=parseFloat(X)||0,a=parseFloat(W)||0,o=p.reduce((d,m)=>d+m.confirmedQuantity,0),n=o>0?t/o:0,c=o>0?a/o:0,h=p.map(d=>{const m=d.confirmedQuantity,s=d.confirmedPrice,N=n*m,j=c*m;let T="System Receipt",$="IT Stock 1-20-000-5770";if(d.checkoutRecords.length>0){const w=d.checkoutRecords[0];T=w.userName||w.user||"System Receipt",$=w.departmentId||w.costCode||"IT Stock 1-20-000-5770"}return{itemName:d.inventoryItem.name,quantity:m,unitPrice:s,totalCost:s*m+N+j,taxAllocation:N,feeAllocation:j,userName:T,costCode:$}}),f=h.reduce((d,m)=>d+m.unitPrice*m.quantity,0),r=f+t+a;yield de(h,{subtotal:f,tax:t,fees:a,total:r});const i=ge(A);for(const d of p){const m=h.find(N=>N.itemName===d.inventoryItem.name),s=J(re(A,"costAllocation"));i.set(s,{itemId:d.inventoryItem.id,itemName:d.inventoryItem.name,quantity:d.confirmedQuantity,unitPrice:d.confirmedPrice,totalCost:m.totalCost,taxAllocation:m.taxAllocation,feeAllocation:m.feeAllocation,costCode:m.costCode,vendor:U||"Unknown",orderNumber:I||"N/A",receiptDate:G||new Date().toISOString().split("T")[0],processedAt:ae.now(),processedBy:(l==null?void 0:l.email)||"Unknown",type:m.costCode.includes("Job")?"job":"it_stock"});for(const N of d.checkoutRecords){const j=J(re(A,"archivedCheckouts"));i.set(j,O(M({},N),{archivedAt:ae.now(),archivedBy:(l==null?void 0:l.email)||"Unknown",archiveReason:"Processed receipt"}));const T=J(A,"checkoutHistory",N.id);i.delete(T)}}yield i.commit();const y={timestamp:new Date().toISOString(),orderNumber:I||"N/A",itemsProcessed:p.length,totalAmount:r,vendor:U||"Unknown"};ce(d=>[...d,y]),C([]),v([]),_(""),H(""),V(""),K(""),Y(""),z("✅ Shipment processed successfully! Report downloaded and items archived."),Q(!1)}catch(t){console.error("Error processing shipment:",t),z(`❌ Error: ${t.message}`),Q(!1)}}),de=(t,a)=>B(void 0,null,function*(){try{const o=window.PDFLib,{PDFDocument:n,rgb:c,StandardFonts:h}=o,f=yield n.create(),r=f.addPage([612,792]),i=yield f.embedFont(h.Helvetica),y=yield f.embedFont(h.HelveticaBold),{width:d,height:m}=r.getSize();let s=m-50;r.drawText("Shipment Cost Allocation Report",{x:50,y:s,size:16,font:y,color:c(0,0,0)}),s-=25;const N=new Date().toLocaleString("en-US",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric",second:"numeric",hour12:!0});if(r.drawText(`Generated: ${N}`,{x:50,y:s,size:10,font:i,color:c(0,0,0)}),s-=20,a.tax>0||a.fees>0){const u=`Tax ($${a.tax.toFixed(2)}) and Fees ($${a.fees.toFixed(2)}) distributed evenly per item`;r.drawText(u,{x:50,y:s,size:10,font:i,color:c(0,0,0)}),s-=30}r.drawText("Cost Allocation Summary",{x:50,y:s,size:14,font:y,color:c(0,0,0)}),s-=25,r.drawText("Item Description",{x:50,y:s,size:9,font:y}),r.drawText("Qty",{x:250,y:s,size:9,font:y}),r.drawText("Job/Cost Code",{x:280,y:s,size:9,font:y}),r.drawText("Units",{x:380,y:s,size:9,font:y}),r.drawText("Unit Price",{x:420,y:s,size:9,font:y}),r.drawText("Total Cost",{x:500,y:s,size:9,font:y}),s-=15;for(const u of t){if(s<150){const te=f.addPage([612,792]);s=m-50}const E=u.itemName.length>35?u.itemName.substring(0,35)+"...":u.itemName;r.drawText(E,{x:50,y:s,size:9,font:i}),r.drawText(String(u.quantity),{x:250,y:s,size:9,font:i}),r.drawText(u.costCode||"-",{x:280,y:s,size:9,font:i}),r.drawText(String(u.quantity),{x:380,y:s,size:9,font:i}),r.drawText(`$${u.unitPrice.toFixed(2)}`,{x:420,y:s,size:9,font:i}),r.drawText(`$${u.totalCost.toFixed(2)}`,{x:500,y:s,size:9,font:i}),s-=15}s-=10;const j=420;r.drawText(`Subtotal (Items): $${a.subtotal.toFixed(2)}`,{x:j,y:s,size:9,font:i}),s-=12,r.drawText(`Tax: $${a.tax.toFixed(2)}`,{x:j,y:s,size:9,font:i}),s-=12,r.drawText(`Fees: $${a.fees.toFixed(2)}`,{x:j,y:s,size:9,font:i}),s-=15,r.drawText(`Grand Total: $${a.total.toFixed(2)}`,{x:j,y:s,size:10,font:y}),s-=30,r.drawText("Individual Checkout Details",{x:50,y:s,size:14,font:y,color:c(0,0,0)}),s-=25,r.drawText("Item Description",{x:50,y:s,size:9,font:y}),r.drawText("User",{x:280,y:s,size:9,font:y}),r.drawText("Cost Code",{x:450,y:s,size:9,font:y}),s-=15;for(const u of t){if(s<100)break;const E=u.itemName.length>35?u.itemName.substring(0,35)+"...":u.itemName,te=u.userName||"N/A";r.drawText(E,{x:50,y:s,size:9,font:i}),r.drawText(te,{x:280,y:s,size:9,font:i}),r.drawText(u.costCode||"-",{x:450,y:s,size:9,font:i}),s-=15}const T=yield f.save(),$=new Blob([T],{type:"application/pdf"}),w=URL.createObjectURL($),q=document.createElement("a");q.href=w;const me=I?`shipment-allocation-${I}.pdf`:`shipment-allocation-${new Date().toISOString().split("T")[0]}.pdf`;q.download=me,q.click(),URL.revokeObjectURL(w)}catch(o){throw console.error("Error generating PDF report:",o),o}}),D=g.filter(t=>{var o,n,c;if(!P)return!0;const a=P.toLowerCase();return((o=t.name)==null?void 0:o.toLowerCase().includes(a))||((n=t.category)==null?void 0:n.toLowerCase().includes(a))||((c=t.asin)==null?void 0:c.toLowerCase().includes(a))});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center mb-4",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",children:"receipt_long"}),"Process Receipt"]}),e.jsx("p",{style:{color:"var(--color-text-muted)"},children:"Select items from inventory and process receipts with cost allocation to appropriate billing codes."})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"inventory_2"}),"Select from Inventory (",k.length," selected)"]}),e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search by item name, category, or ASIN...",value:P,onChange:t=>L(t.target.value),className:"w-full px-4 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}}),e.jsx("span",{className:"material-icons absolute right-3 top-2.5",style:{color:"var(--color-text-muted)"},children:"search"})]})}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{style:{background:"var(--md-sys-color-surface-container-high)"},children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Select"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Item"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Category"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Qty"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Price"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Cost Code"})]})}),e.jsx("tbody",{children:D.slice(0,20).map(t=>{var c,h;const a=k.some(f=>f.id===t.id),n=((c=t.category)==null?void 0:c.toLowerCase().includes("job"))||((h=t.name)==null?void 0:h.toLowerCase().includes("job"))||jobNumber.trim()?`Job ${jobNumber||"x-xx-xxx"}-5770`:"IT Stock 1-20-000-5770";return e.jsxs("tr",{className:`border-b border-[var(--md-sys-color-outline-variant)] cursor-pointer hover:bg-[var(--md-sys-color-surface-container-highest)] ${a?"bg-[rgba(59,130,246,0.15)]":""}`,onClick:()=>ne(t),children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"checkbox",checked:a,onChange:()=>{},className:"cursor-pointer"})}),e.jsxs("td",{className:"px-4 py-2 text-sm font-medium",style:{color:"var(--color-text-light)"},children:[t.name,t.asin&&e.jsx("div",{className:"text-xs",style:{color:"var(--color-text-muted)"},children:t.asin})]}),e.jsx("td",{className:"px-4 py-2 text-sm",style:{color:"var(--color-text-muted)"},children:t.category||"Uncategorized"}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"quantity-badge adequate-stock",children:t.quantity||0})}),e.jsx("td",{className:"px-4 py-2 text-sm",style:{color:"var(--color-success-green)"},children:t.price>0?`$${t.price.toFixed(2)}`:"-"}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"pill-badge",children:n})})]},t.id)})})]}),D.length===0&&e.jsx("div",{className:"text-center py-8",style:{color:"var(--color-text-muted)"},children:"No inventory items available"}),D.length>20&&e.jsxs("div",{className:"text-center py-2 text-sm",style:{color:"var(--color-text-muted)"},children:["Showing first 20 of ",D.length," items"]})]})]}),p.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"link"}),"Matched Checkout Records (",p.length," items)"]}),e.jsx("div",{className:"space-y-4",children:p.map((t,a)=>e.jsxs("div",{className:"border border-[var(--md-sys-color-outline-variant)] rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-medium",style:{color:"var(--color-text-light)"},children:t.inventoryItem.name}),e.jsxs("span",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:[t.checkoutRecords.length," checkout",t.checkoutRecords.length!==1?"s":""," matched"]})]}),t.checkoutRecords.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h5",{className:"text-sm font-medium mb-2",style:{color:"var(--color-text-light)"},children:"Checkout Details:"}),e.jsx("div",{className:"space-y-1",children:t.checkoutRecords.map((o,n)=>{var c,h;return e.jsxs("div",{className:"text-xs p-2 rounded",style:{background:"var(--md-sys-color-surface-container-high)",color:"var(--color-text-muted)"},children:[o.userName||o.user," • Qty: ",o.quantity," • Dept: ",o.departmentId||o.costCode," • ",new Date(((h=(c=o.dateEntered)==null?void 0:c.toDate)==null?void 0:h.call(c))||o.dateEntered||o.date).toLocaleDateString()]},o.id)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",style:{color:"var(--color-text-light)"},children:"Received Quantity"}),e.jsx("input",{type:"number",min:"1",value:t.confirmedQuantity,onChange:o=>ee(t.inventoryItem.id,"confirmedQuantity",o.target.value),className:"w-full px-3 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",style:{color:"var(--color-text-light)"},children:"Unit Price"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:t.confirmedPrice,onChange:o=>ee(t.inventoryItem.id,"confirmedPrice",o.target.value),className:"w-full px-3 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}})]})]}),e.jsxs("div",{className:"mt-3 text-sm",style:{color:"var(--color-text-muted)"},children:["Total: $",(t.confirmedQuantity*t.confirmedPrice).toFixed(2)]})]},t.inventoryItem.id))})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-success-green)"},children:"settings"}),"Shipment Details"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(R,{type:"text",label:"Vendor Name",value:U,onChange:t=>_(t.target.value),placeholder:"e.g., Amazon, Staples"}),e.jsx(R,{type:"text",label:"Order Number",value:I,onChange:t=>H(t.target.value),placeholder:"e.g., 114-5534389-2755439"}),e.jsx(R,{type:"date",label:"Receipt Date",value:G,onChange:t=>V(t.target.value)}),e.jsx("div",{}),e.jsx(R,{type:"number",label:"Tax Amount",value:X,onChange:t=>K(t.target.value),step:"0.01",min:"0",placeholder:"0.00",required:!0}),e.jsx(R,{type:"number",label:"Fees (Shipping/Handling)",value:W,onChange:t=>Y(t.target.value),step:"0.01",min:"0",placeholder:"0.00"})]}),e.jsx(ve,{color:"success",className:"w-full mt-6",disabled:S||p.length===0,onClick:ie,children:S?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-icons mr-2",children:"receipt_long"}),"Process Receipt (",p.length," items)"]})})]}),F&&e.jsx("div",{className:`mat-card p-4 ${F.includes("✅")?"success-box":F.includes("⏳")?"info-box":"error-box"}`,children:F}),Z.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"history"}),"Recent Shipment Processing"]}),e.jsx("div",{className:"space-y-3",children:Z.slice(-5).reverse().map((t,a)=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg",style:{background:"var(--md-sys-color-surface-container-high)"},children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"material-icons",style:{color:"var(--color-success-green)"},children:"check_circle"}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",style:{color:"var(--color-text-light)"},children:["Order ",t.orderNumber]}),e.jsxs("p",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:[t.itemsProcessed," items • $",t.totalAmount.toFixed(2)," • ",t.vendor]})]})]}),e.jsx("div",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:new Date(t.timestamp).toLocaleDateString()})]},a))})]})]})};export{Se as default};
