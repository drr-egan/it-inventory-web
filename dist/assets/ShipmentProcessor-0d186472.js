var Pe=Object.defineProperty,Se=Object.defineProperties;var Te=Object.getOwnPropertyDescriptors;var me=Object.getOwnPropertySymbols;var Ie=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable;var xe=(h,x,m)=>x in h?Pe(h,x,{enumerable:!0,configurable:!0,writable:!0,value:m}):h[x]=m,B=(h,x)=>{for(var m in x||(x={}))Ie.call(x,m)&&xe(h,m,x[m]);if(me)for(var m of me(x))ke.call(x,m)&&xe(h,m,x[m]);return h},M=(h,x)=>Se(h,Te(x));var X=(h,x,m)=>new Promise((T,j)=>{var I=p=>{try{f(m.next(p))}catch(w){j(w)}},E=p=>{try{f(m.throw(p))}catch(w){j(w)}},f=p=>p.done?T(p.value):Promise.resolve(p.value).then(I,E);f((m=m.apply(h,x)).next())});import{j as e,d as O}from"./index-d76abcc3.js";import{r as y}from"./react-vendor-3371026b.js";import{w as Fe,h as K,d as ze,T as ue}from"./firebase-vendor-e2f55cd7.js";import{M as De}from"./MaterialButton-6af25c8b.js";import{M as A}from"./MaterialInput-b81e10eb.js";const Qe=({items:h,checkoutHistory:x,user:m})=>{const[T,j]=y.useState([]),[I,E]=y.useState(""),[f,p]=y.useState([]),[w,_]=y.useState(!1),[H,W]=y.useState(""),[k,Y]=y.useState(""),[Z,ee]=y.useState(""),[te,se]=y.useState(""),[oe,re]=y.useState(""),[F,ae]=y.useState(null),[U,z]=y.useState(""),[ce,he]=y.useState([]),pe=t=>{T.findIndex(r=>r.id===t.id)>=0?(j(r=>r.filter(l=>l.id!==t.id)),p(r=>r.filter(l=>l.inventoryItem.id!==t.id))):(j(r=>[...r,t]),ye(t))},ye=t=>{const a=x.filter(r=>{var l,n,v,g;return((l=r.itemName)==null?void 0:l.toLowerCase())===((n=t.name)==null?void 0:n.toLowerCase())||((v=r.item)==null?void 0:v.toLowerCase())===((g=t.name)==null?void 0:g.toLowerCase())});if(a.length>0){const r={inventoryItem:t,checkoutRecords:a,confirmedQuantity:a.reduce((l,n)=>l+(n.quantity||1),0),confirmedPrice:t.price||0};p(l=>[...l,r])}else{const r={inventoryItem:t,checkoutRecords:[],confirmedQuantity:1,confirmedPrice:t.price||0};p(l=>[...l,r])}},le=(t,a,r)=>{p(l=>l.map(n=>n.inventoryItem.id===t?M(B({},n),{[a]:parseFloat(r)||0}):n))},fe=t=>{const a=t.target.files[0];a&&a.type==="application/pdf"?ae(a):alert("Please select a valid PDF file.")},ve=()=>X(void 0,null,function*(){if(!F){z("❌ Please upload a receipt PDF first");return}if(f.length===0){z("❌ Please select at least one item from inventory");return}_(!0),z("⏳ Processing receipt and generating cost allocation...");try{const t=parseFloat(te)||0,a=parseFloat(oe)||0,r=f.flatMap(s=>s.checkoutRecords.map(c=>M(B({},c),{inventoryItem:s.inventoryItem,confirmedPrice:s.confirmedPrice}))),l=r.reduce((s,c)=>s+(c.quantity||1),0),n=l>0?t/l:0,v=l>0?a/l:0,g=r.reduce((s,c)=>{const i=c.departmentId||c.costCode||"IT Stock 1-20-000-5770",u=`${c.inventoryItem.name}|${i}`;return s[u]||(s[u]=[]),s[u].push(c),s},{}),D=Object.entries(g).map(([s,c])=>{const[i,P]=s.split("|"),u=c.reduce((R,$)=>R+($.quantity||1),0),o=c[0].confirmedPrice,S=n*u,b=v*u;return{itemName:i,quantity:u,unitPrice:o,totalCost:o*u+S+b,taxAllocation:S,feeAllocation:b,costCode:P}}),L=D.reduce((s,c)=>s+c.unitPrice*c.quantity,0),Q=L+t+a;yield ge(D,{subtotal:L,tax:t,fees:a,total:Q,taxPerItem:n,feePerItem:v},F,r);const C=Fe(O);for(const s of r){const c=s.departmentId||s.costCode||"IT Stock 1-20-000-5770",i=s.quantity||1,P=s.confirmedPrice,u=n*i,o=v*i,S=K(ze(O,"costAllocation"));C.set(S,{itemId:s.inventoryItem.id,itemName:s.inventoryItem.name,quantity:i,unitPrice:P,totalCost:P*i+u+o,taxAllocation:u,feeAllocation:o,costCode:c,userName:s.userName||s.user||"Unknown",vendor:H||"Unknown",orderNumber:k||"N/A",receiptDate:Z||new Date().toISOString().split("T")[0],processedAt:ue.now(),processedBy:(m==null?void 0:m.email)||"Unknown",type:c.includes("Job")?"job":"it_stock"});const b=M(B({},s),{archivedAt:ue.now(),archivedBy:(m==null?void 0:m.email)||"Unknown",archiveReason:"Processed receipt"});delete b.id;const R=K(O,"archivedCheckouts",s.id);C.set(R,b);const $=K(O,"checkoutHistory",s.id);C.delete($)}yield C.commit();const N={timestamp:new Date().toISOString(),orderNumber:k||"N/A",itemsProcessed:r.length,totalAmount:Q,vendor:H||"Unknown"};he(s=>[...s,N]),j([]),p([]),W(""),Y(""),ee(""),se(""),re(""),ae(null),z("✅ Shipment processed successfully! Report downloaded and items archived."),_(!1)}catch(t){console.error("Error processing shipment:",t),z(`❌ Error: ${t.message}`),_(!1)}}),ge=(t,a,r,l)=>X(void 0,null,function*(){try{const n=window.PDFLib,{PDFDocument:v,rgb:g,StandardFonts:D}=n,L=a.taxPerItem||0,Q=a.feePerItem||0,C=yield r.arrayBuffer(),N=yield v.load(C),s=N.addPage([612,792]),c=yield N.embedFont(D.Helvetica),i=yield N.embedFont(D.HelveticaBold),{width:P,height:u}=s.getSize();let o=u-50;s.drawText("Shipment Cost Allocation Report",{x:50,y:o,size:16,font:i,color:g(0,0,0)}),o-=25;const S=new Date().toLocaleString("en-US",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric",second:"numeric",hour12:!0});if(s.drawText(`Generated: ${S}`,{x:50,y:o,size:10,font:c,color:g(0,0,0)}),o-=20,a.tax>0||a.fees>0){const d=`Tax ($${a.tax.toFixed(2)}) and Fees ($${a.fees.toFixed(2)}) distributed evenly per item`;s.drawText(d,{x:50,y:o,size:10,font:c,color:g(0,0,0)}),o-=30}s.drawText("Cost Allocation Summary",{x:50,y:o,size:14,font:i,color:g(0,0,0)}),o-=25,s.drawText("Item Description",{x:50,y:o,size:9,font:i}),s.drawText("Qty",{x:250,y:o,size:9,font:i}),s.drawText("Job/Cost Code",{x:280,y:o,size:9,font:i}),s.drawText("Units",{x:380,y:o,size:9,font:i}),s.drawText("Unit Price",{x:420,y:o,size:9,font:i}),s.drawText("Total Cost",{x:500,y:o,size:9,font:i}),o-=15;for(const d of t){if(o<150){const ie=N.addPage([612,792]);o=u-50}const J=d.itemName.length>35?d.itemName.substring(0,35)+"...":d.itemName;s.drawText(J,{x:50,y:o,size:9,font:c}),s.drawText(String(d.quantity),{x:250,y:o,size:9,font:c}),s.drawText(d.costCode||"-",{x:280,y:o,size:9,font:c}),s.drawText(String(d.quantity),{x:380,y:o,size:9,font:c}),s.drawText(`$${d.unitPrice.toFixed(2)}`,{x:420,y:o,size:9,font:c}),s.drawText(`$${d.totalCost.toFixed(2)}`,{x:500,y:o,size:9,font:c}),o-=15}o-=10;const b=420;s.drawText(`Subtotal (Items): $${a.subtotal.toFixed(2)}`,{x:b,y:o,size:9,font:c}),o-=12,s.drawText(`Tax: $${a.tax.toFixed(2)}`,{x:b,y:o,size:9,font:c}),o-=12,s.drawText(`Fees: $${a.fees.toFixed(2)}`,{x:b,y:o,size:9,font:c}),o-=15,s.drawText(`Grand Total: $${a.total.toFixed(2)}`,{x:b,y:o,size:10,font:i}),o-=30,s.drawText("Individual Checkout Details",{x:50,y:o,size:14,font:i,color:g(0,0,0)}),o-=25,s.drawText("Item Description",{x:50,y:o,size:9,font:i}),s.drawText("User",{x:200,y:o,size:9,font:i}),s.drawText("Cost Code",{x:320,y:o,size:9,font:i}),s.drawText("Unit Price",{x:440,y:o,size:9,font:i}),s.drawText("Total Cost",{x:500,y:o,size:9,font:i}),o-=15;for(const d of l){if(o<100)break;const J=d.inventoryItem.name.length>25?d.inventoryItem.name.substring(0,25)+"...":d.inventoryItem.name,ie=(d.userName||d.user||"N/A").length>15?(d.userName||d.user||"N/A").substring(0,15)+"...":d.userName||d.user||"N/A",Ne=d.departmentId||d.costCode||"IT Stock 1-20-000-5770",de=d.confirmedPrice,V=d.quantity||1,je=L*V,we=Q*V,Ce=de*V+je+we;s.drawText(J,{x:50,y:o,size:9,font:c}),s.drawText(ie,{x:200,y:o,size:9,font:c}),s.drawText(Ne,{x:320,y:o,size:9,font:c}),s.drawText(`$${de.toFixed(2)}`,{x:440,y:o,size:9,font:c}),s.drawText(`$${Ce.toFixed(2)}`,{x:500,y:o,size:9,font:c}),o-=15}const R=yield N.save(),$=new Blob([R],{type:"application/pdf"}),ne=URL.createObjectURL($),G=document.createElement("a");G.href=ne;const be=k?`receipt-with-allocation-${k}.pdf`:`receipt-with-allocation-${new Date().toISOString().split("T")[0]}.pdf`;G.download=be,G.click(),URL.revokeObjectURL(ne)}catch(n){throw console.error("Error generating PDF report:",n),n}}),q=h.filter(t=>{var r,l,n;if(!I)return!0;const a=I.toLowerCase();return((r=t.name)==null?void 0:r.toLowerCase().includes(a))||((l=t.category)==null?void 0:l.toLowerCase().includes(a))||((n=t.asin)==null?void 0:n.toLowerCase().includes(a))});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center mb-4",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",children:"receipt_long"}),"Process Receipt"]}),e.jsx("p",{style:{color:"var(--color-text-muted)"},children:"Select items from inventory and process receipts with cost allocation to appropriate billing codes."})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"inventory_2"}),"Select from Inventory (",T.length," selected)"]}),e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search by item name, category, or ASIN...",value:I,onChange:t=>E(t.target.value),className:"w-full px-4 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}}),e.jsx("span",{className:"material-icons absolute right-3 top-2.5",style:{color:"var(--color-text-muted)"},children:"search"})]})}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{style:{background:"var(--md-sys-color-surface-container-high)"},children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Select"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Item"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Category"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Qty"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Price"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Cost Code"})]})}),e.jsx("tbody",{children:q.slice(0,20).map(t=>{const a=T.some(l=>l.id===t.id),r="IT Stock 1-20-000-5770";return e.jsxs("tr",{className:`border-b border-[var(--md-sys-color-outline-variant)] cursor-pointer hover:bg-[var(--md-sys-color-surface-container-highest)] ${a?"bg-[rgba(59,130,246,0.15)]":""}`,onClick:()=>pe(t),children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"checkbox",checked:a,onChange:()=>{},className:"cursor-pointer"})}),e.jsxs("td",{className:"px-4 py-2 text-sm font-medium",style:{color:"var(--color-text-light)"},children:[t.name,t.asin&&e.jsx("div",{className:"text-xs",style:{color:"var(--color-text-muted)"},children:t.asin})]}),e.jsx("td",{className:"px-4 py-2 text-sm",style:{color:"var(--color-text-muted)"},children:t.category||"Uncategorized"}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"quantity-badge adequate-stock",children:t.quantity||0})}),e.jsx("td",{className:"px-4 py-2 text-sm",style:{color:"var(--color-success-green)"},children:t.price>0?`$${t.price.toFixed(2)}`:"-"}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"pill-badge",children:r})})]},t.id)})})]}),q.length===0&&e.jsx("div",{className:"text-center py-8",style:{color:"var(--color-text-muted)"},children:"No inventory items available"}),q.length>20&&e.jsxs("div",{className:"text-center py-2 text-sm",style:{color:"var(--color-text-muted)"},children:["Showing first 20 of ",q.length," items"]})]})]}),f.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"link"}),"Matched Checkout Records (",f.length," items)"]}),e.jsx("div",{className:"space-y-4",children:f.map((t,a)=>e.jsxs("div",{className:"border border-[var(--md-sys-color-outline-variant)] rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-medium",style:{color:"var(--color-text-light)"},children:t.inventoryItem.name}),e.jsxs("span",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:[t.checkoutRecords.length," checkout",t.checkoutRecords.length!==1?"s":""," matched"]})]}),t.checkoutRecords.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h5",{className:"text-sm font-medium mb-2",style:{color:"var(--color-text-light)"},children:"Checkout Details:"}),e.jsx("div",{className:"space-y-1",children:t.checkoutRecords.map((r,l)=>{var n,v;return e.jsxs("div",{className:"text-xs p-2 rounded",style:{background:"var(--md-sys-color-surface-container-high)",color:"var(--color-text-muted)"},children:[r.userName||r.user," • Qty: ",r.quantity," • Dept: ",r.departmentId||r.costCode," • ",new Date(((v=(n=r.dateEntered)==null?void 0:n.toDate)==null?void 0:v.call(n))||r.dateEntered||r.date).toLocaleDateString()]},r.id)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",style:{color:"var(--color-text-light)"},children:"Received Quantity"}),e.jsx("input",{type:"number",min:"1",value:t.confirmedQuantity,onChange:r=>le(t.inventoryItem.id,"confirmedQuantity",r.target.value),className:"w-full px-3 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",style:{color:"var(--color-text-light)"},children:"Unit Price"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:t.confirmedPrice,onChange:r=>le(t.inventoryItem.id,"confirmedPrice",r.target.value),className:"w-full px-3 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}})]})]}),e.jsxs("div",{className:"mt-3 text-sm",style:{color:"var(--color-text-muted)"},children:["Total: $",(t.confirmedQuantity*t.confirmedPrice).toFixed(2)]})]},t.inventoryItem.id))})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-success-green)"},children:"settings"}),"Shipment Details"]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",style:{color:"var(--color-text-light)"},children:"Upload Receipt PDF (Required)"}),e.jsxs("div",{className:"border-2 border-dashed border-[var(--md-sys-color-outline-variant)] rounded-lg p-6 text-center hover:border-[var(--color-primary-blue)] transition-colors",children:[e.jsx("input",{type:"file",accept:".pdf",onChange:fe,className:"hidden",id:"pdf-upload"}),e.jsxs("label",{htmlFor:"pdf-upload",className:"cursor-pointer",children:[e.jsx("span",{className:"material-icons text-4xl",style:{color:"var(--color-text-muted)"},children:"upload_file"}),e.jsx("p",{className:"mt-2 text-sm",style:{color:"var(--color-text-light)"},children:"Click to upload PDF receipt or drag and drop"}),F&&e.jsxs("p",{className:"mt-2 text-sm font-medium",style:{color:"var(--color-success-green)"},children:["Selected: ",F.name]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(A,{type:"text",label:"Vendor Name",value:H,onChange:t=>W(t.target.value),placeholder:"e.g., Amazon, Staples"}),e.jsx(A,{type:"text",label:"Order Number",value:k,onChange:t=>Y(t.target.value),placeholder:"e.g., 114-5534389-2755439"}),e.jsx(A,{type:"date",label:"Receipt Date",value:Z,onChange:t=>ee(t.target.value)}),e.jsx("div",{}),e.jsx(A,{type:"number",label:"Tax Amount",value:te,onChange:t=>se(t.target.value),step:"0.01",min:"0",placeholder:"0.00",required:!0}),e.jsx(A,{type:"number",label:"Fees (Shipping/Handling)",value:oe,onChange:t=>re(t.target.value),step:"0.01",min:"0",placeholder:"0.00"})]}),e.jsx(De,{color:"success",className:"w-full mt-6",disabled:w||!F||f.length===0,onClick:ve,children:w?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-icons mr-2",children:"receipt_long"}),"Process Receipt (",f.length," items)"]})})]}),U&&e.jsx("div",{className:`mat-card p-4 ${U.includes("✅")?"success-box":U.includes("⏳")?"info-box":"error-box"}`,children:U}),ce.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"history"}),"Recent Shipment Processing"]}),e.jsx("div",{className:"space-y-3",children:ce.slice(-5).reverse().map((t,a)=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg",style:{background:"var(--md-sys-color-surface-container-high)"},children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"material-icons",style:{color:"var(--color-success-green)"},children:"check_circle"}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",style:{color:"var(--color-text-light)"},children:["Order ",t.orderNumber]}),e.jsxs("p",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:[t.itemsProcessed," items • $",t.totalAmount.toFixed(2)," • ",t.vendor]})]})]}),e.jsx("div",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:new Date(t.timestamp).toLocaleDateString()})]},a))})]})]})};export{Qe as default};
