var ge=Object.defineProperty,be=Object.defineProperties;var Ne=Object.getOwnPropertyDescriptors;var le=Object.getOwnPropertySymbols;var je=Object.prototype.hasOwnProperty,we=Object.prototype.propertyIsEnumerable;var ne=(p,x,i)=>x in p?ge(p,x,{enumerable:!0,configurable:!0,writable:!0,value:i}):p[x]=i,Q=(p,x)=>{for(var i in x||(x={}))je.call(x,i)&&ne(p,i,x[i]);if(le)for(var i of le(x))we.call(x,i)&&ne(p,i,x[i]);return p},B=(p,x)=>be(p,Ne(x));var J=(p,x,i)=>new Promise((I,w)=>{var k=y=>{try{f(i.next(y))}catch(C){w(C)}},O=y=>{try{f(i.throw(y))}catch(C){w(C)}},f=y=>y.done?I(y.value):Promise.resolve(y.value).then(k,O);f((i=i.apply(p,x)).next())});import{j as e,d as E}from"./index-10f1bd4c.js";import{r as v}from"./react-vendor-3371026b.js";import{w as Ce,h as V,d as ie,T as de}from"./firebase-vendor-e2f55cd7.js";import{M as Se}from"./MaterialButton-f7238a9c.js";import{M as A}from"./MaterialInput-f24c4823.js";const De=({items:p,checkoutHistory:x,user:i})=>{const[I,w]=v.useState([]),[k,O]=v.useState(""),[f,y]=v.useState([]),[C,M]=v.useState(!1),[_,X]=v.useState(""),[F,K]=v.useState(""),[W,Y]=v.useState(""),[Z,ee]=v.useState(""),[te,se]=v.useState(""),[R,oe]=v.useState(null),[L,D]=v.useState(""),[re,me]=v.useState([]),xe=t=>{I.findIndex(o=>o.id===t.id)>=0?(w(o=>o.filter(l=>l.id!==t.id)),y(o=>o.filter(l=>l.inventoryItem.id!==t.id))):(w(o=>[...o,t]),ue(t))},ue=t=>{const a=x.filter(o=>{var l,n,g,b;return((l=o.itemName)==null?void 0:l.toLowerCase())===((n=t.name)==null?void 0:n.toLowerCase())||((g=o.item)==null?void 0:g.toLowerCase())===((b=t.name)==null?void 0:b.toLowerCase())});if(a.length>0){const o={inventoryItem:t,checkoutRecords:a,confirmedQuantity:a.reduce((l,n)=>l+(n.quantity||1),0),confirmedPrice:t.price||0};y(l=>[...l,o])}else{const o={inventoryItem:t,checkoutRecords:[],confirmedQuantity:1,confirmedPrice:t.price||0};y(l=>[...l,o])}},ae=(t,a,o)=>{y(l=>l.map(n=>n.inventoryItem.id===t?B(Q({},n),{[a]:parseFloat(o)||0}):n))},he=t=>{const a=t.target.files[0];a&&a.type==="application/pdf"?oe(a):alert("Please select a valid PDF file.")},pe=()=>J(void 0,null,function*(){if(!R){D("❌ Please upload a receipt PDF first");return}if(f.length===0){D("❌ Please select at least one item from inventory");return}M(!0),D("⏳ Processing receipt and generating cost allocation...");try{const t=parseFloat(Z)||0,a=parseFloat(te)||0,o=[];f.forEach(r=>{r.checkoutRecords.forEach(d=>{o.push(B(Q({},d),{inventoryItem:r.inventoryItem,confirmedPrice:r.confirmedPrice}))})});const l=o.reduce((r,d)=>r+(d.quantity||1),0),n=l>0?t/l:0,g=l>0?a/l:0,b=o.reduce((r,d)=>{const h=d.departmentId||d.costCode||"IT Stock 1-20-000-5770";return r[h]||(r[h]=[]),r[h].push(d),r},{}),z=Object.entries(b).map(([r,d])=>{const h=d.reduce(($,T)=>$+(T.quantity||1),0),s=d[0].confirmedPrice,S=d[0].inventoryItem.name,N=n*h,P=g*h;return{itemName:S,quantity:h,unitPrice:s,totalCost:s*h+N+P,taxAllocation:N,feeAllocation:P,costCode:r}}),q=z.reduce((r,d)=>r+d.unitPrice*d.quantity,0),j=q+t+a;yield ye(z,{subtotal:q,tax:t,fees:a,total:j},R,o);const c=Ce(E);for(const r of o){const d=r.departmentId||r.costCode||"IT Stock 1-20-000-5770",h=r.quantity||1,s=r.confirmedPrice,S=n*h,N=g*h,P=V(ie(E,"costAllocation"));c.set(P,{itemId:r.inventoryItem.id,itemName:r.inventoryItem.name,quantity:h,unitPrice:s,totalCost:s*h+S+N,taxAllocation:S,feeAllocation:N,costCode:d,userName:r.userName||r.user||"Unknown",vendor:_||"Unknown",orderNumber:F||"N/A",receiptDate:W||new Date().toISOString().split("T")[0],processedAt:de.now(),processedBy:(i==null?void 0:i.email)||"Unknown",type:d.includes("Job")?"job":"it_stock"});const $=V(ie(E,"archivedCheckouts"));c.set($,B(Q({},r),{archivedAt:de.now(),archivedBy:(i==null?void 0:i.email)||"Unknown",archiveReason:"Processed receipt"}));const T=V(E,"checkoutHistory",r.id);c.delete(T)}yield c.commit();const u={timestamp:new Date().toISOString(),orderNumber:F||"N/A",itemsProcessed:o.length,totalAmount:j,vendor:_||"Unknown"};me(r=>[...r,u]),w([]),y([]),X(""),K(""),Y(""),ee(""),se(""),oe(null),D("✅ Shipment processed successfully! Report downloaded and items archived."),M(!1)}catch(t){console.error("Error processing shipment:",t),D(`❌ Error: ${t.message}`),M(!1)}}),ye=(t,a,o,l)=>J(void 0,null,function*(){try{const n=window.PDFLib,{PDFDocument:g,rgb:b,StandardFonts:z}=n,q=yield o.arrayBuffer(),j=yield g.load(q),c=j.addPage([612,792]),u=yield j.embedFont(z.Helvetica),r=yield j.embedFont(z.HelveticaBold),{width:d,height:h}=c.getSize();let s=h-50;c.drawText("Shipment Cost Allocation Report",{x:50,y:s,size:16,font:r,color:b(0,0,0)}),s-=25;const S=new Date().toLocaleString("en-US",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric",second:"numeric",hour12:!0});if(c.drawText(`Generated: ${S}`,{x:50,y:s,size:10,font:u,color:b(0,0,0)}),s-=20,a.tax>0||a.fees>0){const m=`Tax ($${a.tax.toFixed(2)}) and Fees ($${a.fees.toFixed(2)}) distributed evenly per item`;c.drawText(m,{x:50,y:s,size:10,font:u,color:b(0,0,0)}),s-=30}c.drawText("Cost Allocation Summary",{x:50,y:s,size:14,font:r,color:b(0,0,0)}),s-=25,c.drawText("Item Description",{x:50,y:s,size:9,font:r}),c.drawText("Qty",{x:250,y:s,size:9,font:r}),c.drawText("Job/Cost Code",{x:280,y:s,size:9,font:r}),c.drawText("Units",{x:380,y:s,size:9,font:r}),c.drawText("Unit Price",{x:420,y:s,size:9,font:r}),c.drawText("Total Cost",{x:500,y:s,size:9,font:r}),s-=15;for(const m of t){if(s<150){const ce=j.addPage([612,792]);s=h-50}const G=m.itemName.length>35?m.itemName.substring(0,35)+"...":m.itemName;c.drawText(G,{x:50,y:s,size:9,font:u}),c.drawText(String(m.quantity),{x:250,y:s,size:9,font:u}),c.drawText(m.costCode||"-",{x:280,y:s,size:9,font:u}),c.drawText(String(m.quantity),{x:380,y:s,size:9,font:u}),c.drawText(`$${m.unitPrice.toFixed(2)}`,{x:420,y:s,size:9,font:u}),c.drawText(`$${m.totalCost.toFixed(2)}`,{x:500,y:s,size:9,font:u}),s-=15}s-=10;const N=420;c.drawText(`Subtotal (Items): $${a.subtotal.toFixed(2)}`,{x:N,y:s,size:9,font:u}),s-=12,c.drawText(`Tax: $${a.tax.toFixed(2)}`,{x:N,y:s,size:9,font:u}),s-=12,c.drawText(`Fees: $${a.fees.toFixed(2)}`,{x:N,y:s,size:9,font:u}),s-=15,c.drawText(`Grand Total: $${a.total.toFixed(2)}`,{x:N,y:s,size:10,font:r}),s-=30,c.drawText("Individual Checkout Details",{x:50,y:s,size:14,font:r,color:b(0,0,0)}),s-=25,c.drawText("Item Description",{x:50,y:s,size:9,font:r}),c.drawText("User",{x:280,y:s,size:9,font:r}),c.drawText("Cost Code",{x:450,y:s,size:9,font:r}),s-=15;for(const m of l){if(s<100)break;const G=m.inventoryItem.name.length>35?m.inventoryItem.name.substring(0,35)+"...":m.inventoryItem.name,ce=m.userName||m.user||"N/A",fe=m.departmentId||m.costCode||"IT Stock 1-20-000-5770";c.drawText(G,{x:50,y:s,size:9,font:u}),c.drawText(ce,{x:280,y:s,size:9,font:u}),c.drawText(fe,{x:450,y:s,size:9,font:u}),s-=15}const P=yield j.save(),$=new Blob([P],{type:"application/pdf"}),T=URL.createObjectURL($),H=document.createElement("a");H.href=T;const ve=F?`receipt-with-allocation-${F}.pdf`:`receipt-with-allocation-${new Date().toISOString().split("T")[0]}.pdf`;H.download=ve,H.click(),URL.revokeObjectURL(T)}catch(n){throw console.error("Error generating PDF report:",n),n}}),U=p.filter(t=>{var o,l,n;if(!k)return!0;const a=k.toLowerCase();return((o=t.name)==null?void 0:o.toLowerCase().includes(a))||((l=t.category)==null?void 0:l.toLowerCase().includes(a))||((n=t.asin)==null?void 0:n.toLowerCase().includes(a))});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center mb-4",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",children:"receipt_long"}),"Process Receipt"]}),e.jsx("p",{style:{color:"var(--color-text-muted)"},children:"Select items from inventory and process receipts with cost allocation to appropriate billing codes."})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"inventory_2"}),"Select from Inventory (",I.length," selected)"]}),e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search by item name, category, or ASIN...",value:k,onChange:t=>O(t.target.value),className:"w-full px-4 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}}),e.jsx("span",{className:"material-icons absolute right-3 top-2.5",style:{color:"var(--color-text-muted)"},children:"search"})]})}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{style:{background:"var(--md-sys-color-surface-container-high)"},children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Select"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Item"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Category"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Qty"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Price"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Cost Code"})]})}),e.jsx("tbody",{children:U.slice(0,20).map(t=>{const a=I.some(l=>l.id===t.id),o="IT Stock 1-20-000-5770";return e.jsxs("tr",{className:`border-b border-[var(--md-sys-color-outline-variant)] cursor-pointer hover:bg-[var(--md-sys-color-surface-container-highest)] ${a?"bg-[rgba(59,130,246,0.15)]":""}`,onClick:()=>xe(t),children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"checkbox",checked:a,onChange:()=>{},className:"cursor-pointer"})}),e.jsxs("td",{className:"px-4 py-2 text-sm font-medium",style:{color:"var(--color-text-light)"},children:[t.name,t.asin&&e.jsx("div",{className:"text-xs",style:{color:"var(--color-text-muted)"},children:t.asin})]}),e.jsx("td",{className:"px-4 py-2 text-sm",style:{color:"var(--color-text-muted)"},children:t.category||"Uncategorized"}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"quantity-badge adequate-stock",children:t.quantity||0})}),e.jsx("td",{className:"px-4 py-2 text-sm",style:{color:"var(--color-success-green)"},children:t.price>0?`$${t.price.toFixed(2)}`:"-"}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"pill-badge",children:o})})]},t.id)})})]}),U.length===0&&e.jsx("div",{className:"text-center py-8",style:{color:"var(--color-text-muted)"},children:"No inventory items available"}),U.length>20&&e.jsxs("div",{className:"text-center py-2 text-sm",style:{color:"var(--color-text-muted)"},children:["Showing first 20 of ",U.length," items"]})]})]}),f.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"link"}),"Matched Checkout Records (",f.length," items)"]}),e.jsx("div",{className:"space-y-4",children:f.map((t,a)=>e.jsxs("div",{className:"border border-[var(--md-sys-color-outline-variant)] rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-medium",style:{color:"var(--color-text-light)"},children:t.inventoryItem.name}),e.jsxs("span",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:[t.checkoutRecords.length," checkout",t.checkoutRecords.length!==1?"s":""," matched"]})]}),t.checkoutRecords.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h5",{className:"text-sm font-medium mb-2",style:{color:"var(--color-text-light)"},children:"Checkout Details:"}),e.jsx("div",{className:"space-y-1",children:t.checkoutRecords.map((o,l)=>{var n,g;return e.jsxs("div",{className:"text-xs p-2 rounded",style:{background:"var(--md-sys-color-surface-container-high)",color:"var(--color-text-muted)"},children:[o.userName||o.user," • Qty: ",o.quantity," • Dept: ",o.departmentId||o.costCode," • ",new Date(((g=(n=o.dateEntered)==null?void 0:n.toDate)==null?void 0:g.call(n))||o.dateEntered||o.date).toLocaleDateString()]},o.id)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",style:{color:"var(--color-text-light)"},children:"Received Quantity"}),e.jsx("input",{type:"number",min:"1",value:t.confirmedQuantity,onChange:o=>ae(t.inventoryItem.id,"confirmedQuantity",o.target.value),className:"w-full px-3 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",style:{color:"var(--color-text-light)"},children:"Unit Price"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:t.confirmedPrice,onChange:o=>ae(t.inventoryItem.id,"confirmedPrice",o.target.value),className:"w-full px-3 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}})]})]}),e.jsxs("div",{className:"mt-3 text-sm",style:{color:"var(--color-text-muted)"},children:["Total: $",(t.confirmedQuantity*t.confirmedPrice).toFixed(2)]})]},t.inventoryItem.id))})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-success-green)"},children:"settings"}),"Shipment Details"]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",style:{color:"var(--color-text-light)"},children:"Upload Receipt PDF (Required)"}),e.jsxs("div",{className:"border-2 border-dashed border-[var(--md-sys-color-outline-variant)] rounded-lg p-6 text-center hover:border-[var(--color-primary-blue)] transition-colors",children:[e.jsx("input",{type:"file",accept:".pdf",onChange:he,className:"hidden",id:"pdf-upload"}),e.jsxs("label",{htmlFor:"pdf-upload",className:"cursor-pointer",children:[e.jsx("span",{className:"material-icons text-4xl",style:{color:"var(--color-text-muted)"},children:"upload_file"}),e.jsx("p",{className:"mt-2 text-sm",style:{color:"var(--color-text-light)"},children:"Click to upload PDF receipt or drag and drop"}),R&&e.jsxs("p",{className:"mt-2 text-sm font-medium",style:{color:"var(--color-success-green)"},children:["Selected: ",R.name]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(A,{type:"text",label:"Vendor Name",value:_,onChange:t=>X(t.target.value),placeholder:"e.g., Amazon, Staples"}),e.jsx(A,{type:"text",label:"Order Number",value:F,onChange:t=>K(t.target.value),placeholder:"e.g., 114-5534389-2755439"}),e.jsx(A,{type:"date",label:"Receipt Date",value:W,onChange:t=>Y(t.target.value)}),e.jsx("div",{}),e.jsx(A,{type:"number",label:"Tax Amount",value:Z,onChange:t=>ee(t.target.value),step:"0.01",min:"0",placeholder:"0.00",required:!0}),e.jsx(A,{type:"number",label:"Fees (Shipping/Handling)",value:te,onChange:t=>se(t.target.value),step:"0.01",min:"0",placeholder:"0.00"})]}),e.jsx(Se,{color:"success",className:"w-full mt-6",disabled:C||!R||f.length===0,onClick:pe,children:C?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-icons mr-2",children:"receipt_long"}),"Process Receipt (",f.length," items)"]})})]}),L&&e.jsx("div",{className:`mat-card p-4 ${L.includes("✅")?"success-box":L.includes("⏳")?"info-box":"error-box"}`,children:L}),re.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"history"}),"Recent Shipment Processing"]}),e.jsx("div",{className:"space-y-3",children:re.slice(-5).reverse().map((t,a)=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg",style:{background:"var(--md-sys-color-surface-container-high)"},children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"material-icons",style:{color:"var(--color-success-green)"},children:"check_circle"}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",style:{color:"var(--color-text-light)"},children:["Order ",t.orderNumber]}),e.jsxs("p",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:[t.itemsProcessed," items • $",t.totalAmount.toFixed(2)," • ",t.vendor]})]})]}),e.jsx("div",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:new Date(t.timestamp).toLocaleDateString()})]},a))})]})]})};export{De as default};
