var le=Object.defineProperty,ce=Object.defineProperties;var ne=Object.getOwnPropertyDescriptors;var G=Object.getOwnPropertySymbols;var ie=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable;var V=(m,n,c)=>n in m?le(m,n,{enumerable:!0,configurable:!0,writable:!0,value:c}):m[n]=c,J=(m,n)=>{for(var c in n||(n={}))ie.call(n,c)&&V(m,c,n[c]);if(G)for(var c of G(n))de.call(n,c)&&V(m,c,n[c]);return m},X=(m,n)=>ce(m,ne(n));var L=(m,n,c)=>new Promise((x,b)=>{var w=u=>{try{j(c.next(u))}catch(v){b(v)}},D=u=>{try{j(c.throw(u))}catch(v){b(v)}},j=u=>u.done?x(u.value):Promise.resolve(u.value).then(w,D);j((c=c.apply(m,n)).next())});import{j as e,d as K}from"./index-fc5c4fdd.js";import{r as f}from"./react-vendor-3371026b.js";import{j as me,d as xe,T as he,k as ue,h as pe}from"./firebase-vendor-fdbb15af.js";import{M as ye}from"./MaterialButton-42949906.js";import{M as C}from"./MaterialInput-8734d6cb.js";const we=({items:m,checkoutHistory:n,user:c})=>{const[x,b]=f.useState([]),[w,D]=f.useState(""),[j,u]=f.useState(!1),[v,R]=f.useState(""),[S,U]=f.useState(""),[W,q]=f.useState(""),[O,E]=f.useState(""),[H,M]=f.useState(""),[k,z]=f.useState(""),[B,Y]=f.useState([]),Z=t=>{if(t.jobNum&&t.jobNum.trim())return t.jobNum.trim();if(!t.departmentId)return"";const r=t.departmentId,l=r.split("-");if(l.length>=3){const[p,h,N]=l,y=N.length===4?N.substring(0,3):N.padStart(3,"0");return`${p}-${h}-${y}-5770`}return r},ee=t=>{x.findIndex(l=>l.id===t.id)>=0?b(l=>l.filter(p=>p.id!==t.id)):b(l=>[...l,t])},te=()=>L(void 0,null,function*(){if(x.length===0){z("❌ Please select at least one item from checkout history");return}u(!0),z("⏳ Processing shipment and generating report...");try{const t=parseFloat(O)||0,r=parseFloat(H)||0,l=x.reduce((o,g)=>o+(g.quantity||1),0),p=l>0?t/l:0,h=l>0?r/l:0,N=x.map(o=>{const g=o.quantity||1,T=o.price||0,s=p*g,P=h*g;return{itemName:o.itemName,quantity:g,unitPrice:T,totalCost:T*g+s+P,taxAllocation:s,feeAllocation:P,userName:o.userName,costCode:Z(o)}}),y=N.reduce((o,g)=>o+g.unitPrice*g.quantity,0),a=y+t+r;yield se(N,{subtotal:y,tax:t,fees:r,total:a});for(const o of x)yield me(xe(K,"archivedCheckouts"),X(J({},o),{archivedAt:he.now(),processedBy:(c==null?void 0:c.email)||"Unknown",orderNumber:S||"N/A",vendor:v||"Unknown"})),yield ue(pe(K,"checkoutHistory",o.id));const i={timestamp:new Date().toISOString(),orderNumber:S||"N/A",itemsProcessed:x.length,totalAmount:a,vendor:v||"Unknown"};Y(o=>[...o,i]),b([]),R(""),U(""),q(""),E(""),M(""),z("✅ Shipment processed successfully! Report downloaded and items archived."),u(!1)}catch(t){console.error("Error processing shipment:",t),z(`❌ Error: ${t.message}`),u(!1)}}),se=(t,r)=>L(void 0,null,function*(){try{const l=window.PDFLib,{PDFDocument:p,rgb:h,StandardFonts:N}=l,y=yield p.create(),a=y.addPage([612,792]),i=yield y.embedFont(N.Helvetica),o=yield y.embedFont(N.HelveticaBold),{width:g,height:T}=a.getSize();let s=T-50;a.drawText("Shipment Cost Allocation Report",{x:50,y:s,size:16,font:o,color:h(0,0,0)}),s-=25;const P=new Date().toLocaleString("en-US",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric",second:"numeric",hour12:!0});if(a.drawText(`Generated: ${P}`,{x:50,y:s,size:10,font:i,color:h(0,0,0)}),s-=20,r.tax>0||r.fees>0){const d=`Tax ($${r.tax.toFixed(2)}) and Fees ($${r.fees.toFixed(2)}) distributed evenly per item`;a.drawText(d,{x:50,y:s,size:10,font:i,color:h(0,0,0)}),s-=30}a.drawText("Cost Allocation Summary",{x:50,y:s,size:14,font:o,color:h(0,0,0)}),s-=25,a.drawText("Item Description",{x:50,y:s,size:9,font:o}),a.drawText("Qty",{x:250,y:s,size:9,font:o}),a.drawText("Job/Cost Code",{x:280,y:s,size:9,font:o}),a.drawText("Units",{x:380,y:s,size:9,font:o}),a.drawText("Unit Price",{x:420,y:s,size:9,font:o}),a.drawText("Total Cost",{x:500,y:s,size:9,font:o}),s-=15;for(const d of t){if(s<150){const _=y.addPage([612,792]);s=T-50}const A=d.itemName.length>35?d.itemName.substring(0,35)+"...":d.itemName;a.drawText(A,{x:50,y:s,size:9,font:i}),a.drawText(String(d.quantity),{x:250,y:s,size:9,font:i}),a.drawText(d.costCode||"-",{x:280,y:s,size:9,font:i}),a.drawText(String(d.quantity),{x:380,y:s,size:9,font:i}),a.drawText(`$${d.unitPrice.toFixed(2)}`,{x:420,y:s,size:9,font:i}),a.drawText(`$${d.totalCost.toFixed(2)}`,{x:500,y:s,size:9,font:i}),s-=15}s-=10;const $=420;a.drawText(`Subtotal (Items): $${r.subtotal.toFixed(2)}`,{x:$,y:s,size:9,font:i}),s-=12,a.drawText(`Tax: $${r.tax.toFixed(2)}`,{x:$,y:s,size:9,font:i}),s-=12,a.drawText(`Fees: $${r.fees.toFixed(2)}`,{x:$,y:s,size:9,font:i}),s-=15,a.drawText(`Grand Total: $${r.total.toFixed(2)}`,{x:$,y:s,size:10,font:o}),s-=30,a.drawText("Individual Checkout Details",{x:50,y:s,size:14,font:o,color:h(0,0,0)}),s-=25,a.drawText("Item Description",{x:50,y:s,size:9,font:o}),a.drawText("User",{x:280,y:s,size:9,font:o}),a.drawText("Cost Code",{x:450,y:s,size:9,font:o}),s-=15;for(const d of t){if(s<100)break;const A=d.itemName.length>35?d.itemName.substring(0,35)+"...":d.itemName,_=d.userName||"N/A";a.drawText(A,{x:50,y:s,size:9,font:i}),a.drawText(_,{x:280,y:s,size:9,font:i}),a.drawText(d.costCode||"-",{x:450,y:s,size:9,font:i}),s-=15}const ae=yield y.save(),oe=new Blob([ae],{type:"application/pdf"}),Q=URL.createObjectURL(oe),I=document.createElement("a");I.href=Q;const re=S?`shipment-allocation-${S}.pdf`:`shipment-allocation-${new Date().toISOString().split("T")[0]}.pdf`;I.download=re,I.click(),URL.revokeObjectURL(Q)}catch(l){throw console.error("Error generating PDF report:",l),l}}),F=n.filter(t=>{var l,p,h;if(!w)return!0;const r=w.toLowerCase();return((l=t.itemName)==null?void 0:l.toLowerCase().includes(r))||((p=t.userName)==null?void 0:p.toLowerCase().includes(r))||((h=t.departmentId)==null?void 0:h.toLowerCase().includes(r))});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center mb-4",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",children:"local_shipping"}),"Process Shipment"]}),e.jsx("p",{style:{color:"var(--color-text-muted)"},children:"Select items from checkout history and allocate costs with tax and fee distribution."})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"checklist"}),"Select from Checkout History (",x.length," selected)"]}),e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search by item name, user, or department...",value:w,onChange:t=>D(t.target.value),className:"w-full px-4 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}}),e.jsx("span",{className:"material-icons absolute right-3 top-2.5",style:{color:"var(--color-text-muted)"},children:"search"})]})}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{style:{background:"var(--md-sys-color-surface-container-high)"},children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Select"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Item"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"User"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Qty"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Price"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Department"})]})}),e.jsx("tbody",{children:F.slice(0,20).map(t=>{const r=x.some(l=>l.id===t.id);return e.jsxs("tr",{className:`border-b border-[var(--md-sys-color-outline-variant)] cursor-pointer hover:bg-[var(--md-sys-color-surface-container-highest)] ${r?"bg-[rgba(59,130,246,0.15)]":""}`,onClick:()=>ee(t),children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"checkbox",checked:r,onChange:()=>{},className:"cursor-pointer"})}),e.jsx("td",{className:"px-4 py-2 text-sm font-medium",style:{color:"var(--color-text-light)"},children:t.itemName}),e.jsx("td",{className:"px-4 py-2 text-sm",style:{color:"var(--color-text-muted)"},children:t.userName}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"quantity-badge adequate-stock",children:t.quantity||1})}),e.jsx("td",{className:"px-4 py-2 text-sm",style:{color:"var(--color-success-green)"},children:t.price>0?`$${t.price.toFixed(2)}`:"-"}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"pill-badge",children:t.departmentId||t.jobNum||"-"})})]},t.id)})})]}),F.length===0&&e.jsx("div",{className:"text-center py-8",style:{color:"var(--color-text-muted)"},children:"No checkout history available"}),F.length>20&&e.jsxs("div",{className:"text-center py-2 text-sm",style:{color:"var(--color-text-muted)"},children:["Showing first 20 of ",F.length," records"]})]})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-success-green)"},children:"settings"}),"Shipment Details"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(C,{type:"text",label:"Vendor Name",value:v,onChange:t=>R(t.target.value),placeholder:"e.g., Amazon, Staples"}),e.jsx(C,{type:"text",label:"Order Number",value:S,onChange:t=>U(t.target.value),placeholder:"e.g., 114-5534389-2755439"}),e.jsx(C,{type:"date",label:"Receipt Date",value:W,onChange:t=>q(t.target.value)}),e.jsx("div",{}),e.jsx(C,{type:"number",label:"Tax Amount",value:O,onChange:t=>E(t.target.value),step:"0.01",min:"0",placeholder:"0.00",required:!0}),e.jsx(C,{type:"number",label:"Fees (Shipping/Handling)",value:H,onChange:t=>M(t.target.value),step:"0.01",min:"0",placeholder:"0.00"})]}),e.jsx(ye,{color:"success",className:"w-full mt-6",disabled:j||x.length===0,onClick:te,children:j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-icons mr-2",children:"receipt_long"}),"Process Shipment (",x.length," items)"]})})]}),k&&e.jsx("div",{className:`mat-card p-4 ${k.includes("✅")?"success-box":k.includes("⏳")?"info-box":"error-box"}`,children:k}),B.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"history"}),"Recent Shipment Processing"]}),e.jsx("div",{className:"space-y-3",children:B.slice(-5).reverse().map((t,r)=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg",style:{background:"var(--md-sys-color-surface-container-high)"},children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"material-icons",style:{color:"var(--color-success-green)"},children:"check_circle"}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",style:{color:"var(--color-text-light)"},children:["Order ",t.orderNumber]}),e.jsxs("p",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:[t.itemsProcessed," items • $",t.totalAmount.toFixed(2)," • ",t.vendor]})]})]}),e.jsx("div",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:new Date(t.timestamp).toLocaleDateString()})]},r))})]})]})};export{we as default};
