var xe=Object.defineProperty,he=Object.defineProperties;var ue=Object.getOwnPropertyDescriptors;var Z=Object.getOwnPropertySymbols;var pe=Object.prototype.hasOwnProperty,ye=Object.prototype.propertyIsEnumerable;var ee=(m,x,h)=>x in m?xe(m,x,{enumerable:!0,configurable:!0,writable:!0,value:h}):m[x]=h,C=(m,x)=>{for(var h in x||(x={}))pe.call(x,h)&&ee(m,h,x[h]);if(Z)for(var h of Z(x))ye.call(x,h)&&ee(m,h,x[h]);return m},F=(m,x)=>he(m,ue(x));var I=(m,x,h)=>new Promise((f,T)=>{var N=v=>{try{u(h.next(v))}catch(b){T(b)}},q=v=>{try{u(h.throw(v))}catch(b){T(b)}},u=v=>v.done?f(v.value):Promise.resolve(v.value).then(N,q);u((h=h.apply(m,x)).next())});import{j as e}from"./index-38c6cd32.js";import{r as g}from"./react-vendor-3371026b.js";import"./firebase-vendor-fdbb15af.js";import{M as $}from"./MaterialButton-2dd43b0e.js";import{M as E}from"./MaterialInput-6fa283f0.js";const Se=({items:m,checkoutHistory:x,user:h})=>{const[f,T]=g.useState("auto"),[N,q]=g.useState(""),[u,v]=g.useState([]),[b,L]=g.useState({}),[te,k]=g.useState(!1),[w,O]=g.useState(null),[ge,B]=g.useState(""),[j,_]=g.useState([]),[H,D]=g.useState(!1),[z,V]=g.useState(""),[R,G]=g.useState(""),[Q,Y]=g.useState(""),[M,p]=g.useState(""),[J,se]=g.useState([]),ae=t=>{if(!t)return"";const s=t.split("-");if(s.length>=3){const[l,o,n]=s,i=n.length===4?n.substring(0,3):n.padStart(3,"0");return`${l}-${o}-${i}-5770`}return t},re=t=>I(void 0,null,function*(){const s=t.target.files[0];if(s){if(s.type!=="application/pdf"){p("❌ Please select a PDF file");return}O(s),D(!0),p("⏳ Extracting text from PDF...");try{const l=window.pdfjsLib,o=yield s.arrayBuffer(),n=yield l.getDocument(o).promise;let i="";for(let y=1;y<=n.numPages;y++){const d=(yield(yield n.getPage(y)).getTextContent()).items.map(S=>S.str).join(" ");i+=d+" "}B(i),p(`✅ PDF uploaded successfully! Extracted ${i.length} characters.`),f==="auto"?yield le(i):setTimeout(()=>p(""),3e3)}catch(l){console.error("Error processing PDF:",l),p(`❌ Failed to process PDF: ${l.message}`)}finally{D(!1)}}}),le=t=>I(void 0,null,function*(){try{const s=[],l=t.toLowerCase();for(const o of x){const n=o.itemName.toLowerCase();if(l.includes(n)||n.split(" ").some(i=>i.length>3&&l.includes(i))){const i=l.indexOf(n),y=t.substring(Math.max(0,i-100),i+200),a=y.match(/\$?(\d+\.?\d{0,2})/),c=y.match(/(\d+)\s*(?:ea|each|qty|quantity|pcs?|pieces?)?/i);s.push(F(C({},o),{extractedPrice:a?parseFloat(a[1]):null,extractedQuantity:c?parseInt(c[1]):o.quantity,confidence:n.length>5?"high":"medium"}))}}_(s),p(`✅ Found ${s.length} potential item match${s.length!==1?"es":""} in PDF`),setTimeout(()=>p(""),3e3)}catch(s){console.error("Error matching items:",s),p(`❌ Error matching items: ${s.message}`)}}),oe=t=>{u.includes(t.name)||(v(s=>[...s,t.name]),L(s=>F(C({},s),{[t.name]:{quantity:1,price:t.price||0}}))),q("")},ce=t=>{v(s=>s.filter(l=>l!==t)),L(s=>{const l=C({},s);return delete l[t],l})},K=(t,s,l)=>{L(o=>F(C({},o),{[t]:F(C({},o[t]),{[s]:s==="quantity"?parseInt(l)||0:parseFloat(l)||0})}))},ne=()=>I(void 0,null,function*(){if((f==="auto"?j:u).length===0){p(`❌ Please ${f==="auto"?"upload a PDF to match items":"select at least one item"}`);return}if(f==="manual"&&u.filter(l=>{const o=b[l];return!o||o.quantity<=0}).length>0){p("❌ Please set quantity and price for all items");return}D(!0),p("⏳ Processing shipment and generating report...");try{let s;f==="auto"?s=j.map(a=>({itemName:a.itemName,quantity:a.extractedQuantity||a.quantity,unitPrice:a.extractedPrice||0,totalCost:(a.extractedQuantity||a.quantity)*(a.extractedPrice||0),userName:a.userName,departmentId:a.departmentId,costCode:ae(a.departmentId)})):s=u.map(a=>{const c=b[a],d=m.find(S=>S.name===a);return{itemName:a,quantity:c.quantity,unitPrice:c.price,totalCost:c.quantity*c.price,category:(d==null?void 0:d.category)||"Uncategorized",asin:(d==null?void 0:d.asin)||""}});const l=s.reduce((a,c)=>a+c.totalCost,0),o=l*.08,n=0,i=l+o+n;yield ie(s,{subtotal:l,tax:o,fees:n,total:i});const y={timestamp:new Date().toISOString(),fileName:(w==null?void 0:w.name)||"Manual Entry",itemsProcessed:u.length,totalAmount:i,vendor:z||"Unknown"};se(a=>[...a,y]),v([]),L({}),_([]),O(null),B(""),V(""),G(""),Y(""),document.getElementById("pdf-upload")&&(document.getElementById("pdf-upload").value=""),p("✅ Shipment processed successfully! Report downloaded."),D(!1)}catch(s){console.error("Error processing shipment:",s),p(`❌ Error: ${s.message}`),D(!1)}}),ie=(t,s)=>I(void 0,null,function*(){try{const l=window.PDFLib,{PDFDocument:o,rgb:n,StandardFonts:i}=l,y=yield o.create(),a=y.addPage([612,792]),c=yield y.embedFont(i.Helvetica),d=yield y.embedFont(i.HelveticaBold),{width:S,height:W}=a.getSize();let r=W-50;a.drawText("SHIPMENT COST ALLOCATION REPORT",{x:50,y:r,size:16,font:d,color:n(.12,.23,.54)}),r-=30,a.drawText(`Generated: ${new Date().toLocaleString()}`,{x:50,y:r,size:10,font:c,color:n(.5,.5,.5)}),r-=15,z&&(a.drawText(`Vendor: ${z}`,{x:50,y:r,size:10,font:c}),r-=15),R&&(a.drawText(`Receipt Date: ${R}`,{x:50,y:r,size:10,font:c}),r-=15),w&&(a.drawText(`Source File: ${w.name}`,{x:50,y:r,size:10,font:c}),r-=15),r-=20,a.drawText("Item Description",{x:50,y:r,size:10,font:d}),a.drawText("Qty",{x:250,y:r,size:10,font:d}),a.drawText("Unit Price",{x:310,y:r,size:10,font:d}),a.drawText("Total Cost",{x:420,y:r,size:10,font:d}),r-=15,a.drawLine({start:{x:50,y:r},end:{x:S-50,y:r},thickness:1,color:n(.8,.8,.8)}),r-=15;for(const P of t){if(r<100){const fe=y.addPage([612,792]);r=W-50}const A=P.itemName.length>30?P.itemName.substring(0,30)+"...":P.itemName;a.drawText(A,{x:50,y:r,size:9,font:c}),a.drawText(String(P.quantity),{x:250,y:r,size:9,font:c}),a.drawText(`$${P.unitPrice.toFixed(2)}`,{x:310,y:r,size:9,font:c}),a.drawText(`$${P.totalCost.toFixed(2)}`,{x:420,y:r,size:9,font:c}),r-=15}r-=20,a.drawLine({start:{x:50,y:r},end:{x:S-50,y:r},thickness:1,color:n(.8,.8,.8)}),r-=20,a.drawText("FINANCIAL SUMMARY",{x:50,y:r,size:12,font:d}),r-=20,a.drawText(`Subtotal: $${s.subtotal.toFixed(2)}`,{x:50,y:r,size:10,font:c}),r-=15,a.drawText(`Tax (8%): $${s.tax.toFixed(2)}`,{x:50,y:r,size:10,font:c}),r-=15,s.fees>0&&(a.drawText(`Fees: $${s.fees.toFixed(2)}`,{x:50,y:r,size:10,font:c}),r-=15),a.drawText(`Grand Total: $${s.total.toFixed(2)}`,{x:50,y:r,size:12,font:d}),Q&&(r-=30,a.drawText("Notes:",{x:50,y:r,size:10,font:d}),r-=15,(Q.match(/.{1,70}/g)||[]).forEach(A=>{r<50||(a.drawText(A,{x:50,y:r,size:9,font:c}),r-=12)}));const de=yield y.save(),me=new Blob([de],{type:"application/pdf"}),X=URL.createObjectURL(me),U=document.createElement("a");U.href=X,U.download=`shipment-allocation-${new Date().toISOString().split("T")[0]}.pdf`,U.click(),URL.revokeObjectURL(X)}catch(l){throw console.error("Error generating PDF report:",l),l}});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center mb-4",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",children:"local_shipping"}),"Process Shipment"]}),e.jsx("p",{style:{color:"var(--color-text-muted)"},children:"Choose between automatic PDF matching or manual item selection for shipment processing."})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",style:{color:"var(--color-text-light)"},children:"Cost Allocation Method"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:"allocation",value:"auto",checked:f==="auto",onChange:t=>T(t.target.value),className:"mr-3"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",style:{color:"var(--color-text-light)"},children:"Automatic - Match against checkout history"}),e.jsx("p",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:"Upload PDF receipt and automatically find matching items from checkout history"})]})]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:"allocation",value:"manual",checked:f==="manual",onChange:t=>T(t.target.value),className:"mr-3"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",style:{color:"var(--color-text-light)"},children:"Manual - Select items and set prices"}),e.jsx("p",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:"Manually select items from inventory and enter quantities/prices"})]})]})]})]}),f==="manual"&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"search"}),"Select Items for Processing"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",style:{color:"var(--color-text-light)"},children:"Search and Add Items"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Type item name to search...",value:N,onChange:t=>q(t.target.value),className:"w-full px-4 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}}),e.jsx("span",{className:"material-icons absolute right-3 top-2.5",style:{color:"var(--color-text-muted)"},children:"search"})]}),N&&N.length>0&&e.jsxs("div",{className:"mt-2 border border-[var(--md-sys-color-outline-variant)] rounded-lg shadow-lg max-h-48 overflow-y-auto",style:{background:"var(--md-sys-color-surface)"},children:[m.filter(t=>t.name.toLowerCase().includes(N.toLowerCase())).slice(0,10).map(t=>e.jsxs("div",{onClick:()=>oe(t),className:"px-4 py-2 hover:bg-[var(--md-sys-color-surface-container-highest)] cursor-pointer border-b border-[var(--md-sys-color-outline-variant)] last:border-b-0",children:[e.jsx("div",{className:"font-medium",style:{color:"var(--color-text-light)"},children:t.name}),e.jsxs("div",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:["Qty: ",t.quantity," | Category: ",t.category,t.price>0&&e.jsxs("span",{className:"ml-2",style:{color:"var(--color-success-green)"},children:["$",t.price]})]})]},t.id)),m.filter(t=>t.name.toLowerCase().includes(N.toLowerCase())).length===0&&e.jsx("div",{className:"px-4 py-2",style:{color:"var(--color-text-muted)"},children:"No items found"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",style:{color:"var(--color-text-light)"},children:["Selected Items (",u.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:u.length===0?e.jsx("div",{className:"text-sm italic",style:{color:"var(--color-text-muted)"},children:"No items selected"}):u.map(t=>e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 rounded-lg",style:{background:"rgba(59, 130, 246, 0.15)"},children:[e.jsx("span",{className:"text-sm font-medium",style:{color:"var(--color-text-light)"},children:t}),e.jsx("button",{onClick:()=>ce(t),className:"hover:opacity-80",style:{color:"var(--color-error-red)"},children:e.jsx("span",{className:"material-icons text-sm",children:"close"})})]},t))})]}),u.length>0&&e.jsxs($,{color:"primary",onClick:()=>k(!0),className:"w-full",children:[e.jsx("span",{className:"material-icons mr-2",children:"edit"}),"Set Quantities & Prices (",u.length," items)"]})]})]}),f==="auto"&&j.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-success-green)"},children:"assignment_turned_in"}),"Matched Items (",j.length,")"]}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{style:{background:"var(--md-sys-color-surface-container-high)"},children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Item"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"User"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Qty"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Dept"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Confidence"})]})}),e.jsx("tbody",{children:j.slice(0,10).map((t,s)=>e.jsxs("tr",{className:"border-b border-[var(--md-sys-color-outline-variant)]",children:[e.jsx("td",{className:"px-4 py-2 text-sm font-medium",style:{color:"var(--color-text-light)"},children:t.itemName.length>30?t.itemName.substring(0,30)+"...":t.itemName}),e.jsx("td",{className:"px-4 py-2 text-sm",style:{color:"var(--color-text-muted)"},children:t.userName}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"quantity-badge adequate-stock",children:t.extractedQuantity||t.quantity})}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"pill-badge",children:t.departmentId||"-"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("span",{className:`inline-flex px-2 py-1 text-xs font-medium rounded-full ${t.confidence==="high"?"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300":"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300"}`,children:t.confidence})})]},s))})]}),j.length>10&&e.jsxs("div",{className:"text-center py-2 text-sm",style:{color:"var(--color-text-muted)"},children:["and ",j.length-10," more items..."]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"upload_file"}),"Upload Receipt PDF"]}),e.jsxs("div",{className:"border-2 border-dashed border-[var(--md-sys-color-outline-variant)] rounded-lg p-8 text-center hover:border-[var(--color-primary-blue)] transition-colors",children:[e.jsx("span",{className:"material-icons text-4xl mb-2",style:{color:"var(--color-text-muted)"},children:"picture_as_pdf"}),e.jsx("p",{className:"mb-4",style:{color:"var(--color-text-muted)"},children:"Drop PDF receipt here or click to upload"}),e.jsx("input",{type:"file",accept:".pdf",className:"hidden",id:"pdf-upload",onChange:re}),e.jsxs($,{variant:"outlined",onClick:()=>document.getElementById("pdf-upload").click(),children:[e.jsx("span",{className:"material-icons mr-2",children:"file_upload"}),w?w.name:"Choose PDF File"]})]})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-success-green)"},children:"settings"}),"Processing Options"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(E,{type:"date",label:"Receipt Date",value:R,onChange:t=>G(t.target.value)}),e.jsx(E,{type:"text",label:"Vendor Name",value:z,onChange:t=>V(t.target.value),placeholder:"Optional vendor name"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",style:{color:"var(--color-text-light)"},children:"Notes"}),e.jsx("textarea",{rows:3,placeholder:"Processing notes or special instructions",value:Q,onChange:t=>Y(t.target.value),className:"w-full px-3 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}})]}),e.jsx($,{color:"success",className:"w-full",disabled:H||f==="auto"&&j.length===0||f==="manual"&&u.length===0,onClick:ne,children:H?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-icons mr-2",children:"receipt_long"}),"Process Shipment"]})})]})]})]}),M&&e.jsx("div",{className:`mat-card p-4 ${M.includes("✅")?"success-box":M.includes("⏳")?"info-box":"error-box"}`,children:M}),J.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"history"}),"Recent Shipment Processing"]}),e.jsx("div",{className:"space-y-3",children:J.slice(-5).reverse().map((t,s)=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg",style:{background:"var(--md-sys-color-surface-container-high)"},children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"material-icons",style:{color:"var(--color-success-green)"},children:"check_circle"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",style:{color:"var(--color-text-light)"},children:t.fileName}),e.jsxs("p",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:[t.itemsProcessed," items • $",t.totalAmount.toFixed(2)," • ",t.vendor]})]})]}),e.jsx("div",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:new Date(t.timestamp).toLocaleDateString()})]},s))})]}),te&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:()=>k(!1),children:e.jsxs("div",{className:"mat-card p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-xl font-semibold flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"edit"}),"Set Quantities & Prices"]}),e.jsx("button",{onClick:()=>k(!1),className:"hover:opacity-80",style:{color:"var(--color-text-muted)"},children:e.jsx("span",{className:"material-icons",children:"close"})})]}),e.jsx("div",{className:"space-y-4",children:u.map(t=>{const s=m.find(o=>o.name===t),l=b[t]||{quantity:1,price:(s==null?void 0:s.price)||0};return e.jsxs("div",{className:"p-4 rounded-lg",style:{background:"var(--md-sys-color-surface-container-high)"},children:[e.jsx("h4",{className:"font-medium mb-3",style:{color:"var(--color-text-light)"},children:t}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(E,{type:"number",label:"Quantity",value:l.quantity,onChange:o=>K(t,"quantity",o.target.value),min:"1",required:!0}),e.jsx(E,{type:"number",label:"Unit Price",value:l.price,onChange:o=>K(t,"price",o.target.value),step:"0.01",placeholder:"0.00"})]}),s&&e.jsxs("div",{className:"text-sm mt-2",style:{color:"var(--color-text-muted)"},children:["Current stock: ",s.quantity," | Category: ",s.category]})]},t)})}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx($,{variant:"outlined",onClick:()=>k(!1),children:"Cancel"}),e.jsxs($,{color:"primary",onClick:()=>{k(!1),p("✅ Item details saved successfully"),setTimeout(()=>p(""),3e3)},children:[e.jsx("span",{className:"material-icons mr-2",children:"save"}),"Save Details"]})]})]})})]})};export{Se as default};
