var fe=Object.defineProperty,ve=Object.defineProperties;var ge=Object.getOwnPropertyDescriptors;var ae=Object.getOwnPropertySymbols;var be=Object.prototype.hasOwnProperty,Ne=Object.prototype.propertyIsEnumerable;var ce=(p,m,i)=>m in p?fe(p,m,{enumerable:!0,configurable:!0,writable:!0,value:i}):p[m]=i,M=(p,m)=>{for(var i in m||(m={}))be.call(m,i)&&ce(p,i,m[i]);if(ae)for(var i of ae(m))Ne.call(m,i)&&ce(p,i,m[i]);return p},O=(p,m)=>ve(p,ge(m));var _=(p,m,i)=>new Promise((P,j)=>{var T=y=>{try{h(i.next(y))}catch(w){j(w)}},U=y=>{try{h(i.throw(y))}catch(w){j(w)}},h=y=>y.done?P(y.value):Promise.resolve(y.value).then(T,U);h((i=i.apply(p,m)).next())});import{j as e,d as L}from"./index-62cddff3.js";import{r as f}from"./react-vendor-3371026b.js";import{w as je,h as H,d as le,T as ne}from"./firebase-vendor-e2f55cd7.js";import{M as we}from"./MaterialButton-636ed5da.js";import{M as D}from"./MaterialInput-b4cbb124.js";const Ie=({items:p,checkoutHistory:m,user:i})=>{const[P,j]=f.useState([]),[T,U]=f.useState(""),[h,y]=f.useState([]),[w,Q]=f.useState(!1),[q,G]=f.useState(""),[k,J]=f.useState(""),[V,X]=f.useState(""),[K,W]=f.useState(""),[Y,Z]=f.useState(""),[F,ee]=f.useState(null),[z,I]=f.useState(""),[te,ie]=f.useState([]),de=t=>{P.findIndex(o=>o.id===t.id)>=0?(j(o=>o.filter(n=>n.id!==t.id)),y(o=>o.filter(n=>n.inventoryItem.id!==t.id))):(j(o=>[...o,t]),me(t))},me=t=>{const r=m.filter(o=>{var n,d,u,b;return((n=o.itemName)==null?void 0:n.toLowerCase())===((d=t.name)==null?void 0:d.toLowerCase())||((u=o.item)==null?void 0:u.toLowerCase())===((b=t.name)==null?void 0:b.toLowerCase())});if(r.length>0){const o={inventoryItem:t,checkoutRecords:r,confirmedQuantity:r.reduce((n,d)=>n+(d.quantity||1),0),confirmedPrice:t.price||0};y(n=>[...n,o])}else{const o={inventoryItem:t,checkoutRecords:[],confirmedQuantity:1,confirmedPrice:t.price||0};y(n=>[...n,o])}},se=(t,r,o)=>{y(n=>n.map(d=>d.inventoryItem.id===t?O(M({},d),{[r]:parseFloat(o)||0}):d))},xe=t=>{const r=t.target.files[0];r&&r.type==="application/pdf"?ee(r):alert("Please select a valid PDF file.")},ue=()=>_(void 0,null,function*(){if(!F){I("❌ Please upload a receipt PDF first");return}if(h.length===0){I("❌ Please select at least one item from inventory");return}Q(!0),I("⏳ Processing receipt and generating cost allocation...");try{const t=parseFloat(K)||0,r=parseFloat(Y)||0,o=h.reduce((a,l)=>a+l.confirmedQuantity,0),n=o>0?t/o:0,d=o>0?r/o:0,u=h.map(a=>{const l=a.confirmedQuantity,R=a.confirmedPrice,g=n*l,s=d*l;let C="IT Stock",N="IT Stock 1-20-000-5770";if(a.checkoutRecords.length>0){const S=a.checkoutRecords[0];C=S.userName||S.user||"System Receipt",N=S.departmentId||S.costCode||"IT Stock 1-20-000-5770"}return{itemName:a.inventoryItem.name,quantity:l,unitPrice:R,totalCost:R*l+g+s,taxAllocation:g,feeAllocation:s,userName:C,costCode:N}}),b=u.reduce((a,l)=>a+l.unitPrice*l.quantity,0),A=b+t+r;yield he(u,{subtotal:b,tax:t,fees:r,total:A},F);const v=je(L);for(const a of h){const l=u.find(g=>g.itemName===a.inventoryItem.name),R=H(le(L,"costAllocation"));v.set(R,{itemId:a.inventoryItem.id,itemName:a.inventoryItem.name,quantity:a.confirmedQuantity,unitPrice:a.confirmedPrice,totalCost:l.totalCost,taxAllocation:l.taxAllocation,feeAllocation:l.feeAllocation,costCode:l.costCode,vendor:q||"Unknown",orderNumber:k||"N/A",receiptDate:V||new Date().toISOString().split("T")[0],processedAt:ne.now(),processedBy:(i==null?void 0:i.email)||"Unknown",type:l.costCode.includes("Job")?"job":"it_stock"});for(const g of a.checkoutRecords){const s=H(le(L,"archivedCheckouts"));v.set(s,O(M({},g),{archivedAt:ne.now(),archivedBy:(i==null?void 0:i.email)||"Unknown",archiveReason:"Processed receipt"}));const C=H(L,"checkoutHistory",g.id);v.delete(C)}}yield v.commit();const c={timestamp:new Date().toISOString(),orderNumber:k||"N/A",itemsProcessed:h.length,totalAmount:A,vendor:q||"Unknown"};ie(a=>[...a,c]),j([]),y([]),G(""),J(""),X(""),W(""),Z(""),ee(null),I("✅ Shipment processed successfully! Report downloaded and items archived."),Q(!1)}catch(t){console.error("Error processing shipment:",t),I(`❌ Error: ${t.message}`),Q(!1)}}),he=(t,r,o)=>_(void 0,null,function*(){try{const n=window.PDFLib,{PDFDocument:d,rgb:u,StandardFonts:b}=n,A=yield o.arrayBuffer(),v=yield d.load(A),c=v.addPage([612,792]),a=yield v.embedFont(b.Helvetica),l=yield v.embedFont(b.HelveticaBold),{width:R,height:g}=c.getSize();let s=g-50;c.drawText("Shipment Cost Allocation Report",{x:50,y:s,size:16,font:l,color:u(0,0,0)}),s-=25;const C=new Date().toLocaleString("en-US",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric",second:"numeric",hour12:!0});if(c.drawText(`Generated: ${C}`,{x:50,y:s,size:10,font:a,color:u(0,0,0)}),s-=20,r.tax>0||r.fees>0){const x=`Tax ($${r.tax.toFixed(2)}) and Fees ($${r.fees.toFixed(2)}) distributed evenly per item`;c.drawText(x,{x:50,y:s,size:10,font:a,color:u(0,0,0)}),s-=30}c.drawText("Cost Allocation Summary",{x:50,y:s,size:14,font:l,color:u(0,0,0)}),s-=25,c.drawText("Item Description",{x:50,y:s,size:9,font:l}),c.drawText("Qty",{x:250,y:s,size:9,font:l}),c.drawText("Job/Cost Code",{x:280,y:s,size:9,font:l}),c.drawText("Units",{x:380,y:s,size:9,font:l}),c.drawText("Unit Price",{x:420,y:s,size:9,font:l}),c.drawText("Total Cost",{x:500,y:s,size:9,font:l}),s-=15;for(const x of t){if(s<150){const re=v.addPage([612,792]);s=g-50}const E=x.itemName.length>35?x.itemName.substring(0,35)+"...":x.itemName;c.drawText(E,{x:50,y:s,size:9,font:a}),c.drawText(String(x.quantity),{x:250,y:s,size:9,font:a}),c.drawText(x.costCode||"-",{x:280,y:s,size:9,font:a}),c.drawText(String(x.quantity),{x:380,y:s,size:9,font:a}),c.drawText(`$${x.unitPrice.toFixed(2)}`,{x:420,y:s,size:9,font:a}),c.drawText(`$${x.totalCost.toFixed(2)}`,{x:500,y:s,size:9,font:a}),s-=15}s-=10;const N=420;c.drawText(`Subtotal (Items): $${r.subtotal.toFixed(2)}`,{x:N,y:s,size:9,font:a}),s-=12,c.drawText(`Tax: $${r.tax.toFixed(2)}`,{x:N,y:s,size:9,font:a}),s-=12,c.drawText(`Fees: $${r.fees.toFixed(2)}`,{x:N,y:s,size:9,font:a}),s-=15,c.drawText(`Grand Total: $${r.total.toFixed(2)}`,{x:N,y:s,size:10,font:l}),s-=30,c.drawText("Individual Checkout Details",{x:50,y:s,size:14,font:l,color:u(0,0,0)}),s-=25,c.drawText("Item Description",{x:50,y:s,size:9,font:l}),c.drawText("User",{x:280,y:s,size:9,font:l}),c.drawText("Cost Code",{x:450,y:s,size:9,font:l}),s-=15;for(const x of t){if(s<100)break;const E=x.itemName.length>35?x.itemName.substring(0,35)+"...":x.itemName,re=x.userName||"N/A";c.drawText(E,{x:50,y:s,size:9,font:a}),c.drawText(re,{x:280,y:s,size:9,font:a}),c.drawText(x.costCode||"-",{x:450,y:s,size:9,font:a}),s-=15}const S=yield v.save(),pe=new Blob([S],{type:"application/pdf"}),oe=URL.createObjectURL(pe),B=document.createElement("a");B.href=oe;const ye=k?`receipt-with-allocation-${k}.pdf`:`receipt-with-allocation-${new Date().toISOString().split("T")[0]}.pdf`;B.download=ye,B.click(),URL.revokeObjectURL(oe)}catch(n){throw console.error("Error generating PDF report:",n),n}}),$=p.filter(t=>{var o,n,d;if(!T)return!0;const r=T.toLowerCase();return((o=t.name)==null?void 0:o.toLowerCase().includes(r))||((n=t.category)==null?void 0:n.toLowerCase().includes(r))||((d=t.asin)==null?void 0:d.toLowerCase().includes(r))});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center mb-4",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",children:"receipt_long"}),"Process Receipt"]}),e.jsx("p",{style:{color:"var(--color-text-muted)"},children:"Select items from inventory and process receipts with cost allocation to appropriate billing codes."})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"inventory_2"}),"Select from Inventory (",P.length," selected)"]}),e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search by item name, category, or ASIN...",value:T,onChange:t=>U(t.target.value),className:"w-full px-4 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}}),e.jsx("span",{className:"material-icons absolute right-3 top-2.5",style:{color:"var(--color-text-muted)"},children:"search"})]})}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{style:{background:"var(--md-sys-color-surface-container-high)"},children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Select"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Item"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Category"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Qty"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Price"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Cost Code"})]})}),e.jsx("tbody",{children:$.slice(0,20).map(t=>{const r=P.some(n=>n.id===t.id),o="IT Stock 1-20-000-5770";return e.jsxs("tr",{className:`border-b border-[var(--md-sys-color-outline-variant)] cursor-pointer hover:bg-[var(--md-sys-color-surface-container-highest)] ${r?"bg-[rgba(59,130,246,0.15)]":""}`,onClick:()=>de(t),children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"checkbox",checked:r,onChange:()=>{},className:"cursor-pointer"})}),e.jsxs("td",{className:"px-4 py-2 text-sm font-medium",style:{color:"var(--color-text-light)"},children:[t.name,t.asin&&e.jsx("div",{className:"text-xs",style:{color:"var(--color-text-muted)"},children:t.asin})]}),e.jsx("td",{className:"px-4 py-2 text-sm",style:{color:"var(--color-text-muted)"},children:t.category||"Uncategorized"}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"quantity-badge adequate-stock",children:t.quantity||0})}),e.jsx("td",{className:"px-4 py-2 text-sm",style:{color:"var(--color-success-green)"},children:t.price>0?`$${t.price.toFixed(2)}`:"-"}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"pill-badge",children:o})})]},t.id)})})]}),$.length===0&&e.jsx("div",{className:"text-center py-8",style:{color:"var(--color-text-muted)"},children:"No inventory items available"}),$.length>20&&e.jsxs("div",{className:"text-center py-2 text-sm",style:{color:"var(--color-text-muted)"},children:["Showing first 20 of ",$.length," items"]})]})]}),h.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"link"}),"Matched Checkout Records (",h.length," items)"]}),e.jsx("div",{className:"space-y-4",children:h.map((t,r)=>e.jsxs("div",{className:"border border-[var(--md-sys-color-outline-variant)] rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-medium",style:{color:"var(--color-text-light)"},children:t.inventoryItem.name}),e.jsxs("span",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:[t.checkoutRecords.length," checkout",t.checkoutRecords.length!==1?"s":""," matched"]})]}),t.checkoutRecords.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h5",{className:"text-sm font-medium mb-2",style:{color:"var(--color-text-light)"},children:"Checkout Details:"}),e.jsx("div",{className:"space-y-1",children:t.checkoutRecords.map((o,n)=>{var d,u;return e.jsxs("div",{className:"text-xs p-2 rounded",style:{background:"var(--md-sys-color-surface-container-high)",color:"var(--color-text-muted)"},children:[o.userName||o.user," • Qty: ",o.quantity," • Dept: ",o.departmentId||o.costCode," • ",new Date(((u=(d=o.dateEntered)==null?void 0:d.toDate)==null?void 0:u.call(d))||o.dateEntered||o.date).toLocaleDateString()]},o.id)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",style:{color:"var(--color-text-light)"},children:"Received Quantity"}),e.jsx("input",{type:"number",min:"1",value:t.confirmedQuantity,onChange:o=>se(t.inventoryItem.id,"confirmedQuantity",o.target.value),className:"w-full px-3 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",style:{color:"var(--color-text-light)"},children:"Unit Price"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:t.confirmedPrice,onChange:o=>se(t.inventoryItem.id,"confirmedPrice",o.target.value),className:"w-full px-3 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}})]})]}),e.jsxs("div",{className:"mt-3 text-sm",style:{color:"var(--color-text-muted)"},children:["Total: $",(t.confirmedQuantity*t.confirmedPrice).toFixed(2)]})]},t.inventoryItem.id))})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-success-green)"},children:"settings"}),"Shipment Details"]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",style:{color:"var(--color-text-light)"},children:"Upload Receipt PDF (Required)"}),e.jsxs("div",{className:"border-2 border-dashed border-[var(--md-sys-color-outline-variant)] rounded-lg p-6 text-center hover:border-[var(--color-primary-blue)] transition-colors",children:[e.jsx("input",{type:"file",accept:".pdf",onChange:xe,className:"hidden",id:"pdf-upload"}),e.jsxs("label",{htmlFor:"pdf-upload",className:"cursor-pointer",children:[e.jsx("span",{className:"material-icons text-4xl",style:{color:"var(--color-text-muted)"},children:"upload_file"}),e.jsx("p",{className:"mt-2 text-sm",style:{color:"var(--color-text-light)"},children:"Click to upload PDF receipt or drag and drop"}),F&&e.jsxs("p",{className:"mt-2 text-sm font-medium",style:{color:"var(--color-success-green)"},children:["Selected: ",F.name]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(D,{type:"text",label:"Vendor Name",value:q,onChange:t=>G(t.target.value),placeholder:"e.g., Amazon, Staples"}),e.jsx(D,{type:"text",label:"Order Number",value:k,onChange:t=>J(t.target.value),placeholder:"e.g., 114-5534389-2755439"}),e.jsx(D,{type:"date",label:"Receipt Date",value:V,onChange:t=>X(t.target.value)}),e.jsx("div",{}),e.jsx(D,{type:"number",label:"Tax Amount",value:K,onChange:t=>W(t.target.value),step:"0.01",min:"0",placeholder:"0.00",required:!0}),e.jsx(D,{type:"number",label:"Fees (Shipping/Handling)",value:Y,onChange:t=>Z(t.target.value),step:"0.01",min:"0",placeholder:"0.00"})]}),e.jsx(we,{color:"success",className:"w-full mt-6",disabled:w||!F||h.length===0,onClick:ue,children:w?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-icons mr-2",children:"receipt_long"}),"Process Receipt (",h.length," items)"]})})]}),z&&e.jsx("div",{className:`mat-card p-4 ${z.includes("✅")?"success-box":z.includes("⏳")?"info-box":"error-box"}`,children:z}),te.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"history"}),"Recent Shipment Processing"]}),e.jsx("div",{className:"space-y-3",children:te.slice(-5).reverse().map((t,r)=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg",style:{background:"var(--md-sys-color-surface-container-high)"},children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"material-icons",style:{color:"var(--color-success-green)"},children:"check_circle"}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",style:{color:"var(--color-text-light)"},children:["Order ",t.orderNumber]}),e.jsxs("p",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:[t.itemsProcessed," items • $",t.totalAmount.toFixed(2)," • ",t.vendor]})]})]}),e.jsx("div",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:new Date(t.timestamp).toLocaleDateString()})]},r))})]})]})};export{Ie as default};
