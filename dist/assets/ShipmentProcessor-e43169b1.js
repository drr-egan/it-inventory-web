var Ce=Object.defineProperty,Pe=Object.defineProperties;var Se=Object.getOwnPropertyDescriptors;var ie=Object.getOwnPropertySymbols;var Te=Object.prototype.hasOwnProperty,Ie=Object.prototype.propertyIsEnumerable;var de=(h,x,d)=>x in h?Ce(h,x,{enumerable:!0,configurable:!0,writable:!0,value:d}):h[x]=d,B=(h,x)=>{for(var d in x||(x={}))Te.call(x,d)&&de(h,d,x[d]);if(ie)for(var d of ie(x))Ie.call(x,d)&&de(h,d,x[d]);return h},O=(h,x)=>Pe(h,Se(x));var V=(h,x,d)=>new Promise((F,P)=>{var z=f=>{try{w(d.next(f))}catch(S){P(S)}},M=f=>{try{w(d.throw(f))}catch(S){P(S)}},w=f=>f.done?F(f.value):Promise.resolve(f.value).then(z,M);w((d=d.apply(h,x)).next())});import{j as e,d as E}from"./index-2c473f43.js";import{r as g}from"./react-vendor-3371026b.js";import{w as Fe,h as X,d as me,T as xe}from"./firebase-vendor-e2f55cd7.js";import{M as ze}from"./MaterialButton-33231d9b.js";import{M as A}from"./MaterialInput-92fb11ba.js";const Ue=({items:h,checkoutHistory:x,user:d})=>{const[F,P]=g.useState([]),[z,M]=g.useState(""),[w,f]=g.useState([]),[S,_]=g.useState(!1),[G,K]=g.useState(""),[k,W]=g.useState(""),[Y,Z]=g.useState(""),[ee,te]=g.useState(""),[se,oe]=g.useState(""),[$,re]=g.useState(null),[L,U]=g.useState(""),[ae,ue]=g.useState([]),pe=t=>{F.findIndex(r=>r.id===t.id)>=0?(P(r=>r.filter(l=>l.id!==t.id)),f(r=>r.filter(l=>l.inventoryItem.id!==t.id))):(P(r=>[...r,t]),he(t))},he=t=>{const c=x.filter(r=>{var l,n,N,b;return((l=r.itemName)==null?void 0:l.toLowerCase())===((n=t.name)==null?void 0:n.toLowerCase())||((N=r.item)==null?void 0:N.toLowerCase())===((b=t.name)==null?void 0:b.toLowerCase())});if(c.length>0){const r={inventoryItem:t,checkoutRecords:c,confirmedQuantity:c.reduce((l,n)=>l+(n.quantity||1),0),confirmedPrice:t.price||0};f(l=>[...l,r])}else{const r={inventoryItem:t,checkoutRecords:[],confirmedQuantity:1,confirmedPrice:t.price||0};f(l=>[...l,r])}},ce=(t,c,r)=>{f(l=>l.map(n=>n.inventoryItem.id===t?O(B({},n),{[c]:parseFloat(r)||0}):n))},ye=t=>{const c=t.target.files[0];c&&c.type==="application/pdf"?re(c):alert("Please select a valid PDF file.")},fe=()=>V(void 0,null,function*(){if(!$){U("❌ Please upload a receipt PDF first");return}_(!0),U("⏳ Processing receipt and generating cost allocation...");try{const t=parseFloat(ee)||0,c=parseFloat(se)||0,r=x.map(o=>{const m=h.find(y=>{var s,p,v,j;return((s=y.name)==null?void 0:s.toLowerCase())===((p=o.itemName)==null?void 0:p.toLowerCase())||((v=y.name)==null?void 0:v.toLowerCase())===((j=o.item)==null?void 0:j.toLowerCase())});return O(B({},o),{inventoryItem:m||{name:o.itemName||o.item,price:0},confirmedPrice:(m==null?void 0:m.price)||0})}),l=r.reduce((o,m)=>o+(m.quantity||1),0),n=l>0?t/l:0,N=l>0?c/l:0,b=r.reduce((o,m)=>{const y=m.departmentId||m.costCode||"IT Stock 1-20-000-5770",p=`${m.inventoryItem.name}|${y}`;return o[p]||(o[p]=[]),o[p].push(m),o},{}),D=Object.entries(b).map(([o,m])=>{const[y,s]=o.split("|"),p=m.reduce((I,R)=>I+(R.quantity||1),0),v=m[0].confirmedPrice,j=n*p,T=N*p;return{itemName:y,quantity:p,unitPrice:v,totalCost:v*p+j+T,taxAllocation:j,feeAllocation:T,costCode:s}}),Q=D.reduce((o,m)=>o+m.unitPrice*m.quantity,0),C=Q+t+c;yield ve(D,{subtotal:Q,tax:t,fees:c,total:C},$,r);const a=Fe(E);for(const o of r){const m=o.departmentId||o.costCode||"IT Stock 1-20-000-5770",y=o.quantity||1,s=o.confirmedPrice,p=n*y,v=N*y,j=X(me(E,"costAllocation"));a.set(j,{itemId:o.inventoryItem.id,itemName:o.inventoryItem.name,quantity:y,unitPrice:s,totalCost:s*y+p+v,taxAllocation:p,feeAllocation:v,costCode:m,userName:o.userName||o.user||"Unknown",vendor:G||"Unknown",orderNumber:k||"N/A",receiptDate:Y||new Date().toISOString().split("T")[0],processedAt:xe.now(),processedBy:(d==null?void 0:d.email)||"Unknown",type:m.includes("Job")?"job":"it_stock"});const T=X(me(E,"archivedCheckouts"));a.set(T,O(B({},o),{archivedAt:xe.now(),archivedBy:(d==null?void 0:d.email)||"Unknown",archiveReason:"Processed receipt"}));const I=X(E,"checkoutHistory",o.id);a.delete(I)}yield a.commit();const u={timestamp:new Date().toISOString(),orderNumber:k||"N/A",itemsProcessed:r.length,totalAmount:C,vendor:G||"Unknown"};ue(o=>[...o,u]),P([]),f([]),K(""),W(""),Z(""),te(""),oe(""),re(null),U("✅ Shipment processed successfully! Report downloaded and items archived."),_(!1)}catch(t){console.error("Error processing shipment:",t),U(`❌ Error: ${t.message}`),_(!1)}}),ve=(t,c,r,l)=>V(void 0,null,function*(){try{const n=window.PDFLib,{PDFDocument:N,rgb:b,StandardFonts:D}=n,Q=yield r.arrayBuffer(),C=yield N.load(Q),a=C.addPage([612,792]),u=yield C.embedFont(D.Helvetica),o=yield C.embedFont(D.HelveticaBold),{width:m,height:y}=a.getSize();let s=y-50;a.drawText("Shipment Cost Allocation Report",{x:50,y:s,size:16,font:o,color:b(0,0,0)}),s-=25;const p=new Date().toLocaleString("en-US",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric",second:"numeric",hour12:!0});if(a.drawText(`Generated: ${p}`,{x:50,y:s,size:10,font:u,color:b(0,0,0)}),s-=20,c.tax>0||c.fees>0){const i=`Tax ($${c.tax.toFixed(2)}) and Fees ($${c.fees.toFixed(2)}) distributed evenly per item`;a.drawText(i,{x:50,y:s,size:10,font:u,color:b(0,0,0)}),s-=30}a.drawText("Cost Allocation Summary",{x:50,y:s,size:14,font:o,color:b(0,0,0)}),s-=25,a.drawText("Item Description",{x:50,y:s,size:9,font:o}),a.drawText("Qty",{x:250,y:s,size:9,font:o}),a.drawText("Job/Cost Code",{x:280,y:s,size:9,font:o}),a.drawText("Units",{x:380,y:s,size:9,font:o}),a.drawText("Unit Price",{x:420,y:s,size:9,font:o}),a.drawText("Total Cost",{x:500,y:s,size:9,font:o}),s-=15;for(const i of t){if(s<150){const le=C.addPage([612,792]);s=y-50}const H=i.itemName.length>35?i.itemName.substring(0,35)+"...":i.itemName;a.drawText(H,{x:50,y:s,size:9,font:u}),a.drawText(String(i.quantity),{x:250,y:s,size:9,font:u}),a.drawText(i.costCode||"-",{x:280,y:s,size:9,font:u}),a.drawText(String(i.quantity),{x:380,y:s,size:9,font:u}),a.drawText(`$${i.unitPrice.toFixed(2)}`,{x:420,y:s,size:9,font:u}),a.drawText(`$${i.totalCost.toFixed(2)}`,{x:500,y:s,size:9,font:u}),s-=15}s-=10;const v=420;a.drawText(`Subtotal (Items): $${c.subtotal.toFixed(2)}`,{x:v,y:s,size:9,font:u}),s-=12,a.drawText(`Tax: $${c.tax.toFixed(2)}`,{x:v,y:s,size:9,font:u}),s-=12,a.drawText(`Fees: $${c.fees.toFixed(2)}`,{x:v,y:s,size:9,font:u}),s-=15,a.drawText(`Grand Total: $${c.total.toFixed(2)}`,{x:v,y:s,size:10,font:o}),s-=30,a.drawText("Individual Checkout Details",{x:50,y:s,size:14,font:o,color:b(0,0,0)}),s-=25,a.drawText("Item Description",{x:50,y:s,size:9,font:o}),a.drawText("User",{x:200,y:s,size:9,font:o}),a.drawText("Cost Code",{x:320,y:s,size:9,font:o}),a.drawText("Unit Price",{x:440,y:s,size:9,font:o}),a.drawText("Total Cost",{x:500,y:s,size:9,font:o}),s-=15;for(const i of l){if(s<100)break;const H=i.inventoryItem.name.length>25?i.inventoryItem.name.substring(0,25)+"...":i.inventoryItem.name,le=(i.userName||i.user||"N/A").length>15?(i.userName||i.user||"N/A").substring(0,15)+"...":i.userName||i.user||"N/A",Ne=i.departmentId||i.costCode||"IT Stock 1-20-000-5770",ne=i.confirmedPrice,J=i.quantity||1,be=taxPerItem*J,je=feePerItem*J,we=ne*J+be+je;a.drawText(H,{x:50,y:s,size:9,font:u}),a.drawText(le,{x:200,y:s,size:9,font:u}),a.drawText(Ne,{x:320,y:s,size:9,font:u}),a.drawText(`$${ne.toFixed(2)}`,{x:440,y:s,size:9,font:u}),a.drawText(`$${we.toFixed(2)}`,{x:500,y:s,size:9,font:u}),s-=15}const j=yield C.save(),T=new Blob([j],{type:"application/pdf"}),I=URL.createObjectURL(T),R=document.createElement("a");R.href=I;const ge=k?`receipt-with-allocation-${k}.pdf`:`receipt-with-allocation-${new Date().toISOString().split("T")[0]}.pdf`;R.download=ge,R.click(),URL.revokeObjectURL(I)}catch(n){throw console.error("Error generating PDF report:",n),n}}),q=h.filter(t=>{var r,l,n;if(!z)return!0;const c=z.toLowerCase();return((r=t.name)==null?void 0:r.toLowerCase().includes(c))||((l=t.category)==null?void 0:l.toLowerCase().includes(c))||((n=t.asin)==null?void 0:n.toLowerCase().includes(c))});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center mb-4",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",children:"receipt_long"}),"Process Receipt"]}),e.jsx("p",{style:{color:"var(--color-text-muted)"},children:"Select items from inventory and process receipts with cost allocation to appropriate billing codes."})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"inventory_2"}),"Select from Inventory (",F.length," selected)"]}),e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search by item name, category, or ASIN...",value:z,onChange:t=>M(t.target.value),className:"w-full px-4 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}}),e.jsx("span",{className:"material-icons absolute right-3 top-2.5",style:{color:"var(--color-text-muted)"},children:"search"})]})}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{style:{background:"var(--md-sys-color-surface-container-high)"},children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Select"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Item"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Category"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Qty"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Price"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium",style:{color:"var(--color-text-light)"},children:"Cost Code"})]})}),e.jsx("tbody",{children:q.slice(0,20).map(t=>{const c=F.some(l=>l.id===t.id),r="IT Stock 1-20-000-5770";return e.jsxs("tr",{className:`border-b border-[var(--md-sys-color-outline-variant)] cursor-pointer hover:bg-[var(--md-sys-color-surface-container-highest)] ${c?"bg-[rgba(59,130,246,0.15)]":""}`,onClick:()=>pe(t),children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"checkbox",checked:c,onChange:()=>{},className:"cursor-pointer"})}),e.jsxs("td",{className:"px-4 py-2 text-sm font-medium",style:{color:"var(--color-text-light)"},children:[t.name,t.asin&&e.jsx("div",{className:"text-xs",style:{color:"var(--color-text-muted)"},children:t.asin})]}),e.jsx("td",{className:"px-4 py-2 text-sm",style:{color:"var(--color-text-muted)"},children:t.category||"Uncategorized"}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"quantity-badge adequate-stock",children:t.quantity||0})}),e.jsx("td",{className:"px-4 py-2 text-sm",style:{color:"var(--color-success-green)"},children:t.price>0?`$${t.price.toFixed(2)}`:"-"}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsx("span",{className:"pill-badge",children:r})})]},t.id)})})]}),q.length===0&&e.jsx("div",{className:"text-center py-8",style:{color:"var(--color-text-muted)"},children:"No inventory items available"}),q.length>20&&e.jsxs("div",{className:"text-center py-2 text-sm",style:{color:"var(--color-text-muted)"},children:["Showing first 20 of ",q.length," items"]})]})]}),w.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"link"}),"Matched Checkout Records (",w.length," items)"]}),e.jsx("div",{className:"space-y-4",children:w.map((t,c)=>e.jsxs("div",{className:"border border-[var(--md-sys-color-outline-variant)] rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-medium",style:{color:"var(--color-text-light)"},children:t.inventoryItem.name}),e.jsxs("span",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:[t.checkoutRecords.length," checkout",t.checkoutRecords.length!==1?"s":""," matched"]})]}),t.checkoutRecords.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h5",{className:"text-sm font-medium mb-2",style:{color:"var(--color-text-light)"},children:"Checkout Details:"}),e.jsx("div",{className:"space-y-1",children:t.checkoutRecords.map((r,l)=>{var n,N;return e.jsxs("div",{className:"text-xs p-2 rounded",style:{background:"var(--md-sys-color-surface-container-high)",color:"var(--color-text-muted)"},children:[r.userName||r.user," • Qty: ",r.quantity," • Dept: ",r.departmentId||r.costCode," • ",new Date(((N=(n=r.dateEntered)==null?void 0:n.toDate)==null?void 0:N.call(n))||r.dateEntered||r.date).toLocaleDateString()]},r.id)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",style:{color:"var(--color-text-light)"},children:"Received Quantity"}),e.jsx("input",{type:"number",min:"1",value:t.confirmedQuantity,onChange:r=>ce(t.inventoryItem.id,"confirmedQuantity",r.target.value),className:"w-full px-3 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",style:{color:"var(--color-text-light)"},children:"Unit Price"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:t.confirmedPrice,onChange:r=>ce(t.inventoryItem.id,"confirmedPrice",r.target.value),className:"w-full px-3 py-2 rounded-lg border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}})]})]}),e.jsxs("div",{className:"mt-3 text-sm",style:{color:"var(--color-text-muted)"},children:["Total: $",(t.confirmedQuantity*t.confirmedPrice).toFixed(2)]})]},t.inventoryItem.id))})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-success-green)"},children:"settings"}),"Shipment Details"]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",style:{color:"var(--color-text-light)"},children:"Upload Receipt PDF (Required)"}),e.jsxs("div",{className:"border-2 border-dashed border-[var(--md-sys-color-outline-variant)] rounded-lg p-6 text-center hover:border-[var(--color-primary-blue)] transition-colors",children:[e.jsx("input",{type:"file",accept:".pdf",onChange:ye,className:"hidden",id:"pdf-upload"}),e.jsxs("label",{htmlFor:"pdf-upload",className:"cursor-pointer",children:[e.jsx("span",{className:"material-icons text-4xl",style:{color:"var(--color-text-muted)"},children:"upload_file"}),e.jsx("p",{className:"mt-2 text-sm",style:{color:"var(--color-text-light)"},children:"Click to upload PDF receipt or drag and drop"}),$&&e.jsxs("p",{className:"mt-2 text-sm font-medium",style:{color:"var(--color-success-green)"},children:["Selected: ",$.name]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(A,{type:"text",label:"Vendor Name",value:G,onChange:t=>K(t.target.value),placeholder:"e.g., Amazon, Staples"}),e.jsx(A,{type:"text",label:"Order Number",value:k,onChange:t=>W(t.target.value),placeholder:"e.g., 114-5534389-2755439"}),e.jsx(A,{type:"date",label:"Receipt Date",value:Y,onChange:t=>Z(t.target.value)}),e.jsx("div",{}),e.jsx(A,{type:"number",label:"Tax Amount",value:ee,onChange:t=>te(t.target.value),step:"0.01",min:"0",placeholder:"0.00",required:!0}),e.jsx(A,{type:"number",label:"Fees (Shipping/Handling)",value:se,onChange:t=>oe(t.target.value),step:"0.01",min:"0",placeholder:"0.00"})]}),e.jsx(ze,{color:"success",className:"w-full mt-6",disabled:S||!$||x.length===0,onClick:fe,children:S?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-icons mr-2",children:"receipt_long"}),"Process Receipt (",w.length," items)"]})})]}),L&&e.jsx("div",{className:`mat-card p-4 ${L.includes("✅")?"success-box":L.includes("⏳")?"info-box":"error-box"}`,children:L}),ae.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",style:{color:"var(--color-primary-blue)"},children:"history"}),"Recent Shipment Processing"]}),e.jsx("div",{className:"space-y-3",children:ae.slice(-5).reverse().map((t,c)=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg",style:{background:"var(--md-sys-color-surface-container-high)"},children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"material-icons",style:{color:"var(--color-success-green)"},children:"check_circle"}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",style:{color:"var(--color-text-light)"},children:["Order ",t.orderNumber]}),e.jsxs("p",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:[t.itemsProcessed," items • $",t.totalAmount.toFixed(2)," • ",t.vendor]})]})]}),e.jsx("div",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:new Date(t.timestamp).toLocaleDateString()})]},c))})]})]})};export{Ue as default};
