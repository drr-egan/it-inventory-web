var pe=Object.defineProperty,ue=Object.defineProperties;var fe=Object.getOwnPropertyDescriptors;var q=Object.getOwnPropertySymbols;var ge=Object.prototype.hasOwnProperty,ye=Object.prototype.propertyIsEnumerable;var H=(h,i,r)=>i in h?pe(h,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):h[i]=r,E=(h,i)=>{for(var r in i||(i={}))ge.call(i,r)&&H(h,r,i[r]);if(q)for(var r of q(i))ye.call(i,r)&&H(h,r,i[r]);return h},z=(h,i)=>ue(h,fe(i));var N=(h,i,r)=>new Promise((C,F)=>{var k=p=>{try{g(r.next(p))}catch(m){F(m)}},P=p=>{try{g(r.throw(p))}catch(m){F(m)}},g=p=>p.done?C(p.value):Promise.resolve(p.value).then(k,P);g((r=r.apply(h,i)).next())});import{j as e,d as Q}from"./index-2b42a54e.js";import{r as v}from"./react-vendor-3371026b.js";import{j as be,d as ve,T as je,k as we,h as Ne}from"./firebase-vendor-fdbb15af.js";import{M as A}from"./MaterialButton-e621bad7.js";const ke=({checkoutHistory:h,user:i})=>{const[r,C]=v.useState(null),[F,k]=v.useState(null),[P,g]=v.useState(!1),[p,m]=v.useState(""),[y,R]=v.useState([]),[L,U]=v.useState({}),[_,W]=v.useState(0),[T,J]=v.useState(0),[D,K]=v.useState(0),[Pe,B]=v.useState(""),M=t=>{if(!t)return"";t.toString().replace(/-/g,"");const a=t.split("-");if(a.length>=3){const o=a[0],n=a[1];let c=a[2];return c.length===4?c=c.substring(0,3):c.length===2&&(c=c+"0"),`${o}-${n}-${c}-5770`}return t},V=t=>N(void 0,null,function*(){const a=t.target.files[0];if(a){C(a),m('📄 PDF selected. Click "Process Shipment" to continue.'),R([]),B("");try{const o=window.pdfjsLib,n=new FileReader;n.onload=function(){return N(this,null,function*(){const c=new Uint8Array(this.result),d=yield(yield o.getDocument(c).promise).getPage(1),u=1.5,b=d.getViewport({scale:u}),w=document.createElement("canvas"),s=w.getContext("2d");w.height=b.height,w.width=b.width,yield d.render({canvasContext:s,viewport:b}).promise,k(w.toDataURL())})},n.readAsArrayBuffer(a)}catch(o){console.error("Error generating preview:",o)}}}),X=t=>N(void 0,null,function*(){const a=window.pdfjsLib,o=new FileReader;return new Promise((n,c)=>{o.onload=function(){return N(this,null,function*(){try{const l=new Uint8Array(this.result),d=yield a.getDocument(l).promise;let u="";for(let b=1;b<=d.numPages;b++){const G=(yield(yield d.getPage(b)).getTextContent()).items.map($=>$.str).join(" ");u+=G+`
`}n(u)}catch(l){c(l)}})},o.onerror=c,o.readAsArrayBuffer(t)})}),Y=t=>{let a=t.match(/subtotal[:\s]*\$?(\d+\.?\d*)/i),o=t.match(/tax[:\s]*\$?(\d+\.?\d*)/i),n=t.match(/fee[s]?[:\s]*\$?(\d+\.?\d*)/i)||t.match(/shipping[:\s]*\$?(\d+\.?\d*)/i);return{subtotal:a?parseFloat(a[1]):0,tax:o?parseFloat(o[1]):0,fees:n?parseFloat(n[1]):0}},Z=()=>N(void 0,null,function*(){if(!r){m("❌ Please select a PDF file first");return}g(!0),m("⏳ Processing PDF and matching items...");try{const t=yield X(r);B(t);const a=Y(t);W(a.subtotal),J(a.tax),K(a.fees);const o=[],n={};for(const c of h){const l=c.itemName.toLowerCase();if(t.toLowerCase().includes(l)){o.push(c);const d=new RegExp(l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"[^\\d]*(\\d+\\.\\d{2})","i"),u=t.match(d);u?n[c.id]=parseFloat(u[1]):n[c.id]=0}}if(o.length===0){m("⚠️ No matching items found in PDF. Items from checkout history must appear in the receipt."),R([]),g(!1);return}R(o),U(n),m(`✅ Found ${o.length} matching item(s). Review and click "Generate Report" to continue.`),g(!1)}catch(t){console.error("Error processing PDF:",t),m(`❌ Error: ${t.message}`),g(!1)}}),ee=(t,a)=>{U(o=>z(E({},o),{[t]:parseFloat(a)||0}))},te=()=>N(void 0,null,function*(){if(y.length===0){m("❌ No matched items to generate report");return}g(!0),m("⏳ Generating cost allocation report...");try{const t=window.PDFLib,{PDFDocument:a,rgb:o,StandardFonts:n}=t,c=yield a.create(),l=c.addPage([612,792]),d=yield c.embedFont(n.Helvetica),u=yield c.embedFont(n.HelveticaBold),{width:b,height:w}=l.getSize();let s=w-50;l.drawText("SHIPMENT COST ALLOCATION REPORT",{x:50,y:s,size:16,font:u,color:o(.12,.23,.54)}),s-=30,l.drawText(`Generated: ${new Date().toLocaleString()}`,{x:50,y:s,size:10,font:d,color:o(.5,.5,.5)}),s-=30;const G=y.reduce((x,j)=>x+(j.quantity||0),0),$=y.reduce((x,j)=>x+(L[j.id]||0)*(j.quantity||0),0),ae=T/y.length,oe=D/y.length;l.drawText("Cost Allocation Summary",{x:50,y:s,size:12,font:u}),s-=20;const re=["Item Description","Qty","Job/Cost Code","Unit Price","Total Cost"],S=[200,40,120,80,80];let f=50;re.forEach((x,j)=>{l.drawText(x,{x:f,y:s,size:9,font:u}),f+=S[j]}),s-=15,l.drawLine({start:{x:50,y:s},end:{x:b-50,y:s},thickness:1,color:o(.8,.8,.8)}),s-=15;for(const x of y){const j=L[x.id]||0,ne=ae,de=oe,me=j*(x.quantity||0)+ne+de,xe=x.jobNum||M(x.departmentId);f=50;const he=x.itemName.substring(0,30);l.drawText(he,{x:f,y:s,size:8,font:d}),f+=S[0],l.drawText(String(x.quantity||0),{x:f,y:s,size:8,font:d}),f+=S[1],l.drawText(xe||"-",{x:f,y:s,size:8,font:d}),f+=S[2],l.drawText(`$${j.toFixed(2)}`,{x:f,y:s,size:8,font:d}),f+=S[3],l.drawText(`$${me.toFixed(2)}`,{x:f,y:s,size:8,font:d}),s-=20,s<100&&(s=w-50)}s-=10,l.drawLine({start:{x:50,y:s},end:{x:b-50,y:s},thickness:1,color:o(.8,.8,.8)}),s-=20,l.drawText("Financial Breakdown",{x:50,y:s,size:10,font:u}),s-=15;const ce=$+T+D;[`Items Subtotal: $${$.toFixed(2)}`,`Tax (distributed): $${T.toFixed(2)}`,`Fees (distributed): $${D.toFixed(2)}`,`Grand Total: $${ce.toFixed(2)}`].forEach(x=>{l.drawText(x,{x:50,y:s,size:9,font:d}),s-=15});const le=yield c.save(),ie=new Blob([le],{type:"application/pdf"}),O=URL.createObjectURL(ie),I=document.createElement("a");I.href=O,I.download=`shipment-allocation-${new Date().toISOString().split("T")[0]}.pdf`,I.click(),URL.revokeObjectURL(O),yield se(),m("✅ Report generated and items archived successfully!"),g(!1)}catch(t){console.error("Error generating report:",t),m(`❌ Error generating report: ${t.message}`),g(!1)}}),se=()=>N(void 0,null,function*(){for(const t of y)try{yield be(ve(Q,"archivedCheckouts"),z(E({},t),{archivedAt:je.now(),processedBy:(i==null?void 0:i.email)||"unknown",shipmentDate:new Date().toISOString()})),yield we(Ne(Q,"checkoutHistory",t.id))}catch(a){console.error("Error archiving item:",a)}});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center mb-4",style:{color:"var(--color-text-light)"},children:[e.jsx("span",{className:"material-icons mr-2",children:"local_shipping"}),"Process Shipment"]}),e.jsx("p",{style:{color:"var(--color-text-muted)"},children:"Upload PDF receipt to match against checkout history and generate cost allocation report."})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",style:{color:"var(--color-text-light)"},children:"Step 1: Upload PDF Receipt"}),e.jsxs("div",{className:"flex gap-4 mb-4",children:[e.jsx("input",{id:"pdf-upload",type:"file",accept:".pdf",onChange:V,className:"hidden"}),e.jsx("label",{htmlFor:"pdf-upload",children:e.jsxs(A,{variant:"outlined",onClick:()=>document.getElementById("pdf-upload").click(),children:[e.jsx("span",{className:"material-icons",children:"upload_file"}),"Select PDF Receipt"]})}),r&&e.jsxs(A,{color:"primary",onClick:Z,disabled:P,children:[e.jsx("span",{className:"material-icons",children:"search"}),P?"Processing...":"Process Shipment"]})]}),r&&e.jsxs("div",{className:"info-box",children:[e.jsx("strong",{children:"Selected:"})," ",r.name," (",(r.size/1024).toFixed(2)," KB)"]}),p&&e.jsx("div",{className:`mt-4 p-3 rounded-lg ${p.includes("✅")?"success-box":p.includes("⏳")?"info-box":p.includes("⚠️")?"warning-box":"error-box"}`,children:p})]}),F&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",style:{color:"var(--color-text-light)"},children:"PDF Preview (Page 1)"}),e.jsx("div",{className:"border border-[var(--md-sys-color-outline-variant)] rounded-lg overflow-hidden",children:e.jsx("img",{src:F,alt:"PDF Preview",className:"max-w-full h-auto"})})]}),y.length>0&&e.jsxs("div",{className:"mat-card p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4",style:{color:"var(--color-text-light)"},children:["Step 2: Review Matched Items (",y.length,")"]}),e.jsx("div",{className:"overflow-x-auto mb-4",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-[var(--md-sys-color-outline-variant)]",children:[e.jsx("th",{className:"text-left p-3",style:{color:"var(--color-text-light)"},children:"Item"}),e.jsx("th",{className:"text-left p-3",style:{color:"var(--color-text-light)"},children:"User"}),e.jsx("th",{className:"text-left p-3",style:{color:"var(--color-text-light)"},children:"Qty"}),e.jsx("th",{className:"text-left p-3",style:{color:"var(--color-text-light)"},children:"Cost Code"}),e.jsx("th",{className:"text-left p-3",style:{color:"var(--color-text-light)"},children:"Unit Price"})]})}),e.jsx("tbody",{children:y.map(t=>e.jsxs("tr",{className:"border-b border-[var(--md-sys-color-outline-variant)]",children:[e.jsx("td",{className:"p-3",style:{color:"var(--color-text-light)"},children:t.itemName}),e.jsx("td",{className:"p-3",style:{color:"var(--color-text-muted)"},children:t.userName}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:"quantity-badge adequate-stock",children:t.quantity})}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:"pill-badge",children:t.jobNum||M(t.departmentId)})}),e.jsx("td",{className:"p-3",children:e.jsx("input",{type:"number",step:"0.01",value:L[t.id]||0,onChange:a=>ee(t.id,a.target.value),className:"w-24 px-2 py-1 rounded border border-[var(--md-sys-color-outline-variant)]",style:{background:"var(--md-sys-color-surface)",color:"var(--color-text-light)"}})})]},t.id))})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{className:"info-box",children:[e.jsx("div",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:"Subtotal (from PDF)"}),e.jsxs("div",{className:"text-xl font-bold",style:{color:"var(--color-text-light)"},children:["$",_.toFixed(2)]})]}),e.jsxs("div",{className:"info-box",children:[e.jsx("div",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:"Tax (from PDF)"}),e.jsxs("div",{className:"text-xl font-bold",style:{color:"var(--color-text-light)"},children:["$",T.toFixed(2)]})]}),e.jsxs("div",{className:"info-box",children:[e.jsx("div",{className:"text-sm",style:{color:"var(--color-text-muted)"},children:"Fees (from PDF)"}),e.jsxs("div",{className:"text-xl font-bold",style:{color:"var(--color-text-light)"},children:["$",D.toFixed(2)]})]})]}),e.jsxs("div",{className:"warning-box mb-4",children:[e.jsx("strong",{children:"Note:"})," Tax and fees will be distributed evenly across all items in the cost allocation report."]}),e.jsxs(A,{color:"primary",onClick:te,disabled:P,children:[e.jsx("span",{className:"material-icons",children:"receipt_long"}),P?"Generating...":"Generate Cost Allocation Report"]})]}),e.jsxs("div",{className:"mat-card p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",style:{color:"var(--color-text-light)"},children:"How It Works"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-2",style:{color:"var(--color-text-muted)"},children:[e.jsx("li",{children:"Upload a PDF receipt from your shipment"}),e.jsx("li",{children:"System extracts text and searches for items from active checkout history"}),e.jsx("li",{children:"Review matched items and adjust prices if needed"}),e.jsx("li",{children:"Generate cost allocation report with department IDs formatted as x-xx-xxx-5770"}),e.jsx("li",{children:"Processed items are automatically archived to maintain clean checkout history"})]})]})]})};export{ke as default};
