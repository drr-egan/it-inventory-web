var N=(r,y,c)=>new Promise((x,m)=>{var u=s=>{try{i(c.next(s))}catch(d){m(d)}},g=s=>{try{i(c.throw(s))}catch(d){m(d)}},i=s=>s.done?x(s.value):Promise.resolve(s.value).then(u,g);i((c=c.apply(r,y)).next())});import{j as e,d as k}from"./index-f1da842b.js";import{r as o}from"./react-vendor-3371026b.js";import{h as Q,r as J,f as U,d as M}from"./firebase-vendor-fdbb15af.js";const R=({cart:r,addToCart:y,removeFromCart:c,clearCart:x,users:m,onCheckout:u})=>{const[g,i]=o.useState(!1),[s,d]=o.useState("user"),[h,v]=o.useState(""),[b,w]=o.useState(""),[C,S]=o.useState(""),[p,_]=o.useState(""),$=r.reduce((t,a)=>t+(a.price||0)*a.cartQuantity,0),f=t=>{if(!t)return"";const a=t.toString().split("-");if(a.length>=3){const l=a[2],n=l.length===3?l:l.padStart(3,"0").substring(0,3);return`${a[0]}-${a[1]}-${n}-5770`}return t},j=m.filter(t=>{if(!p)return!0;const a=p.toLowerCase(),l=t.name||`${t.firstName} ${t.lastName}`,n=f(t.costCode||t.cost_code);return l.toLowerCase().includes(a)||n.toLowerCase().includes(a)}),q=()=>N(void 0,null,function*(){if(r.length!==0){if(s==="user"&&!h){alert("Please select a user for checkout");return}if(s==="job"&&!b.trim()){alert("Please enter a job number");return}i(!0);try{const t=m.find(a=>a.id===h);for(const a of r){const l=Q(k,"items",a.id);yield J(k,n=>N(void 0,null,function*(){const T=(yield n.get(l)).data().quantity||0,F=Math.max(0,T-a.cartQuantity);n.update(l,{quantity:F,lastUpdated:U()});const I=Q(M(k,"checkoutHistory"));n.set(I,{itemId:a.id,itemName:a.name,userId:s==="user"?h:"",userName:s==="user"?(t==null?void 0:t.name)||`${t==null?void 0:t.firstName} ${t==null?void 0:t.lastName}`:"Job Checkout",quantity:a.cartQuantity,departmentId:s==="user"?f((t==null?void 0:t.costCode)||(t==null?void 0:t.cost_code)):b,jobNumber:s==="job"?b:"",notes:C,status:"active",dateEntered:U(),createdBy:"system"})}))}x(),v(""),w(""),S(""),alert(`Checkout completed! ${r.length} items processed.`),u&&u()}catch(t){console.error("Checkout error:",t),alert(`Checkout failed: ${t.message}`)}finally{i(!1)}}});return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 sticky top-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"material-icons text-xl mr-2 text-blue-600",children:"shopping_cart"}),e.jsx("h3",{className:"text-lg font-medium dark:text-white",children:"Shopping Cart"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[r.length>0&&e.jsxs("div",{className:"bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full text-sm font-medium",children:[r.length," items"]}),$>0&&e.jsxs("div",{className:"bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-3 py-1 rounded-full text-sm font-medium",children:["$",$.toFixed(2)]})]})]}),r.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-500 dark:text-gray-400",children:[e.jsx("span",{className:"material-icons text-6xl mb-4 opacity-50",children:"shopping_cart"}),e.jsx("p",{className:"font-medium",children:"Your cart is empty"}),e.jsx("p",{className:"text-sm",children:"Add items to get started"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"space-y-3 max-h-60 overflow-y-auto",children:r.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white truncate",children:t.name}),e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:["Qty: ",t.cartQuantity,t.price>0&&e.jsxs("span",{className:"ml-2 text-green-600 dark:text-green-400 font-medium",children:["$",(t.price*t.cartQuantity).toFixed(2)]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-3",children:[e.jsx("button",{onClick:()=>y(t,1),className:"p-2 min-w-0 w-8 h-8 bg-blue-500 hover:bg-blue-600 text-white rounded transition-all flex items-center justify-center",children:e.jsx("span",{className:"material-icons text-sm",children:"add"})}),e.jsx("button",{onClick:()=>c(t.id),className:"p-2 min-w-0 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded transition-all flex items-center justify-center",children:e.jsx("span",{className:"material-icons text-sm",children:"remove"})})]})]},t.id))}),e.jsxs("div",{className:"border-t dark:border-gray-600 pt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3",children:"Checkout Method"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",value:"user",checked:s==="user",onChange:t=>d(t.target.value),className:"mr-2 text-blue-600"}),e.jsx("span",{className:"material-icons mr-1 text-sm",children:"person"}),e.jsx("span",{className:"text-sm dark:text-gray-300",children:"User Checkout"})]}),e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",value:"job",checked:s==="job",onChange:t=>d(t.target.value),className:"mr-2 text-blue-600"}),e.jsx("span",{className:"material-icons mr-1 text-sm",children:"work"}),e.jsx("span",{className:"text-sm dark:text-gray-300",children:"Job Checkout"})]})]})]}),s==="user"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Select User"}),e.jsxs("div",{className:"relative mb-2",children:[e.jsx("span",{className:"material-icons absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm",children:"search"}),e.jsx("input",{type:"text",placeholder:"Search by name or cost code...",value:p,onChange:t=>_(t.target.value),className:"w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("select",{value:h,onChange:t=>v(t.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"Choose a user..."}),j.slice(0,200).map(t=>e.jsxs("option",{value:t.id,children:[t.name||`${t.firstName} ${t.lastName}`," - ",f(t.costCode||t.cost_code)]},t.id))]}),p&&e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:[j.length," user",j.length!==1?"s":""," found"]})]}),s==="job"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Job Number"}),e.jsx("input",{type:"text",value:b,onChange:t=>w(t.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Notes (Optional)"}),e.jsx("textarea",{value:C,onChange:t=>S(t.target.value),rows:2,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:q,disabled:g,className:"flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg font-medium transition-all flex items-center justify-center",children:g?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-icons mr-2",children:"check_circle"}),"Checkout"]})}),e.jsx("button",{onClick:x,className:"px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all",children:e.jsx("span",{className:"material-icons",children:"clear"})})]})]})]})]})};export{R as default};
