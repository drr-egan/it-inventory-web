<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Inventory Management - Firebase Material - UPDATED</title>
    <!-- GitHub Pages Deploy: 2025-09-18 - ITEMS FIXED -->

    <!-- External CSS Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Material Design CSS (after Tailwind to override) -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PDF Processing Libraries -->
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <!-- PDF.js Configuration -->
    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
    </script>

    <!-- Firebase Configuration (Embedded for GitHub Pages) -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCBOBb7mJPoI7cwubp12xnmjglLkuWYWYI",
            authDomain: "it-inventory-eaebc.firebaseapp.com",
            projectId: "it-inventory-eaebc",
            storageBucket: "it-inventory-eaebc.firebasestorage.app",
            messagingSenderId: "1081021280207",
            appId: "1:1081021280207:web:9619a96bff1692493aecba"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Initialize Google Auth Provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.addScope('email');
        googleProvider.addScope('profile');

        // Enable offline persistence
        db.enablePersistence({synchronizeTabs: true}).catch((err) => {
            console.warn('Firestore persistence not available:', err.code);
        });
    </script>

    <style>
        /* Material You Design System */
        :root {
            /* Material You Elevation Tokens */
            --md-elevation-1: 0px 1px 3px 1px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
            --md-elevation-2: 0px 2px 6px 2px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
            --md-elevation-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px 0px rgba(0, 0, 0, 0.3);
            --md-elevation-4: 0px 6px 10px 4px rgba(0, 0, 0, 0.15), 0px 2px 3px 0px rgba(0, 0, 0, 0.3);
            --md-elevation-5: 0px 8px 12px 6px rgba(0, 0, 0, 0.15), 0px 4px 4px 0px rgba(0, 0, 0, 0.3);

            /* Material You Shape Tokens */
            --md-sys-shape-corner-none: 0px;
            --md-sys-shape-corner-extra-small: 4px;
            --md-sys-shape-corner-small: 8px;
            --md-sys-shape-corner-medium: 12px;
            --md-sys-shape-corner-large: 16px;
            --md-sys-shape-corner-extra-large: 28px;
            --md-sys-shape-corner-full: 1000px;

            /* Material You Typography Scale */
            --md-sys-typescale-display-large: 400 57px/64px 'Roboto', sans-serif;
            --md-sys-typescale-headline-large: 400 32px/40px 'Roboto', sans-serif;
            --md-sys-typescale-headline-medium: 400 28px/36px 'Roboto', sans-serif;
            --md-sys-typescale-title-large: 400 22px/28px 'Roboto', sans-serif;
            --md-sys-typescale-title-medium: 500 16px/24px 'Roboto', sans-serif;
            --md-sys-typescale-body-large: 400 16px/24px 'Roboto', sans-serif;
            --md-sys-typescale-body-medium: 400 14px/20px 'Roboto', sans-serif;
            --md-sys-typescale-label-large: 500 14px/20px 'Roboto', sans-serif;
            --md-sys-typescale-label-medium: 500 12px/16px 'Roboto', sans-serif;

            /* Material You Color System */
            --md-sys-color-primary: #1976d2;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #d7eaff;
            --md-sys-color-on-primary-container: #001c38;

            --md-sys-color-secondary: #535f70;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #d7e3f7;
            --md-sys-color-on-secondary-container: #101c2b;

            --md-sys-color-tertiary: #6b5778;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #f2daff;
            --md-sys-color-on-tertiary-container: #251431;

            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #ffdad6;
            --md-sys-color-on-error-container: #410002;

            --md-sys-color-surface: #fefbff;
            --md-sys-color-on-surface: #1a1c1e;
            --md-sys-color-surface-variant: #dfe2eb;
            --md-sys-color-on-surface-variant: #43474e;

            --md-sys-color-surface-container-lowest: #ffffff;
            --md-sys-color-surface-container-low: #f4f0f7;
            --md-sys-color-surface-container: #eee8f5;
            --md-sys-color-surface-container-high: #e8e1ee;
            --md-sys-color-surface-container-highest: #e2dbe8;

            --md-sys-color-outline: #73777f;
            --md-sys-color-outline-variant: #c3c7cf;

            --md-sys-color-success: #006d35;
            --md-sys-color-on-success: #ffffff;
            --md-sys-color-success-container: #94f7ad;
            --md-sys-color-on-success-container: #00210a;
        }

        /* Material You Base Styles */
        * {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Material You Global Styles */
        body {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
            padding: 0;
        }

        /* Material You Elevation System */
        .md-elevation-1 { box-shadow: var(--md-elevation-1); }
        .md-elevation-2 { box-shadow: var(--md-elevation-2); }
        .md-elevation-3 { box-shadow: var(--md-elevation-3); }
        .md-elevation-4 { box-shadow: var(--md-elevation-4); }
        .md-elevation-5 { box-shadow: var(--md-elevation-5); }

        /* Material You Navigation Components */
        .md-navigation-bar {
            transition: background-color 0.3s ease;
        }

        .md-navigation-tab {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 16px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--md-sys-shape-corner-small);
            font: var(--md-sys-typescale-label-large);
            min-height: 48px;
        }

        .md-navigation-tab:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-on-surface) 8%, transparent);
        }

        .md-navigation-tab .material-icons {
            font-size: 20px;
        }

        /* Material You Badges */
        .md-badge {
            border-radius: var(--md-sys-shape-corner-full);
            padding: 2px 8px;
            font-size: 12px;
            font-weight: 500;
            min-width: 16px;
            text-align: center;
            line-height: 1;
        }

        /* Material You Theme Toggle */
        .md-theme-toggle {
            background-color: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-full);
            padding: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .md-theme-toggle:hover {
            background-color: var(--md-sys-color-surface-container-high);
            transform: scale(1.05);
        }

        /* Material You Status Indicator */
        .md-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 16px;
            background-color: var(--md-sys-color-success-container);
            color: var(--md-sys-color-on-surface-variant);
            border-radius: var(--md-sys-shape-corner-full);
            font-size: 12px;
            font-weight: 500;
        }

        .md-status-dot {
            width: 8px;
            height: 8px;
            background-color: var(--md-sys-color-success);
            border-radius: 50%;
            animation: md-pulse 2s ease-in-out infinite;
        }

        @keyframes md-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.95); }
        }

        /* Material You Modal/Popup */
        .md-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
            animation: md-fade-in 0.3s ease;
        }

        .md-modal {
            background-color: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-extra-large);
            box-shadow: var(--md-elevation-5);
            max-width: 560px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: md-scale-in 0.3s ease;
        }

        .md-modal-header {
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .md-modal-title {
            font: var(--md-sys-typescale-headline-medium);
            color: var(--md-sys-color-on-surface);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .md-modal-body {
            padding: 16px 24px;
        }

        .md-modal-actions {
            padding: 16px 24px 24px 24px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            flex-wrap: wrap;
        }

        .md-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: transparent;
            border: none;
            padding: 8px;
            border-radius: var(--md-sys-shape-corner-full);
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            transition: all 0.2s ease;
        }

        .md-modal-close:hover {
            background-color: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface);
        }

        .md-button {
            padding: 10px 24px;
            border-radius: var(--md-sys-shape-corner-full);
            border: none;
            font: var(--md-sys-typescale-label-large);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 40px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .md-button.primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .md-button.primary:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 92%, black);
            box-shadow: var(--md-elevation-1);
        }

        .md-button.secondary {
            background-color: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface);
            border: 1px solid var(--md-sys-color-outline);
        }

        .md-button.secondary:hover {
            background-color: var(--md-sys-color-surface-container-high);
        }

        .md-button.error {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-error);
        }

        .md-button.error:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-error-container) 92%, var(--md-sys-color-error));
        }

        .md-low-stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: var(--md-sys-color-warning-container);
            border-radius: var(--md-sys-shape-corner-small);
            margin: 8px 0;
        }

        .md-low-stock-item-name {
            font: var(--md-sys-typescale-body-medium);
            color: var(--md-sys-color-on-surface);
            font-weight: 500;
        }

        .md-low-stock-item-quantity {
            font: var(--md-sys-typescale-body-medium);
            color: var(--md-sys-color-warning);
            font-weight: 600;
        }

        @keyframes md-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes md-scale-in {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Material Design Ripple Effect */
        .mat-ripple {
            position: relative;
            overflow: hidden;
            transform: translate3d(0, 0, 0);
        }

        .mat-ripple:before {
            content: "";
            display: block;
            position: absolute;
            left: 50%;
            top: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transition: width 0.6s, height 0.6s, left 0.6s, top 0.6s;
            transform: translate(-50%, -50%);
        }

        .mat-ripple:active:before {
            width: 300px;
            height: 300px;
        }

        /* Material Design Input Fields */
        .mat-input {
            position: relative;
        }

        .mat-input input, .mat-input select, .mat-input textarea {
            width: 100%;
            padding: 16px 12px 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: transparent;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .mat-input input:focus, .mat-input select:focus, .mat-input textarea:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }

        .mat-input label {
            position: absolute;
            left: 12px;
            top: 16px;
            color: #757575;
            font-size: 16px;
            transition: all 0.2s ease;
            pointer-events: none;
            background: white;
            padding: 0 4px;
        }

        .mat-input input:focus + label,
        .mat-input input:not(:placeholder-shown) + label,
        .mat-input select:focus + label,
        .mat-input textarea:focus + label,
        .mat-input textarea:not(:placeholder-shown) + label {
            top: -6px;
            font-size: 12px;
            color: #1976d2;
        }

        /* Material Design FAB */
        .mat-fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .mat-fab:hover {
            transform: scale(1.1);
        }

        /* Material Design Tabs */
        .mat-tab-nav {
            border-bottom: 1px solid #e0e0e0;
        }

        .mat-tab {
            position: relative;
            padding: 16px 24px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }

        .mat-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #1976d2;
            transition: all 0.2s ease;
        }

        /* Material Design Cards */
        .mat-card {
            border-radius: 4px;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .mat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0px 3px 5px -1px rgba(0,0,0,0.2), 0px 6px 10px 0px rgba(0,0,0,0.14), 0px 1px 18px 0px rgba(0,0,0,0.12);
        }

        /* Material Design Elevation Classes */
        .mat-elevation-0 { box-shadow: none; }
        .mat-elevation-1 { box-shadow: var(--md-elevation-1); }
        .mat-elevation-2 { box-shadow: var(--md-elevation-2); }
        .mat-elevation-3 { box-shadow: var(--md-elevation-3); }
        .mat-elevation-4 { box-shadow: var(--md-elevation-4); }
        .mat-elevation-5 { box-shadow: var(--md-elevation-5); }

        /* Material Design Snackbar */
        .mat-snackbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: #323232;
            color: white;
            padding: 14px 24px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Enhanced Dark Mode Material Design */
        .dark .mat-card {
            background: #1f2937;
            border: 1px solid #374151;
        }
        .dark .mat-input input,
        .dark .mat-input select,
        .dark .mat-input textarea {
            background: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        .dark .mat-input input:focus,
        .dark .mat-input select:focus,
        .dark .mat-input textarea:focus {
            background: #374151;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .dark .mat-input label {
            background: #1f2937;
            color: #9ca3af;
        }
        .dark .mat-input input:focus + label,
        .dark .mat-input input:not(:placeholder-shown) + label,
        .dark .mat-input select:focus + label,
        .dark .mat-input textarea:focus + label,
        .dark .mat-input textarea:not(:placeholder-shown) + label {
            color: #3b82f6;
            background: #1f2937;
        }
        .dark .mat-tab-nav { border-bottom-color: #4b5563; }

        /* Dark mode enhancements */
        .dark body { background: #111827; }
        .dark .mat-snackbar {
            background: #374151;
            border: 1px solid #4b5563;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .mat-tab {
                padding: 12px 16px;
                font-size: 14px;
            }
            .mat-card {
                border-radius: 8px;
            }
            .mat-input input,
            .mat-input select,
            .mat-input textarea {
                padding: 14px 10px 6px 10px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        /* Enhanced mobile optimizations for barcode scanner */
        @media (max-width: 768px) {
            /* Large touch targets for mobile */
            .mat-button {
                min-height: 44px;
                padding: 12px 24px;
                font-size: 16px;
            }

            /* Camera video full-width on mobile */
            video {
                width: 100% !important;
                height: auto !important;
                max-height: 60vh;
            }

            /* Prevent zoom when focusing inputs */
            input[type="text"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px !important;
            }

            /* Scanner feedback messages larger on mobile */
            .scanner-feedback {
                font-size: 16px;
                padding: 16px;
                text-align: center;
            }

            /* Scan history optimized for mobile */
            .scan-history-item {
                padding: 12px;
                font-size: 14px;
            }
        }

        /* Touch-specific optimizations */
        @media (pointer: coarse) {
            /* Larger touch targets for touch devices */
            .mat-button,
            button {
                min-height: 48px;
                min-width: 48px;
                padding: 12px 16px;
            }

            /* Increase spacing for better touch targets */
            .space-x-2 > * + * {
                margin-left: 12px;
            }

            .space-y-2 > * + * {
                margin-top: 12px;
            }
        }

        /* Mobile scanner specific styles */
        .mobile-scanner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Camera focus frame animation */
        @keyframes scanner-pulse {
            0% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
            100% { opacity: 0.6; transform: scale(1); }
        }

        .scanner-frame {
            animation: scanner-pulse 2s infinite;
        }

        /* Vibration and feedback animations */
        @keyframes scan-success {
            0% { background-color: rgba(34, 197, 94, 0.1); }
            50% { background-color: rgba(34, 197, 94, 0.3); }
            100% { background-color: rgba(34, 197, 94, 0.1); }
        }

        @keyframes scan-error {
            0% { background-color: rgba(239, 68, 68, 0.1); }
            50% { background-color: rgba(239, 68, 68, 0.3); }
            100% { background-color: rgba(239, 68, 68, 0.1); }
        }

        .scan-success-animation {
            animation: scan-success 0.5s ease-in-out;
        }

        .scan-error-animation {
            animation: scan-error 0.5s ease-in-out;
        }

        /* PWA-specific optimizations */
        @media (display-mode: standalone) {
            /* App is running as PWA */
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }

            /* Account for notches and safe areas */
            .mat-card {
                margin-left: env(safe-area-inset-left);
                margin-right: env(safe-area-inset-right);
            }
        }

        /* Edit mode specific styles */
        .edit-mode-row {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(37, 99, 235, 0.1));
            border-left: 4px solid #3b82f6;
        }

        .edit-mode-row .mat-input {
            margin-bottom: 8px;
        }

        .edit-mode-row .mat-input input {
            font-size: 14px;
            padding: 8px 12px 4px 12px;
        }

        /* Mobile-specific edit styles */
        @media (max-width: 768px) {
            /* Larger edit buttons on mobile */
            .edit-action-buttons .mat-button {
                min-width: 40px;
                min-height: 40px;
                padding: 8px;
            }

            /* Better input sizing on mobile */
            .edit-mode-row .mat-input input {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 12px 8px 6px 8px;
            }

            /* Responsive table columns for edit mode */
            .edit-mode-row td {
                vertical-align: top;
                padding: 8px 4px;
            }

            /* Stack edit buttons vertically on very small screens */
            @media (max-width: 480px) {
                .edit-action-buttons {
                    flex-direction: column;
                    gap: 4px;
                }

                .edit-action-buttons .mat-button {
                    width: 100%;
                    min-width: auto;
                }
            }
        }

        /* Edit form validation styles */
        .edit-form-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
        }

        .edit-form-success {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2) !important;
        }

        /* Edit mode animations */
        .edit-mode-transition {
            transition: all 0.3s ease-in-out;
        }

        .edit-row-highlight {
            animation: edit-highlight 0.5s ease-in-out;
        }

        @keyframes edit-highlight {
            0% { background-color: rgba(59, 130, 246, 0.1); }
            50% { background-color: rgba(59, 130, 246, 0.2); }
            100% { background-color: rgba(59, 130, 246, 0.1); }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Loading animations */
        .mat-spinner {
            animation: mat-spinner-rotate 2s linear infinite;
        }

        @keyframes mat-spinner-rotate {
            0% { transform: rotate(0); }
            100% { transform: rotate(360deg); }
        }

        /* Material Design progress bar */
        .mat-progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .mat-progress-bar-fill {
            height: 100%;
            background: #1976d2;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Utility function for formatting department IDs
        const formatDepartmentId = (deptId) => {
            if (!deptId) return '';
            const parts = deptId.split('-');
            if (parts.length >= 3) {
                const [first, second, third, ...rest] = parts;
                const formattedThird = third.padStart(3, '0');
                return `${first}-${second}-${formattedThird}-5770`;
            }
            return deptId;
        };

        // Material Design Hook for Snackbar
        const useSnackbar = () => {
            const [snackbar, setSnackbar] = useState(null);

            const showSnackbar = (message, type = 'info', duration = 4000) => {
                setSnackbar({ message, type });
                setTimeout(() => setSnackbar(null), duration);
            };

            return { snackbar, showSnackbar };
        };

        // Material You Theme System
        const useTheme = () => {
            const [isDarkMode, setIsDarkMode] = useState(() => {
                const saved = localStorage.getItem('materialYouTheme');
                return saved ? JSON.parse(saved) : false;
            });

            useEffect(() => {
                localStorage.setItem('materialYouTheme', JSON.stringify(isDarkMode));

                // Apply Material You color tokens
                const root = document.documentElement;

                if (isDarkMode) {
                    // Material You Dark Theme
                    root.classList.add('dark');
                    root.style.setProperty('--md-sys-color-primary', '#A6C8FF');
                    root.style.setProperty('--md-sys-color-on-primary', '#002E69');
                    root.style.setProperty('--md-sys-color-primary-container', '#004494');
                    root.style.setProperty('--md-sys-color-on-primary-container', '#D1E4FF');
                    root.style.setProperty('--md-sys-color-surface', '#101418');
                    root.style.setProperty('--md-sys-color-on-surface', '#E1E2E8');
                    root.style.setProperty('--md-sys-color-surface-variant', '#42474E');
                    root.style.setProperty('--md-sys-color-on-surface-variant', '#C2C7CF');
                    root.style.setProperty('--md-sys-color-surface-container', '#1C2024');
                    root.style.setProperty('--md-sys-color-surface-container-high', '#272A2F');
                    root.style.setProperty('--md-sys-color-surface-container-highest', '#31353A');
                    root.style.setProperty('--md-sys-color-outline', '#8C9199');
                    root.style.setProperty('--md-sys-color-outline-variant', '#42474E');
                    root.style.setProperty('--md-sys-color-error', '#FFB4AB');
                    root.style.setProperty('--md-sys-color-error-container', '#93000A');
                    root.style.setProperty('--md-sys-color-warning', '#FFB951');
                    root.style.setProperty('--md-sys-color-warning-container', '#7F4F00');
                    root.style.setProperty('--md-sys-color-success', '#4DD865');
                    root.style.setProperty('--md-sys-color-success-container', '#00390F');
                } else {
                    // Material You Light Theme
                    root.classList.remove('dark');
                    root.style.setProperty('--md-sys-color-primary', '#1B5FBF');
                    root.style.setProperty('--md-sys-color-on-primary', '#FFFFFF');
                    root.style.setProperty('--md-sys-color-primary-container', '#D1E4FF');
                    root.style.setProperty('--md-sys-color-on-primary-container', '#001D35');
                    root.style.setProperty('--md-sys-color-surface', '#FCFCFF');
                    root.style.setProperty('--md-sys-color-on-surface', '#1A1C1E');
                    root.style.setProperty('--md-sys-color-surface-variant', '#E1E2E8');
                    root.style.setProperty('--md-sys-color-on-surface-variant', '#42474E');
                    root.style.setProperty('--md-sys-color-surface-container', '#F3F4FA');
                    root.style.setProperty('--md-sys-color-surface-container-high', '#ECEEF4');
                    root.style.setProperty('--md-sys-color-surface-container-highest', '#E6E7ED');
                    root.style.setProperty('--md-sys-color-outline', '#73777F');
                    root.style.setProperty('--md-sys-color-outline-variant', '#C2C7CF');
                    root.style.setProperty('--md-sys-color-error', '#BA1A1A');
                    root.style.setProperty('--md-sys-color-error-container', '#FFDAD6');
                    root.style.setProperty('--md-sys-color-warning', '#A06500');
                    root.style.setProperty('--md-sys-color-warning-container', '#FFDDB3');
                    root.style.setProperty('--md-sys-color-success', '#146C2E');
                    root.style.setProperty('--md-sys-color-success-container', '#B7F4B7');
                }
            }, [isDarkMode]);

            return { isDarkMode, toggleDarkMode: () => setIsDarkMode(!isDarkMode) };
        };

        // Material Design Input Component
        const MaterialInput = ({ label, type = 'text', value, onChange, placeholder = ' ', ...props }) => {
            return (
                <div className="mat-input">
                    <input
                        type={type}
                        value={value}
                        onChange={onChange}
                        placeholder={placeholder}
                        {...props}
                    />
                    <label>{label}</label>
                </div>
            );
        };

        // Material Design Button Component
        const MaterialButton = ({ children, variant = 'contained', color = 'primary', onClick, disabled, className = '', ...props }) => {
            const baseClasses = 'mat-ripple inline-flex items-center justify-center px-6 py-3 font-medium text-sm rounded transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2';

            const variantClasses = {
                contained: {
                    primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500 mat-elevation-2',
                    secondary: 'bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500 mat-elevation-2',
                    success: 'bg-green-600 text-white hover:bg-green-700 focus:ring-green-500 mat-elevation-2',
                    error: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500 mat-elevation-2'
                },
                outlined: {
                    primary: 'border border-blue-600 text-blue-600 hover:bg-blue-50 focus:ring-blue-500',
                    secondary: 'border border-gray-600 text-gray-600 hover:bg-gray-50 focus:ring-gray-500',
                    success: 'border border-green-600 text-green-600 hover:bg-green-50 focus:ring-green-500',
                    error: 'border border-red-600 text-red-600 hover:bg-red-50 focus:ring-red-500'
                },
                text: {
                    primary: 'text-blue-600 hover:bg-blue-50 focus:ring-blue-500',
                    secondary: 'text-gray-600 hover:bg-gray-50 focus:ring-gray-500',
                    success: 'text-green-600 hover:bg-green-50 focus:ring-green-500',
                    error: 'text-red-600 hover:bg-red-50 focus:ring-red-500'
                }
            };

            const buttonClasses = `${baseClasses} ${variantClasses[variant][color]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`;

            return (
                <button
                    className={buttonClasses}
                    onClick={onClick}
                    disabled={disabled}
                    {...props}
                >
                    {children}
                </button>
            );
        };

        // Material Design Card Component
        const MaterialCard = ({ children, elevation = 1, className = '', ...props }) => {
            return (
                <div className={`mat-card mat-elevation-${elevation} p-6 ${className}`} {...props}>
                    {children}
                </div>
            );
        };

        // Material You Pagination Component
        const MaterialPagination = ({
            currentPage,
            totalItems,
            itemsPerPage,
            onPageChange,
            onItemsPerPageChange,
            className = ''
        }) => {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);

            const getVisiblePages = () => {
                const delta = 2;
                const range = [];
                const rangeWithDots = [];

                for (let i = Math.max(2, currentPage - delta);
                     i <= Math.min(totalPages - 1, currentPage + delta);
                     i++) {
                    range.push(i);
                }

                if (currentPage - delta > 2) {
                    rangeWithDots.push(1, '...');
                } else {
                    rangeWithDots.push(1);
                }

                rangeWithDots.push(...range);

                if (currentPage + delta < totalPages - 1) {
                    rangeWithDots.push('...', totalPages);
                } else {
                    rangeWithDots.push(totalPages);
                }

                return rangeWithDots.filter((v, i, a) => a.indexOf(v) === i);
            };

            if (totalPages <= 1) return null;

            return (
                <div className={`flex items-center justify-between flex-wrap gap-4 mt-6 ${className}`}>
                    <div className="flex items-center gap-4">
                        <div className="text-sm" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>
                            Showing {startItem}-{endItem} of {totalItems} items
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-sm" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>
                                Items per page:
                            </span>
                            <select
                                value={itemsPerPage}
                                onChange={(e) => onItemsPerPageChange(parseInt(e.target.value))}
                                className="mat-input-select"
                                style={{
                                    padding: '4px 8px',
                                    border: `1px solid var(--md-sys-color-outline)`,
                                    borderRadius: '4px',
                                    backgroundColor: 'var(--md-sys-color-surface)',
                                    color: 'var(--md-sys-color-on-surface)'
                                }}
                            >
                                <option value={50}>50</option>
                                <option value={100}>100</option>
                            </select>
                        </div>
                    </div>

                    <div className="flex items-center gap-1">
                        <MaterialButton
                            variant="text"
                            onClick={() => onPageChange(currentPage - 1)}
                            disabled={currentPage === 1}
                            className="!p-2 !min-w-0"
                        >
                            <span className="material-icons">chevron_left</span>
                        </MaterialButton>

                        {getVisiblePages().map((page, index) => (
                            page === '...' ? (
                                <span key={`dots-${index}`} className="px-2 text-gray-400">...</span>
                            ) : (
                                <MaterialButton
                                    key={page}
                                    variant={currentPage === page ? "contained" : "text"}
                                    color="primary"
                                    onClick={() => onPageChange(page)}
                                    className="!p-2 !min-w-[40px] !w-10 !h-10"
                                >
                                    {page}
                                </MaterialButton>
                            )
                        ))}

                        <MaterialButton
                            variant="text"
                            onClick={() => onPageChange(currentPage + 1)}
                            disabled={currentPage === totalPages}
                            className="!p-2 !min-w-0"
                        >
                            <span className="material-icons">chevron_right</span>
                        </MaterialButton>
                    </div>
                </div>
            );
        };

        // Error Boundary
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error('🚨 Application Error:', error);
                this.setState({ error });
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
                            <MaterialCard elevation={8} className="max-w-md">
                                <div className="flex items-center text-red-600 mb-4">
                                    <span className="material-icons mr-2">error</span>
                                    <h1 className="text-xl font-bold">Application Error</h1>
                                </div>
                                <p className="text-gray-700 dark:text-gray-300 mb-4">
                                    {this.state.error?.message || 'An unexpected error occurred'}
                                </p>
                                <MaterialButton
                                    onClick={() => window.location.reload()}
                                    variant="contained"
                                    color="primary"
                                    className="w-full"
                                >
                                    <span className="material-icons mr-2">refresh</span>
                                    Refresh Page
                                </MaterialButton>
                            </MaterialCard>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Authentication Component with Material Design
        const AuthComponent = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [showEmailForm, setShowEmailForm] = useState(false);
            const { showSnackbar } = useSnackbar();

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    setUser(user);
                    setLoading(false);
                });
                return unsubscribe;
            }, []);

            const handleSignIn = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    showSnackbar('Welcome back!', 'success');
                } catch (error) {
                    setError(error.message);
                    showSnackbar(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleGoogleSignIn = async () => {
                setError('');
                setLoading(true);

                try {
                    const result = await auth.signInWithPopup(googleProvider);
                    const user = result.user;
                    showSnackbar(`Welcome ${user.displayName || user.email}!`, 'success');
                } catch (error) {
                    console.error('Google Sign-In Error:', error);
                    if (error.code === 'auth/popup-closed-by-user') {
                        showSnackbar('Sign-in was cancelled', 'warning');
                    } else if (error.code === 'auth/popup-blocked') {
                        showSnackbar('Pop-up blocked. Please allow pop-ups for this site.', 'error');
                    } else {
                        setError(error.message);
                        showSnackbar(`Google Sign-In failed: ${error.message}`, 'error');
                    }
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
                        <div className="text-center">
                            <div className="mat-spinner w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                            <p className="text-gray-600 dark:text-gray-400">Loading Firebase...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return (
                    <div className="min-h-screen relative bg-gradient-to-br from-blue-50 via-white to-indigo-50 dark:from-gray-900 dark:via-gray-800 dark:to-indigo-900">
                        {/* Email Sign-In Toggle - Small corner button */}
                        <div className="absolute top-4 right-4 z-10">
                            <MaterialButton
                                onClick={() => setShowEmailForm(!showEmailForm)}
                                variant="text"
                                className="!p-2 !min-w-0 !text-xs opacity-60 hover:opacity-100 transition-opacity"
                            >
                                <span className="material-icons text-sm">alternate_email</span>
                            </MaterialButton>
                        </div>

                        {/* Email Form Overlay */}
                        {showEmailForm && (
                            <div className="absolute inset-0 bg-black/50 backdrop-blur-sm z-20 flex items-center justify-center p-4">
                                <MaterialCard elevation={16} className="w-full max-w-sm relative">
                                    <MaterialButton
                                        onClick={() => setShowEmailForm(false)}
                                        variant="text"
                                        className="!absolute !top-2 !right-2 !p-2 !min-w-0"
                                    >
                                        <span className="material-icons text-sm">close</span>
                                    </MaterialButton>

                                    <h3 className="text-lg font-medium mb-4 dark:text-white">Email Sign-In</h3>

                                    <form onSubmit={handleSignIn} className="space-y-4">
                                        <MaterialInput
                                            label="Email Address"
                                            type="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            required
                                        />

                                        <MaterialInput
                                            label="Password"
                                            type="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            required
                                        />

                                        {error && (
                                            <div className="flex items-center text-red-600 text-sm bg-red-50 dark:bg-red-900/20 p-3 rounded">
                                                <span className="material-icons mr-2 text-sm">error</span>
                                                {error}
                                            </div>
                                        )}

                                        <MaterialButton
                                            type="submit"
                                            variant="contained"
                                            color="primary"
                                            disabled={loading}
                                            className="w-full"
                                        >
                                            {loading ? (
                                                <>
                                                    <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                    Signing in...
                                                </>
                                            ) : (
                                                <>
                                                    <span className="material-icons mr-2">login</span>
                                                    Sign In
                                                </>
                                            )}
                                        </MaterialButton>
                                    </form>
                                </MaterialCard>
                            </div>
                        )}

                        {/* Main Sign-In Interface - Google Only */}
                        <div className="flex items-center justify-center min-h-screen p-4">
                            <div className="text-center max-w-md">
                                {/* Logo and Branding */}
                                <div className="mb-12">
                                    <div className="inline-flex items-center justify-center w-20 h-20 bg-white dark:bg-gray-800 rounded-3xl shadow-lg mb-6">
                                        <span className="material-icons text-4xl text-blue-600 dark:text-blue-400">inventory</span>
                                    </div>
                                    <h1 className="text-4xl font-bold text-gray-900 dark:text-white mb-2">
                                        IT Inventory
                                    </h1>
                                    <p className="text-gray-600 dark:text-gray-300 text-lg">
                                        Enterprise Inventory Management
                                    </p>
                                    <p className="text-gray-500 dark:text-gray-400 text-sm mt-2">
                                        Real-time tracking • Material Design • Firebase powered
                                    </p>
                                </div>

                                {/* Primary Google Sign-In */}
                                <div className="space-y-4">
                                    <MaterialButton
                                        onClick={handleGoogleSignIn}
                                        variant="contained"
                                        disabled={loading}
                                        className="w-full !bg-white hover:!bg-gray-50 !text-gray-700 !border !border-gray-300 shadow-lg hover:shadow-xl transition-all duration-200 !py-4 !text-lg"
                                    >
                                        {loading ? (
                                            <>
                                                <div className="mat-spinner w-5 h-5 border-2 border-gray-600 border-t-transparent rounded-full mr-3"></div>
                                                Signing in...
                                            </>
                                        ) : (
                                            <>
                                                <svg className="w-6 h-6 mr-3" viewBox="0 0 24 24">
                                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                                </svg>
                                                Continue with Google
                                            </>
                                        )}
                                    </MaterialButton>

                                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-6">
                                        Secure authentication powered by Google<br/>
                                        Your data is protected and never shared
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <header className="bg-blue-600 dark:bg-blue-800 text-white mat-elevation-4">
                    <div className="max-w-7xl mx-auto px-4">
                        <div className="flex items-center justify-between h-16">
                            <div className="flex items-center space-x-4">
                                <span className="material-icons text-2xl">inventory</span>
                                <div>
                                    <h1 className="font-semibold">IT Inventory System</h1>
                                    <p className="text-xs text-blue-100">Firebase powered</p>
                                </div>
                            </div>

                            <div className="flex items-center space-x-4">
                                <div className="flex items-center space-x-2 text-sm">
                                    <span className="material-icons text-sm">account_circle</span>
                                    <span>{user.email}</span>
                                    <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                </div>

                                <MaterialButton
                                    onClick={() => auth.signOut()}
                                    variant="text"
                                    className="text-white hover:bg-blue-700 dark:hover:bg-blue-900"
                                >
                                    <span className="material-icons mr-1">logout</span>
                                    Sign Out
                                </MaterialButton>
                            </div>
                        </div>
                    </div>
                </header>
            );
        };

        // Shopping Cart Component with Material Design
        const MaterialShoppingCart = ({ cart, addToCart, removeFromCart, clearCart, users, onCheckout, userSearchQuery, setUserSearchQuery }) => {
            const [isCheckingOut, setIsCheckingOut] = useState(false);
            const [checkoutMethod, setCheckoutMethod] = useState('user');
            const [selectedUser, setSelectedUser] = useState('');
            const [jobNumber, setJobNumber] = useState('');
            const [notes, setNotes] = useState('');
            const { showSnackbar } = useSnackbar();

            const cartTotal = cart.reduce((sum, item) => sum + (item.price || 0) * item.cartQuantity, 0);

            const handleCheckout = async () => {
                if (cart.length === 0) return;

                if (checkoutMethod === 'user' && !selectedUser) {
                    showSnackbar('Please select a user for checkout', 'error');
                    return;
                }

                if (checkoutMethod === 'job' && !jobNumber.trim()) {
                    showSnackbar('Please enter a job number', 'error');
                    return;
                }

                setIsCheckingOut(true);

                try {
                    const user = users.find(u => u.id === selectedUser);

                    for (const cartItem of cart) {
                        // Update inventory
                        const itemRef = db.collection('items').doc(cartItem.id);
                        await db.runTransaction(async (transaction) => {
                            const doc = await transaction.get(itemRef);
                            const currentQty = doc.data().quantity || 0;
                            const newQty = Math.max(0, currentQty - cartItem.cartQuantity);

                            transaction.update(itemRef, {
                                quantity: newQty,
                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            });

                            // Create checkout record
                            const checkoutRef = db.collection('checkoutHistory').doc();
                            transaction.set(checkoutRef, {
                                itemId: cartItem.id,
                                itemName: cartItem.name,
                                userId: checkoutMethod === 'user' ? selectedUser : '',
                                userName: checkoutMethod === 'user' ? (user?.name || `${user?.firstName} ${user?.lastName}`) : 'Job Checkout',
                                quantity: cartItem.cartQuantity,
                                departmentId: checkoutMethod === 'user' ? formatDepartmentId(user?.costCode || user?.cost_code) : jobNumber,
                                jobNumber: checkoutMethod === 'job' ? jobNumber : '',
                                notes: notes,
                                status: 'active',
                                dateEntered: firebase.firestore.FieldValue.serverTimestamp(),
                                createdBy: auth.currentUser?.email || 'unknown'
                            });
                        });
                    }

                    // Clear cart and form
                    clearCart();
                    setSelectedUser('');
                    setJobNumber('');
                    setNotes('');
                    showSnackbar(`Checkout completed! ${cart.length} items processed.`, 'success');

                    if (onCheckout) onCheckout();

                } catch (error) {
                    console.error('Checkout error:', error);
                    showSnackbar(`Checkout failed: ${error.message}`, 'error');
                } finally {
                    setIsCheckingOut(false);
                }
            };

            return (
                <MaterialCard elevation={2} className="sticky top-6">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center">
                            <span className="material-icons text-xl mr-2 text-blue-600">shopping_cart</span>
                            <h3 className="text-lg font-medium dark:text-white">Shopping Cart</h3>
                        </div>
                        <div className="flex items-center space-x-2">
                            {cart.length > 0 && (
                                <div className="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full text-sm font-medium">
                                    {cart.length} items
                                </div>
                            )}
                            {cartTotal > 0 && (
                                <div className="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-3 py-1 rounded-full text-sm font-medium">
                                    ${cartTotal.toFixed(2)}
                                </div>
                            )}
                        </div>
                    </div>

                    {cart.length === 0 ? (
                        <div className="text-center py-12 text-gray-500 dark:text-gray-400">
                            <span className="material-icons text-6xl mb-4 opacity-50">shopping_cart</span>
                            <p className="font-medium">Your cart is empty</p>
                            <p className="text-sm">Add items to get started</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            <div className="space-y-3 max-h-60 overflow-y-auto">
                                {cart.map(item => (
                                    <div key={item.id} className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div className="flex-1 min-w-0">
                                            <div className="font-medium text-gray-900 dark:text-white truncate">{item.name}</div>
                                            <div className="text-sm text-gray-600 dark:text-gray-400">
                                                Qty: {item.cartQuantity}
                                                {item.price > 0 && (
                                                    <span className="ml-2 text-green-600 dark:text-green-400 font-medium">
                                                        ${(item.price * item.cartQuantity).toFixed(2)}
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex items-center space-x-2 ml-3">
                                            <MaterialButton
                                                onClick={() => addToCart(item, 1)}
                                                variant="outlined"
                                                color="primary"
                                                className="!p-2 !min-w-0 !w-8 !h-8"
                                            >
                                                <span className="material-icons text-sm">add</span>
                                            </MaterialButton>
                                            <MaterialButton
                                                onClick={() => removeFromCart(item.id)}
                                                variant="outlined"
                                                color="error"
                                                className="!p-2 !min-w-0 !w-8 !h-8"
                                            >
                                                <span className="material-icons text-sm">remove</span>
                                            </MaterialButton>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="border-t dark:border-gray-600 pt-4 space-y-4">
                                {/* Checkout Method */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                                        Checkout Method
                                    </label>
                                    <div className="flex space-x-4">
                                        <label className="flex items-center cursor-pointer">
                                            <input
                                                type="radio"
                                                value="user"
                                                checked={checkoutMethod === 'user'}
                                                onChange={(e) => setCheckoutMethod(e.target.value)}
                                                className="mr-2 text-blue-600"
                                            />
                                            <span className="material-icons mr-1 text-sm">person</span>
                                            <span className="text-sm">User Checkout</span>
                                        </label>
                                        <label className="flex items-center cursor-pointer">
                                            <input
                                                type="radio"
                                                value="job"
                                                checked={checkoutMethod === 'job'}
                                                onChange={(e) => setCheckoutMethod(e.target.value)}
                                                className="mr-2 text-blue-600"
                                            />
                                            <span className="material-icons mr-1 text-sm">work</span>
                                            <span className="text-sm">Job Checkout</span>
                                        </label>
                                    </div>
                                </div>

                                {/* User Selection */}
                                {checkoutMethod === 'user' && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            Select User
                                        </label>
                                        <div className="relative">
                                            <input
                                                type="text"
                                                placeholder="Search users by name or cost code..."
                                                value={userSearchQuery}
                                                onChange={(e) => setUserSearchQuery(e.target.value)}
                                                className="w-full px-4 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            />
                                            <span className="material-icons absolute left-3 top-2.5 text-gray-400 text-sm">search</span>
                                        </div>

                                        {/* User Search Results */}
                                        {userSearchQuery && userSearchQuery.length > 0 && (
                                            <div className="mt-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                {users
                                                    .filter(user => {
                                                        const name = user.name || `${user.firstName} ${user.lastName}`;
                                                        const costCode = user.costCode || user.cost_code;
                                                        return name.toLowerCase().includes(userSearchQuery.toLowerCase()) ||
                                                               (costCode && costCode.toLowerCase().includes(userSearchQuery.toLowerCase()));
                                                    })
                                                    .slice(0, 20)
                                                    .map(user => (
                                                        <div
                                                            key={user.id}
                                                            onClick={() => {
                                                                setSelectedUser(user.id);
                                                                setUserSearchQuery('');
                                                            }}
                                                            className="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer border-b border-gray-200 dark:border-gray-600 last:border-b-0"
                                                        >
                                                            <div className="font-medium text-gray-900 dark:text-white">
                                                                {user.name || `${user.firstName} ${user.lastName}`}
                                                            </div>
                                                            <div className="text-sm text-gray-600 dark:text-gray-400">
                                                                Cost Code: {formatDepartmentId(user.costCode || user.cost_code)}
                                                            </div>
                                                        </div>
                                                    ))
                                                }
                                                {users.filter(user => {
                                                    const name = user.name || `${user.firstName} ${user.lastName}`;
                                                    const costCode = user.costCode || user.cost_code;
                                                    return name.toLowerCase().includes(userSearchQuery.toLowerCase()) ||
                                                           (costCode && costCode.toLowerCase().includes(userSearchQuery.toLowerCase()));
                                                }).length === 0 && (
                                                    <div className="px-4 py-2 text-gray-500 dark:text-gray-400">No users found</div>
                                                )}
                                            </div>
                                        )}

                                        {/* Selected User Display */}
                                        {selectedUser && (
                                            <div className="mt-2 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                                                <div className="flex items-center justify-between">
                                                    <div>
                                                        <div className="font-medium text-blue-900 dark:text-blue-100">
                                                            {(() => {
                                                                const user = users.find(u => u.id === selectedUser);
                                                                return user ? (user.name || `${user.firstName} ${user.lastName}`) : 'Unknown User';
                                                            })()}
                                                        </div>
                                                        <div className="text-sm text-blue-700 dark:text-blue-300">
                                                            Cost Code: {(() => {
                                                                const user = users.find(u => u.id === selectedUser);
                                                                return user ? formatDepartmentId(user.costCode || user.cost_code) : 'N/A';
                                                            })()}
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={() => setSelectedUser('')}
                                                        className="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200"
                                                    >
                                                        <span className="material-icons text-sm">close</span>
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* Job Number */}
                                {checkoutMethod === 'job' && (
                                    <MaterialInput
                                        label="Job Number"
                                        value={jobNumber}
                                        onChange={(e) => setJobNumber(e.target.value)}
                                        required
                                    />
                                )}

                                {/* Notes */}
                                <div className="mat-input">
                                    <textarea
                                        value={notes}
                                        onChange={(e) => setNotes(e.target.value)}
                                        rows={2}
                                        placeholder=" "
                                    />
                                    <label>Notes (Optional)</label>
                                </div>

                                {/* Checkout Buttons */}
                                <div className="flex space-x-3">
                                    <MaterialButton
                                        onClick={handleCheckout}
                                        disabled={isCheckingOut}
                                        variant="contained"
                                        color="success"
                                        className="flex-1"
                                    >
                                        {isCheckingOut ? (
                                            <>
                                                <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                Processing...
                                            </>
                                        ) : (
                                            <>
                                                <span className="material-icons mr-2">check_circle</span>
                                                Checkout
                                            </>
                                        )}
                                    </MaterialButton>
                                    <MaterialButton
                                        onClick={clearCart}
                                        variant="outlined"
                                        color="secondary"
                                        className="px-4"
                                    >
                                        <span className="material-icons">clear</span>
                                    </MaterialButton>
                                </div>
                            </div>
                        </div>
                    )}
                </MaterialCard>
            );
        };


        // Snackbar Component
        const MaterialSnackbar = ({ snackbar }) => {
            if (!snackbar) return null;

            const iconMap = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };

            return (
                <div className="mat-snackbar flex items-center">
                    <span className="material-icons mr-2 text-sm">
                        {iconMap[snackbar.type] || 'info'}
                    </span>
                    {snackbar.message}
                </div>
            );
        };

        // Enhanced Mobile-Optimized Barcode Scanner Component
        const MaterialBarcodeScanner = ({ items, onItemScanned }) => {
            const [scanInput, setScanInput] = useState('');
            const [isExpanded, setIsExpanded] = useState(true); // Default expanded for better UX
            const [scanMode, setScanMode] = useState('keyboard'); // 'keyboard' or 'camera'
            const [cameraStream, setCameraStream] = useState(null);
            const [scanHistory, setScanHistory] = useState([]);
            const [scanFeedback, setScanFeedback] = useState('');
            const [isScanning, setIsScanning] = useState(false);
            const [flashlightOn, setFlashlightOn] = useState(false);

            const inputRef = useRef(null);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const detectionIntervalRef = useRef(null);

            // Mobile vibration feedback
            const vibrate = (pattern = [100]) => {
                if (navigator.vibrate && 'ontouchstart' in window) {
                    navigator.vibrate(pattern);
                }
            };

            // Audio feedback for scans
            const playBeep = (success = true) => {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(success ? 800 : 400, audioContext.currentTime);
                    oscillator.type = 'square';

                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (error) {
                    console.log('Audio feedback not available');
                }
            };

            const handleScan = async (input, fromCamera = false) => {
                if (!input.trim()) return;

                setIsScanning(true);

                // Try to find item by name, ASIN, or exact barcode match
                const foundItem = items.find(item =>
                    item.name.toLowerCase().includes(input.toLowerCase()) ||
                    (item.asin && item.asin.toLowerCase() === input.toLowerCase()) ||
                    (item.barcode && item.barcode === input) ||
                    item.id === input
                );

                if (foundItem && onItemScanned) {
                    // Add to scan history
                    const scanRecord = {
                        id: Date.now().toString(),
                        itemName: foundItem.name,
                        timestamp: new Date(),
                        method: fromCamera ? 'camera' : 'keyboard'
                    };
                    setScanHistory(prev => [scanRecord, ...prev.slice(0, 4)]); // Keep last 5 scans

                    // Success feedback
                    setScanFeedback(`✅ Added ${foundItem.name} to cart`);
                    playBeep(true);
                    vibrate([100]);

                    // Call the callback to add to cart
                    onItemScanned(foundItem, 1);
                    setScanInput('');

                    // Clear feedback after 3 seconds
                    setTimeout(() => setScanFeedback(''), 3000);
                } else {
                    // Error feedback
                    setScanFeedback(`❌ Item not found: ${input}`);
                    playBeep(false);
                    vibrate([200, 100, 200]); // Error vibration pattern

                    setTimeout(() => setScanFeedback(''), 3000);
                }

                setIsScanning(false);

                // Keep focus on input for rapid scanning
                if (!fromCamera && inputRef.current) {
                    setTimeout(() => inputRef.current?.focus(), 100);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleScan(scanInput);
                }
            };

            // Detect mobile device types
            const isIOS = () => {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            };

            const isAndroid = () => {
                return /Android/.test(navigator.userAgent);
            };

            const isMobile = () => {
                return isIOS() || isAndroid() || /Mobi|Android/i.test(navigator.userAgent);
            };

            // Check HTTPS requirement
            const isHTTPS = () => {
                return location.protocol === 'https:' || location.hostname === 'localhost';
            };

            // Enhanced camera scanning with progressive fallback
            const startCameraScanning = async () => {
                try {
                    // Check basic requirements
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        setScanFeedback('❌ Camera API not supported in this browser');
                        setTimeout(() => {
                            setScanMode('keyboard');
                            setScanFeedback('⌨️ Use keyboard mode instead');
                        }, 2000);
                        return;
                    }

                    // Check HTTPS requirement (required for camera access)
                    if (!isHTTPS()) {
                        setScanFeedback('❌ Camera requires HTTPS connection. Use keyboard mode instead.');
                        setTimeout(() => {
                            setScanMode('keyboard');
                            setScanFeedback('⌨️ Switched to keyboard mode');
                        }, 3000);
                        return;
                    }

                    setScanFeedback('🔍 Requesting camera access...');
                    console.log('Starting camera access attempt...');

                    // Enhanced progressive constraint fallback strategy with device-specific optimizations
                    const constraintStrategies = [];

                    if (isIOS()) {
                        // iOS-specific constraint strategies optimized for Safari and WebView compatibility
                        constraintStrategies.push(
                            // Strategy 1: iOS-optimized back camera with standard resolution
                            {
                                name: 'iOS back camera (standard)',
                                constraints: {
                                    video: {
                                        facingMode: { exact: 'environment' },
                                        width: { ideal: 640, max: 1280 },
                                        height: { ideal: 480, max: 720 },
                                        frameRate: { ideal: 15, max: 30 }
                                    }
                                }
                            },
                            // Strategy 2: iOS-optimized back camera (simple)
                            {
                                name: 'iOS back camera (simple)',
                                constraints: {
                                    video: {
                                        facingMode: 'environment',
                                        width: { ideal: 640 },
                                        height: { ideal: 480 }
                                    }
                                }
                            },
                            // Strategy 3: iOS front camera fallback
                            {
                                name: 'iOS front camera',
                                constraints: {
                                    video: {
                                        facingMode: 'user',
                                        width: { ideal: 640 },
                                        height: { ideal: 480 },
                                        frameRate: { ideal: 15 }
                                    }
                                }
                            }
                        );
                    } else if (isAndroid()) {
                        // Android-specific constraint strategies optimized for Chrome compatibility
                        constraintStrategies.push(
                            // Strategy 1: Android-optimized back camera with higher resolution
                            {
                                name: 'Android back camera (HD)',
                                constraints: {
                                    video: {
                                        facingMode: { ideal: 'environment' },
                                        width: { ideal: 1280, min: 640 },
                                        height: { ideal: 720, min: 480 },
                                        frameRate: { ideal: 30, min: 15 }
                                    }
                                }
                            },
                            // Strategy 2: Android-optimized back camera (standard)
                            {
                                name: 'Android back camera (standard)',
                                constraints: {
                                    video: {
                                        facingMode: 'environment',
                                        width: { ideal: 640 },
                                        height: { ideal: 480 },
                                        frameRate: { ideal: 30 }
                                    }
                                }
                            },
                            // Strategy 3: Android front camera fallback
                            {
                                name: 'Android front camera',
                                constraints: {
                                    video: {
                                        facingMode: 'user',
                                        width: { ideal: 640 },
                                        height: { ideal: 480 }
                                    }
                                }
                            }
                        );
                    } else {
                        // Desktop/other device strategies
                        constraintStrategies.push(
                            // Strategy 1: Desktop high-quality camera
                            {
                                name: 'Desktop camera (HD)',
                                constraints: {
                                    video: {
                                        width: { ideal: 1280 },
                                        height: { ideal: 720 },
                                        frameRate: { ideal: 30 }
                                    }
                                }
                            },
                            // Strategy 2: Desktop basic camera
                            {
                                name: 'Desktop camera (basic)',
                                constraints: {
                                    video: {
                                        width: { ideal: 640 },
                                        height: { ideal: 480 }
                                    }
                                }
                            }
                        );
                    }

                    // Universal fallback strategies (apply to all devices)
                    constraintStrategies.push(
                        // Universal Strategy 1: Basic back camera
                        {
                            name: 'Basic back camera',
                            constraints: {
                                video: {
                                    facingMode: 'environment'
                                }
                            }
                        },
                        // Universal Strategy 2: Basic front camera
                        {
                            name: 'Basic front camera',
                            constraints: {
                                video: {
                                    facingMode: 'user'
                                }
                            }
                        },
                        // Universal Strategy 3: Any available camera
                        {
                            name: 'Any available camera',
                            constraints: {
                                video: true
                            }
                        }
                    );

                    let stream = null;
                    let successfulStrategy = null;

                    for (const strategy of constraintStrategies) {
                        try {
                            console.log(`Trying camera strategy: ${strategy.name}`, strategy.constraints);
                            setScanFeedback(`🔍 Trying ${strategy.name} camera...`);

                            stream = await navigator.mediaDevices.getUserMedia(strategy.constraints);
                            successfulStrategy = strategy;
                            console.log(`✅ Camera access successful with: ${strategy.name}`);
                            break;
                        } catch (error) {
                            console.log(`❌ Strategy "${strategy.name}" failed:`, error.name, error.message);

                            // If permission denied, don't try other strategies
                            if (error.name === 'NotAllowedError') {
                                throw error;
                            }

                            // Continue to next strategy for other errors
                            continue;
                        }
                    }

                    if (!stream) {
                        throw new Error('All camera access strategies failed');
                    }

                    // Success! Set up the camera
                    setCameraStream(stream);
                    setScanMode('camera');

                    const cameraType = successfulStrategy.name;
                    const tracks = stream.getVideoTracks();
                    const settings = tracks[0]?.getSettings();

                    console.log('Camera settings:', settings);
                    setScanFeedback(`📷 ${cameraType} camera active - ${isMobile() ? 'Tap to focus' : 'Point at barcode'}`);

                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;

                        // Enhanced mobile video setup for iOS and Android compatibility
                        if (isMobile()) {
                            // Critical iOS Safari attributes
                            videoRef.current.setAttribute('playsinline', 'true');
                            videoRef.current.setAttribute('webkit-playsinline', 'true');
                            videoRef.current.setAttribute('muted', 'true');
                            videoRef.current.setAttribute('autoplay', 'true');

                            // Set properties directly for maximum compatibility
                            videoRef.current.muted = true;
                            videoRef.current.playsInline = true;
                            videoRef.current.defaultMuted = true;

                            // iOS specific settings for better camera handling
                            if (isIOS()) {
                                videoRef.current.setAttribute('controls', 'false');
                                videoRef.current.setAttribute('preload', 'metadata');
                                // Disable picture-in-picture for iOS
                                if (videoRef.current.disablePictureInPicture !== undefined) {
                                    videoRef.current.disablePictureInPicture = true;
                                }
                            }
                        }

                        // Enhanced iOS/Mobile video play handling
                        try {
                            if (isIOS()) {
                                // iOS-specific play sequence for maximum compatibility
                                console.log('🍎 Setting up iOS video playback...');

                                // Load the video metadata first
                                await new Promise((resolve, reject) => {
                                    const onLoadedMetadata = () => {
                                        videoRef.current.removeEventListener('loadedmetadata', onLoadedMetadata);
                                        resolve();
                                    };
                                    const onError = (error) => {
                                        videoRef.current.removeEventListener('error', onError);
                                        reject(error);
                                    };

                                    if (videoRef.current.readyState >= 1) {
                                        resolve(); // Already loaded
                                    } else {
                                        videoRef.current.addEventListener('loadedmetadata', onLoadedMetadata);
                                        videoRef.current.addEventListener('error', onError);
                                        videoRef.current.load();
                                    }
                                });

                                // Attempt to play with iOS-specific handling
                                const playPromise = videoRef.current.play();
                                if (playPromise !== undefined) {
                                    await playPromise;
                                }
                                console.log('✅ iOS video playing successfully');
                                setScanFeedback('📷 Camera ready - Point at barcode');
                            } else {
                                // Standard play for Android and other devices
                                await videoRef.current.play();
                                console.log('✅ Video playing successfully');
                                setScanFeedback('📷 Camera ready - Point at barcode');
                            }
                        } catch (playError) {
                            console.log('⚠️ Video autoplay failed:', playError.message);

                            if (isIOS()) {
                                setScanFeedback('👆 iOS: Tap the camera view to start video playback');
                            } else if (isAndroid()) {
                                setScanFeedback('👆 Android: Tap the camera view to start video');
                            } else {
                                setScanFeedback('👆 Tap the camera view to start video');
                            }
                        }

                        // Enhanced video event handlers
                        videoRef.current.onloadedmetadata = () => {
                            console.log('Video metadata loaded');
                            setTimeout(() => {
                                startBarcodeDetection();
                            }, isMobile() ? 1000 : 500);
                        };

                        videoRef.current.onplay = () => {
                            console.log('Video started playing');
                            setScanFeedback('📷 Camera ready - Point at barcode');
                        };

                        videoRef.current.onerror = (error) => {
                            console.error('Video error:', error);
                            setScanFeedback('❌ Video playback error');
                        };

                        // Enhanced universal tap handler for mobile with device-specific optimizations
                        videoRef.current.onclick = async (event) => {
                            event.preventDefault();
                            event.stopPropagation();

                            const video = videoRef.current;
                            console.log(`📱 Video tap detected - Device: ${isIOS() ? 'iOS' : isAndroid() ? 'Android' : 'Other'}, Paused: ${video.paused}`);

                            if (video.paused) {
                                try {
                                    if (isIOS()) {
                                        // iOS-specific play sequence with user interaction
                                        console.log('🍎 iOS user interaction - attempting video play...');

                                        // For iOS, ensure video is properly configured before play
                                        video.muted = true;
                                        video.playsInline = true;

                                        const playPromise = video.play();
                                        if (playPromise !== undefined) {
                                            await playPromise;
                                        }
                                        setScanFeedback('📷 iOS camera active - Point at barcode');
                                    } else if (isAndroid()) {
                                        // Android-specific play handling
                                        console.log('🤖 Android user interaction - attempting video play...');
                                        await video.play();
                                        setScanFeedback('📷 Android camera active - Point at barcode');
                                    } else {
                                        // Standard play for other devices
                                        await video.play();
                                        setScanFeedback('📷 Camera active - Point at barcode');
                                    }

                                    // Start or restart barcode detection after successful play
                                    setTimeout(() => {
                                        startBarcodeDetection();
                                    }, 500);

                                } catch (error) {
                                    console.error('❌ Manual video play failed:', error);

                                    if (isIOS()) {
                                        setScanFeedback('❌ iOS camera failed - Try Safari instead of Chrome, or reload page');
                                    } else if (isAndroid()) {
                                        setScanFeedback('❌ Android camera failed - Check permissions or reload page');
                                    } else {
                                        setScanFeedback('❌ Cannot start camera - try reloading page');
                                    }
                                }
                            } else {
                                // Video is already playing - provide focus feedback
                                if (isMobile()) {
                                    // Haptic feedback on mobile for focus action
                                    if (navigator.vibrate) {
                                        navigator.vibrate(50);
                                    }

                                    setScanFeedback('🔍 Focusing camera...');
                                    setTimeout(() => {
                                        if (isIOS()) {
                                            setScanFeedback('📷 iOS camera ready - Hold steady on barcode');
                                        } else if (isAndroid()) {
                                            setScanFeedback('📷 Android camera ready - Point at barcode');
                                        } else {
                                            setScanFeedback('📷 Camera ready - Point at barcode');
                                        }
                                    }, 1000);
                                }
                            }
                        };
                    }

                } catch (error) {
                    console.error('Camera access failed:', error);

                    let errorMessage = '❌ Camera access failed';
                    let detailedMessage = '';

                    // Enhanced device and browser-specific error handling
                    const browserName = navigator.userAgent.includes('Chrome') ? 'Chrome' :
                                       navigator.userAgent.includes('Firefox') ? 'Firefox' :
                                       navigator.userAgent.includes('Safari') ? 'Safari' : 'Browser';

                    switch (error.name) {
                        case 'NotAllowedError':
                            errorMessage = '❌ Camera permission denied';
                            if (isIOS()) {
                                if (browserName === 'Chrome') {
                                    detailedMessage = '🍎 iOS Chrome: Camera access is limited. Try using Safari instead, or open this site in Safari for full camera support.';
                                } else {
                                    detailedMessage = '🍎 iOS Safari: Please allow camera access when prompted, then reload the page. Check Settings > Safari > Camera if needed.';
                                }
                            } else if (isAndroid()) {
                                detailedMessage = '🤖 Android: Please allow camera access when prompted. Check browser permissions in Settings > Apps > Chrome > Permissions if needed.';
                            } else {
                                detailedMessage = 'Please allow camera access in browser settings and reload the page.';
                            }
                            break;
                        case 'NotFoundError':
                            errorMessage = '❌ No camera found';
                            if (isIOS()) {
                                detailedMessage = '🍎 iOS: No camera detected. Ensure camera is not being used by another app, and try closing other camera apps.';
                            } else if (isAndroid()) {
                                detailedMessage = '🤖 Android: Camera not available. Close other camera apps or restart your browser.';
                            } else {
                                detailedMessage = 'This device does not have a camera or it is being used by another app.';
                            }
                            break;
                        case 'NotSupportedError':
                            errorMessage = '❌ Camera not supported';
                            if (isIOS()) {
                                if (browserName === 'Chrome') {
                                    detailedMessage = '🍎 iOS Chrome: Camera access is limited in Chrome on iOS. Please use Safari instead for full camera support.';
                                } else {
                                    detailedMessage = '🍎 iOS: Camera access may be limited. Ensure you\'re using Safari, not a third-party browser.';
                                }
                            } else if (isAndroid()) {
                                detailedMessage = '🤖 Android: Try enabling "Desktop site" mode in Chrome, or update your browser to the latest version.';
                            } else {
                                detailedMessage = 'Camera access is not supported in this browser. Try using Chrome, Firefox, or Safari.';
                            }
                            break;
                        case 'OverconstrainedError':
                            errorMessage = '❌ Camera constraints not supported';
                            if (isIOS()) {
                                detailedMessage = '🍎 iOS: Camera resolution not supported. The app will try simpler settings automatically.';
                            } else if (isAndroid()) {
                                detailedMessage = '🤖 Android: Camera configuration not available. Trying alternative settings automatically.';
                            } else {
                                detailedMessage = 'The requested camera configuration is not available. Trying alternative settings.';
                            }
                            break;
                        case 'NotReadableError':
                            errorMessage = '❌ Camera hardware error';
                            if (isIOS()) {
                                detailedMessage = '🍎 iOS: Camera is in use by another app. Close Camera, FaceTime, or other camera apps and try again.';
                            } else if (isAndroid()) {
                                detailedMessage = '🤖 Android: Camera hardware issue. Close other camera apps, restart browser, or restart device if needed.';
                            } else {
                                detailedMessage = 'Camera is already in use or has a hardware problem. Close other camera apps.';
                            }
                            break;
                        case 'SecurityError':
                            errorMessage = '❌ Camera access blocked by security';
                            if (!isHTTPS()) {
                                detailedMessage = '🔒 HTTPS Required: Camera access requires a secure connection. Please access this site via HTTPS.';
                            } else if (isIOS()) {
                                detailedMessage = '🍎 iOS Security: Camera access blocked. Check Safari privacy settings and ensure this site is trusted.';
                            } else if (isAndroid()) {
                                detailedMessage = '🤖 Android Security: Camera access blocked. Check Chrome site permissions and clear browser cache if needed.';
                            } else {
                                detailedMessage = 'Camera access is blocked by security settings. Check site permissions and try refreshing.';
                            }
                            break;
                        default:
                            errorMessage = `❌ Camera error: ${error.name || 'Unknown'}`;
                            if (isIOS()) {
                                detailedMessage = `🍎 iOS: ${error.message || 'Try using Safari instead of other browsers, or reload the page.'}`;
                            } else if (isAndroid()) {
                                detailedMessage = `🤖 Android: ${error.message || 'Try reloading the page or using keyboard mode instead.'}`;
                            } else {
                                detailedMessage = error.message || 'Please try keyboard mode instead.';
                            }
                    }

                    setScanFeedback(`${errorMessage} - ${detailedMessage}`);

                    // Auto-switch to keyboard mode after showing error
                    setTimeout(() => {
                        setScanMode('keyboard');
                        setScanFeedback('⌨️ Switched to keyboard mode - Use handheld scanner or type item names');

                        // Focus input for immediate use
                        if (inputRef.current) {
                            inputRef.current.focus();
                        }
                    }, 4000);
                }
            };

            const stopCameraScanning = () => {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => {
                        track.stop();
                    });
                    setCameraStream(null);
                    setScanMode('keyboard');
                    setScanFeedback('');
                    setFlashlightOn(false);
                }

                if (detectionIntervalRef.current) {
                    clearInterval(detectionIntervalRef.current);
                }
            };

            // Toggle flashlight (torch)
            const toggleFlashlight = async () => {
                if (cameraStream) {
                    const videoTrack = cameraStream.getVideoTracks()[0];
                    if (videoTrack && 'torch' in videoTrack.getCapabilities()) {
                        try {
                            await videoTrack.applyConstraints({
                                advanced: [{ torch: !flashlightOn }]
                            });
                            setFlashlightOn(!flashlightOn);
                        } catch (error) {
                            console.log('Flashlight not supported');
                        }
                    }
                }
            };

            // Enhanced barcode detection with iOS compatibility
            const startBarcodeDetection = () => {
                if (!videoRef.current || !canvasRef.current) return;

                const detectBarcodes = async () => {
                    const video = videoRef.current;
                    const canvas = canvasRef.current;

                    if (video.readyState === 4 && video.videoWidth > 0) {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0);

                        // Check for BarcodeDetector API (not available on iOS)
                        if ('BarcodeDetector' in window && typeof BarcodeDetector !== 'undefined') {
                            try {
                                const detector = new BarcodeDetector({
                                    formats: ['code_128', 'code_39', 'ean_13', 'ean_8', 'upc_a', 'upc_e']
                                });
                                const barcodes = await detector.detect(canvas);

                                if (barcodes.length > 0 && !isScanning) {
                                    const barcode = barcodes[0];
                                    await handleScan(barcode.rawValue, true);
                                    return; // Exit early on successful scan
                                }
                            } catch (error) {
                                console.log('Barcode detection failed:', error);
                            }
                        } else {
                            // iOS fallback: Manual capture mode
                            if (isIOS()) {
                                // Show manual capture instructions for iOS
                                if (!scanFeedback.includes('Tap')) {
                                    setScanFeedback('📷 Point at barcode, then tap "Capture & Type" below');
                                }
                            }
                        }
                    }
                };

                // Use different detection intervals based on device
                const detectionDelay = isIOS() ? 1000 : 500; // Slower on iOS for performance
                detectionIntervalRef.current = setInterval(detectBarcodes, detectionDelay);
            };

            // Manual capture function for iOS
            const captureBarcode = () => {
                if (!videoRef.current || !canvasRef.current) return;

                const video = videoRef.current;
                const canvas = canvasRef.current;

                if (video.readyState === 4) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);

                    // Visual feedback
                    setScanFeedback('📸 Image captured! Now type the barcode number below:');
                    vibrate([100, 50, 100]); // Capture feedback

                    // Auto-switch to keyboard for manual entry
                    setTimeout(() => {
                        setScanMode('keyboard');
                        if (inputRef.current) {
                            inputRef.current.focus();
                        }
                    }, 1500);
                }
            };

            // Enhanced camera diagnostic function with mobile-specific details
            const runCameraDiagnostic = async () => {
                const getBrowserVersion = () => {
                    const ua = navigator.userAgent;
                    if (ua.includes('Chrome')) {
                        const match = ua.match(/Chrome\/(\d+\.\d+)/);
                        return match ? match[1] : 'unknown';
                    } else if (ua.includes('Safari')) {
                        const match = ua.match(/Version\/(\d+\.\d+)/);
                        return match ? match[1] : 'unknown';
                    } else if (ua.includes('Firefox')) {
                        const match = ua.match(/Firefox\/(\d+\.\d+)/);
                        return match ? match[1] : 'unknown';
                    }
                    return 'unknown';
                };

                const getOSVersion = () => {
                    const ua = navigator.userAgent;
                    if (isIOS()) {
                        const match = ua.match(/OS (\d+)_(\d+)/);
                        return match ? `iOS ${match[1]}.${match[2]}` : 'iOS (unknown)';
                    } else if (isAndroid()) {
                        const match = ua.match(/Android (\d+\.\d+)/);
                        return match ? `Android ${match[1]}` : 'Android (unknown)';
                    }
                    return 'Unknown OS';
                };

                const isWebView = () => {
                    const ua = navigator.userAgent;
                    if (isIOS() && !ua.includes('Safari/')) return true;
                    if (isAndroid() && ua.includes('wv')) return true;
                    return false;
                };

                const diagnostics = {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    isHTTPS: isHTTPS(),
                    hasMediaDevices: !!navigator.mediaDevices,
                    hasGetUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
                    isIOS: isIOS(),
                    isAndroid: isAndroid(),
                    isMobile: isMobile(),
                    isWebView: isWebView(),
                    browserName: getBrowserName(),
                    browserVersion: getBrowserVersion(),
                    osVersion: getOSVersion(),
                    deviceType: isIOS() ? (navigator.userAgent.includes('iPad') ? 'iPad' : 'iPhone') :
                               isAndroid() ? (screen.width < 768 ? 'Android Phone' : 'Android Tablet') : 'Desktop',
                    screenSize: `${screen.width}x${screen.height}`,
                    windowSize: `${window.innerWidth}x${window.innerHeight}`,
                    pixelRatio: window.devicePixelRatio || 1,
                    currentUrl: window.location.href,
                    permissions: { camera: 'unknown' }
                };

                // Check camera permissions if supported
                try {
                    if (navigator.permissions && navigator.permissions.query) {
                        const permissionStatus = await navigator.permissions.query({ name: 'camera' });
                        diagnostics.permissions.camera = permissionStatus.state;
                    }
                } catch (permError) {
                    diagnostics.permissions.camera = 'query_failed';
                }

                // Check available cameras
                try {
                    if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                        const devices = await navigator.mediaDevices.enumerateDevices();
                        const videoDevices = devices.filter(device => device.kind === 'videoinput');
                        diagnostics.availableCameras = videoDevices.length;
                        diagnostics.cameraDevices = videoDevices.map(device => ({
                            label: device.label || 'Camera',
                            deviceId: device.deviceId ? 'Present' : 'Missing',
                            facingMode: device.label.toLowerCase().includes('front') ? 'user' :
                                       device.label.toLowerCase().includes('back') ? 'environment' : 'unknown'
                        }));
                    }
                } catch (error) {
                    diagnostics.enumerateError = error.message;
                }

                // Enhanced camera access test with device-specific constraints
                try {
                    let testConstraints;
                    if (isIOS()) {
                        testConstraints = { video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } } };
                    } else if (isAndroid()) {
                        testConstraints = { video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } };
                    } else {
                        testConstraints = { video: true };
                    }

                    const testStream = await navigator.mediaDevices.getUserMedia(testConstraints);
                    const track = testStream.getVideoTracks()[0];
                    const settings = track.getSettings();

                    diagnostics.basicCameraAccess = 'Success';
                    diagnostics.testCameraSettings = {
                        width: settings.width,
                        height: settings.height,
                        frameRate: settings.frameRate,
                        facingMode: settings.facingMode
                    };

                    testStream.getTracks().forEach(track => track.stop());
                } catch (error) {
                    diagnostics.basicCameraAccess = `Failed: ${error.name} - ${error.message}`;
                    diagnostics.cameraTestError = {
                        name: error.name,
                        message: error.message,
                        constraint: error.constraint || 'none'
                    };
                }

                console.log('📊 Camera Diagnostics:', diagnostics);

                const diagnosticText = `
📊 Camera Diagnostic Results:

🌐 Connection: ${diagnostics.isHTTPS ? '✅ HTTPS' : '❌ HTTP (Camera requires HTTPS)'}
📱 Device Type: ${diagnostics.deviceType}
🖥️ OS Version: ${diagnostics.osVersion}
🌍 Browser: ${diagnostics.browserName} ${diagnostics.browserVersion}
${diagnostics.isWebView ? '📦 WebView: ⚠️ Running in WebView (limited camera support)' : ''}
📏 Screen: ${diagnostics.screenSize} (${diagnostics.pixelRatio}x pixel ratio)
🎦 Window: ${diagnostics.windowSize}

📷 Camera API: ${diagnostics.hasGetUserMedia ? '✅ Available' : '❌ Not Available'}
🔐 Permissions: ${diagnostics.permissions.camera}
📹 Available Cameras: ${diagnostics.availableCameras || 'Unknown'}
${diagnostics.cameraDevices && diagnostics.cameraDevices.length > 0 ?
  diagnostics.cameraDevices.map(cam => `  • ${cam.label} (${cam.facingMode})`).join('\n') : ''}

🔍 Camera Test: ${diagnostics.basicCameraAccess}
${diagnostics.testCameraSettings ?
  `📐 Test Resolution: ${diagnostics.testCameraSettings.width}x${diagnostics.testCameraSettings.height} @ ${diagnostics.testCameraSettings.frameRate}fps` : ''}

${!diagnostics.isHTTPS ? '⚠️ Camera requires HTTPS connection' : ''}
${diagnostics.isIOS && diagnostics.browserName.includes('Chrome') ? '⚠️ iOS Chrome has limited camera support - try Safari instead' : ''}
${diagnostics.isWebView ? '⚠️ WebView detected - full camera access may be limited' : ''}
${diagnostics.isAndroid && diagnostics.browserName.includes('Chrome') && diagnostics.basicCameraAccess.includes('Failed') ? '⚠️ Android Chrome: Try enabling "Desktop site" mode or check permissions' : ''}
                `.trim();

                setScanFeedback(diagnosticText);
            };

            const getBrowserName = () => {
                const ua = navigator.userAgent;
                if (ua.includes('Chrome') && !ua.includes('Edg')) return 'Chrome';
                if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
                if (ua.includes('Firefox')) return 'Firefox';
                if (ua.includes('Edg')) return 'Edge';
                return 'Unknown';
            };

            // Clean up camera on unmount
            useEffect(() => {
                return () => {
                    stopCameraScanning();
                };
            }, []);

            // Auto-focus input when in keyboard mode
            useEffect(() => {
                if (scanMode === 'keyboard' && inputRef.current && isExpanded) {
                    inputRef.current.focus();
                }
            }, [scanMode, isExpanded]);

            return (
                <MaterialCard elevation={2}>
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <span className="material-icons mr-2 text-blue-600">qr_code_scanner</span>
                            Barcode Scanner
                            {scanHistory.length > 0 && (
                                <span className="ml-2 bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                                    {scanHistory.length} scanned
                                </span>
                            )}
                        </h3>
                        <MaterialButton
                            variant="outlined"
                            onClick={() => setIsExpanded(!isExpanded)}
                        >
                            <span className="material-icons">
                                {isExpanded ? 'expand_less' : 'expand_more'}
                            </span>
                        </MaterialButton>
                    </div>

                    {/* Feedback Display */}
                    {scanFeedback && (
                        <div className={`mb-4 p-3 rounded-lg border-l-4 ${
                            scanFeedback.includes('✅')
                                ? 'bg-green-50 border-green-400 text-green-700'
                                : 'bg-red-50 border-red-400 text-red-700'
                        }`}>
                            <div className="flex items-center">
                                <span className="font-medium">{scanFeedback}</span>
                                {isScanning && (
                                    <span className="ml-2 material-icons animate-spin text-sm">refresh</span>
                                )}
                            </div>
                        </div>
                    )}

                    {isExpanded && (
                        <div className="space-y-4">
                            {/* Scanning Mode Toggle */}
                            <div className="flex space-x-2 mb-4">
                                <MaterialButton
                                    variant={scanMode === 'keyboard' ? 'contained' : 'outlined'}
                                    color="primary"
                                    onClick={() => {
                                        if (scanMode === 'camera') stopCameraScanning();
                                        setScanMode('keyboard');
                                    }}
                                    className="flex-1"
                                >
                                    <span className="material-icons mr-2">keyboard</span>
                                    <span className="hidden sm:inline">Keyboard</span>
                                    <span className="sm:hidden">Key</span>
                                </MaterialButton>
                                <MaterialButton
                                    variant={scanMode === 'camera' ? 'contained' : 'outlined'}
                                    color="primary"
                                    onClick={() => {
                                        if (scanMode === 'camera') {
                                            stopCameraScanning();
                                        } else {
                                            startCameraScanning();
                                        }
                                    }}
                                    className="flex-1"
                                >
                                    <span className="material-icons mr-2">
                                        {scanMode === 'camera' ? 'videocam_off' : 'videocam'}
                                    </span>
                                    <span className="hidden sm:inline">
                                        {scanMode === 'camera' ? 'Stop Camera' : 'Camera'}
                                    </span>
                                    <span className="sm:hidden">
                                        {scanMode === 'camera' ? 'Stop' : 'Cam'}
                                    </span>
                                </MaterialButton>
                            </div>

                            {/* Camera Diagnostic Button - Show when camera issues likely */}
                            {(isMobile() || !isHTTPS()) && (
                                <div className="mb-4">
                                    <MaterialButton
                                        onClick={runCameraDiagnostic}
                                        variant="outlined"
                                        color="secondary"
                                        className="w-full"
                                    >
                                        <span className="material-icons mr-2">bug_report</span>
                                        Run Camera Diagnostic
                                    </MaterialButton>
                                </div>
                            )}

                            {/* Keyboard Scanning Mode */}
                            {scanMode === 'keyboard' && (
                                <div className="space-y-3">
                                    <div className="mat-input">
                                        <input
                                            ref={inputRef}
                                            type="text"
                                            value={scanInput}
                                            onChange={(e) => setScanInput(e.target.value)}
                                            onKeyPress={handleKeyPress}
                                            placeholder="Scan barcode or type item name"
                                            className="w-full text-lg"
                                            disabled={isScanning}
                                            autoComplete="off"
                                            autoCorrect="off"
                                            autoCapitalize="off"
                                            spellCheck="false"
                                        />
                                        <label>Scan Input</label>
                                    </div>
                                    <MaterialButton
                                        variant="contained"
                                        color="primary"
                                        onClick={() => handleScan(scanInput)}
                                        disabled={!scanInput.trim() || isScanning}
                                        className="w-full py-3"
                                    >
                                        <span className="material-icons mr-2">
                                            {isScanning ? 'hourglass_empty' : 'search'}
                                        </span>
                                        {isScanning ? 'Scanning...' : 'Find & Add to Cart'}
                                    </MaterialButton>
                                </div>
                            )}

                            {/* Camera Scanning Mode */}
                            {scanMode === 'camera' && (
                                <div className="space-y-3">
                                    <div className="relative bg-black rounded-lg overflow-hidden">
                                        <video
                                            ref={videoRef}
                                            className="w-full h-64 sm:h-80 object-cover"
                                            playsInline
                                            webkit-playsinline="true"
                                            muted
                                            autoPlay
                                            defaultMuted
                                            controls={false}
                                            preload="metadata"
                                            disablePictureInPicture
                                        />
                                        <canvas ref={canvasRef} className="hidden" />

                                        {/* Camera Controls Overlay */}
                                        <div className="absolute bottom-4 left-4 right-4 flex justify-center space-x-4">
                                            {/* Flashlight Toggle */}
                                            <MaterialButton
                                                variant="contained"
                                                color={flashlightOn ? 'secondary' : 'primary'}
                                                onClick={toggleFlashlight}
                                                className="!min-w-0 !w-12 !h-12 !p-0 bg-black bg-opacity-50"
                                            >
                                                <span className="material-icons text-white">
                                                    {flashlightOn ? 'flash_off' : 'flash_on'}
                                                </span>
                                            </MaterialButton>

                                            {/* Focus indicator */}
                                            <div className="flex items-center px-3 py-2 bg-black bg-opacity-50 rounded-full">
                                                <span className="material-icons text-white text-sm mr-1">center_focus_strong</span>
                                                <span className="text-white text-sm">Auto-detecting</span>
                                            </div>
                                        </div>

                                        {/* Scanning frame overlay */}
                                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                            <div className="w-64 h-32 border-2 border-blue-400 border-dashed rounded-lg bg-blue-400 bg-opacity-10"></div>
                                        </div>
                                    </div>

                                    <div className="text-center space-y-2">
                                        <p className="text-sm text-gray-600">
                                            {isIOS() ? (
                                                '📱 iPhone: Point at barcode, then use "Capture & Type" button'
                                            ) : (
                                                '📱 Point camera at barcode • Detection is automatic'
                                            )}
                                        </p>

                                        {/* iOS Manual Capture Button */}
                                        {isIOS() && cameraStream && (
                                            <MaterialButton
                                                onClick={captureBarcode}
                                                variant="contained"
                                                color="secondary"
                                                className="w-full"
                                            >
                                                <span className="material-icons mr-2">camera_alt</span>
                                                Capture & Type Barcode
                                            </MaterialButton>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Recent Scans History */}
                            {scanHistory.length > 0 && (
                                <div className="mt-4 p-3 bg-gray-50 rounded-lg">
                                    <h4 className="font-medium text-sm text-gray-700 mb-2 flex items-center">
                                        <span className="material-icons text-sm mr-1">history</span>
                                        Recent Scans
                                    </h4>
                                    <div className="space-y-1">
                                        {scanHistory.map((scan, index) => (
                                            <div
                                                key={scan.id}
                                                className={`flex justify-between items-center text-sm p-2 rounded ${
                                                    index === 0 ? 'bg-green-100 text-green-800' : 'bg-white text-gray-600'
                                                }`}
                                            >
                                                <span className="font-medium truncate mr-2">{scan.itemName}</span>
                                                <div className="flex items-center text-xs space-x-2">
                                                    <span className="material-icons text-xs">
                                                        {scan.method === 'camera' ? 'videocam' : 'keyboard'}
                                                    </span>
                                                    <span>{scan.timestamp.toLocaleTimeString()}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Mobile Tips */}
                            <div className="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
                                <div className="flex items-start">
                                    <span className="material-icons text-sm mr-2 mt-0.5">info</span>
                                    <div>
                                        <div className="font-medium mb-1">
                                            {isIOS() ? '🍎 iPhone Tips:' : '📱 Mobile Tips:'}
                                        </div>
                                        <ul className="text-xs space-y-0.5 list-disc list-inside">
                                            {isIOS() ? (
                                                <>
                                                    <li><strong>Browser:</strong> Use Safari for best camera support (not Chrome)</li>
                                                    <li><strong>Permissions:</strong> Allow camera access when prompted</li>
                                                    <li><strong>Video Issues:</strong> Tap the camera view to start video playback</li>
                                                    <li><strong>Troubleshooting:</strong> Try refreshing page or restart Safari</li>
                                                    <li><strong>Alternative:</strong> Use keyboard mode with handheld scanners</li>
                                                    <li><strong>Diagnostic:</strong> Run camera diagnostic to identify issues</li>
                                                </>
                                            ) : isAndroid() ? (
                                                <>
                                                    <li><strong>Permissions:</strong> Allow camera access in Chrome permissions</li>
                                                    <li><strong>Fallback:</strong> Try "Desktop site" mode if camera fails</li>
                                                    <li><strong>Apps:</strong> Close other camera apps (Instagram, Snapchat, etc.)</li>
                                                    <li><strong>Settings:</strong> Check Settings > Apps > Chrome > Permissions</li>
                                                    <li><strong>Troubleshooting:</strong> Clear Chrome cache or restart browser</li>
                                                    <li><strong>Alternative:</strong> Use keyboard mode with handheld scanners</li>
                                                    <li><strong>Diagnostic:</strong> Run camera diagnostic for detailed info</li>
                                                </>
                                            ) : (
                                                <>
                                                    <li><strong>Camera Mode:</strong> Best for mobile barcode scanning</li>
                                                    <li><strong>Lighting:</strong> Tap flashlight button in low light conditions</li>
                                                    <li><strong>Positioning:</strong> Hold steady and center barcode in frame</li>
                                                    <li><strong>Focus:</strong> Tap camera view to refocus</li>
                                                    <li><strong>Alternative:</strong> Use keyboard mode with handheld scanners</li>
                                                </>
                                            )}
                                        </ul>

                                        {/* HTTPS Warning */}
                                        {!isHTTPS() && (
                                            <div className="mt-2 p-2 bg-red-100 rounded text-red-700 text-xs">
                                                <strong>⚠️ HTTPS Required:</strong> Camera access requires a secure connection.
                                                <br />Please use HTTPS or keyboard mode instead.
                                            </div>
                                        )}

                                        {/* iOS Chrome Warning */}
                                        {isIOS() && navigator.userAgent.includes('Chrome') && (
                                            <div className="mt-2 p-2 bg-orange-100 rounded text-orange-700 text-xs">
                                                <strong>⚠️ Chrome on iOS:</strong> Camera access is severely limited in Chrome on iOS due to Apple's WebKit restrictions.
                                                <br /><strong>Solution:</strong> Open this site in Safari for full camera support.
                                                <br /><strong>Alternative:</strong> Use keyboard mode or run diagnostic for details.
                                            </div>
                                        )}

                                        {/* iOS WebView Warning */}
                                        {isIOS() && navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Version') && (
                                            <div className="mt-2 p-2 bg-red-100 rounded text-red-700 text-xs">
                                                <strong>⚠️ iOS WebView:</strong> You're viewing this in an app's embedded browser.
                                                <br /><strong>Solution:</strong> Tap "Open in Safari" or copy URL to Safari app.
                                                <br />Camera access is blocked in embedded browsers on iOS.
                                            </div>
                                        )}

                                        {/* Android Chrome Tips */}
                                        {isAndroid() && navigator.userAgent.includes('Chrome') && (
                                            <div className="mt-2 p-2 bg-blue-100 rounded text-blue-700 text-xs">
                                                <strong>💡 Android Chrome:</strong> If camera fails, try these solutions:
                                                <br />• Enable "Desktop site" mode (⋮ menu → Desktop site)
                                                <br />• Check permissions: Settings → Apps → Chrome → Permissions → Camera
                                                <br />• Clear Chrome cache: Settings → Apps → Chrome → Storage → Clear Cache
                                                <br />• Close other camera apps and restart browser
                                                <br />• Using the diagnostic button above
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </MaterialCard>
            );
        };

        // Main Firebase App with Material Design
        const MaterialFirebaseApp = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [items, setItems] = useState([]);
            const [users, setUsers] = useState([]);
            const [checkoutHistory, setCheckoutHistory] = useState([]);
            const [archivedCheckouts, setArchivedCheckouts] = useState([]);
            const [checkoutViewMode, setCheckoutViewMode] = useState('current'); // 'current' or 'archive'
            const [activeTab, setActiveTab] = useState('shop');
            const [cart, setCart] = useState([]);
            const [connectionStatus, setConnectionStatus] = useState('connecting');
            const [notifications, setNotifications] = useState([]);
            const [notificationsDismissed, setNotificationsDismissed] = useState(false);
            const [showLowStockPopup, setShowLowStockPopup] = useState(false);
            const [lowStockAlwaysHidden, setLowStockAlwaysHidden] = useState(() => {
                return localStorage.getItem('lowStockAlwaysHidden') === 'true';
            });

            // Edit checkout record state
            const [editCheckoutRecord, setEditCheckoutRecord] = useState(null);
            const [showEditCheckoutModal, setShowEditCheckoutModal] = useState(false);

            // Form states for Add New Item
            const [newItemForm, setNewItemForm] = useState({
                name: '',
                price: '',
                quantity: '',
                category: ''
            });
            const [isCreatingItem, setIsCreatingItem] = useState(false);

            // Edit states for inventory items
            const [editingItemId, setEditingItemId] = useState(null);
            const [editFormData, setEditFormData] = useState({});
            const [isSavingEdit, setIsSavingEdit] = useState(false);

            // Delete states for inventory items
            const [deleteConfirmItem, setDeleteConfirmItem] = useState(null);
            const [isDeletingItem, setIsDeletingItem] = useState(false);

            // Form states for Add New User
            const [newUserForm, setNewUserForm] = useState({
                firstName: '',
                lastName: '',
                costCode: '',
                employeeId: ''
            });

            // Edit User Modal
            const [editingUser, setEditingUser] = useState(null);
            const [editUserForm, setEditUserForm] = useState({
                firstName: '',
                lastName: '',
                costCode: '',
                employeeId: ''
            });
            const [isCreatingUser, setIsCreatingUser] = useState(false);
            const [isUpdatingUser, setIsUpdatingUser] = useState(false);

            // CSV and bulk operation states
            const [csvOperations, setCsvOperations] = useState({
                importingItems: false,
                importingUsers: false,
                exportingItems: false,
                exportingUsers: false,
                itemImportStatus: '',
                userImportStatus: ''
            });

            const [duplicateDialog, setDuplicateDialog] = useState({
                open: false,
                duplicates: [],
                newItems: [],
                choices: {}
            });

            const [userDuplicateDialog, setUserDuplicateDialog] = useState({
                open: false,
                duplicates: [],
                choices: {},
                scanning: false
            });

            const [cleanupDialog, setCleanupDialog] = useState({
                open: false,
                duplicateGroups: [],
                mergeChoices: {},
                scanning: false
            });

            // Pagination states
            const [inventoryPagination, setInventoryPagination] = useState({
                currentPage: 1,
                itemsPerPage: 50,
                totalItems: 0
            });
            const [usersPagination, setUsersPagination] = useState({
                currentPage: 1,
                itemsPerPage: 50,
                totalItems: 0
            });
            const [checkoutPagination, setCheckoutPagination] = useState({
                currentPage: 1,
                itemsPerPage: 50,
                totalItems: 0
            });

            const { isDarkMode, toggleDarkMode } = useTheme();
            const { snackbar, showSnackbar } = useSnackbar();

            // Process Shipment states
            const [pdfFile, setPdfFile] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [receiptDate, setReceiptDate] = useState('');
            const [vendorName, setVendorName] = useState('');
            const [processingNotes, setProcessingNotes] = useState('');
            const [taxAmount, setTaxAmount] = useState(0);
            const [extraFees, setExtraFees] = useState(0);
            const [processingResults, setProcessingResults] = useState([]);

            // Process Shipment item selection states
            const [itemSearchQuery, setItemSearchQuery] = useState('');
            const [selectedShipmentItems, setSelectedShipmentItems] = useState([]);
            const [showQuantityModal, setShowQuantityModal] = useState(false);
            const [shipmentItemDetails, setShipmentItemDetails] = useState({});

            // Shop search states
            const [shopSearchQuery, setShopSearchQuery] = useState('');
            const [userSearchQuery, setUserSearchQuery] = useState('');

            // Users management search state
            const [usersSearchQuery, setUsersSearchQuery] = useState('');

            // Users sorting state
            const [usersSortConfig, setUsersSortConfig] = useState({
                field: 'name',
                direction: 'asc'
            });

            // Checkout history search state
            const [historySearchQuery, setHistorySearchQuery] = useState('');

            // Inventory management search state
            const [inventorySearchQuery, setInventorySearchQuery] = useState('');

            // Pagination handlers
            const handleInventoryPageChange = (page) => {
                setInventoryPagination(prev => ({ ...prev, currentPage: page }));
            };

            const handleInventoryItemsPerPageChange = (itemsPerPage) => {
                setInventoryPagination(prev => ({
                    ...prev,
                    currentPage: 1,
                    itemsPerPage
                }));
            };

            const handleUsersPageChange = (page) => {
                setUsersPagination(prev => ({ ...prev, currentPage: page }));
            };

            const handleUsersItemsPerPageChange = (itemsPerPage) => {
                setUsersPagination(prev => ({
                    ...prev,
                    currentPage: 1,
                    itemsPerPage
                }));
            };

            const handleCheckoutPageChange = (page) => {
                setCheckoutPagination(prev => ({ ...prev, currentPage: page }));
            };

            const handleCheckoutItemsPerPageChange = (itemsPerPage) => {
                setCheckoutPagination(prev => ({
                    ...prev,
                    currentPage: 1,
                    itemsPerPage
                }));
            };

            // Get filtered items for shop
            const getFilteredItems = () => {
                return shopSearchQuery
                    ? items.filter(item =>
                        item.name.toLowerCase().includes(shopSearchQuery.toLowerCase()) ||
                        item.category.toLowerCase().includes(shopSearchQuery.toLowerCase()) ||
                        (item.asin && item.asin.toLowerCase().includes(shopSearchQuery.toLowerCase()))
                    )
                    : items;
            };

            // Get filtered items for inventory management
            const getFilteredInventoryItems = () => {
                if (!inventorySearchQuery.trim()) {
                    return items;
                }

                const searchTerm = inventorySearchQuery.toLowerCase();
                return items.filter(item => {
                    const name = (item.name || '').toLowerCase();
                    const category = (item.category || '').toLowerCase();
                    const asin = (item.asin || '').toLowerCase();

                    return name.includes(searchTerm) ||
                           category.includes(searchTerm) ||
                           asin.includes(searchTerm);
                });
            };

            // Get paginated data for shop
            const getPaginatedItems = () => {
                const filteredItems = getFilteredItems();
                const startIndex = (inventoryPagination.currentPage - 1) * inventoryPagination.itemsPerPage;
                const endIndex = startIndex + inventoryPagination.itemsPerPage;
                return filteredItems.slice(startIndex, endIndex);
            };

            // Get paginated data for inventory management
            const getPaginatedInventoryItems = () => {
                const filteredItems = getFilteredInventoryItems();
                const startIndex = (inventoryPagination.currentPage - 1) * inventoryPagination.itemsPerPage;
                const endIndex = startIndex + inventoryPagination.itemsPerPage;
                return filteredItems.slice(startIndex, endIndex);
            };

            const getFilteredUsers = () => {
                let filteredUsers = users;

                // Apply search filter if search query exists
                if (usersSearchQuery.trim()) {
                    filteredUsers = users.filter(user => {
                        const name = user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim();
                        const costCode = user.costCode || user.cost_code || '';
                        const employeeId = user.employeeId || user.employee_id || '';

                        const searchTerm = usersSearchQuery.toLowerCase();
                        return name.toLowerCase().includes(searchTerm) ||
                               costCode.toLowerCase().includes(searchTerm) ||
                               employeeId.toLowerCase().includes(searchTerm);
                    });
                }

                // Apply sorting
                if (usersSortConfig.field) {
                    filteredUsers.sort((a, b) => {
                        let aValue = '';
                        let bValue = '';

                        switch (usersSortConfig.field) {
                            case 'name':
                                aValue = (a.name || `${a.firstName || ''} ${a.lastName || ''}`.trim()).toLowerCase();
                                bValue = (b.name || `${b.firstName || ''} ${b.lastName || ''}`.trim()).toLowerCase();
                                break;
                            case 'costCode':
                                aValue = (a.costCode || a.cost_code || '').toLowerCase();
                                bValue = (b.costCode || b.cost_code || '').toLowerCase();
                                break;
                            case 'employeeId':
                                aValue = (a.employeeId || a.employee_id || '').toLowerCase();
                                bValue = (b.employeeId || b.employee_id || '').toLowerCase();
                                break;
                            default:
                                return 0;
                        }

                        if (aValue < bValue) return usersSortConfig.direction === 'asc' ? -1 : 1;
                        if (aValue > bValue) return usersSortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                return filteredUsers;
            };

            // Handle users sorting
            const handleSort = (field) => {
                setUsersSortConfig(prev => ({
                    field,
                    direction: prev.field === field && prev.direction === 'asc' ? 'desc' : 'asc'
                }));
            };

            const getPaginatedUsers = () => {
                const filteredUsers = getFilteredUsers();
                const startIndex = (usersPagination.currentPage - 1) * usersPagination.itemsPerPage;
                const endIndex = startIndex + usersPagination.itemsPerPage;
                return filteredUsers.slice(startIndex, endIndex);
            };

            const getFilteredCheckoutHistory = () => {
                const dataSource = checkoutViewMode === 'archive' ? archivedCheckouts : checkoutHistory;

                if (!historySearchQuery.trim()) {
                    return dataSource;
                }

                const searchTerm = historySearchQuery.toLowerCase();
                return dataSource.filter(record => {
                    const itemName = (record.itemName || '').toLowerCase();
                    const userName = (record.userName || '').toLowerCase();
                    const departmentId = (record.departmentId || '').toLowerCase();
                    const jobNum = (record.jobNum || '').toLowerCase();

                    return itemName.includes(searchTerm) ||
                           userName.includes(searchTerm) ||
                           departmentId.includes(searchTerm) ||
                           jobNum.includes(searchTerm);
                });
            };

            const getPaginatedCheckoutHistory = () => {
                const filteredData = getFilteredCheckoutHistory();
                const startIndex = (checkoutPagination.currentPage - 1) * checkoutPagination.itemsPerPage;
                const endIndex = startIndex + checkoutPagination.itemsPerPage;
                return filteredData.slice(startIndex, endIndex);
            };

            // Process Shipment PDF handling
            const handlePdfUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if (file.type !== 'application/pdf') {
                    showSnackbar('Please select a PDF file', 'error');
                    return;
                }

                setPdfFile(file);
                showSnackbar('PDF uploaded successfully! Ready for cost allocation.', 'success');
            };

            const processShipment = async () => {
                if (!pdfFile) {
                    showSnackbar('Please upload a PDF file first', 'error');
                    return;
                }

                if (!selectedShipmentItems || selectedShipmentItems.length === 0) {
                    showSnackbar('Please select items to process first', 'error');
                    return;
                }

                // Validate that all selected items have quantity and price set
                const incompleteItems = selectedShipmentItems.filter(itemName => {
                    const details = shipmentItemDetails[itemName];
                    return !details || !details.quantity || details.quantity <= 0 || !details.price || details.price <= 0;
                });

                if (incompleteItems.length > 0) {
                    showSnackbar(`Please set quantity and price for all items. Missing: ${incompleteItems.join(', ')}`, 'error');
                    return;
                }

                setIsProcessing(true);

                try {
                    // Find checkout history records for selected items
                    const matchedCheckoutRecords = [];
                    const itemsWithoutCheckout = [];

                    for (const itemName of selectedShipmentItems) {
                        const details = shipmentItemDetails[itemName];
                        const matchingRecords = checkoutHistory.filter(record =>
                            record.itemName === itemName
                        );

                        if (matchingRecords.length > 0) {
                            // Distribute quantity across matching records
                            let remainingQty = details.quantity;
                            for (const record of matchingRecords) {
                                if (remainingQty <= 0) break;

                                const allocatedQty = Math.min(record.quantity, remainingQty);
                                const costPerUnit = details.price;

                                // Handle job numbers vs department IDs
                                let displayUser = record.userName;
                                let costCode = record.departmentId || record.costCode || '';

                                // Only show "Job #" if this record actually has a jobNumber field (indicating it was a job checkout)
                                if (record.jobNumber && record.jobNumber.trim()) {
                                    displayUser = `Job #${record.jobNumber}`;
                                    costCode = formatDepartmentId(record.departmentId || record.costCode || '');
                                } else {
                                    // This is a user checkout, format the department ID properly
                                    costCode = formatDepartmentId(costCode);
                                }

                                matchedCheckoutRecords.push({
                                    ...record,
                                    allocatedQuantity: allocatedQty,
                                    unitPrice: costPerUnit,
                                    totalCost: costPerUnit * allocatedQty,
                                    displayUser: displayUser,
                                    costCode: costCode,
                                    shipmentPrice: details.price
                                });

                                remainingQty -= allocatedQty;
                            }

                            // If there's remaining quantity, create an IT Stock entry
                            if (remainingQty > 0) {
                                itemsWithoutCheckout.push({
                                    itemName: itemName,
                                    quantity: remainingQty,
                                    unitPrice: details.price,
                                    totalCost: details.price * remainingQty,
                                    displayUser: 'IT Stock',
                                    costCode: '1-20-000-5770'
                                });
                            }
                        } else {
                            // No checkout records found, bill as IT Stock
                            itemsWithoutCheckout.push({
                                itemName: itemName,
                                quantity: details.quantity,
                                unitPrice: details.price,
                                totalCost: details.price * details.quantity,
                                displayUser: 'IT Stock',
                                costCode: '1-20-000-5770'
                            });
                        }
                    }

                    // Combine matched records and items without checkout
                    const allocation = [...matchedCheckoutRecords, ...itemsWithoutCheckout];

                    // Calculate per-item tax and fee distribution
                    const totalQuantity = allocation.reduce((sum, item) => sum + (item.allocatedQuantity || item.quantity), 0);
                    const taxPerItem = totalQuantity > 0 ? (taxAmount || 0) / totalQuantity : 0;
                    const feePerItem = totalQuantity > 0 ? (extraFees || 0) / totalQuantity : 0;

                    // Update allocation with distributed taxes and fees
                    const allocationWithDistribution = allocation.map(item => {
                        const itemQuantity = item.allocatedQuantity || item.quantity;
                        const itemTaxAllocation = taxPerItem * itemQuantity;
                        const itemFeeAllocation = feePerItem * itemQuantity;
                        const adjustedTotalCost = item.totalCost + itemTaxAllocation + itemFeeAllocation;

                        return {
                            ...item,
                            taxAllocation: itemTaxAllocation,
                            feeAllocation: itemFeeAllocation,
                            adjustedTotalCost: adjustedTotalCost,
                            originalTotalCost: item.totalCost // Keep original for reference
                        };
                    });

                    // Calculate totals using manual input
                    const subtotal = allocation.reduce((sum, item) => sum + item.totalCost, 0);
                    const tax = taxAmount || 0;
                    const fees = extraFees || 0;
                    const total = subtotal + tax + fees;

                    // Update inventory quantities
                    for (const itemName of selectedShipmentItems) {
                        const details = shipmentItemDetails[itemName];
                        const item = items.find(i => i.name === itemName);

                        if (item) {
                            const newQuantity = item.quantity + details.quantity;
                            const newPrice = details.price;

                            // Update item in database
                            await db.collection('items').doc(item.id).update({
                                quantity: newQuantity,
                                price: newPrice
                            });

                            // Update local state
                            setItems(prevItems =>
                                prevItems.map(i =>
                                    i.id === item.id
                                        ? { ...i, quantity: newQuantity, price: newPrice }
                                        : i
                                )
                            );
                        }
                    }

                    // Generate PDF report
                    await generateCostAllocationReport(allocationWithDistribution, { subtotal, tax, fees, total, taxPerItem, feePerItem });

                    // Archive processed checkout records and remove from checkout history
                    await archiveAndRemoveCheckoutRecords(matchedCheckoutRecords);

                    // Update processing results
                    setProcessingResults(prev => [...prev, {
                        timestamp: new Date().toISOString(),
                        fileName: pdfFile.name,
                        itemsProcessed: selectedShipmentItems.length,
                        totalAmount: total,
                        vendor: vendorName || 'Manual Entry'
                    }]);

                    showSnackbar(`Successfully processed ${selectedShipmentItems.length} items and updated inventory!`, 'success');

                    // Reset form
                    setPdfFile(null);
                    setSelectedShipmentItems([]);
                    setShipmentItemDetails({});
                    setTaxAmount(0);
                    setExtraFees(0);
                    setVendorName('');
                    setReceiptDate('');
                    setProcessingNotes('');
                    document.getElementById('pdf-upload').value = '';

                } catch (error) {
                    console.error('Error processing shipment:', error);
                    showSnackbar(`Error processing shipment: ${error.message}`, 'error');
                } finally {
                    setIsProcessing(false);
                }
            };

            const generateCostAllocationReport = async (allocation, totals) => {
                try {
                    const { PDFDocument, rgb, StandardFonts } = PDFLib;

                    // Load the original PDF
                    const originalPdfBytes = await pdfFile.arrayBuffer();
                    const originalPdfDoc = await PDFDocument.load(originalPdfBytes);

                    // Add a new page for the cost allocation report
                    const page = originalPdfDoc.addPage([612, 792]); // Letter size
                    const font = await originalPdfDoc.embedFont(StandardFonts.Helvetica);
                    const boldFont = await originalPdfDoc.embedFont(StandardFonts.HelveticaBold);

                    let y = 750;
                    const leftMargin = 50;

                    // Title
                    page.drawText('Shipment Cost Allocation Report', {
                        x: leftMargin,
                        y,
                        size: 16,
                        font: boldFont,
                        color: rgb(0, 0, 0)
                    });
                    y -= 25;

                    // Metadata
                    const now = new Date();
                    page.drawText(`Generated: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, { x: leftMargin, y, size: 10, font });
                    y -= 15;
                    page.drawText(`Tax ($${totals.tax.toFixed(2)}) and Fees ($${totals.fees.toFixed(2)}) distributed evenly per item`, { x: leftMargin, y, size: 10, font });
                    y -= 30;

                    // Cost Allocation Summary section title
                    page.drawText('Cost Allocation Summary', {
                        x: leftMargin,
                        y,
                        size: 14,
                        font: boldFont,
                        color: rgb(0, 0, 0)
                    });
                    y -= 25;

                    // Table header
                    page.drawText('Item Description', { x: leftMargin, y, size: 10, font: boldFont });
                    page.drawText('Qty', { x: 220, y, size: 10, font: boldFont });
                    page.drawText('Job/Cost Code', { x: 250, y, size: 10, font: boldFont });
                    page.drawText('Units', { x: 360, y, size: 10, font: boldFont });
                    page.drawText('Unit Price', { x: 400, y, size: 10, font: boldFont });
                    page.drawText('Total Cost', { x: 470, y, size: 10, font: boldFont });
                    y -= 20;

                    // Draw line
                    page.drawLine({
                        start: { x: leftMargin, y },
                        end: { x: 550, y },
                        thickness: 1,
                        color: rgb(0, 0, 0)
                    });
                    y -= 15;

                    // Allocation details
                    let currentPage = page;
                    for (const item of allocation) {
                        if (y < 100) {
                            // Add new page if needed
                            currentPage = originalPdfDoc.addPage([612, 792]);
                            y = 750;
                        }

                        const itemName = item.itemName.length > 30 ?
                            item.itemName.substring(0, 30) + '...' : item.itemName;

                        currentPage.drawText(itemName, { x: leftMargin, y, size: 9, font });
                        currentPage.drawText((item.allocatedQuantity || item.quantity).toString(), { x: 220, y, size: 9, font });

                        const costCode = item.costCode || item.departmentId || '-';
                        currentPage.drawText(costCode.length > 15 ? costCode.substring(0, 15) + '...' : costCode, { x: 250, y, size: 9, font });

                        currentPage.drawText((item.allocatedQuantity || item.quantity).toString(), { x: 360, y, size: 9, font });
                        currentPage.drawText(`$${item.unitPrice.toFixed(2)}`, { x: 400, y, size: 9, font });

                        // Show adjusted total cost (includes tax and fees)
                        const finalCost = item.adjustedTotalCost || item.totalCost;
                        currentPage.drawText(`$${finalCost.toFixed(2)}`, { x: 470, y, size: 9, font });
                        y -= 15;
                    }

                    y -= 20;

                    // Financial summary
                    if (y < 150) {
                        currentPage = originalPdfDoc.addPage([612, 792]);
                        y = 750;
                    }

                    // Financial summary without "FINANCIAL SUMMARY" header, just the numbers
                    y -= 10;
                    currentPage.drawText(`Subtotal (Items): $${totals.subtotal.toFixed(2)}`, { x: leftMargin, y, size: 10, font });
                    y -= 15;
                    currentPage.drawText(`Tax: $${totals.tax.toFixed(2)}`, { x: leftMargin, y, size: 10, font });
                    y -= 15;
                    currentPage.drawText(`Fees: $${totals.fees.toFixed(2)}`, { x: leftMargin, y, size: 10, font });
                    y -= 15;
                    currentPage.drawLine({
                        start: { x: leftMargin, y },
                        end: { x: 200, y },
                        thickness: 1,
                        color: rgb(0, 0, 0)
                    });
                    y -= 10;
                    currentPage.drawText(`Grand Total: $${totals.total.toFixed(2)}`, { x: leftMargin, y, size: 12, font: boldFont });

                    // Individual Checkout Details section
                    y -= 40;
                    if (y < 200) {
                        currentPage = originalPdfDoc.addPage([612, 792]);
                        y = 750;
                    }

                    currentPage.drawText('Individual Checkout Details', {
                        x: leftMargin,
                        y,
                        size: 14,
                        font: boldFont,
                        color: rgb(0, 0, 0)
                    });
                    y -= 25;

                    // Individual checkout table header
                    currentPage.drawText('Item Description', { x: leftMargin, y, size: 10, font: boldFont });
                    currentPage.drawText('User', { x: 250, y, size: 10, font: boldFont });
                    currentPage.drawText('Cost Code', { x: 400, y, size: 10, font: boldFont });
                    y -= 20;

                    // Draw line for individual checkout table
                    currentPage.drawLine({
                        start: { x: leftMargin, y },
                        end: { x: 550, y },
                        thickness: 1,
                        color: rgb(0, 0, 0)
                    });
                    y -= 15;

                    // Individual checkout details
                    for (const item of allocation) {
                        if (y < 100) {
                            currentPage = originalPdfDoc.addPage([612, 792]);
                            y = 750;
                        }

                        const itemName = item.itemName.length > 35 ?
                            item.itemName.substring(0, 35) + '...' : item.itemName;
                        const userName = (item.displayUser || item.userName || 'Unknown').toUpperCase();
                        const costCode = item.costCode || item.departmentId || '-';

                        currentPage.drawText(itemName, { x: leftMargin, y, size: 9, font });
                        currentPage.drawText(userName, { x: 250, y, size: 9, font });
                        currentPage.drawText(costCode, { x: 400, y, size: 9, font });
                        y -= 15;
                    }

                    if (processingNotes) {
                        y -= 30;
                        if (y < 100) {
                            currentPage = originalPdfDoc.addPage([612, 792]);
                            y = 750;
                        }
                        currentPage.drawText('NOTES:', { x: leftMargin, y, size: 10, font: boldFont });
                        y -= 15;
                        const notes = processingNotes.length > 80 ? processingNotes.substring(0, 80) + '...' : processingNotes;
                        currentPage.drawText(notes, { x: leftMargin, y, size: 9, font });
                    }

                    // Save the PDF with the original filename (minus extension) + suffix
                    const originalName = pdfFile.name.replace(/\.pdf$/i, '');
                    const pdfBytes = await originalPdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${originalName}-with-allocation.pdf`;
                    link.click();
                    URL.revokeObjectURL(url);

                } catch (error) {
                    console.error('Error generating PDF report:', error);
                    showSnackbar('Failed to append allocation report to PDF. Please try again.', 'error');
                }
            };

            const archiveAndRemoveCheckoutRecords = async (matchedRecords) => {
                try {
                    if (!matchedRecords || matchedRecords.length === 0) {
                        return;
                    }

                    const batch = db.batch();
                    const archiveTimestamp = new Date();

                    // Create archive entries for each processed record
                    for (const record of matchedRecords) {
                        // Create archive document
                        const archiveRef = db.collection('archivedCheckouts').doc();
                        batch.set(archiveRef, {
                            ...record,
                            archivedAt: archiveTimestamp,
                            shipmentDetails: {
                                vendor: vendorName || 'Unknown',
                                receiptDate: receiptDate || null,
                                processedAt: archiveTimestamp,
                                allocatedQuantity: record.allocatedQuantity,
                                unitPrice: record.unitPrice,
                                totalCost: record.totalCost
                            }
                        });

                        // Remove from checkout history
                        if (record.id) {
                            const checkoutRef = db.collection('checkoutHistory').doc(record.id);
                            batch.delete(checkoutRef);
                        }
                    }

                    await batch.commit();

                    // Update local checkout history state
                    const processedIds = matchedRecords.map(r => r.id).filter(Boolean);
                    setCheckoutHistory(prev =>
                        prev.filter(record => !processedIds.includes(record.id))
                    );

                    console.log(`Archived and removed ${matchedRecords.length} checkout records`);
                } catch (error) {
                    console.error('Error archiving checkout records:', error);
                    throw error;
                }
            };

            // Manual archive function for individual records
            const manualArchiveRecord = async (record) => {
                try {
                    const archiveTimestamp = new Date();
                    const batch = db.batch();

                    // Create archive document
                    const archiveRef = db.collection('archivedCheckouts').doc();
                    batch.set(archiveRef, {
                        ...record,
                        archivedAt: archiveTimestamp,
                        manuallyArchived: true,
                        shipmentDetails: {
                            vendor: 'Manual Archive',
                            method: 'Manual'
                        }
                    });

                    // Remove from checkout history
                    if (record.id) {
                        const checkoutRef = db.collection('checkoutHistory').doc(record.id);
                        batch.delete(checkoutRef);
                    }

                    await batch.commit();

                    // Update local state
                    setCheckoutHistory(prev => prev.filter(r => r.id !== record.id));

                    console.log(`Manually archived checkout record for ${record.itemName}`);
                } catch (error) {
                    console.error('Error manually archiving record:', error);
                    alert('Failed to archive record. Please try again.');
                }
            };

            // Un-archive function for archived records
            const unarchiveRecord = async (record) => {
                try {
                    const batch = db.batch();

                    // Create new checkout history document
                    const checkoutRef = db.collection('checkoutHistory').doc();
                    const recordData = { ...record };

                    // Remove archive-specific fields
                    delete recordData.archivedAt;
                    delete recordData.manuallyArchived;
                    delete recordData.shipmentDetails;
                    delete recordData.id; // Remove old ID to get new one

                    batch.set(checkoutRef, recordData);

                    // Remove from archived checkouts
                    if (record.id) {
                        const archiveRef = db.collection('archivedCheckouts').doc(record.id);
                        batch.delete(archiveRef);
                    }

                    await batch.commit();

                    // Update local state
                    setArchivedCheckouts(prev => prev.filter(r => r.id !== record.id));

                    console.log(`Unarchived checkout record for ${record.itemName}`);
                } catch (error) {
                    console.error('Error unarchiving record:', error);
                    alert('Failed to unarchive record. Please try again.');
                }
            };

            // Edit checkout record functions
            const openEditCheckoutModal = (record) => {
                setEditCheckoutRecord({
                    id: record.id,
                    itemName: record.itemName,
                    userName: record.userName,
                    quantity: record.quantity,
                    departmentId: record.departmentId || record.costCode || '',
                    jobNumber: record.jobNumber || '',
                    notes: record.notes || ''
                });
                setShowEditCheckoutModal(true);
            };

            const closeEditCheckoutModal = () => {
                setEditCheckoutRecord(null);
                setShowEditCheckoutModal(false);
            };

            const saveEditCheckoutRecord = async () => {
                if (!editCheckoutRecord || !editCheckoutRecord.id) return;

                try {
                    const docRef = db.collection('checkoutHistory').doc(editCheckoutRecord.id);
                    await docRef.update({
                        itemName: editCheckoutRecord.itemName,
                        userName: editCheckoutRecord.userName,
                        quantity: parseInt(editCheckoutRecord.quantity),
                        departmentId: formatDepartmentId(editCheckoutRecord.departmentId),
                        jobNumber: editCheckoutRecord.jobNumber,
                        notes: editCheckoutRecord.notes,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Update local state
                    setCheckoutHistory(prev => prev.map(record =>
                        record.id === editCheckoutRecord.id
                            ? { ...record, ...editCheckoutRecord, quantity: parseInt(editCheckoutRecord.quantity) }
                            : record
                    ));

                    closeEditCheckoutModal();
                    showSnackbar('Checkout record updated successfully', 'success');
                } catch (error) {
                    console.error('Error updating checkout record:', error);
                    showSnackbar('Failed to update checkout record', 'error');
                }
            };

            const removeProcessedItems = async (processedItems) => {
                try {
                    const batch = db.batch();

                    for (const item of processedItems) {
                        const docRef = db.collection('checkoutHistory').doc(item.id);
                        batch.delete(docRef);
                    }

                    await batch.commit();

                    // Update local state
                    setCheckoutHistory(prev =>
                        prev.filter(record => !processedItems.some(item => item.id === record.id))
                    );

                    console.log(`Removed ${processedItems.length} processed items from checkout history`);
                } catch (error) {
                    console.error('Error removing processed items:', error);
                    throw error;
                }
            };

            // Initialize Firebase with existing data if empty
            const initializeDataIfEmpty = async () => {
                try {
                    // Check if collections are empty
                    const itemsSnapshot = await db.collection('items').limit(1).get();
                    const usersSnapshot = await db.collection('users').limit(1).get();

                    if (itemsSnapshot.empty || usersSnapshot.empty) {
                        showSnackbar('Initializing database with inventory data...', 'info');

                        // Load and populate items
                        if (itemsSnapshot.empty) {
                            const itemsResponse = await fetch('./data/items.json');
                            if (itemsResponse.ok) {
                                const itemsData = await itemsResponse.json();
                                console.log(`Preparing to load ${itemsData.length} items to Firebase`);

                                // Process in batches due to Firestore 500 doc limit
                                const batchSize = 400;
                                for (let i = 0; i < itemsData.length; i += batchSize) {
                                    const batch = db.batch();
                                    const itemsBatch = itemsData.slice(i, i + batchSize);

                                    itemsBatch.forEach(item => {
                                        const docRef = db.collection('items').doc(item.id);
                                        batch.set(docRef, {
                                            ...item,
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                                            createdBy: 'auto-migration'
                                        });
                                    });

                                    await batch.commit();
                                    showSnackbar(`Loaded ${Math.min(i + batchSize, itemsData.length)} / ${itemsData.length} items`, 'info');
                                }

                                showSnackbar(`Successfully loaded all ${itemsData.length} items`, 'success');
                            }
                        }

                        // Load and populate users
                        if (usersSnapshot.empty) {
                            const usersResponse = await fetch('./data/users.json');
                            if (usersResponse.ok) {
                                const usersData = await usersResponse.json();

                                // Process in smaller batches due to Firestore 500 doc limit
                                const batchSize = 400;
                                for (let i = 0; i < usersData.length; i += batchSize) {
                                    const batch = db.batch();
                                    const usersBatch = usersData.slice(i, i + batchSize);

                                    usersBatch.forEach(user => {
                                        const docRef = db.collection('users').doc(user.id);
                                        batch.set(docRef, {
                                            ...user,
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                            createdBy: 'auto-migration',
                                            active: true
                                        });
                                    });

                                    await batch.commit();
                                    showSnackbar(`Loaded ${Math.min(i + batchSize, usersData.length)} / ${usersData.length} users`, 'info');
                                }

                                showSnackbar(`Loaded ${usersData.length} users`, 'success');
                            }
                        }

                        // Optionally load checkout history (limit to recent records due to size)
                        const historySnapshot = await db.collection('checkoutHistory').limit(1).get();
                        if (historySnapshot.empty) {
                            const historyResponse = await fetch('./data/checkoutHistory.json');
                            if (historyResponse.ok) {
                                const historyData = await historyResponse.json();

                                // Only load most recent 500 records to avoid quota issues
                                const recentHistory = historyData
                                    .sort((a, b) => new Date(b.dateEntered) - new Date(a.dateEntered))
                                    .slice(0, 500);

                                const batchSize = 400;
                                for (let i = 0; i < recentHistory.length; i += batchSize) {
                                    const batch = db.batch();
                                    const historyBatch = recentHistory.slice(i, i + batchSize);

                                    historyBatch.forEach(record => {
                                        const docRef = db.collection('checkoutHistory').doc(record.id);
                                        batch.set(docRef, {
                                            ...record,
                                            dateEntered: record.dateEntered ? new Date(record.dateEntered) : firebase.firestore.FieldValue.serverTimestamp(),
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                            createdBy: 'auto-migration'
                                        });
                                    });

                                    await batch.commit();
                                }

                                showSnackbar(`Loaded ${recentHistory.length} recent checkout records`, 'success');
                            }
                        }

                        showSnackbar('Database initialization complete!', 'success');
                    }
                } catch (error) {
                    console.error('Data initialization error:', error);
                    showSnackbar(`Data initialization failed: ${error.message}`, 'error');
                }
            };

            // Real-time data listeners
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    setUser(user);
                    setLoading(false);

                    if (user) {
                        try {
                            setConnectionStatus('connecting');

                            // Check if data needs to be initialized
                            await initializeDataIfEmpty();

                            // Set up real-time listeners with fallback data
                            const itemsUnsubscribe = db.collection('items')
                                .onSnapshot((snapshot) => {
                                    const itemsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                                    // If Firebase is empty, use default items
                                    if (itemsData.length === 0) {
                                        console.log('Firebase collection empty, using default items');
                                        const defaultItems = [
                                            { id: "item001", name: "Dell Monitor 24\"", asin: "B07CVL2D2T", quantity: 15, minThreshold: 5, category: "Electronics", price: 299.99 },
                                            { id: "item002", name: "USB-C Hub", asin: "B08HR6DSLT", quantity: 25, minThreshold: 10, category: "Accessories", price: 49.99 },
                                            { id: "item003", name: "Wireless Mouse", asin: "B07FKMDJQZ", quantity: 30, minThreshold: 15, category: "Accessories", price: 29.99 },
                                            { id: "item004", name: "Ethernet Cable 6ft", asin: "B00N2VIALK", quantity: 50, minThreshold: 20, category: "Cables", price: 12.99 },
                                            { id: "item005", name: "Laptop Stand", asin: "B075GCG36Z", quantity: 8, minThreshold: 3, category: "Accessories", price: 79.99 }
                                        ];
                                        setItems(defaultItems);
                                        checkLowStock(defaultItems);
                                        console.log(`Using ${defaultItems.length} default items`);
                                    } else {
                                        setItems(itemsData);
                                        checkLowStock(itemsData);
                                        console.log(`Loaded ${itemsData.length} items from Firebase`);
                                    }
                                }, (error) => {
                                    console.error('Firebase items error:', error);
                                    // Fallback to default items on error
                                    const defaultItems = [
                                        { id: "item001", name: "Dell Monitor 24\"", asin: "B07CVL2D2T", quantity: 15, minThreshold: 5, category: "Electronics", price: 299.99 },
                                        { id: "item002", name: "USB-C Hub", asin: "B08HR6DSLT", quantity: 25, minThreshold: 10, category: "Accessories", price: 49.99 },
                                        { id: "item003", name: "Wireless Mouse", asin: "B07FKMDJQZ", quantity: 30, minThreshold: 15, category: "Accessories", price: 29.99 },
                                        { id: "item004", name: "Ethernet Cable 6ft", asin: "B00N2VIALK", quantity: 50, minThreshold: 20, category: "Cables", price: 12.99 },
                                        { id: "item005", name: "Laptop Stand", asin: "B075GCG36Z", quantity: 8, minThreshold: 3, category: "Accessories", price: 79.99 }
                                    ];
                                    setItems(defaultItems);
                                    checkLowStock(defaultItems);
                                    console.log(`Firebase error, using ${defaultItems.length} default items`);
                                });

                            const usersUnsubscribe = db.collection('users')
                                .onSnapshot((snapshot) => {
                                    const usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                    setUsers(usersData);
                                    console.log(`Loaded ${usersData.length} users from Firebase`);
                                });

                            const historyUnsubscribe = db.collection('checkoutHistory')
                                .orderBy('dateEntered', 'desc')
                                .limit(500)
                                .onSnapshot((snapshot) => {
                                    const historyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                    setCheckoutHistory(historyData);
                                    console.log(`Loaded ${historyData.length} checkout records from Firebase`);
                                });

                            // Load archived checkouts
                            const archiveUnsubscribe = db.collection('archivedCheckouts')
                                .orderBy('archivedAt', 'desc')
                                .limit(500)
                                .onSnapshot((snapshot) => {
                                    const archiveData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                    setArchivedCheckouts(archiveData);
                                    console.log(`Loaded ${archiveData.length} archived checkout records from Firebase`);
                                });

                            setConnectionStatus('connected');

                            return () => {
                                itemsUnsubscribe();
                                usersUnsubscribe();
                                historyUnsubscribe();
                            };

                        } catch (error) {
                            console.error('Firebase connection error:', error);
                            setConnectionStatus('error');
                            showSnackbar('Connection error: ' + error.message, 'error');
                        }
                    }
                });

                return unsubscribe;
            }, []);

            const checkLowStock = (itemList) => {
                const lowStockItems = itemList.filter(item =>
                    item.quantity <= (item.minThreshold || 5)
                );

                setNotifications(lowStockItems.map(item => ({
                    id: item.id,
                    type: 'warning',
                    message: `Low stock: ${item.name} (${item.quantity} remaining)`
                })));

                // Low stock items are now accessed via clickable button in System Statistics
                // No automatic popup - users click the Low Stock Alerts stat to view details
            };

            const handleNotificationClick = () => {
                // Switch to Inventory tab to show low stock items
                setActiveTab('inventory');
            };

            const dismissNotifications = () => {
                setNotificationsDismissed(true);
            };

            // Popup handlers
            const handlePopupViewInventory = () => {
                setActiveTab('inventory');
                setShowLowStockPopup(false);
            };

            const handlePopupDismiss = () => {
                setShowLowStockPopup(false);
            };

            const handlePopupAlwaysHide = () => {
                setLowStockAlwaysHidden(true);
                localStorage.setItem('lowStockAlwaysHidden', 'true');
                setShowLowStockPopup(false);
                setNotificationsDismissed(true);
            };

            const addToCart = (item, quantity = 1) => {
                const existingIndex = cart.findIndex(cartItem => cartItem.id === item.id);

                if (existingIndex >= 0) {
                    const newCart = [...cart];
                    newCart[existingIndex].cartQuantity += quantity;
                    setCart(newCart);
                } else {
                    setCart(prev => [...prev, { ...item, cartQuantity: quantity }]);
                }

                showSnackbar(`Added ${item.name} to cart`, 'success');
            };

            const removeFromCart = (itemId) => {
                setCart(prev => prev.filter(item => item.id !== itemId));
            };

            const clearCart = () => {
                setCart([]);
            };

            // Item edit functions
            const startEditItem = (item) => {
                setEditingItemId(item.id);
                setEditFormData({
                    name: item.name,
                    price: item.price || '',
                    quantity: item.quantity || 0,
                    category: item.category || '',
                    asin: item.asin || '',
                    minThreshold: item.minThreshold || 5
                });
            };

            const cancelEditItem = () => {
                setEditingItemId(null);
                setEditFormData({});
            };

            const saveEditItem = async () => {
                if (!editingItemId || isSavingEdit) return;

                // Validation
                if (!editFormData.name?.trim()) {
                    showSnackbar('Item name is required', 'error');
                    return;
                }

                if (editFormData.quantity < 0) {
                    showSnackbar('Quantity cannot be negative', 'error');
                    return;
                }

                if (editFormData.price && editFormData.price < 0) {
                    showSnackbar('Price cannot be negative', 'error');
                    return;
                }

                setIsSavingEdit(true);

                try {
                    // Update item in Firebase
                    await db.collection('items').doc(editingItemId).update({
                        name: editFormData.name.trim(),
                        price: parseFloat(editFormData.price) || 0,
                        quantity: parseInt(editFormData.quantity) || 0,
                        category: editFormData.category?.trim() || 'Uncategorized',
                        asin: editFormData.asin?.trim() || '',
                        minThreshold: parseInt(editFormData.minThreshold) || 5,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    showSnackbar('Item updated successfully', 'success');
                    cancelEditItem();
                } catch (error) {
                    console.error('Error updating item:', error);
                    showSnackbar('Failed to update item', 'error');
                } finally {
                    setIsSavingEdit(false);
                }
            };

            const handleEditFormChange = (field, value) => {
                setEditFormData(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            // Item delete functions
            const confirmDeleteItem = (item) => {
                // Cancel any ongoing edit
                if (editingItemId) {
                    cancelEditItem();
                }
                setDeleteConfirmItem(item);
            };

            const cancelDeleteItem = () => {
                setDeleteConfirmItem(null);
            };

            const deleteItem = async () => {
                if (!deleteConfirmItem || isDeletingItem) return;

                setIsDeletingItem(true);

                try {
                    // Delete item from Firebase
                    await db.collection('items').doc(deleteConfirmItem.id).delete();

                    showSnackbar(`Deleted ${deleteConfirmItem.name} successfully`, 'success');
                    cancelDeleteItem();
                } catch (error) {
                    console.error('Error deleting item:', error);
                    showSnackbar('Failed to delete item', 'error');
                } finally {
                    setIsDeletingItem(false);
                }
            };

            // Handle ESC key for delete dialog
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape' && deleteConfirmItem && !isDeletingItem) {
                        cancelDeleteItem();
                    }
                };

                if (deleteConfirmItem) {
                    document.addEventListener('keydown', handleKeyDown);
                    return () => document.removeEventListener('keydown', handleKeyDown);
                }
            }, [deleteConfirmItem, isDeletingItem]);

            // Handle creating new item
            const handleCreateItem = async (e) => {
                e.preventDefault();
                if (!newItemForm.name.trim()) {
                    showSnackbar('Item name is required', 'error');
                    return;
                }

                setIsCreatingItem(true);
                try {
                    const itemData = {
                        name: newItemForm.name.trim(),
                        price: parseFloat(newItemForm.price) || 0,
                        quantity: parseInt(newItemForm.quantity) || 0,
                        category: newItemForm.category.trim() || 'Uncategorized',
                        minThreshold: 5,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: auth.currentUser?.email || 'unknown'
                    };

                    await db.collection('items').add(itemData);

                    // Reset form
                    setNewItemForm({
                        name: '',
                        price: '',
                        quantity: '',
                        category: ''
                    });

                    showSnackbar(`Item "${itemData.name}" created successfully!`, 'success');
                } catch (error) {
                    console.error('Error creating item:', error);
                    showSnackbar(`Failed to create item: ${error.message}`, 'error');
                } finally {
                    setIsCreatingItem(false);
                }
            };

            // Handle creating new user
            const handleCreateUser = async (e) => {
                e.preventDefault();
                if (!newUserForm.firstName.trim() || !newUserForm.lastName.trim()) {
                    showSnackbar('First name and last name are required', 'error');
                    return;
                }

                setIsCreatingUser(true);
                try {
                    const userData = {
                        firstName: newUserForm.firstName.trim(),
                        lastName: newUserForm.lastName.trim(),
                        name: `${newUserForm.firstName.trim()} ${newUserForm.lastName.trim()}`,
                        costCode: formatDepartmentId(newUserForm.costCode.trim()) || `${Date.now()}-5770`,
                        employeeId: newUserForm.employeeId.trim(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: auth.currentUser?.email || 'unknown'
                    };

                    await db.collection('users').add(userData);

                    // Reset form
                    setNewUserForm({
                        firstName: '',
                        lastName: '',
                        costCode: '',
                        employeeId: ''
                    });

                    showSnackbar(`User "${userData.name}" created successfully!`, 'success');
                } catch (error) {
                    console.error('Error creating user:', error);
                    showSnackbar(`Failed to create user: ${error.message}`, 'error');
                } finally {
                    setIsCreatingUser(false);
                }
            };

            // Populate edit form when editing user changes
            useEffect(() => {
                if (editingUser) {
                    setEditUserForm({
                        firstName: editingUser.firstName || '',
                        lastName: editingUser.lastName || '',
                        costCode: editingUser.costCode || editingUser.cost_code || '',
                        employeeId: editingUser.employeeId || editingUser.employee_id || ''
                    });
                }
            }, [editingUser]);

            // Update pagination totals when data changes
            useEffect(() => {
                const filteredItems = getFilteredInventoryItems();
                setInventoryPagination(prev => ({
                    ...prev,
                    totalItems: filteredItems.length,
                    currentPage: 1 // Reset to first page when search changes
                }));
            }, [items, inventorySearchQuery]);

            useEffect(() => {
                const filteredUsers = getFilteredUsers();
                setUsersPagination(prev => ({
                    ...prev,
                    totalItems: filteredUsers.length,
                    currentPage: 1 // Reset to first page when search changes
                }));
            }, [users, usersSearchQuery]);

            useEffect(() => {
                const filteredData = getFilteredCheckoutHistory();
                setCheckoutPagination(prev => ({
                    ...prev,
                    totalItems: filteredData.length,
                    currentPage: 1 // Reset to first page when data or search changes
                }));
            }, [checkoutHistory, archivedCheckouts, checkoutViewMode, historySearchQuery]);

            // Handle Edit User
            const handleUpdateUser = async (e) => {
                e.preventDefault();
                if (!editUserForm.firstName.trim() || !editUserForm.lastName.trim()) {
                    showSnackbar('First name and last name are required', 'error');
                    return;
                }

                setIsUpdatingUser(true);
                try {
                    const updatedUserData = {
                        firstName: editUserForm.firstName.trim(),
                        lastName: editUserForm.lastName.trim(),
                        name: `${editUserForm.firstName.trim()} ${editUserForm.lastName.trim()}`,
                        costCode: formatDepartmentId(editUserForm.costCode.trim()) || `${Date.now()}-5770`,
                        employeeId: editUserForm.employeeId.trim(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: user?.email || 'anonymous'
                    };

                    await db.collection('users').doc(editingUser.id).update(updatedUserData);

                    // Update local state
                    setUsers(prev => prev.map(u =>
                        u.id === editingUser.id ? { ...u, ...updatedUserData } : u
                    ));

                    setEditingUser(null);
                    setEditUserForm({
                        firstName: '',
                        lastName: '',
                        costCode: '',
                        department: ''
                    });

                    showSnackbar(`User "${updatedUserData.name}" updated successfully!`, 'success');
                } catch (error) {
                    console.error('Error updating user:', error);
                    showSnackbar(`Failed to update user: ${error.message}`, 'error');
                } finally {
                    setIsUpdatingUser(false);
                }
            };

            // CSV Export Functions
            const exportItemsToCSV = async () => {
                setCsvOperations(prev => ({ ...prev, exportingItems: true }));
                try {
                    const csvHeader = 'Item Name,Category,Quantity,Price,Min Threshold\n';
                    const csvRows = items.map(item =>
                        `"${(item.name || '').replace(/"/g, '""')}","${(item.category || '').replace(/"/g, '""')}",${item.quantity || 0},${item.price || 0},${item.minThreshold || 5}`
                    ).join('\n');

                    const csvContent = csvHeader + csvRows;
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `inventory-items-${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();

                    showSnackbar(`Exported ${items.length} items to CSV`, 'success');
                } catch (error) {
                    showSnackbar(`Export failed: ${error.message}`, 'error');
                } finally {
                    setCsvOperations(prev => ({ ...prev, exportingItems: false }));
                }
            };

            const exportUsersToCSV = async () => {
                setCsvOperations(prev => ({ ...prev, exportingUsers: true }));
                try {
                    const csvHeader = 'First Name,Last Name,Full Name,Cost Code,Employee ID\n';
                    const csvRows = users.map(user =>
                        `"${(user.firstName || '').replace(/"/g, '""')}","${(user.lastName || '').replace(/"/g, '""')}","${(user.name || '').replace(/"/g, '""')}","${formatDepartmentId(user.costCode || user.cost_code || '').replace(/"/g, '""')}","${(user.employeeId || user.employee_id || '').replace(/"/g, '""')}"`
                    ).join('\n');

                    const csvContent = csvHeader + csvRows;
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `inventory-users-${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();

                    showSnackbar(`Exported ${users.length} users to CSV`, 'success');
                } catch (error) {
                    showSnackbar(`Export failed: ${error.message}`, 'error');
                } finally {
                    setCsvOperations(prev => ({ ...prev, exportingUsers: false }));
                }
            };

            // Manual data refresh function for troubleshooting
            const refreshDataFromFiles = async () => {
                try {
                    showSnackbar('Starting manual data refresh...', 'info');

                    // Force reload all data regardless of current state
                    const [itemsResponse, usersResponse, historyResponse] = await Promise.all([
                        fetch('./data/items.json'),
                        fetch('./data/users.json'),
                        fetch('./data/checkoutHistory.json')
                    ]);

                    if (itemsResponse.ok) {
                        const itemsData = await itemsResponse.json();
                        console.log(`Refreshing ${itemsData.length} items in Firebase`);

                        // Clear existing items first
                        const existingItems = await db.collection('items').get();
                        if (!existingItems.empty) {
                            const deleteBatch = db.batch();
                            existingItems.docs.forEach(doc => deleteBatch.delete(doc.ref));
                            await deleteBatch.commit();
                        }

                        // Add all items in batches
                        const batchSize = 400;
                        for (let i = 0; i < itemsData.length; i += batchSize) {
                            const batch = db.batch();
                            const itemsBatch = itemsData.slice(i, i + batchSize);

                            itemsBatch.forEach(item => {
                                const docRef = db.collection('items').doc(item.id);
                                batch.set(docRef, {
                                    ...item,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                                    createdBy: 'manual-refresh'
                                });
                            });

                            await batch.commit();
                            showSnackbar(`Refreshed ${Math.min(i + batchSize, itemsData.length)} / ${itemsData.length} items`, 'info');
                        }
                    }

                    if (usersResponse.ok) {
                        const usersData = await usersResponse.json();
                        console.log(`Refreshing ${usersData.length} users in Firebase`);

                        // Clear existing users first
                        const existingUsers = await db.collection('users').get();
                        if (!existingUsers.empty) {
                            const deleteBatch = db.batch();
                            existingUsers.docs.forEach(doc => deleteBatch.delete(doc.ref));
                            await deleteBatch.commit();
                        }

                        // Add all users in batches
                        const batchSize = 400;
                        for (let i = 0; i < usersData.length; i += batchSize) {
                            const batch = db.batch();
                            const usersBatch = usersData.slice(i, i + batchSize);

                            usersBatch.forEach(user => {
                                const docRef = db.collection('users').doc(user.id);
                                batch.set(docRef, {
                                    ...user,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    createdBy: 'manual-refresh',
                                    active: true
                                });
                            });

                            await batch.commit();
                            showSnackbar(`Refreshed ${Math.min(i + batchSize, usersData.length)} / ${usersData.length} users`, 'info');
                        }
                    }

                    showSnackbar('Manual data refresh completed successfully!', 'success');
                } catch (error) {
                    console.error('Manual refresh error:', error);
                    showSnackbar(`Manual refresh failed: ${error.message}`, 'error');
                }
            };

            // Duplicate Detection Functions
            const findDuplicateItems = async (newItems) => {
                try {
                    const duplicates = [];
                    const snapshot = await db.collection('items').get();
                    const existingItems = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    for (const newItem of newItems) {
                        const existingItem = existingItems.find(existing =>
                            existing.name.toLowerCase().trim() === newItem.name.toLowerCase().trim() ||
                            (newItem.asin && existing.asin && existing.asin.toLowerCase().trim() === newItem.asin.toLowerCase().trim())
                        );

                        if (existingItem) {
                            duplicates.push({
                                newItem,
                                existingItem,
                                matchType: existingItem.name.toLowerCase().trim() === newItem.name.toLowerCase().trim() ? 'name' : 'asin'
                            });
                        }
                    }

                    return duplicates;
                } catch (error) {
                    console.error('Error finding duplicates:', error);
                    return [];
                }
            };

            const processDuplicateChoices = async (newItems, duplicateChoices) => {
                let successCount = 0;
                let errorCount = 0;
                const processedItems = new Set();

                for (const newItem of newItems) {
                    try {
                        const itemKey = newItem.name.toLowerCase().trim();
                        if (processedItems.has(itemKey)) continue;

                        const choice = duplicateChoices[itemKey];

                        if (choice?.action === 'skip') {
                            continue;
                        } else if (choice?.action === 'update') {
                            const existingItem = choice.existingItem;
                            const updateData = {
                                quantity: (existingItem.quantity || 0) + (newItem.quantity || 0),
                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedBy: auth.currentUser?.email || 'csv-import'
                            };

                            if (newItem.price && newItem.price > 0) updateData.price = newItem.price;
                            if (newItem.category) updateData.category = newItem.category;
                            if (newItem.asin) updateData.asin = newItem.asin;
                            if (newItem.minThreshold) updateData.minThreshold = newItem.minThreshold;

                            await db.collection('items').doc(existingItem.id).update(updateData);
                            successCount++;
                        } else if (choice?.action === 'replace') {
                            const existingItem = choice.existingItem;
                            const replaceData = {
                                ...newItem,
                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedBy: auth.currentUser?.email || 'csv-import',
                                createdAt: existingItem.createdAt,
                                createdBy: existingItem.createdBy
                            };

                            await db.collection('items').doc(existingItem.id).update(replaceData);
                            successCount++;
                        } else if (choice?.action === 'create') {
                            const createData = {
                                ...newItem,
                                name: choice.newName || newItem.name,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                                createdBy: auth.currentUser?.email || 'csv-import'
                            };

                            await db.collection('items').add(createData);
                            successCount++;
                        } else {
                            // No duplicate, create new item
                            const createData = {
                                ...newItem,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                                createdBy: auth.currentUser?.email || 'csv-import'
                            };

                            await db.collection('items').add(createData);
                            successCount++;
                        }

                        processedItems.add(itemKey);
                    } catch (error) {
                        errorCount++;
                        console.error('Error processing item:', error);
                    }
                }

                return { successCount, errorCount };
            };

            // CSV Import Functions
            const handleItemsImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setCsvOperations(prev => ({ ...prev, importingItems: true, itemImportStatus: 'Reading file...' }));
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        setCsvOperations(prev => ({ ...prev, itemImportStatus: 'Parsing CSV data...' }));
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());

                        setCsvOperations(prev => ({ ...prev, itemImportStatus: `Processing ${lines.length - 1} rows...` }));
                        // Parse all items first
                        const newItems = [];
                        let parseErrors = 0;

                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;

                            try {
                                const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                                const item = {};

                                headers.forEach((header, index) => {
                                    switch(header.toLowerCase()) {
                                        case 'item':
                                        case 'item name':
                                        case 'name':
                                            item.name = values[index];
                                            break;
                                        case 'category':
                                            item.category = values[index] || 'Uncategorized';
                                            break;
                                        case 'quantity':
                                        case 'stock quantity':
                                            item.quantity = parseInt(values[index]) || 0;
                                            break;
                                        case 'price':
                                            item.price = parseFloat(values[index]) || 0;
                                            break;
                                        case 'asin':
                                            item.asin = values[index];
                                            break;
                                        case 'min threshold':
                                        case 'minimum threshold':
                                            item.minThreshold = parseInt(values[index]) || 5;
                                            break;
                                    }
                                });

                                if (!item.name?.trim()) {
                                    parseErrors++;
                                    continue;
                                }

                                // Set defaults
                                item.category = item.category || 'Uncategorized';
                                item.quantity = item.quantity || 0;
                                item.price = item.price || 0;
                                item.minThreshold = item.minThreshold || 5;

                                newItems.push(item);
                            } catch (itemError) {
                                parseErrors++;
                                console.error('Error parsing item:', itemError);
                            }
                        }

                        if (newItems.length === 0) {
                            showSnackbar(
                                parseErrors > 0
                                    ? `No valid items found. ${parseErrors} parsing errors.`
                                    : 'No items found in CSV file.',
                                'warning'
                            );
                            setCsvOperations(prev => ({ ...prev, importingItems: false, itemImportStatus: '' }));
                            event.target.value = '';
                            return;
                        }

                        // Check for duplicates
                        setCsvOperations(prev => ({ ...prev, itemImportStatus: 'Checking for duplicates...' }));
                        const duplicates = await findDuplicateItems(newItems);

                        if (duplicates.length > 0) {
                            // Show duplicate dialog
                            const initialChoices = {};
                            duplicates.forEach(duplicate => {
                                const itemKey = duplicate.newItem.name.toLowerCase().trim();
                                initialChoices[itemKey] = {
                                    action: 'skip',
                                    existingItem: duplicate.existingItem
                                };
                            });

                            setDuplicateDialog({
                                open: true,
                                duplicates,
                                newItems,
                                choices: initialChoices
                            });

                            setCsvOperations(prev => ({ ...prev, importingItems: false, itemImportStatus: '' }));
                        } else {
                            // No duplicates, proceed with direct import
                            setCsvOperations(prev => ({ ...prev, itemImportStatus: `Importing ${newItems.length} items...` }));
                            const { successCount, errorCount } = await processDuplicateChoices(newItems, {});

                            showSnackbar(
                                `Import completed: ${successCount} items added, ${errorCount} errors`,
                                successCount > 0 ? 'success' : 'warning'
                            );

                            setCsvOperations(prev => ({ ...prev, importingItems: false, itemImportStatus: '' }));
                        }

                        event.target.value = ''; // Reset file input
                    } catch (error) {
                        showSnackbar(`Import failed: ${error.message}`, 'error');
                        setCsvOperations(prev => ({ ...prev, importingItems: false, itemImportStatus: '' }));
                        event.target.value = '';
                    }
                };

                reader.readAsText(file);
            };

            const handleUsersImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setCsvOperations(prev => ({ ...prev, importingUsers: true, userImportStatus: 'Reading file...' }));
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        setCsvOperations(prev => ({ ...prev, userImportStatus: 'Parsing CSV data...' }));
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());

                        setCsvOperations(prev => ({ ...prev, userImportStatus: `Processing ${lines.length - 1} user records...` }));
                        // Parse all users from CSV first
                        const newUsers = [];
                        let parseErrorCount = 0;

                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;

                            try {
                                const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                                const user = { tempId: `csv-${i}` }; // Temporary ID for duplicate detection

                                headers.forEach((header, index) => {
                                    switch(header.toLowerCase()) {
                                        case 'first name':
                                        case 'firstname':
                                            user.firstName = values[index];
                                            break;
                                        case 'last name':
                                        case 'lastname':
                                            user.lastName = values[index];
                                            break;
                                        case 'cost code':
                                        case 'costcode':
                                            user.costCode = values[index];
                                            break;
                                        case 'employee id':
                                        case 'employeeid':
                                        case 'employee_id':
                                            user.employeeId = values[index];
                                            break;
                                    }
                                });

                                if (!user.firstName || !user.lastName || !user.costCode) {
                                    parseErrorCount++;
                                    continue;
                                }

                                user.name = `${user.firstName} ${user.lastName}`;

                                // Format cost code to ensure proper x-xx-xxx-5770 format
                                if (user.costCode) {
                                    user.costCode = formatDepartmentId(user.costCode);
                                }

                                newUsers.push(user);
                            } catch (userError) {
                                parseErrorCount++;
                                console.error('Error parsing user:', userError);
                            }
                        }

                        if (newUsers.length === 0) {
                            showSnackbar(`No valid users found in CSV. ${parseErrorCount} parsing errors.`, 'warning');
                            setCsvOperations(prev => ({ ...prev, importingUsers: false, userImportStatus: '' }));
                            return;
                        }

                        // Check for duplicates
                        setCsvOperations(prev => ({ ...prev, userImportStatus: 'Checking for duplicate users...' }));
                        const duplicateGroups = await findUserDuplicates(newUsers);

                        if (duplicateGroups.length > 0) {
                            // Show duplicate preview dialog
                            const duplicateInfo = duplicateGroups.map(group => {
                                const existing = group.users.filter(u => u.id); // Existing users (have IDs)
                                const csvUsers = group.users.filter(u => u.tempId); // CSV users (have tempIds)
                                return {
                                    name: group.name,
                                    matchType: group.primaryMatch,
                                    existing: existing.length,
                                    csvDuplicates: csvUsers.length,
                                    costCodes: [...new Set(group.users.map(u => u.costCode).filter(Boolean))]
                                };
                            });

                            const totalDuplicates = duplicateGroups.reduce((sum, group) =>
                                sum + group.users.filter(u => u.tempId).length, 0);

                            const action = prompt(
                                `🔍 DUPLICATE USERS FOUND!\n\n` +
                                `Found ${duplicateGroups.length} duplicate groups affecting ${totalDuplicates} users from your CSV:\n\n` +
                                duplicateInfo.map(info =>
                                    `• ${info.name}: ${info.csvDuplicates} CSV duplicates, ${info.existing} existing users\n` +
                                    `  Match: ${info.matchType === 'costCode' ? 'Cost Code' :
                                             info.matchType === 'name' ? 'Full Name' : 'Employee ID'}\n` +
                                    `  Cost Codes: ${info.costCodes.join(', ')}`
                                ).join('\n\n') +
                                `\n\n📝 WHAT WOULD YOU LIKE TO DO?\n\n` +
                                `1️⃣ UPDATE existing users with CSV data\n` +
                                `   (Recommended! Adds missing Employee IDs to existing users)\n\n` +
                                `2️⃣ SKIP duplicates, import only new users\n` +
                                `   (Will import ${newUsers.length - totalDuplicates} completely new users)\n\n` +
                                `3️⃣ CANCEL import\n` +
                                `   (Stop import so you can review your CSV file)\n\n` +
                                `💡 TIP: Choose 1 to add Employee IDs to users who don't have them!\n\n` +
                                `Please enter 1, 2, or 3:`
                            );

                            if (action === '3' || action === null) {
                                showSnackbar('Import cancelled. Please review CSV for duplicates.', 'info');
                                setCsvOperations(prev => ({ ...prev, importingUsers: false, userImportStatus: '' }));
                                return;
                            }

                            if (action === '1') {
                                // UPDATE existing users with CSV data
                                setCsvOperations(prev => ({ ...prev, userImportStatus: `Updating ${totalDuplicates} existing users...` }));
                                showSnackbar(`Updating ${totalDuplicates} existing users with CSV data...`, 'info');

                                let updatedCount = 0;
                                let errorCount = 0;

                                for (const group of duplicateGroups) {
                                    const existingUsers = group.users.filter(u => u.id);
                                    const csvUsers = group.users.filter(u => u.tempId);

                                    for (const csvUser of csvUsers) {
                                        try {
                                            // Find the matching existing user (first match)
                                            const existingUser = existingUsers[0];
                                            if (existingUser) {
                                                // Prepare update data - only update fields that have values in CSV
                                                const updateData = {
                                                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                                                    updatedBy: auth.currentUser?.email || 'csv-import'
                                                };

                                                // Update fields only if CSV has values
                                                if (csvUser.firstName && csvUser.firstName.trim()) {
                                                    updateData.firstName = csvUser.firstName.trim();
                                                }
                                                if (csvUser.lastName && csvUser.lastName.trim()) {
                                                    updateData.lastName = csvUser.lastName.trim();
                                                }
                                                if (csvUser.firstName && csvUser.lastName) {
                                                    updateData.name = `${csvUser.firstName.trim()} ${csvUser.lastName.trim()}`;
                                                }
                                                if (csvUser.costCode && csvUser.costCode.trim()) {
                                                    updateData.costCode = formatDepartmentId(csvUser.costCode.trim());
                                                }
                                                if (csvUser.employeeId && csvUser.employeeId.trim()) {
                                                    updateData.employeeId = csvUser.employeeId.trim();
                                                }

                                                await db.collection('users').doc(existingUser.id).update(updateData);
                                                updatedCount++;
                                            }
                                        } catch (error) {
                                            console.error('Error updating user:', error);
                                            errorCount++;
                                        }
                                    }
                                }

                                // Filter out users that were updated (remove from import list)
                                const duplicateIds = new Set();
                                duplicateGroups.forEach(group => {
                                    group.users.filter(u => u.tempId).forEach(u => duplicateIds.add(u.tempId));
                                });

                                const usersToImport = newUsers.filter(user => !duplicateIds.has(user.tempId));
                                newUsers.length = 0; // Clear original array
                                newUsers.push(...usersToImport); // Replace with filtered users

                                showSnackbar(`Updated ${updatedCount} existing users${errorCount > 0 ? `, ${errorCount} errors` : ''}. Importing ${usersToImport.length} new users...`, 'success');

                            } else if (action === '2') {
                                // SKIP duplicates (original behavior)
                                const duplicateIds = new Set();
                                duplicateGroups.forEach(group => {
                                    group.users.filter(u => u.tempId).forEach(u => duplicateIds.add(u.tempId));
                                });

                                const usersToImport = newUsers.filter(user => !duplicateIds.has(user.tempId));
                                showSnackbar(`Skipping ${totalDuplicates} duplicates. Importing ${usersToImport.length} unique users...`, 'info');

                                newUsers.length = 0; // Clear original array
                                newUsers.push(...usersToImport); // Replace with filtered users
                            } else {
                                showSnackbar('Invalid choice. Import cancelled.', 'error');
                                return;
                            }
                        }

                        // Import users (no duplicates at this point)
                        let successCount = 0;
                        let errorCount = 0;

                        for (const user of newUsers) {
                            try {
                                // Remove tempId before saving
                                delete user.tempId;

                                user.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                                user.createdBy = auth.currentUser?.email || 'csv-import';

                                await db.collection('users').add(user);
                                successCount++;
                            } catch (userError) {
                                errorCount++;
                                console.error('Error importing user:', userError);
                            }
                        }

                        const skippedCount = duplicateGroups.length > 0 ?
                            duplicateGroups.reduce((sum, group) =>
                                sum + group.users.filter(u => u.tempId).length, 0) : 0;

                        let message = `Import completed: ${successCount} users added`;
                        if (errorCount > 0) message += `, ${errorCount} errors`;
                        if (parseErrorCount > 0) message += `, ${parseErrorCount} parsing errors`;
                        if (skippedCount > 0) message += `, ${skippedCount} duplicates skipped`;

                        showSnackbar(message, successCount > 0 ? 'success' : 'warning');
                    } catch (error) {
                        showSnackbar(`Import failed: ${error.message}`, 'error');
                    } finally {
                        setCsvOperations(prev => ({ ...prev, importingUsers: false, userImportStatus: '' }));
                        event.target.value = ''; // Reset file input
                    }
                };

                reader.readAsText(file);
            };

            // Duplicate Cleanup Functions
            const findExistingDuplicates = async () => {
                try {
                    const snapshot = await db.collection('items').get();
                    const allItems = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    const duplicateGroups = [];
                    const processed = new Set();

                    for (const item of allItems) {
                        if (processed.has(item.id)) continue;

                        const duplicates = allItems.filter(other =>
                            other.id !== item.id &&
                            !processed.has(other.id) &&
                            (
                                other.name.toLowerCase().trim() === item.name.toLowerCase().trim() ||
                                (item.asin && other.asin && item.asin.toLowerCase().trim() === other.asin.toLowerCase().trim())
                            )
                        );

                        if (duplicates.length > 0) {
                            const group = [item, ...duplicates];
                            group.forEach(dup => processed.add(dup.id));
                            duplicateGroups.push({
                                name: item.name,
                                items: group,
                                totalQuantity: group.reduce((sum, dup) => sum + (dup.quantity || 0), 0),
                                matchType: duplicates.some(dup => dup.name.toLowerCase().trim() === item.name.toLowerCase().trim()) ? 'name' : 'asin'
                            });
                        }
                    }

                    return duplicateGroups;
                } catch (error) {
                    console.error('Error finding existing duplicates:', error);
                    return [];
                }
            };

            const mergeDuplicateGroup = async (group, keepItemId, deleteOtherIds) => {
                try {
                    const keepItem = group.items.find(item => item.id === keepItemId);
                    const otherItems = group.items.filter(item => item.id !== keepItemId);

                    // Calculate merged quantities and data
                    const mergedQuantity = group.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                    const highestPrice = Math.max(...group.items.map(item => item.price || 0));
                    const mostRecentCategory = group.items
                        .filter(item => item.category)
                        .sort((a, b) => (b.lastUpdated?.toDate() || new Date(0)) - (a.lastUpdated?.toDate() || new Date(0)))[0]?.category || keepItem.category;

                    // Update the kept item with merged data
                    await db.collection('items').doc(keepItemId).update({
                        quantity: mergedQuantity,
                        price: highestPrice,
                        category: mostRecentCategory,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: auth.currentUser?.email || 'duplicate-cleanup',
                        mergedFrom: otherItems.map(item => ({ id: item.id, name: item.name, quantity: item.quantity }))
                    });

                    // Delete the duplicate items
                    const batch = db.batch();
                    deleteOtherIds.forEach(id => {
                        batch.delete(db.collection('items').doc(id));
                    });
                    await batch.commit();

                    return { success: true, mergedQuantity, deletedCount: deleteOtherIds.length };
                } catch (error) {
                    console.error('Error merging duplicate group:', error);
                    return { success: false, error: error.message };
                }
            };

            // User Duplicate Detection Functions
            const findUserDuplicates = async (newUsers = []) => {
                try {
                    const snapshot = await db.collection('users').get();
                    const existingUsers = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    const allUsers = [...existingUsers, ...newUsers];
                    const duplicates = [];
                    const processed = new Set();

                    for (const user of allUsers) {
                        if (processed.has(user.id || user.tempId)) continue;

                        const potentialDuplicates = allUsers.filter(other => {
                            const otherId = other.id || other.tempId;
                            if (otherId === (user.id || user.tempId) || processed.has(otherId)) return false;

                            // Check for employee ID match (primary identifier)
                            if (user.employeeId && other.employeeId && user.employeeId.toLowerCase().trim() === other.employeeId.toLowerCase().trim()) {
                                return true;
                            }

                            // Check for exact name match
                            const userName = (user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim()).toLowerCase();
                            const otherName = (other.name || `${other.firstName || ''} ${other.lastName || ''}`.trim()).toLowerCase();

                            if (userName && otherName && userName === otherName) {
                                return true;
                            }

                            // Check for email match if available
                            if (user.email && other.email && user.email.toLowerCase() === other.email.toLowerCase()) {
                                return true;
                            }

                            return false;
                        });

                        if (potentialDuplicates.length > 0) {
                            const group = [user, ...potentialDuplicates];
                            group.forEach(dup => processed.add(dup.id || dup.tempId));

                            duplicates.push({
                                users: group,
                                primaryMatch: group.some(u => formatDepartmentId(u.costCode) === formatDepartmentId(user.costCode)) ? 'costCode' :
                                           group.some(u => (u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim()).toLowerCase() ===
                                                      (user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim()).toLowerCase()) ? 'name' : 'email',
                                name: user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim()
                            });
                        }
                    }

                    return duplicates;
                } catch (error) {
                    console.error('Error finding user duplicates:', error);
                    return [];
                }
            };

            const findExistingUserDuplicates = async () => {
                try {
                    const snapshot = await db.collection('users').get();
                    const allUsers = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    const duplicateGroups = [];
                    const processed = new Set();

                    for (const user of allUsers) {
                        if (processed.has(user.id)) continue;

                        const duplicates = allUsers.filter(other =>
                            other.id !== user.id &&
                            !processed.has(other.id) &&
                            (
                                // Primary: Employee ID match
                                (user.employeeId && other.employeeId && user.employeeId.toLowerCase().trim() === other.employeeId.toLowerCase().trim()) ||
                                // Secondary: Exact name match
                                (user.name && other.name && user.name.toLowerCase().trim() === other.name.toLowerCase().trim()) ||
                                // Tertiary: First + Last name match
                                (user.firstName && user.lastName && other.firstName && other.lastName &&
                                 user.firstName.toLowerCase().trim() === other.firstName.toLowerCase().trim() &&
                                 user.lastName.toLowerCase().trim() === other.lastName.toLowerCase().trim()) ||
                                // Quaternary: Email match
                                (user.email && other.email && user.email.toLowerCase().trim() === other.email.toLowerCase().trim())
                            )
                        );

                        if (duplicates.length > 0) {
                            const group = [user, ...duplicates];
                            group.forEach(dup => processed.add(dup.id));
                            duplicateGroups.push({
                                name: user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim(),
                                users: group,
                                matchType: duplicates.some(dup => formatDepartmentId(dup.costCode) === formatDepartmentId(user.costCode)) ? 'costCode' :
                                          duplicates.some(dup => dup.name?.toLowerCase().trim() === user.name?.toLowerCase().trim()) ? 'name' :
                                          duplicates.some(dup => dup.firstName?.toLowerCase().trim() === user.firstName?.toLowerCase().trim() &&
                                                               dup.lastName?.toLowerCase().trim() === user.lastName?.toLowerCase().trim()) ? 'fullName' : 'email'
                            });
                        }
                    }

                    return duplicateGroups;
                } catch (error) {
                    console.error('Error finding existing user duplicates:', error);
                    return [];
                }
            };

            const mergeUserDuplicateGroup = async (group, keepUserId, deleteOtherIds) => {
                try {
                    const keepUser = group.users.find(user => user.id === keepUserId);
                    const otherUsers = group.users.filter(user => user.id !== keepUserId);

                    // Merge user data - prefer non-empty values
                    const mergedData = {
                        ...keepUser,
                        // Merge name fields
                        firstName: keepUser.firstName || otherUsers.find(u => u.firstName)?.firstName || '',
                        lastName: keepUser.lastName || otherUsers.find(u => u.lastName)?.lastName || '',
                        email: keepUser.email || otherUsers.find(u => u.email)?.email || '',
                        // Prefer most complete cost code
                        costCode: formatDepartmentId(keepUser.costCode || otherUsers.find(u => u.costCode)?.costCode || ''),
                        employeeId: keepUser.employeeId || keepUser.employee_id || otherUsers.find(u => u.employeeId || u.employee_id)?.employeeId || otherUsers.find(u => u.employeeId || u.employee_id)?.employee_id || '',
                        // Merge any other fields
                        mergedFrom: otherUsers.map(u => u.id),
                        mergedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        mergedBy: auth.currentUser?.email || 'system'
                    };

                    // Update the keep user with merged data
                    await db.collection('users').doc(keepUserId).update(mergedData);

                    // Update checkout history to point to the kept user
                    const checkoutSnapshot = await db.collection('checkoutHistory')
                        .where('userId', 'in', deleteOtherIds)
                        .get();

                    const archivedSnapshot = await db.collection('archivedCheckouts')
                        .where('userId', 'in', deleteOtherIds)
                        .get();

                    const batch = db.batch();

                    // Update checkout history references
                    checkoutSnapshot.docs.forEach(doc => {
                        batch.update(doc.ref, {
                            userId: keepUserId,
                            userName: mergedData.name || `${mergedData.firstName} ${mergedData.lastName}`.trim()
                        });
                    });

                    // Update archived checkout references
                    archivedSnapshot.docs.forEach(doc => {
                        batch.update(doc.ref, {
                            userId: keepUserId,
                            userName: mergedData.name || `${mergedData.firstName} ${mergedData.lastName}`.trim()
                        });
                    });

                    // Delete the duplicate users
                    deleteOtherIds.forEach(id => {
                        batch.delete(db.collection('users').doc(id));
                    });

                    await batch.commit();

                    return { success: true, mergedData };
                } catch (error) {
                    console.error('Error merging user duplicate group:', error);
                    return { success: false, error: error.message };
                }
            };

            // Bulk Operations
            const handleResetAllQuantities = async () => {
                if (!confirm('Are you sure you want to reset ALL item quantities to zero? This cannot be undone.')) {
                    return;
                }

                try {
                    const batch = db.batch();
                    items.forEach(item => {
                        const itemRef = db.collection('items').doc(item.id);
                        batch.update(itemRef, {
                            quantity: 0,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });

                    await batch.commit();
                    showSnackbar(`Reset quantities for ${items.length} items`, 'success');
                } catch (error) {
                    showSnackbar(`Bulk reset failed: ${error.message}`, 'error');
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
                        <div className="text-center">
                            <div className="mat-spinner w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                            <p className="text-gray-600 dark:text-gray-400">Loading Firebase App...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return (
                    <>
                        <AuthComponent />
                        <MaterialSnackbar snackbar={snackbar} />
                    </>
                );
            }

            const tabs = [
                { id: 'shop', name: 'Shop', icon: 'storefront', count: cart.length },
                { id: 'inventory', name: 'Inventory', icon: 'inventory_2', count: items.length },
                { id: 'users', name: 'Users', icon: 'people', count: users.length },
                { id: 'admin', name: 'Admin', icon: 'admin_panel_settings' },
                { id: 'shipment', name: 'Process Shipment', icon: 'local_shipping' },
                { id: 'history', name: 'History', icon: 'history', count: checkoutHistory.length }
            ];

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
                    <AuthComponent />

                    {/* Connection Status */}
                    <div className={`px-4 py-2 text-center text-sm transition-colors duration-300 ${
                        connectionStatus === 'connected'
                            ? 'bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300'
                            : connectionStatus === 'error'
                            ? 'bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300'
                            : 'bg-yellow-50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-300'
                    }`}>
                        <div className="flex items-center justify-center space-x-2">
                            <span className="material-icons text-sm">
                                {connectionStatus === 'connected' ? 'cloud_done' :
                                 connectionStatus === 'error' ? 'cloud_off' : 'cloud_sync'}
                            </span>
                            <span>
                                {connectionStatus === 'connected' ? 'Firebase Connected - Real-time sync active' :
                                 connectionStatus === 'error' ? 'Firebase Connection Error' :
                                 'Connecting to Firebase...'}
                            </span>
                        </div>
                    </div>


                    {/* Material You Navigation */}
                    <nav className="md-navigation-bar md-elevation-2" style={{
                        backgroundColor: 'var(--md-sys-color-surface-container)',
                        borderBottom: '1px solid var(--md-sys-color-outline-variant)'
                    }}>
                        <div className="max-w-7xl mx-auto">
                            {/* Desktop Navigation */}
                            <div className="hidden lg:flex justify-between items-center px-4">
                                <div className="flex">
                                    {tabs.map(tab => (
                                        <button
                                            key={tab.id}
                                            onClick={() => setActiveTab(tab.id)}
                                            className={`md-navigation-tab ${activeTab === tab.id ? 'active' : ''}`}
                                            style={{
                                                backgroundColor: activeTab === tab.id
                                                    ? 'var(--md-sys-color-primary-container)'
                                                    : 'transparent',
                                                color: activeTab === tab.id
                                                    ? 'var(--md-sys-color-on-primary-container)'
                                                    : 'var(--md-sys-color-on-surface-variant)'
                                            }}
                                        >
                                            <span className="material-icons text-lg">{tab.icon}</span>
                                            <span>{tab.name}</span>
                                            {tab.count !== undefined && tab.count > 0 && (
                                                <div
                                                    className="md-badge"
                                                    style={{
                                                        backgroundColor: tab.id === 'shop'
                                                            ? 'var(--md-sys-color-primary)'
                                                            : 'var(--md-sys-color-surface-variant)',
                                                        color: tab.id === 'shop'
                                                            ? 'var(--md-sys-color-on-primary)'
                                                            : 'var(--md-sys-color-on-surface-variant)'
                                                    }}
                                                >
                                                    {tab.count}
                                                </div>
                                            )}
                                        </button>
                                    ))}
                                </div>

                                <div className="flex items-center gap-3">
                                    <div className="md-status-indicator">
                                        <div className="md-status-dot"></div>
                                        <span>Connected</span>
                                    </div>

                                    <button
                                        onClick={toggleDarkMode}
                                        className="md-theme-toggle"
                                        title={isDarkMode ? 'Switch to light mode' : 'Switch to dark mode'}
                                    >
                                        <span className="material-icons text-lg">
                                            {isDarkMode ? 'light_mode' : 'dark_mode'}
                                        </span>
                                    </button>
                                </div>
                            </div>

                            {/* Mobile Navigation */}
                            <div className="lg:hidden">
                                {/* Mobile Header */}
                                <div className="flex justify-between items-center p-4">
                                    <h2 className="font-medium text-xl" style={{
                                        color: 'var(--md-sys-color-on-surface)',
                                        font: 'var(--md-sys-typescale-title-large)'
                                    }}>
                                        {tabs.find(t => t.id === activeTab)?.name || 'IT Inventory'}
                                    </h2>
                                    <div className="flex items-center gap-2">
                                        <div className="md-status-indicator" style={{ padding: '4px 12px', fontSize: '11px' }}>
                                            <div className="md-status-dot" style={{ width: '6px', height: '6px' }}></div>
                                            <span>Live</span>
                                        </div>
                                        <button
                                            onClick={toggleDarkMode}
                                            className="md-theme-toggle"
                                            style={{ padding: '6px' }}
                                        >
                                            <span className="material-icons text-base">
                                                {isDarkMode ? 'light_mode' : 'dark_mode'}
                                            </span>
                                        </button>
                                    </div>
                                </div>

                                {/* Mobile Tab Scrollable */}
                                <div className="overflow-x-auto">
                                    <div className="flex gap-1 px-4 pb-3">
                                        {tabs.map(tab => (
                                            <button
                                                key={tab.id}
                                                onClick={() => setActiveTab(tab.id)}
                                                className="flex-shrink-0 flex items-center gap-2 px-4 py-2 rounded-full text-sm transition-all whitespace-nowrap"
                                                style={{
                                                    backgroundColor: activeTab === tab.id
                                                        ? 'var(--md-sys-color-primary-container)'
                                                        : 'var(--md-sys-color-surface-container-highest)',
                                                    color: activeTab === tab.id
                                                        ? 'var(--md-sys-color-on-primary-container)'
                                                        : 'var(--md-sys-color-on-surface-variant)',
                                                    border: activeTab === tab.id
                                                        ? 'none'
                                                        : '1px solid var(--md-sys-color-outline-variant)'
                                                }}
                                            >
                                                <span className="material-icons text-sm">{tab.icon}</span>
                                                <span className="font-medium">{tab.name}</span>
                                                {tab.count !== undefined && tab.count > 0 && (
                                                    <div
                                                        className="md-badge"
                                                        style={{
                                                            backgroundColor: tab.id === 'shop'
                                                                ? 'var(--md-sys-color-primary)'
                                                                : 'var(--md-sys-color-surface-variant)',
                                                            color: tab.id === 'shop'
                                                                ? 'var(--md-sys-color-on-primary)'
                                                                : 'var(--md-sys-color-on-surface-variant)',
                                                            fontSize: '10px',
                                                            padding: '1px 6px'
                                                        }}
                                                    >
                                                        {tab.count}
                                                    </div>
                                                )}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto p-3 sm:p-6">
                        {activeTab === 'shop' && (
                            <div className="grid grid-cols-1 xl:grid-cols-3 gap-4 lg:gap-6">
                                {/* Shop Items */}
                                <div className="xl:col-span-2 space-y-4 lg:space-y-6 order-2 xl:order-1">
                                    {/* Barcode Scanner */}
                                    <MaterialBarcodeScanner
                                        items={items}
                                        onItemScanned={(item, quantity) => {
                                            addToCart(item, quantity);
                                            console.log(`✅ Scanned and added to cart: ${item.name} +${quantity}`);
                                        }}
                                    />

                                    {/* Items Grid */}
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                                            <span className="material-icons mr-2">storefront</span>
                                            Shop Items
                                        </h2>

                                        {/* Search Field */}
                                        <div className="mb-6">
                                            <div className="relative">
                                                <input
                                                    type="text"
                                                    placeholder="Search items by name, category, or ASIN..."
                                                    value={shopSearchQuery}
                                                    onChange={(e) => {
                                                        setShopSearchQuery(e.target.value);
                                                        setInventoryPagination(prev => ({ ...prev, currentPage: 1 }));
                                                    }}
                                                    className="w-full px-4 py-3 pl-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                />
                                                <span className="material-icons absolute left-4 top-3.5 text-gray-400">search</span>
                                                {shopSearchQuery && (
                                                    <button
                                                        onClick={() => {
                                                            setShopSearchQuery('');
                                                            setInventoryPagination(prev => ({ ...prev, currentPage: 1 }));
                                                        }}
                                                        className="absolute right-4 top-3.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                                                    >
                                                        <span className="material-icons">clear</span>
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-3 lg:gap-4">
                                            {getPaginatedItems().map(item => (
                                                <MaterialCard key={item.id} elevation={1} className="!p-3 lg:!p-4 hover:mat-elevation-4">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <h3 className="font-medium text-sm text-gray-900 dark:text-white line-clamp-2">
                                                            {item.name}
                                                        </h3>
                                                        <div className={`px-2 py-1 rounded-full text-xs font-medium ${
                                                            item.quantity <= (item.minThreshold || 5)
                                                                ? 'bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300'
                                                                : 'bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300'
                                                        }`}>
                                                            {item.quantity}
                                                        </div>
                                                    </div>
                                                    <div className="text-xs text-gray-600 dark:text-gray-400 mb-4">
                                                        <div className="flex items-center">
                                                            <span className="material-icons text-xs mr-1">category</span>
                                                            {item.category}
                                                        </div>
                                                        {item.price > 0 && (
                                                            <div className="flex items-center mt-1 text-green-600 dark:text-green-400 font-medium">
                                                                <span className="material-icons text-xs mr-1">attach_money</span>
                                                                ${item.price}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <MaterialButton
                                                        onClick={() => addToCart(item)}
                                                        disabled={item.quantity === 0}
                                                        variant="contained"
                                                        color="primary"
                                                        className="w-full !py-2"
                                                    >
                                                        {item.quantity === 0 ? (
                                                            <>
                                                                <span className="material-icons mr-2 text-sm">block</span>
                                                                Out of Stock
                                                            </>
                                                        ) : (
                                                            <>
                                                                <span className="material-icons mr-2 text-sm">add_shopping_cart</span>
                                                                Add to Cart
                                                            </>
                                                        )}
                                                    </MaterialButton>
                                                </MaterialCard>
                                            ))}
                                        </div>

                                        {/* Inventory Pagination */}
                                        <MaterialPagination
                                            currentPage={inventoryPagination.currentPage}
                                            totalItems={getFilteredItems().length}
                                            itemsPerPage={inventoryPagination.itemsPerPage}
                                            onPageChange={handleInventoryPageChange}
                                            onItemsPerPageChange={handleInventoryItemsPerPageChange}
                                        />
                                    </div>
                                </div>

                                {/* Shopping Cart - Mobile First, Desktop Sticky */}
                                <div className="order-1 xl:order-2">
                                    <div className="xl:sticky xl:top-6">
                                        <MaterialShoppingCart
                                            cart={cart}
                                            addToCart={addToCart}
                                            removeFromCart={removeFromCart}
                                            clearCart={clearCart}
                                            users={users}
                                            userSearchQuery={userSearchQuery}
                                            setUserSearchQuery={setUserSearchQuery}
                                            onCheckout={() => {
                                                showSnackbar('Checkout completed successfully!', 'success');
                                            }}
                                        />
                                    </div>
                                </div>
                            </div>
                        )}


                        {activeTab === 'inventory' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                                    <span className="material-icons mr-2">inventory_2</span>
                                    Inventory Management
                                </h2>
                                <MaterialCard elevation={1}>
                                    <div className="mb-4 flex justify-between items-center">
                                        <p className="text-sm text-gray-600 dark:text-gray-400">
                                            Comprehensive inventory management with pagination
                                        </p>
                                        <div className="flex items-center space-x-2">
                                            <span className="material-icons text-green-500">trending_up</span>
                                            <span className="text-sm text-gray-600 dark:text-gray-400">Real-time sync</span>
                                        </div>
                                    </div>

                                    {/* Search Inventory */}
                                    <div className="mb-6">
                                        <div className="relative">
                                            <input
                                                type="text"
                                                placeholder="Search inventory by name, category, or ASIN..."
                                                value={inventorySearchQuery}
                                                onChange={(e) => setInventorySearchQuery(e.target.value)}
                                                className="w-full px-4 py-3 pl-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                                            />
                                            <span className="material-icons absolute left-4 top-3.5 text-gray-400">search</span>
                                            {inventorySearchQuery && (
                                                <button
                                                    onClick={() => setInventorySearchQuery('')}
                                                    className="absolute right-3 top-3.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
                                                >
                                                    <span className="material-icons text-sm">clear</span>
                                                </button>
                                            )}
                                        </div>
                                    </div>

                                    <div className="overflow-x-auto">
                                        <table className="min-w-full">
                                            <thead className="bg-gray-50 dark:bg-gray-700">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">inventory</span>
                                                            Item
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">numbers</span>
                                                            Quantity
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">category</span>
                                                            Category
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">qr_code</span>
                                                            ASIN
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">attach_money</span>
                                                            Price
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                {getPaginatedInventoryItems().map(item => {
                                                    const isEditing = editingItemId === item.id;
                                                    return (
                                                        <tr key={item.id} className={`edit-mode-transition ${
                                                            isEditing
                                                                ? 'edit-mode-row bg-blue-50 dark:bg-blue-900/20'
                                                                : 'hover:bg-gray-50 dark:hover:bg-gray-700'
                                                        }`}>
                                                            {/* Item Name */}
                                                            <td className="px-6 py-4">
                                                                {isEditing ? (
                                                                    <div className="mat-input">
                                                                        <input
                                                                            type="text"
                                                                            value={editFormData.name || ''}
                                                                            onChange={(e) => handleEditFormChange('name', e.target.value)}
                                                                            className="w-full font-medium"
                                                                            placeholder=" "
                                                                        />
                                                                        <label>Item Name</label>
                                                                    </div>
                                                                ) : (
                                                                    <div className="font-medium text-gray-900 dark:text-white">{item.name}</div>
                                                                )}
                                                            </td>

                                                            {/* Quantity */}
                                                            <td className="px-6 py-4">
                                                                {isEditing ? (
                                                                    <div className="mat-input">
                                                                        <input
                                                                            type="number"
                                                                            value={editFormData.quantity || 0}
                                                                            onChange={(e) => handleEditFormChange('quantity', e.target.value)}
                                                                            className="w-20"
                                                                            min="0"
                                                                            placeholder=" "
                                                                        />
                                                                        <label>Qty</label>
                                                                    </div>
                                                                ) : (
                                                                    <div className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                                                                        item.quantity <= (item.minThreshold || 5)
                                                                            ? 'bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300'
                                                                            : 'bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300'
                                                                    }`}>
                                                                        {item.quantity}
                                                                    </div>
                                                                )}
                                                            </td>

                                                            {/* Category */}
                                                            <td className="px-6 py-4">
                                                                {isEditing ? (
                                                                    <div className="mat-input">
                                                                        <input
                                                                            type="text"
                                                                            value={editFormData.category || ''}
                                                                            onChange={(e) => handleEditFormChange('category', e.target.value)}
                                                                            className="w-32"
                                                                            placeholder=" "
                                                                        />
                                                                        <label>Category</label>
                                                                    </div>
                                                                ) : (
                                                                    <span className="text-sm text-gray-600 dark:text-gray-400">
                                                                        {item.category || 'Uncategorized'}
                                                                    </span>
                                                                )}
                                                            </td>

                                                            {/* ASIN */}
                                                            <td className="px-6 py-4">
                                                                {isEditing ? (
                                                                    <div className="mat-input">
                                                                        <input
                                                                            type="text"
                                                                            value={editFormData.asin || ''}
                                                                            onChange={(e) => handleEditFormChange('asin', e.target.value)}
                                                                            className="w-28"
                                                                            placeholder=" "
                                                                        />
                                                                        <label>ASIN</label>
                                                                    </div>
                                                                ) : (
                                                                    <span className="text-sm text-gray-600 dark:text-gray-400 font-mono">
                                                                        {item.asin || '-'}
                                                                    </span>
                                                                )}
                                                            </td>

                                                            {/* Price */}
                                                            <td className="px-6 py-4">
                                                                {isEditing ? (
                                                                    <div className="mat-input">
                                                                        <input
                                                                            type="number"
                                                                            value={editFormData.price || ''}
                                                                            onChange={(e) => handleEditFormChange('price', e.target.value)}
                                                                            className="w-24"
                                                                            min="0"
                                                                            step="0.01"
                                                                            placeholder=" "
                                                                        />
                                                                        <label>Price</label>
                                                                    </div>
                                                                ) : (
                                                                    item.price > 0 ? (
                                                                        <span className="text-green-600 dark:text-green-400 font-medium">
                                                                            ${item.price}
                                                                        </span>
                                                                    ) : (
                                                                        <span className="text-gray-400">-</span>
                                                                    )
                                                                )}
                                                            </td>

                                                            {/* Actions */}
                                                            <td className="px-6 py-4">
                                                                <div className="flex items-center space-x-2 edit-action-buttons">
                                                                    {isEditing ? (
                                                                        <>
                                                                            {/* Save Button */}
                                                                            <MaterialButton
                                                                                onClick={saveEditItem}
                                                                                variant="contained"
                                                                                color="primary"
                                                                                disabled={isSavingEdit}
                                                                                className="!p-2 !min-w-0"
                                                                                title="Save changes"
                                                                            >
                                                                                <span className="material-icons text-sm">
                                                                                    {isSavingEdit ? 'hourglass_empty' : 'save'}
                                                                                </span>
                                                                            </MaterialButton>

                                                                            {/* Cancel Button */}
                                                                            <MaterialButton
                                                                                onClick={cancelEditItem}
                                                                                variant="outlined"
                                                                                color="secondary"
                                                                                disabled={isSavingEdit}
                                                                                className="!p-2 !min-w-0"
                                                                                title="Cancel editing"
                                                                            >
                                                                                <span className="material-icons text-sm">cancel</span>
                                                                            </MaterialButton>
                                                                        </>
                                                                    ) : (
                                                                        <>
                                                                            {/* Edit Button */}
                                                                            <MaterialButton
                                                                                onClick={() => startEditItem(item)}
                                                                                variant="text"
                                                                                color="primary"
                                                                                className="!p-2 !min-w-0"
                                                                                title="Edit item"
                                                                            >
                                                                                <span className="material-icons text-sm">edit</span>
                                                                            </MaterialButton>

                                                                            {/* Add to Cart Button */}
                                                                            <MaterialButton
                                                                                onClick={() => addToCart(item)}
                                                                                variant="text"
                                                                                color="primary"
                                                                                className="!p-2 !min-w-0"
                                                                                title="Add to cart"
                                                                            >
                                                                                <span className="material-icons text-sm">add_shopping_cart</span>
                                                                            </MaterialButton>

                                                                            {/* Delete Button */}
                                                                            <MaterialButton
                                                                                onClick={() => confirmDeleteItem(item)}
                                                                                variant="text"
                                                                                color="error"
                                                                                className="!p-2 !min-w-0"
                                                                                title="Delete item"
                                                                            >
                                                                                <span className="material-icons text-sm">delete</span>
                                                                            </MaterialButton>
                                                                        </>
                                                                    )}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* Inventory Management Pagination */}
                                    <MaterialPagination
                                        currentPage={inventoryPagination.currentPage}
                                        totalItems={inventoryPagination.totalItems}
                                        itemsPerPage={inventoryPagination.itemsPerPage}
                                        onPageChange={handleInventoryPageChange}
                                        onItemsPerPageChange={handleInventoryItemsPerPageChange}
                                    />
                                </MaterialCard>
                            </div>
                        )}

                        {/* Delete Confirmation Dialog */}
                        {deleteConfirmItem && (
                            <div
                                className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                                onClick={(e) => e.target === e.currentTarget && cancelDeleteItem()}
                                onKeyDown={(e) => {
                                    if (e.key === 'Escape') cancelDeleteItem();
                                }}
                                tabIndex={-1}
                            >
                                <MaterialCard elevation={3} className="max-w-md w-full">
                                    <div className="p-6">
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-red-600">warning</span>
                                            Confirm Delete
                                        </h3>

                                        <div className="mb-6">
                                            <p className="text-gray-700 dark:text-gray-300 mb-3">
                                                Are you sure you want to delete this item? This action cannot be undone.
                                            </p>

                                            <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                                <div className="flex items-center justify-between mb-2">
                                                    <span className="font-medium text-gray-900 dark:text-white">
                                                        {deleteConfirmItem.name}
                                                    </span>
                                                    <span className={`px-2 py-1 rounded-full text-xs ${
                                                        deleteConfirmItem.quantity <= (deleteConfirmItem.minThreshold || 5)
                                                            ? 'bg-red-100 text-red-700'
                                                            : 'bg-green-100 text-green-700'
                                                    }`}>
                                                        Qty: {deleteConfirmItem.quantity}
                                                    </span>
                                                </div>
                                                <div className="text-sm text-gray-600 dark:text-gray-400">
                                                    <div>Category: {deleteConfirmItem.category || 'Uncategorized'}</div>
                                                    {deleteConfirmItem.asin && (
                                                        <div>ASIN: {deleteConfirmItem.asin}</div>
                                                    )}
                                                    {deleteConfirmItem.price > 0 && (
                                                        <div>Price: ${deleteConfirmItem.price}</div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="flex space-x-3">
                                            <MaterialButton
                                                onClick={cancelDeleteItem}
                                                variant="outlined"
                                                color="secondary"
                                                disabled={isDeletingItem}
                                                className="flex-1"
                                            >
                                                Cancel
                                            </MaterialButton>
                                            <MaterialButton
                                                onClick={deleteItem}
                                                variant="contained"
                                                color="error"
                                                disabled={isDeletingItem}
                                                className="flex-1"
                                            >
                                                {isDeletingItem ? (
                                                    <>
                                                        <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                        Deleting...
                                                    </>
                                                ) : (
                                                    <>
                                                        <span className="material-icons mr-2">delete</span>
                                                        Delete
                                                    </>
                                                )}
                                            </MaterialButton>
                                        </div>
                                    </div>
                                </MaterialCard>
                            </div>
                        )}

                        {activeTab === 'users' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                                    <span className="material-icons mr-2">people</span>
                                    Users Management
                                </h2>
                                <MaterialCard elevation={1}>
                                    <div className="mb-4">
                                        <p className="text-sm text-gray-600 dark:text-gray-400">
                                            Manage user accounts with pagination for better performance
                                        </p>
                                    </div>

                                    {/* Search Users */}
                                    <div className="mb-6">
                                        <div className="relative">
                                            <input
                                                type="text"
                                                placeholder="Search users by name, cost code, or employee ID..."
                                                value={usersSearchQuery}
                                                onChange={(e) => setUsersSearchQuery(e.target.value)}
                                                className="w-full px-4 py-3 pl-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                                            />
                                            <span className="material-icons absolute left-4 top-3.5 text-gray-400">search</span>
                                            {usersSearchQuery && (
                                                <button
                                                    onClick={() => setUsersSearchQuery('')}
                                                    className="absolute right-3 top-3.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
                                                >
                                                    <span className="material-icons text-sm">clear</span>
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full">
                                            <thead className="bg-gray-50 dark:bg-gray-700">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                                                        onClick={() => handleSort('name')}>
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">person</span>
                                                            Name
                                                            {usersSortConfig.field === 'name' && (
                                                                <span className="material-icons text-sm ml-1">
                                                                    {usersSortConfig.direction === 'asc' ? 'arrow_upward' : 'arrow_downward'}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                                                        onClick={() => handleSort('costCode')}>
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">business</span>
                                                            Cost Code
                                                            {usersSortConfig.field === 'costCode' && (
                                                                <span className="material-icons text-sm ml-1">
                                                                    {usersSortConfig.direction === 'asc' ? 'arrow_upward' : 'arrow_downward'}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                                                        onClick={() => handleSort('employeeId')}>
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">badge</span>
                                                            Employee ID
                                                            {usersSortConfig.field === 'employeeId' && (
                                                                <span className="material-icons text-sm ml-1">
                                                                    {usersSortConfig.direction === 'asc' ? 'arrow_upward' : 'arrow_downward'}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                {getPaginatedUsers().map(user => (
                                                    <tr key={user.id} className="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                                        <td className="px-6 py-4">
                                                            <div className="font-medium text-gray-900 dark:text-white">
                                                                {user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim()}
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <code className="text-sm bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">
                                                                {formatDepartmentId(user.costCode || user.cost_code)}
                                                            </code>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <code className="text-sm bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">
                                                                {user.employeeId || user.employee_id || 'N/A'}
                                                            </code>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <MaterialButton
                                                                onClick={() => setEditingUser(user)}
                                                                variant="text"
                                                                color="primary"
                                                                className="!p-2"
                                                            >
                                                                <span className="material-icons text-sm">edit</span>
                                                            </MaterialButton>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* Users Pagination */}
                                    <MaterialPagination
                                        currentPage={usersPagination.currentPage}
                                        totalItems={usersPagination.totalItems}
                                        itemsPerPage={usersPagination.itemsPerPage}
                                        onPageChange={handleUsersPageChange}
                                        onItemsPerPageChange={handleUsersItemsPerPageChange}
                                    />
                                </MaterialCard>

                            </div>
                        )}

                        {activeTab === 'admin' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                                    <span className="material-icons mr-2">admin_panel_settings</span>
                                    Administration
                                </h2>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
                                    {/* Add New Item */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-blue-600">add_box</span>
                                            Add New Item
                                        </h3>
                                        <form onSubmit={handleCreateItem} className="space-y-4">
                                            <MaterialInput
                                                label="Item Name"
                                                value={newItemForm.name}
                                                onChange={(e) => setNewItemForm(prev => ({ ...prev, name: e.target.value }))}
                                                required
                                            />
                                            <div className="grid grid-cols-2 gap-4">
                                                <MaterialInput
                                                    label="Price"
                                                    type="number"
                                                    step="0.01"
                                                    value={newItemForm.price}
                                                    onChange={(e) => setNewItemForm(prev => ({ ...prev, price: e.target.value }))}
                                                    placeholder="0.00"
                                                />
                                                <MaterialInput
                                                    label="Quantity"
                                                    type="number"
                                                    value={newItemForm.quantity}
                                                    onChange={(e) => setNewItemForm(prev => ({ ...prev, quantity: e.target.value }))}
                                                    placeholder="0"
                                                />
                                            </div>
                                            <div className="mat-input">
                                                <select
                                                    value={newItemForm.category}
                                                    onChange={(e) => setNewItemForm(prev => ({ ...prev, category: e.target.value }))}
                                                >
                                                    <option value="">Choose category...</option>
                                                    <option value="Electronics">Electronics</option>
                                                    <option value="Accessories">Accessories</option>
                                                    <option value="Cables">Cables</option>
                                                    <option value="Office">Office</option>
                                                    <option value="Hardware">Hardware</option>
                                                    <option value="Software">Software</option>
                                                    <option value="Supplies">Supplies</option>
                                                </select>
                                                <label>Category</label>
                                            </div>
                                            <MaterialButton
                                                type="submit"
                                                variant="contained"
                                                color="primary"
                                                className="w-full"
                                                disabled={isCreatingItem}
                                            >
                                                {isCreatingItem ? (
                                                    <>
                                                        <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                        Creating...
                                                    </>
                                                ) : (
                                                    <>
                                                        <span className="material-icons mr-2">add</span>
                                                        Create Item
                                                    </>
                                                )}
                                            </MaterialButton>
                                        </form>
                                    </MaterialCard>

                                    {/* Add New User */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-green-600">person_add</span>
                                            Add New User
                                        </h3>
                                        <form onSubmit={handleCreateUser} className="space-y-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <MaterialInput
                                                    label="First Name"
                                                    value={newUserForm.firstName}
                                                    onChange={(e) => setNewUserForm(prev => ({ ...prev, firstName: e.target.value }))}
                                                    required
                                                />
                                                <MaterialInput
                                                    label="Last Name"
                                                    value={newUserForm.lastName}
                                                    onChange={(e) => setNewUserForm(prev => ({ ...prev, lastName: e.target.value }))}
                                                    required
                                                />
                                            </div>
                                            <MaterialInput
                                                label="Cost Code"
                                                value={newUserForm.costCode}
                                                onChange={(e) => setNewUserForm(prev => ({ ...prev, costCode: e.target.value }))}
                                                placeholder="e.g., 1-10-100-5770 (auto-generated if empty)"
                                            />
                                            <MaterialInput
                                                label="Employee ID"
                                                value={newUserForm.employeeId}
                                                onChange={(e) => setNewUserForm(prev => ({ ...prev, employeeId: e.target.value }))}
                                                placeholder="e.g., EMP001, 12345"
                                            />
                                            <MaterialButton
                                                type="submit"
                                                variant="contained"
                                                color="success"
                                                className="w-full"
                                                disabled={isCreatingUser}
                                            >
                                                {isCreatingUser ? (
                                                    <>
                                                        <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                        Creating...
                                                    </>
                                                ) : (
                                                    <>
                                                        <span className="material-icons mr-2">person_add</span>
                                                        Create User
                                                    </>
                                                )}
                                            </MaterialButton>
                                        </form>
                                    </MaterialCard>

                                    {/* CSV Import/Export */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-purple-600">import_export</span>
                                            CSV Import/Export
                                        </h3>
                                        <div className="space-y-4">
                                            {/* Instructions for CSV Import */}
                                            <div className="text-xs text-gray-600 dark:text-gray-400 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border-l-4 border-yellow-400">
                                                <p className="font-medium mb-2">📝 When importing users, you'll see a dialog with 3 options:</p>
                                                <div className="space-y-1 ml-2">
                                                    <p><strong>Type "1"</strong> - UPDATE existing users with CSV data (recommended for adding Employee IDs)</p>
                                                    <p><strong>Type "2"</strong> - SKIP duplicates, import only new users</p>
                                                    <p><strong>Type "3"</strong> - CANCEL import to review your CSV file</p>
                                                </div>
                                                <p className="mt-2 text-xs italic">💡 Choose option 1 to add missing Employee IDs to existing users!</p>
                                            </div>
                                            <div>
                                                <h4 className="font-medium mb-2">Import Data</h4>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <input
                                                            type="file"
                                                            accept=".csv"
                                                            onChange={handleItemsImport}
                                                            className="hidden"
                                                            id="items-csv-import"
                                                        />
                                                        <MaterialButton
                                                            onClick={() => document.getElementById('items-csv-import').click()}
                                                            variant="outlined"
                                                            color="primary"
                                                            className="w-full"
                                                            disabled={csvOperations.importingItems}
                                                        >
                                                            {csvOperations.importingItems ? (
                                                                <>
                                                                    <div className="mat-spinner w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full mr-2"></div>
                                                                    {csvOperations.itemImportStatus || 'Importing...'}
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <span className="material-icons mr-2">upload_file</span>
                                                                    Import Items
                                                                </>
                                                            )}
                                                        </MaterialButton>
                                                    </div>
                                                    <div>
                                                        <input
                                                            type="file"
                                                            accept=".csv"
                                                            onChange={handleUsersImport}
                                                            className="hidden"
                                                            id="users-csv-import"
                                                        />
                                                        <MaterialButton
                                                            onClick={() => document.getElementById('users-csv-import').click()}
                                                            variant="outlined"
                                                            color="primary"
                                                            className="w-full"
                                                            disabled={csvOperations.importingUsers}
                                                        >
                                                            {csvOperations.importingUsers ? (
                                                                <>
                                                                    <div className="mat-spinner w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full mr-2"></div>
                                                                    {csvOperations.userImportStatus || 'Importing...'}
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <span className="material-icons mr-2">upload_file</span>
                                                                    Import Users
                                                                </>
                                                            )}
                                                        </MaterialButton>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="border-t dark:border-gray-600 pt-4">
                                                <h4 className="font-medium mb-2">Export Data</h4>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <MaterialButton
                                                        onClick={exportItemsToCSV}
                                                        variant="outlined"
                                                        color="secondary"
                                                        className="w-full"
                                                        disabled={csvOperations.exportingItems}
                                                    >
                                                        {csvOperations.exportingItems ? (
                                                            <>
                                                                <div className="mat-spinner w-4 h-4 border-2 border-gray-600 border-t-transparent rounded-full mr-2"></div>
                                                                Exporting...
                                                            </>
                                                        ) : (
                                                            <>
                                                                <span className="material-icons mr-2">download</span>
                                                                Export Items ({items.length})
                                                            </>
                                                        )}
                                                    </MaterialButton>
                                                    <MaterialButton
                                                        onClick={exportUsersToCSV}
                                                        variant="outlined"
                                                        color="secondary"
                                                        className="w-full"
                                                        disabled={csvOperations.exportingUsers}
                                                    >
                                                        {csvOperations.exportingUsers ? (
                                                            <>
                                                                <div className="mat-spinner w-4 h-4 border-2 border-gray-600 border-t-transparent rounded-full mr-2"></div>
                                                                Exporting...
                                                            </>
                                                        ) : (
                                                            <>
                                                                <span className="material-icons mr-2">download</span>
                                                                Export Users ({users.length})
                                                            </>
                                                        )}
                                                    </MaterialButton>
                                                </div>
                                            </div>
                                            <div className="text-xs text-gray-600 dark:text-gray-400 mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                                <p className="font-medium mb-1">📋 CSV Format Tips:</p>
                                                <p><strong>Items:</strong> Item Name, Category, Quantity, Price, ASIN, Min Threshold</p>
                                                <p><strong>Users:</strong> First Name, Last Name, Cost Code, Employee ID</p>
                                            </div>
                                        </div>
                                    </MaterialCard>

                                    {/* Bulk Operations */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-orange-600">batch_prediction</span>
                                            Bulk Operations
                                        </h3>
                                        <div className="space-y-4">
                                            <div>
                                                <h4 className="font-medium mb-2">Inventory Management</h4>
                                                <div className="space-y-3">
                                                    <MaterialButton
                                                        onClick={exportItemsToCSV}
                                                        variant="outlined"
                                                        color="primary"
                                                        className="w-full"
                                                    >
                                                        <span className="material-icons mr-2">edit</span>
                                                        Bulk Edit via CSV Export/Import
                                                    </MaterialButton>
                                                    <MaterialButton
                                                        onClick={() => showSnackbar('Price bulk update: Export CSV, edit prices, then import back', 'info')}
                                                        variant="outlined"
                                                        color="primary"
                                                        className="w-full"
                                                    >
                                                        <span className="material-icons mr-2">attach_money</span>
                                                        Update Prices via CSV
                                                    </MaterialButton>
                                                    <MaterialButton
                                                        onClick={handleResetAllQuantities}
                                                        variant="outlined"
                                                        color="error"
                                                        className="w-full"
                                                    >
                                                        <span className="material-icons mr-2">restore</span>
                                                        Reset All Quantities to Zero
                                                    </MaterialButton>
                                                    <MaterialButton
                                                        onClick={refreshDataFromFiles}
                                                        variant="contained"
                                                        color="primary"
                                                        className="w-full"
                                                    >
                                                        <span className="material-icons mr-2">refresh</span>
                                                        Force Refresh All Data from Files
                                                    </MaterialButton>
                                                </div>
                                            </div>
                                            <div className="text-xs text-gray-600 dark:text-gray-400 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
                                                <p className="font-medium mb-1">⚠️ Bulk Operations:</p>
                                                <p><strong>Edit/Prices:</strong> Use CSV export → edit → import workflow</p>
                                                <p><strong>Reset:</strong> Sets ALL item quantities to zero (permanent!)</p>
                                            </div>
                                        </div>
                                    </MaterialCard>

                                    {/* Duplicate Cleanup */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-red-600">content_copy</span>
                                            Duplicate Cleanup
                                        </h3>
                                        <div className="space-y-4">
                                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                                Scan inventory for duplicate items and merge them to clean up your database.
                                            </p>
                                            <MaterialButton
                                                onClick={async () => {
                                                    setCleanupDialog(prev => ({ ...prev, scanning: true }));
                                                    try {
                                                        const duplicateGroups = await findExistingDuplicates();
                                                        if (duplicateGroups.length === 0) {
                                                            showSnackbar('No duplicate items found in inventory!', 'success');
                                                        } else {
                                                            const initialChoices = {};
                                                            duplicateGroups.forEach(group => {
                                                                initialChoices[group.name] = {
                                                                    keepItemId: group.items[0].id,
                                                                    deleteItemIds: group.items.slice(1).map(item => item.id)
                                                                };
                                                            });
                                                            setCleanupDialog({
                                                                open: true,
                                                                duplicateGroups,
                                                                mergeChoices: initialChoices,
                                                                scanning: false
                                                            });
                                                        }
                                                    } catch (error) {
                                                        showSnackbar(`Error scanning for duplicates: ${error.message}`, 'error');
                                                    } finally {
                                                        setCleanupDialog(prev => ({ ...prev, scanning: false }));
                                                    }
                                                }}
                                                variant="outlined"
                                                color="warning"
                                                className="w-full"
                                                disabled={cleanupDialog.scanning}
                                            >
                                                {cleanupDialog.scanning ? (
                                                    <>
                                                        <div className="mat-spinner w-4 h-4 border-2 border-amber-600 border-t-transparent rounded-full mr-2"></div>
                                                        Scanning for Duplicates...
                                                    </>
                                                ) : (
                                                    <>
                                                        <span className="material-icons mr-2">search</span>
                                                        Scan & Clean Duplicates
                                                    </>
                                                )}
                                            </MaterialButton>
                                            <div className="text-xs text-gray-600 dark:text-gray-400 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                                <p className="font-medium mb-1">💡 How it works:</p>
                                                <p><strong>Detection:</strong> Finds items with identical names or ASINs</p>
                                                <p><strong>Merging:</strong> Combines quantities, preserves highest price, keeps most recent category</p>
                                                <p><strong>Safety:</strong> Preview all changes before applying them</p>
                                            </div>
                                        </div>
                                    </MaterialCard>

                                    {/* User Duplicate Cleanup */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-purple-600">people</span>
                                            User Duplicate Cleanup
                                        </h3>
                                        <div className="space-y-4">
                                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                                Scan user database for duplicate users and merge them to clean up your database. Users are considered duplicates if they have matching employee IDs, names, or email addresses.
                                            </p>
                                            <MaterialButton
                                                onClick={async () => {
                                                    setUserDuplicateDialog(prev => ({ ...prev, scanning: true }));
                                                    try {
                                                        const duplicateGroups = await findExistingUserDuplicates();
                                                        if (duplicateGroups.length === 0) {
                                                            showSnackbar('No duplicate users found in database!', 'success');
                                                        } else {
                                                            const initialChoices = {};
                                                            duplicateGroups.forEach(group => {
                                                                initialChoices[group.name] = {
                                                                    keepUserId: group.users[0].id,
                                                                    deleteUserIds: group.users.slice(1).map(user => user.id)
                                                                };
                                                            });
                                                            setUserDuplicateDialog({
                                                                open: true,
                                                                duplicates: duplicateGroups,
                                                                choices: initialChoices,
                                                                scanning: false
                                                            });
                                                        }
                                                    } catch (error) {
                                                        showSnackbar(`Error scanning for user duplicates: ${error.message}`, 'error');
                                                    } finally {
                                                        setUserDuplicateDialog(prev => ({ ...prev, scanning: false }));
                                                    }
                                                }}
                                                variant="outlined"
                                                color="secondary"
                                                className="w-full"
                                                disabled={userDuplicateDialog.scanning}
                                            >
                                                {userDuplicateDialog.scanning ? (
                                                    <>
                                                        <div className="mat-spinner w-4 h-4 border-2 border-purple-600 border-t-transparent rounded-full mr-2"></div>
                                                        Scanning for User Duplicates...
                                                    </>
                                                ) : (
                                                    <>
                                                        <span className="material-icons mr-2">person_search</span>
                                                        Scan & Clean User Duplicates
                                                    </>
                                                )}
                                            </MaterialButton>
                                            <div className="text-xs text-gray-600 dark:text-gray-400 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                                <p className="font-medium mb-1">💡 How it works:</p>
                                                <p><strong>Detection:</strong> Finds users with matching employee IDs, names, or email addresses</p>
                                                <p><strong>Merging:</strong> Combines user data and removes duplicates</p>
                                                <p><strong>Safety:</strong> Preview all changes before applying them</p>
                                            </div>
                                        </div>
                                    </MaterialCard>

                                    {/* System Stats */}
                                    <MaterialCard elevation={2} className="lg:col-span-2">
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-indigo-600">analytics</span>
                                            System Statistics
                                        </h3>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <div className="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                                <div className="text-2xl font-bold text-blue-600 dark:text-blue-400">{items.length}</div>
                                                <div className="text-sm text-gray-600 dark:text-gray-400">Total Items</div>
                                            </div>
                                            <div className="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                                <div className="text-2xl font-bold text-green-600 dark:text-green-400">{users.length}+</div>
                                                <div className="text-sm text-gray-600 dark:text-gray-400">Active Users</div>
                                            </div>
                                            <div className="text-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                                <div className="text-2xl font-bold text-purple-600 dark:text-purple-400">{checkoutHistory.length}</div>
                                                <div className="text-sm text-gray-600 dark:text-gray-400">Recent Checkouts</div>
                                            </div>
                                            <div
                                                className="text-center p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg cursor-pointer hover:bg-amber-100 dark:hover:bg-amber-900/30 transition-colors border-2 border-transparent hover:border-amber-300 dark:hover:border-amber-600"
                                                onClick={() => {
                                                    if (notifications.length > 0) {
                                                        setShowLowStockPopup(true);
                                                    }
                                                }}
                                                title={notifications.length > 0 ? "Click to view low stock items" : "No low stock items"}
                                            >
                                                <div className="text-2xl font-bold text-amber-600 dark:text-amber-400">{notifications.length}</div>
                                                <div className="text-sm text-gray-600 dark:text-gray-400">Low Stock Alerts</div>
                                                {notifications.length > 0 && (
                                                    <div className="text-xs text-amber-600 dark:text-amber-400 mt-1 font-medium">
                                                        Click to view
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </MaterialCard>
                                </div>
                            </div>
                        )}

                        {activeTab === 'shipment' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                                    <span className="material-icons mr-2">local_shipping</span>
                                    Process Shipment
                                </h2>

                                <div className="space-y-6">
                                    {/* Item Selection */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-purple-600">search</span>
                                            Select Items for Processing
                                        </h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Search and Add Items
                                                </label>
                                                <div className="relative">
                                                    <input
                                                        type="text"
                                                        placeholder="Type item name to search..."
                                                        value={itemSearchQuery || ''}
                                                        onChange={(e) => setItemSearchQuery(e.target.value)}
                                                        className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                    />
                                                    <span className="material-icons absolute right-3 top-2.5 text-gray-400">search</span>
                                                </div>

                                                {/* Search Results */}
                                                {itemSearchQuery && itemSearchQuery.length > 0 && (
                                                    <div className="mt-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                        {items
                                                            .filter(item => item.name.toLowerCase().includes(itemSearchQuery.toLowerCase()))
                                                            .slice(0, 10)
                                                            .map(item => (
                                                                <div
                                                                    key={item.id}
                                                                    onClick={() => {
                                                                        if (!selectedShipmentItems.includes(item.name)) {
                                                                            setSelectedShipmentItems(prev => [...prev, item.name]);
                                                                        }
                                                                        setItemSearchQuery('');
                                                                    }}
                                                                    className="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer border-b border-gray-200 dark:border-gray-600 last:border-b-0"
                                                                >
                                                                    <div className="font-medium text-gray-900 dark:text-white">{item.name}</div>
                                                                    <div className="text-sm text-gray-600 dark:text-gray-400">
                                                                        Qty: {item.quantity} | Category: {item.category}
                                                                        {item.price > 0 && <span className="ml-2 text-green-600">${item.price}</span>}
                                                                    </div>
                                                                </div>
                                                            ))
                                                        }
                                                        {items.filter(item => item.name.toLowerCase().includes(itemSearchQuery.toLowerCase())).length === 0 && (
                                                            <div className="px-4 py-2 text-gray-500 dark:text-gray-400">No items found</div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>

                                            {/* Selected Items List */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Selected Items ({selectedShipmentItems?.length || 0})
                                                </label>
                                                <div className="space-y-2 max-h-32 overflow-y-auto">
                                                    {selectedShipmentItems?.length > 0 ? (
                                                        selectedShipmentItems.map(itemName => (
                                                            <div key={itemName} className="flex items-center justify-between bg-blue-50 dark:bg-blue-900/20 px-3 py-2 rounded-lg">
                                                                <span className="text-sm font-medium text-gray-900 dark:text-white">{itemName}</span>
                                                                <button
                                                                    onClick={() => setSelectedShipmentItems(prev => prev.filter(name => name !== itemName))}
                                                                    className="text-red-600 hover:text-red-800 dark:text-red-400"
                                                                >
                                                                    <span className="material-icons text-sm">close</span>
                                                                </button>
                                                            </div>
                                                        ))
                                                    ) : (
                                                        <div className="text-sm text-gray-500 dark:text-gray-400 italic">No items selected</div>
                                                    )}
                                                </div>
                                            </div>

                                            {selectedShipmentItems?.length > 0 && (
                                                <div className="space-y-2">
                                                    <MaterialButton
                                                        onClick={() => setShowQuantityModal(true)}
                                                        variant="contained"
                                                        color="primary"
                                                        className="w-full"
                                                    >
                                                        <span className="material-icons mr-2">edit</span>
                                                        Set Quantities & Prices ({selectedShipmentItems.length} items)
                                                    </MaterialButton>
                                                    <div className="text-sm text-gray-600 dark:text-gray-400">
                                                        <p className="font-medium mb-1">Instructions:</p>
                                                        <ul className="list-disc list-inside space-y-1">
                                                            <li>Set the quantity received for each item</li>
                                                            <li>Enter the unit price from the receipt</li>
                                                            <li>Items will be added to inventory automatically</li>
                                                            <li>Cost allocation report will be generated</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </MaterialCard>

                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        {/* PDF Upload */}
                                        <MaterialCard elevation={2}>
                                            <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-blue-600">upload_file</span>
                                            Upload Receipt PDF
                                        </h3>
                                            <div className="space-y-4">
                                            <div className="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-blue-400 transition-colors">
                                                <span className="material-icons text-4xl text-gray-400 mb-2">picture_as_pdf</span>
                                                <p className="text-gray-600 dark:text-gray-400 mb-4">
                                                    Drop PDF receipt here or click to upload
                                                </p>
                                                <input
                                                    type="file"
                                                    accept=".pdf"
                                                    className="hidden"
                                                    id="pdf-upload"
                                                    onChange={handlePdfUpload}
                                                />
                                                <MaterialButton
                                                    onClick={() => document.getElementById('pdf-upload').click()}
                                                    variant="outlined"
                                                    color="primary"
                                                    disabled={isProcessing}
                                                >
                                                    <span className="material-icons mr-2">file_upload</span>
                                                    {pdfFile ? pdfFile.name : 'Choose PDF File'}
                                                </MaterialButton>
                                            </div>
                                            <div className="text-sm text-gray-600 dark:text-gray-400">
                                                <p className="font-medium mb-2">Supported formats:</p>
                                                <ul className="list-disc list-inside space-y-1">
                                                    <li>PDF receipts from vendors</li>
                                                    <li>Purchase orders with itemized costs</li>
                                                    <li>Invoices with line items</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </MaterialCard>

                                    {/* Processing Options */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-blue-600">receipt_long</span>
                                            Receipt Details
                                        </h3>
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className="mat-input">
                                                    <input
                                                        type="text"
                                                        placeholder="Enter vendor name"
                                                        value={vendorName}
                                                        onChange={(e) => setVendorName(e.target.value)}
                                                    />
                                                    <label>Vendor Name</label>
                                                </div>
                                                <div className="mat-input">
                                                    <input
                                                        type="date"
                                                        value={receiptDate}
                                                        onChange={(e) => setReceiptDate(e.target.value)}
                                                    />
                                                    <label>Receipt Date</label>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className="mat-input">
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        min="0"
                                                        placeholder="0.00"
                                                        value={taxAmount || ''}
                                                        onChange={(e) => setTaxAmount(parseFloat(e.target.value) || 0)}
                                                    />
                                                    <label>Tax Amount ($)</label>
                                                </div>
                                                <div className="mat-input">
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        min="0"
                                                        placeholder="0.00"
                                                        value={extraFees || ''}
                                                        onChange={(e) => setExtraFees(parseFloat(e.target.value) || 0)}
                                                    />
                                                    <label>Extra Fees (Shipping, etc.) ($)</label>
                                                </div>
                                            </div>

                                            <div className="mat-input">
                                                <textarea
                                                    rows={2}
                                                    placeholder="Optional processing notes"
                                                    value={processingNotes}
                                                    onChange={(e) => setProcessingNotes(e.target.value)}
                                                />
                                                <label>Notes</label>
                                            </div>

                                            <MaterialButton
                                                variant="contained"
                                                color="success"
                                                className="w-full"
                                                disabled={!pdfFile || isProcessing || !selectedShipmentItems || selectedShipmentItems.length === 0}
                                                onClick={processShipment}
                                            >
                                                {isProcessing ? (
                                                    <>
                                                        <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                        Processing...
                                                    </>
                                                ) : (
                                                    <>
                                                        <span className="material-icons mr-2">inventory</span>
                                                        Process Shipment & Update Inventory
                                                    </>
                                                )}
                                            </MaterialButton>
                                        </div>
                                    </MaterialCard>

                                    {/* Selected Items Summary */}
                                    {selectedShipmentItems && selectedShipmentItems.length > 0 && (
                                        <MaterialCard elevation={1} className="lg:col-span-2">
                                            <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                                <span className="material-icons mr-2 text-green-600">inventory</span>
                                                Ready to Process ({selectedShipmentItems.length} items)
                                            </h3>
                                            <div className="overflow-x-auto">
                                                <table className="min-w-full">
                                                    <thead className="bg-gray-50 dark:bg-gray-700">
                                                        <tr>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300">Item</th>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300">Current Stock</th>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300">Qty to Add</th>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300">Unit Price</th>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300">Total Cost</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                        {selectedShipmentItems.map((itemName, index) => {
                                                            const item = items.find(i => i.name === itemName);
                                                            const details = shipmentItemDetails[itemName];
                                                            return (
                                                                <tr key={index} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                                                                    <td className="px-4 py-2 text-sm font-medium text-gray-900 dark:text-white">
                                                                        {itemName.length > 30 ? itemName.substring(0, 30) + '...' : itemName}
                                                                    </td>
                                                                    <td className="px-4 py-2 text-sm text-gray-600 dark:text-gray-400">{item?.quantity || 0}</td>
                                                                    <td className="px-4 py-2 text-sm text-gray-600 dark:text-gray-400">
                                                                        {details?.quantity || '-'}
                                                                    </td>
                                                                    <td className="px-4 py-2 text-sm text-gray-600 dark:text-gray-400">
                                                                        {details?.price ? `$${details.price.toFixed(2)}` : '-'}
                                                                    </td>
                                                                    <td className="px-4 py-2 text-sm font-medium text-green-600 dark:text-green-400">
                                                                        {details?.quantity && details?.price ? `$${(details.quantity * details.price).toFixed(2)}` : '-'}
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                                <div className="mt-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                                    <div className="text-sm font-medium text-green-900 dark:text-green-100">
                                                        Total Shipment Value: ${
                                                            selectedShipmentItems.reduce((sum, itemName) => {
                                                                const details = shipmentItemDetails[itemName];
                                                                return sum + (details?.quantity && details?.price ? details.quantity * details.price : 0);
                                                            }, 0).toFixed(2)
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </MaterialCard>
                                    )}

                                    {/* Recent Processing */}
                                    <MaterialCard elevation={1} className="lg:col-span-2">
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-purple-600">history</span>
                                            Recent Shipment Processing
                                        </h3>
                                        {processingResults.length === 0 ? (
                                            <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                                                <span className="material-icons text-6xl mb-4 opacity-50">receipt_long</span>
                                                <p className="font-medium">No shipments processed yet</p>
                                                <p className="text-sm">Upload a PDF receipt to get started</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                {processingResults.slice(-5).reverse().map((result, index) => (
                                                    <div key={index} className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                                        <div className="flex items-center space-x-3">
                                                            <span className="material-icons text-green-600">check_circle</span>
                                                            <div>
                                                                <p className="font-medium text-gray-900 dark:text-white">{result.fileName}</p>
                                                                <p className="text-sm text-gray-600 dark:text-gray-400">
                                                                    {result.itemsProcessed} items • ${result.totalAmount.toFixed(2)} • {result.vendor}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div className="text-sm text-gray-500 dark:text-gray-400">
                                                            {new Date(result.timestamp).toLocaleDateString()}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )})
                                    </MaterialCard>
                                </div>
                            </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                                    <span className="material-icons mr-2">history</span>
                                    Checkout History
                                </h2>

                                {/* Current/Archive Toggle */}
                                <div className="mb-6">
                                    <div className="flex bg-gray-100 dark:bg-gray-700 rounded-xl p-1 w-fit">
                                        <button
                                            onClick={() => setCheckoutViewMode('current')}
                                            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all font-medium text-sm ${
                                                checkoutViewMode === 'current'
                                                    ? 'bg-white dark:bg-gray-600 text-blue-600 dark:text-blue-400 shadow-sm'
                                                    : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
                                            }`}
                                        >
                                            <span className="material-icons text-sm">pending_actions</span>
                                            Current Checkout
                                            {checkoutHistory.length > 0 && (
                                                <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                                                    checkoutViewMode === 'current'
                                                        ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300'
                                                        : 'bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-400'
                                                }`}>
                                                    {checkoutHistory.length}
                                                </span>
                                            )}
                                        </button>
                                        <button
                                            onClick={() => setCheckoutViewMode('archive')}
                                            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all font-medium text-sm ${
                                                checkoutViewMode === 'archive'
                                                    ? 'bg-white dark:bg-gray-600 text-blue-600 dark:text-blue-400 shadow-sm'
                                                    : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
                                            }`}
                                        >
                                            <span className="material-icons text-sm">inventory</span>
                                            Archive
                                            {archivedCheckouts.length > 0 && (
                                                <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                                                    checkoutViewMode === 'archive'
                                                        ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300'
                                                        : 'bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-400'
                                                }`}>
                                                    {archivedCheckouts.length}
                                                </span>
                                            )}
                                        </button>
                                    </div>
                                </div>

                                <MaterialCard elevation={1}>
                                    <div className="mb-4">
                                        <p className="text-sm text-gray-600 dark:text-gray-400">
                                            {checkoutViewMode === 'archive'
                                                ? 'View archived checkout records that have been processed through shipments'
                                                : 'View current checkout history with pagination for better performance'
                                            }
                                        </p>
                                    </div>

                                    {/* Search History */}
                                    <div className="mb-6">
                                        <div className="relative">
                                            <input
                                                type="text"
                                                placeholder="Search history by item, user, department, or job number..."
                                                value={historySearchQuery}
                                                onChange={(e) => setHistorySearchQuery(e.target.value)}
                                                className="w-full px-4 py-3 pl-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                                            />
                                            <span className="material-icons absolute left-4 top-3.5 text-gray-400">search</span>
                                            {historySearchQuery && (
                                                <button
                                                    onClick={() => setHistorySearchQuery('')}
                                                    className="absolute right-3 top-3.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
                                                >
                                                    <span className="material-icons text-sm">clear</span>
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full">
                                            <thead className="bg-gray-50 dark:bg-gray-700">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">inventory</span>
                                                            Item
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">person</span>
                                                            User
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">numbers</span>
                                                            Quantity
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">business</span>
                                                            Department
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">schedule</span>
                                                            {checkoutViewMode === 'archive' ? 'Original Date' : 'Date'}
                                                        </div>
                                                    </th>
                                                    {checkoutViewMode === 'archive' && (
                                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                            <div className="flex items-center">
                                                                <span className="material-icons mr-1 text-sm">archive</span>
                                                                Archived Date
                                                            </div>
                                                        </th>
                                                    )}
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">settings</span>
                                                            Actions
                                                        </div>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                {getPaginatedCheckoutHistory().map(record => (
                                                    <tr key={record.id} className="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                                        <td className="px-6 py-4 font-medium text-gray-900 dark:text-white">
                                                            {record.itemName}
                                                        </td>
                                                        <td className="px-6 py-4 text-gray-600 dark:text-gray-400">
                                                            {record.userName}
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300">
                                                                {record.quantity}
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                                            {formatDepartmentId(record.departmentId || record.costCode) || '-'}
                                                        </td>
                                                        <td className="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                                            {record.dateEntered?.toDate?.()?.toLocaleDateString() ||
                                                             (typeof record.dateEntered === 'string' ? new Date(record.dateEntered).toLocaleDateString() : 'Unknown')}
                                                        </td>
                                                        {checkoutViewMode === 'archive' && (
                                                            <td className="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                                                {record.archivedAt?.toDate?.()?.toLocaleDateString() ||
                                                                 (typeof record.archivedAt === 'string' ? new Date(record.archivedAt).toLocaleDateString() : 'Unknown')}
                                                            </td>
                                                        )}
                                                        <td className="px-6 py-4">
                                                            <div className="flex items-center space-x-2">
                                                                {checkoutViewMode === 'current' ? (
                                                                    <>
                                                                        <MaterialButton
                                                                            variant="text"
                                                                            color="primary"
                                                                            className="!p-2 !min-w-0"
                                                                            onClick={() => openEditCheckoutModal(record)}
                                                                        >
                                                                            <span className="material-icons text-sm">edit</span>
                                                                        </MaterialButton>
                                                                        <MaterialButton
                                                                            variant="text"
                                                                            color="secondary"
                                                                            className="!p-2 !min-w-0"
                                                                            onClick={() => manualArchiveRecord(record)}
                                                                        >
                                                                            <span className="material-icons text-sm">archive</span>
                                                                        </MaterialButton>
                                                                    </>
                                                                ) : (
                                                                    <MaterialButton
                                                                        variant="text"
                                                                        color="primary"
                                                                        className="!p-2 !min-w-0"
                                                                        onClick={() => unarchiveRecord(record)}
                                                                    >
                                                                        <span className="material-icons text-sm">unarchive</span>
                                                                    </MaterialButton>
                                                                )}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* Checkout History Pagination */}
                                    <MaterialPagination
                                        currentPage={checkoutPagination.currentPage}
                                        totalItems={checkoutPagination.totalItems}
                                        itemsPerPage={checkoutPagination.itemsPerPage}
                                        onPageChange={handleCheckoutPageChange}
                                        onItemsPerPageChange={handleCheckoutItemsPerPageChange}
                                    />
                                </MaterialCard>
                            </div>
                        )}
                    </main>

                    {/* Material Design FAB */}
                    <button
                        onClick={() => setActiveTab('shop')}
                        className="mat-fab bg-blue-600 hover:bg-blue-700 text-white mat-elevation-8"
                    >
                        <span className="material-icons">add_shopping_cart</span>
                    </button>

                    {/* Duplicate Items Dialog */}
                    {duplicateDialog.open && (
                        <div className="md-modal-overlay" onClick={() => setDuplicateDialog(prev => ({...prev, open: false}))}>
                            <div className="md-modal" style={{maxWidth: '800px', width: '95%'}} onClick={(e) => e.stopPropagation()}>
                                <button className="md-modal-close" onClick={() => setDuplicateDialog(prev => ({...prev, open: false}))}>
                                    <span className="material-icons">close</span>
                                </button>

                                <div className="md-modal-header">
                                    <h2 className="md-modal-title">
                                        <span className="material-icons" style={{ color: 'var(--md-sys-color-warning)' }}>
                                            warning
                                        </span>
                                        Duplicate Items Found
                                    </h2>
                                </div>

                                <div className="md-modal-body">
                                    <p style={{
                                        color: 'var(--md-sys-color-on-surface-variant)',
                                        marginBottom: '16px',
                                        font: 'var(--md-sys-typescale-body-large)'
                                    }}>
                                        Found {duplicateDialog.duplicates.length} potential duplicate{duplicateDialog.duplicates.length !== 1 ? 's' : ''}.
                                        Choose how to handle each one:
                                    </p>

                                    <div className="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div className="flex items-center mb-2">
                                            <span className="material-icons text-blue-600 mr-2">settings</span>
                                            <span className="font-medium text-gray-900 dark:text-gray-100">Batch Actions:</span>
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                            {[
                                                { action: 'skip', label: 'Skip All', icon: 'block', color: 'bg-red-100 hover:bg-red-200 text-red-700' },
                                                { action: 'update', label: 'Add All Quantities', icon: 'add', color: 'bg-green-100 hover:bg-green-200 text-green-700' },
                                                { action: 'replace', label: 'Replace All', icon: 'swap_horiz', color: 'bg-blue-100 hover:bg-blue-200 text-blue-700' },
                                                { action: 'create', label: 'Create All New', icon: 'add_circle', color: 'bg-purple-100 hover:bg-purple-200 text-purple-700' }
                                            ].map(batchOption => (
                                                <button
                                                    key={batchOption.action}
                                                    className={`p-2 rounded border text-xs font-medium transition-colors ${batchOption.color} border-transparent`}
                                                    onClick={() => {
                                                        const newChoices = {};
                                                        duplicateDialog.duplicates.forEach(duplicate => {
                                                            const itemKey = duplicate.newItem.name.toLowerCase().trim();
                                                            newChoices[itemKey] = {
                                                                action: batchOption.action,
                                                                existingItem: duplicate.existingItem,
                                                                newName: batchOption.action === 'create' ? `${duplicate.newItem.name} (Import)` : undefined
                                                            };
                                                        });
                                                        setDuplicateDialog(prev => ({
                                                            ...prev,
                                                            choices: { ...prev.choices, ...newChoices }
                                                        }));
                                                    }}
                                                >
                                                    <div className="flex flex-col items-center">
                                                        <span className="material-icons text-sm">{batchOption.icon}</span>
                                                        <span className="mt-1">{batchOption.label}</span>
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="space-y-4 max-h-96 overflow-y-auto">
                                        {duplicateDialog.duplicates.map((duplicate, index) => {
                                            const itemKey = duplicate.newItem.name.toLowerCase().trim();
                                            const choice = duplicateDialog.choices[itemKey] || { action: 'skip' };

                                            return (
                                                <div key={index} className="border border-gray-200 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="flex-1">
                                                            <h4 className="font-medium text-gray-900 dark:text-gray-100">
                                                                {duplicate.newItem.name}
                                                            </h4>
                                                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                                                Match found by: {duplicate.matchType}
                                                                {duplicate.matchType === 'asin' && ` (${duplicate.newItem.asin})`}
                                                            </p>
                                                        </div>
                                                    </div>

                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                        <div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded">
                                                            <h5 className="font-medium text-blue-900 dark:text-blue-100 mb-2">New Item (CSV)</h5>
                                                            <div className="text-sm space-y-1 text-blue-800 dark:text-blue-200">
                                                                <div>Quantity: {duplicate.newItem.quantity || 0}</div>
                                                                {duplicate.newItem.price > 0 && <div>Price: ${duplicate.newItem.price}</div>}
                                                                {duplicate.newItem.category && <div>Category: {duplicate.newItem.category}</div>}
                                                                {duplicate.newItem.asin && <div>ASIN: {duplicate.newItem.asin}</div>}
                                                            </div>
                                                        </div>
                                                        <div className="bg-gray-100 dark:bg-gray-600 p-3 rounded">
                                                            <h5 className="font-medium text-gray-900 dark:text-gray-100 mb-2">Existing Item</h5>
                                                            <div className="text-sm space-y-1 text-gray-700 dark:text-gray-300">
                                                                <div>Quantity: {duplicate.existingItem.quantity || 0}</div>
                                                                {duplicate.existingItem.price > 0 && <div>Price: ${duplicate.existingItem.price}</div>}
                                                                {duplicate.existingItem.category && <div>Category: {duplicate.existingItem.category}</div>}
                                                                {duplicate.existingItem.asin && <div>ASIN: {duplicate.existingItem.asin}</div>}
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div className="space-y-2">
                                                        <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Choose Action:</label>
                                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                            {[
                                                                { value: 'skip', label: 'Skip Import', icon: 'block', color: 'text-red-600' },
                                                                { value: 'update', label: 'Add Quantities', icon: 'add', color: 'text-green-600' },
                                                                { value: 'replace', label: 'Replace Existing', icon: 'swap_horiz', color: 'text-blue-600' },
                                                                { value: 'create', label: 'Create New', icon: 'add_circle', color: 'text-purple-600' }
                                                            ].map(option => (
                                                                <button
                                                                    key={option.value}
                                                                    className={`p-2 rounded border text-xs font-medium transition-colors ${
                                                                        choice.action === option.value
                                                                            ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300'
                                                                            : 'border-gray-300 dark:border-gray-600 hover:border-gray-400'
                                                                    }`}
                                                                    onClick={() => {
                                                                        setDuplicateDialog(prev => ({
                                                                            ...prev,
                                                                            choices: {
                                                                                ...prev.choices,
                                                                                [itemKey]: {
                                                                                    action: option.value,
                                                                                    existingItem: duplicate.existingItem,
                                                                                    newName: option.value === 'create' ? `${duplicate.newItem.name} (Import)` : undefined
                                                                                }
                                                                            }
                                                                        }));
                                                                    }}
                                                                >
                                                                    <div className="flex flex-col items-center">
                                                                        <span className={`material-icons text-sm ${option.color}`}>{option.icon}</span>
                                                                        <span className="mt-1">{option.label}</span>
                                                                    </div>
                                                                </button>
                                                            ))}
                                                        </div>
                                                        {choice.action === 'create' && (
                                                            <input
                                                                type="text"
                                                                placeholder="New item name"
                                                                className="w-full mt-2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                                                                value={choice.newName || `${duplicate.newItem.name} (Import)`}
                                                                onChange={(e) => {
                                                                    setDuplicateDialog(prev => ({
                                                                        ...prev,
                                                                        choices: {
                                                                            ...prev.choices,
                                                                            [itemKey]: { ...choice, newName: e.target.value }
                                                                        }
                                                                    }));
                                                                }}
                                                            />
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div className="mt-4 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
                                        <div className="flex items-center mb-2">
                                            <span className="material-icons text-amber-600 mr-2">info</span>
                                            <span className="font-medium text-amber-800 dark:text-amber-200">Action Explanations:</span>
                                        </div>
                                        <div className="text-xs text-amber-700 dark:text-amber-300 space-y-1">
                                            <div><strong>Skip:</strong> Don't import this item, keep existing unchanged</div>
                                            <div><strong>Add Quantities:</strong> Add new quantity to existing quantity, update other fields</div>
                                            <div><strong>Replace:</strong> Completely replace existing item with new data</div>
                                            <div><strong>Create New:</strong> Create as a separate item with different name</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="md-modal-actions">
                                    <button
                                        type="button"
                                        className="md-button secondary"
                                        onClick={() => setDuplicateDialog(prev => ({...prev, open: false}))}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="button"
                                        className="md-button primary"
                                        onClick={async () => {
                                            try {
                                                setCsvOperations(prev => ({ ...prev, importingItems: true }));
                                                const { successCount, errorCount } = await processDuplicateChoices(
                                                    duplicateDialog.newItems,
                                                    duplicateDialog.choices
                                                );

                                                showSnackbar(
                                                    `Import completed: ${successCount} items processed, ${errorCount} errors`,
                                                    successCount > 0 ? 'success' : 'warning'
                                                );

                                                setDuplicateDialog({ open: false, duplicates: [], newItems: [], choices: {} });
                                            } catch (error) {
                                                showSnackbar(`Import failed: ${error.message}`, 'error');
                                            } finally {
                                                setCsvOperations(prev => ({ ...prev, importingItems: false }));
                                            }
                                        }}
                                    >
                                        Proceed with Import
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Duplicate Cleanup Dialog */}
                    {cleanupDialog.open && (
                        <div className="md-modal-overlay" onClick={() => setCleanupDialog(prev => ({...prev, open: false}))}>
                            <div className="md-modal" style={{maxWidth: '900px', width: '95%'}} onClick={(e) => e.stopPropagation()}>
                                <button className="md-modal-close" onClick={() => setCleanupDialog(prev => ({...prev, open: false}))}>
                                    <span className="material-icons">close</span>
                                </button>

                                <div className="md-modal-header">
                                    <h2 className="md-modal-title">
                                        <span className="material-icons" style={{ color: 'var(--md-sys-color-error)' }}>
                                            content_copy
                                        </span>
                                        Duplicate Items Found - Cleanup Required
                                    </h2>
                                </div>

                                <div className="md-modal-body">
                                    <p style={{
                                        color: 'var(--md-sys-color-on-surface-variant)',
                                        marginBottom: '16px',
                                        font: 'var(--md-sys-typescale-body-large)'
                                    }}>
                                        Found {cleanupDialog.duplicateGroups.length} group{cleanupDialog.duplicateGroups.length !== 1 ? 's' : ''} of duplicate items.
                                        Review and choose which items to keep:
                                    </p>

                                    <div className="space-y-4 max-h-96 overflow-y-auto">
                                        {cleanupDialog.duplicateGroups.map((group, groupIndex) => {
                                            const choice = cleanupDialog.mergeChoices[group.name] || { keepItemId: group.items[0].id, deleteItemIds: [] };

                                            return (
                                                <div key={groupIndex} className="border border-red-200 dark:border-red-600 rounded-lg p-4 bg-red-50 dark:bg-red-900/20">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="flex-1">
                                                            <h4 className="font-medium text-red-900 dark:text-red-100 flex items-center">
                                                                <span className="material-icons mr-2 text-red-600">warning</span>
                                                                {group.name}
                                                            </h4>
                                                            <p className="text-sm text-red-700 dark:text-red-300">
                                                                {group.items.length} duplicates found | Total quantity: {group.totalQuantity} | Match by: {group.matchType}
                                                            </p>
                                                        </div>
                                                    </div>

                                                    <div className="space-y-3">
                                                        <label className="text-sm font-medium text-red-800 dark:text-red-200">Choose which item to keep (others will be deleted):</label>
                                                        <div className="grid gap-3">
                                                            {group.items.map((item, itemIndex) => (
                                                                <div
                                                                    key={item.id}
                                                                    className={`p-3 rounded border cursor-pointer transition-colors ${
                                                                        choice.keepItemId === item.id
                                                                            ? 'border-green-500 bg-green-50 dark:bg-green-900/20'
                                                                            : 'border-gray-300 dark:border-gray-600 hover:border-gray-400'
                                                                    }`}
                                                                    onClick={() => {
                                                                        setCleanupDialog(prev => ({
                                                                            ...prev,
                                                                            mergeChoices: {
                                                                                ...prev.mergeChoices,
                                                                                [group.name]: {
                                                                                    keepItemId: item.id,
                                                                                    deleteItemIds: group.items.filter(i => i.id !== item.id).map(i => i.id)
                                                                                }
                                                                            }
                                                                        }));
                                                                    }}
                                                                >
                                                                    <div className="flex items-center">
                                                                        <div className={`w-4 h-4 rounded-full border-2 mr-3 flex items-center justify-center ${
                                                                            choice.keepItemId === item.id
                                                                                ? 'border-green-500 bg-green-500'
                                                                                : 'border-gray-400'
                                                                        }`}>
                                                                            {choice.keepItemId === item.id && (
                                                                                <span className="material-icons text-white text-xs">check</span>
                                                                            )}
                                                                        </div>
                                                                        <div className="flex-1">
                                                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                                                                                <div><strong>Quantity:</strong> {item.quantity || 0}</div>
                                                                                <div><strong>Price:</strong> {item.price > 0 ? `$${item.price}` : 'N/A'}</div>
                                                                                <div><strong>Category:</strong> {item.category || 'N/A'}</div>
                                                                                <div><strong>ASIN:</strong> {item.asin || 'N/A'}</div>
                                                                            </div>
                                                                            <div className="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                                                                ID: {item.id} | Created: {item.createdAt?.toDate?.()?.toLocaleDateString() || 'Unknown'}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>

                                                    <div className="mt-3 p-2 bg-amber-50 dark:bg-amber-900/20 rounded text-xs text-amber-800 dark:text-amber-200">
                                                        <strong>After merge:</strong> Quantities will be combined ({group.totalQuantity} total),
                                                        highest price kept, most recent category preserved, audit trail maintained.
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div className="mt-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
                                        <div className="flex items-center mb-2">
                                            <span className="material-icons text-red-600 mr-2">warning</span>
                                            <span className="font-medium text-red-800 dark:text-red-200">⚠️ Important Safety Information:</span>
                                        </div>
                                        <div className="text-xs text-red-700 dark:text-red-300 space-y-1">
                                            <div><strong>Merge Process:</strong> Selected items will be kept with combined quantities and best attributes</div>
                                            <div><strong>Deletion:</strong> Non-selected duplicates will be permanently deleted from database</div>
                                            <div><strong>Audit Trail:</strong> All changes are logged with timestamps and user attribution</div>
                                            <div><strong>Irreversible:</strong> This action cannot be undone - please review carefully!</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="md-modal-actions">
                                    <button
                                        type="button"
                                        className="md-button secondary"
                                        onClick={() => setCleanupDialog(prev => ({...prev, open: false}))}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="button"
                                        className="md-button error"
                                        onClick={async () => {
                                            if (!confirm(`Are you sure you want to merge ${cleanupDialog.duplicateGroups.length} duplicate groups? This will permanently delete ${cleanupDialog.duplicateGroups.reduce((total, group) => total + group.items.length - 1, 0)} items and cannot be undone.`)) {
                                                return;
                                            }

                                            try {
                                                let totalMerged = 0;
                                                let totalDeleted = 0;
                                                let errors = 0;

                                                for (const group of cleanupDialog.duplicateGroups) {
                                                    const choice = cleanupDialog.mergeChoices[group.name];
                                                    if (choice) {
                                                        const result = await mergeDuplicateGroup(group, choice.keepItemId, choice.deleteItemIds);
                                                        if (result.success) {
                                                            totalMerged++;
                                                            totalDeleted += result.deletedCount;
                                                        } else {
                                                            errors++;
                                                            console.error('Merge failed:', result.error);
                                                        }
                                                    }
                                                }

                                                showSnackbar(
                                                    `Cleanup completed: ${totalMerged} groups merged, ${totalDeleted} duplicates removed${errors > 0 ? `, ${errors} errors` : ''}`,
                                                    errors === 0 ? 'success' : 'warning'
                                                );

                                                setCleanupDialog({ open: false, duplicateGroups: [], mergeChoices: {}, scanning: false });
                                            } catch (error) {
                                                showSnackbar(`Cleanup failed: ${error.message}`, 'error');
                                            }
                                        }}
                                    >
                                        <span className="material-icons mr-2">merge</span>
                                        Merge All Duplicates
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Low Stock Popup Modal */}
                    {showLowStockPopup && notifications.length > 0 && (
                        <div className="md-modal-overlay" onClick={handlePopupDismiss}>
                            <div className="md-modal" onClick={(e) => e.stopPropagation()}>
                                <button className="md-modal-close" onClick={handlePopupDismiss}>
                                    <span className="material-icons">close</span>
                                </button>

                                <div className="md-modal-header">
                                    <h2 className="md-modal-title">
                                        <span className="material-icons" style={{ color: 'var(--md-sys-color-warning)' }}>
                                            warning
                                        </span>
                                        Low Stock Alert
                                    </h2>
                                </div>

                                <div className="md-modal-body">
                                    <p style={{
                                        color: 'var(--md-sys-color-on-surface-variant)',
                                        marginBottom: '16px',
                                        font: 'var(--md-sys-typescale-body-large)'
                                    }}>
                                        {notifications.length} item{notifications.length > 1 ? 's' : ''} {notifications.length > 1 ? 'need' : 'needs'} immediate attention due to low stock levels.
                                    </p>

                                    <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                                        {notifications.slice(0, 5).map((notif, index) => {
                                            const item = items.find(i => i.id === notif.id);
                                            return (
                                                <div key={notif.id} className="md-low-stock-item">
                                                    <div className="md-low-stock-item-name">
                                                        {item?.name || 'Unknown Item'}
                                                    </div>
                                                    <div className="md-low-stock-item-quantity">
                                                        {item?.quantity || 0} remaining
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {notifications.length > 5 && (
                                            <p style={{
                                                color: 'var(--md-sys-color-on-surface-variant)',
                                                textAlign: 'center',
                                                margin: '12px 0',
                                                font: 'var(--md-sys-typescale-body-medium)'
                                            }}>
                                                ... and {notifications.length - 5} more items
                                            </p>
                                        )}
                                    </div>
                                </div>

                                <div className="md-modal-actions">
                                    <button className="md-button error" onClick={handlePopupAlwaysHide}>
                                        <span className="material-icons">visibility_off</span>
                                        Don't show again
                                    </button>
                                    <button className="md-button secondary" onClick={handlePopupDismiss}>
                                        Dismiss
                                    </button>
                                    <button className="md-button primary" onClick={handlePopupViewInventory}>
                                        <span className="material-icons">inventory_2</span>
                                        View Inventory
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Checkout Record Modal */}
                    {showEditCheckoutModal && editCheckoutRecord && (
                        <div className="md-modal-overlay" onClick={closeEditCheckoutModal}>
                            <div className="md-modal" onClick={(e) => e.stopPropagation()}>
                                <button className="md-modal-close" onClick={closeEditCheckoutModal}>
                                    <span className="material-icons">close</span>
                                </button>

                                <div className="md-modal-header">
                                    <h2 className="md-modal-title">
                                        <span className="material-icons" style={{ color: 'var(--md-sys-color-primary)' }}>
                                            edit
                                        </span>
                                        Edit Checkout Record
                                    </h2>
                                </div>

                                <div className="md-modal-body">
                                    <div className="space-y-4">
                                        <MaterialInput
                                            label="Item Name"
                                            value={editCheckoutRecord.itemName}
                                            onChange={(e) => setEditCheckoutRecord(prev => ({ ...prev, itemName: e.target.value }))}
                                            required
                                        />

                                        <MaterialInput
                                            label="User Name"
                                            value={editCheckoutRecord.userName}
                                            onChange={(e) => setEditCheckoutRecord(prev => ({ ...prev, userName: e.target.value }))}
                                            required
                                        />

                                        <MaterialInput
                                            label="Quantity"
                                            type="number"
                                            value={editCheckoutRecord.quantity}
                                            onChange={(e) => setEditCheckoutRecord(prev => ({ ...prev, quantity: e.target.value }))}
                                            required
                                            min="1"
                                        />

                                        <MaterialInput
                                            label="Department ID"
                                            value={editCheckoutRecord.departmentId}
                                            onChange={(e) => setEditCheckoutRecord(prev => ({ ...prev, departmentId: e.target.value }))}
                                            placeholder="e.g., 2-20-060"
                                        />

                                        <MaterialInput
                                            label="Job Number"
                                            value={editCheckoutRecord.jobNumber}
                                            onChange={(e) => setEditCheckoutRecord(prev => ({ ...prev, jobNumber: e.target.value }))}
                                            placeholder="Optional job number"
                                        />

                                        <MaterialInput
                                            label="Notes"
                                            value={editCheckoutRecord.notes}
                                            onChange={(e) => setEditCheckoutRecord(prev => ({ ...prev, notes: e.target.value }))}
                                            placeholder="Optional notes"
                                        />
                                    </div>
                                </div>

                                <div className="md-modal-actions">
                                    <button type="button" className="md-button secondary" onClick={closeEditCheckoutModal}>
                                        Cancel
                                    </button>
                                    <button type="button" className="md-button primary" onClick={saveEditCheckoutRecord}>
                                        <span className="material-icons">save</span>
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit User Modal */}
                    {editingUser && (
                        <div className="md-modal-overlay" onClick={() => setEditingUser(null)}>
                            <div className="md-modal" onClick={(e) => e.stopPropagation()}>
                                <button className="md-modal-close" onClick={() => setEditingUser(null)}>
                                    <span className="material-icons">close</span>
                                </button>

                                <div className="md-modal-header">
                                    <h2 className="md-modal-title">
                                        <span className="material-icons" style={{ color: 'var(--md-sys-color-primary)' }}>
                                            person
                                        </span>
                                        Edit User
                                    </h2>
                                </div>

                                <form onSubmit={handleUpdateUser}>
                                    <div className="md-modal-body">
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <MaterialInput
                                                    label="First Name"
                                                    value={editUserForm.firstName}
                                                    onChange={(e) => setEditUserForm(prev => ({ ...prev, firstName: e.target.value }))}
                                                    required
                                                />
                                                <MaterialInput
                                                    label="Last Name"
                                                    value={editUserForm.lastName}
                                                    onChange={(e) => setEditUserForm(prev => ({ ...prev, lastName: e.target.value }))}
                                                    required
                                                />
                                            </div>
                                            <MaterialInput
                                                label="Cost Code"
                                                value={editUserForm.costCode}
                                                onChange={(e) => setEditUserForm(prev => ({ ...prev, costCode: e.target.value }))}
                                                placeholder="e.g., 1-10-100-5770"
                                            />
                                            <MaterialInput
                                                label="Employee ID"
                                                value={editUserForm.employeeId}
                                                onChange={(e) => setEditUserForm(prev => ({ ...prev, employeeId: e.target.value }))}
                                                placeholder="e.g., EMP001, 12345"
                                            />
                                        </div>
                                    </div>

                                    <div className="md-modal-actions">
                                        <button
                                            type="button"
                                            className="md-button secondary"
                                            onClick={() => setEditingUser(null)}
                                        >
                                            Cancel
                                        </button>
                                        <MaterialButton
                                            type="submit"
                                            variant="contained"
                                            color="primary"
                                            disabled={isUpdatingUser}
                                        >
                                            {isUpdatingUser ? (
                                                <>
                                                    <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                    Updating...
                                                </>
                                            ) : (
                                                <>
                                                    <span className="material-icons mr-2">save</span>
                                                    Update User
                                                </>
                                            )}
                                        </MaterialButton>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Quantity/Price Modal for Process Shipment */}
                    {showQuantityModal && (
                        <div className="md-modal-overlay" onClick={() => setShowQuantityModal(false)}>
                            <div className="md-modal" onClick={(e) => e.stopPropagation()}>
                                <button className="md-modal-close" onClick={() => setShowQuantityModal(false)}>
                                    <span className="material-icons">close</span>
                                </button>

                                <div className="md-modal-header">
                                    <h2 className="md-modal-title">
                                        <span className="material-icons" style={{ color: 'var(--md-sys-color-primary)' }}>
                                            edit
                                        </span>
                                        Set Quantities & Prices
                                    </h2>
                                </div>

                                <div className="md-modal-body">
                                    <div className="space-y-4 max-h-96 overflow-y-auto">
                                        {selectedShipmentItems?.map((itemName, index) => {
                                            const item = items.find(i => i.name === itemName);
                                            return (
                                                <div key={itemName} className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                                    <h4 className="font-medium text-gray-900 dark:text-white mb-3">{itemName}</h4>
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div className="mat-input">
                                                            <input
                                                                type="number"
                                                                value={shipmentItemDetails[itemName]?.quantity || ''}
                                                                onChange={(e) => setShipmentItemDetails(prev => ({
                                                                    ...prev,
                                                                    [itemName]: {
                                                                        ...prev[itemName],
                                                                        quantity: parseInt(e.target.value) || 0
                                                                    }
                                                                }))}
                                                                min="1"
                                                                required
                                                                placeholder="Enter quantity received"
                                                            />
                                                            <label>Quantity Received</label>
                                                        </div>
                                                        <div className="mat-input">
                                                            <input
                                                                type="number"
                                                                value={shipmentItemDetails[itemName]?.price || ''}
                                                                onChange={(e) => setShipmentItemDetails(prev => ({
                                                                    ...prev,
                                                                    [itemName]: {
                                                                        ...prev[itemName],
                                                                        price: parseFloat(e.target.value) || 0
                                                                    }
                                                                }))}
                                                                step="0.01"
                                                                placeholder="0.00"
                                                                required
                                                            />
                                                            <label>Unit Price ($)</label>
                                                        </div>
                                                    </div>
                                                    {item && (
                                                        <div className="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded">
                                                            <div className="text-sm text-gray-600 dark:text-gray-400">
                                                                <div className="grid grid-cols-2 gap-4">
                                                                    <div>
                                                                        <span className="font-medium">Current Stock:</span> {item.quantity}
                                                                    </div>
                                                                    <div>
                                                                        <span className="font-medium">Category:</span> {item.category}
                                                                    </div>
                                                                    <div>
                                                                        <span className="font-medium">Current Price:</span> {item.price > 0 ? `$${item.price.toFixed(2)}` : 'Not set'}
                                                                    </div>
                                                                    <div>
                                                                        <span className="font-medium">New Stock:</span> {item.quantity + (shipmentItemDetails[itemName]?.quantity || 0)}
                                                                    </div>
                                                                </div>
                                                                {shipmentItemDetails[itemName]?.quantity && shipmentItemDetails[itemName]?.price && (
                                                                    <div className="mt-2 pt-2 border-t border-blue-200 dark:border-blue-700">
                                                                        <span className="font-medium text-green-600 dark:text-green-400">
                                                                            Total Cost: ${(shipmentItemDetails[itemName].quantity * shipmentItemDetails[itemName].price).toFixed(2)}
                                                                        </span>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                <div className="md-modal-actions">
                                    <button
                                        type="button"
                                        className="md-button secondary"
                                        onClick={() => setShowQuantityModal(false)}
                                    >
                                        Cancel
                                    </button>
                                    <MaterialButton
                                        variant="contained"
                                        color="primary"
                                        onClick={() => {
                                            // Validate all items have quantity and price
                                            const incompleteItems = selectedShipmentItems.filter(itemName => {
                                                const details = shipmentItemDetails[itemName];
                                                return !details || !details.quantity || details.quantity <= 0 || !details.price || details.price <= 0;
                                            });

                                            if (incompleteItems.length > 0) {
                                                showSnackbar(`Please set quantity and price for: ${incompleteItems.join(', ')}`, 'error');
                                                return;
                                            }

                                            setShowQuantityModal(false);
                                            showSnackbar('Item details saved successfully', 'success');
                                        }}
                                    >
                                        <span className="material-icons mr-2">save</span>
                                        Save Details
                                    </MaterialButton>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* User Duplicate Cleanup Dialog */}
                    {userDuplicateDialog.open && (
                        <div className="md-modal-overlay" onClick={() => setUserDuplicateDialog(prev => ({...prev, open: false}))}>
                            <div className="md-modal" style={{maxWidth: '900px', width: '95%'}} onClick={(e) => e.stopPropagation()}>
                                <button className="md-modal-close" onClick={() => setUserDuplicateDialog(prev => ({...prev, open: false}))}>
                                    <span className="material-icons">close</span>
                                </button>

                                <div className="md-modal-header">
                                    <h2 className="md-modal-title">
                                        <span className="material-icons" style={{ color: 'var(--md-sys-color-warning)' }}>
                                            content_copy
                                        </span>
                                        User Duplicate Cleanup ({userDuplicateDialog.duplicates.length} groups found)
                                    </h2>
                                </div>

                                <div className="md-modal-body">
                                    <p style={{
                                        color: 'var(--md-sys-color-on-surface-variant)',
                                        marginBottom: '20px',
                                        font: 'var(--md-sys-typescale-body-large)'
                                    }}>
                                        Found {userDuplicateDialog.duplicates.length} duplicate user groups. For each group, choose which user to keep - all others will be merged into it.
                                    </p>

                                    <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                        {userDuplicateDialog.duplicates.map((group, groupIndex) => (
                                            <div key={groupIndex} className="border border-gray-200 dark:border-gray-600 rounded-lg p-4 mb-4">
                                                <div className="flex items-center mb-3">
                                                    <span className="material-icons text-orange-600 mr-2">group</span>
                                                    <h4 className="font-medium text-gray-900 dark:text-white">
                                                        {group.name} ({group.users.length} duplicates)
                                                    </h4>
                                                    <span className="ml-auto text-xs px-2 py-1 bg-orange-100 dark:bg-orange-900/20 text-orange-600 rounded">
                                                        {group.matchType === 'costCode' ? 'Cost Code Match' :
                                                         group.matchType === 'name' ? 'Name Match' :
                                                         group.matchType === 'fullName' ? 'Full Name Match' : 'Email Match'}
                                                    </span>
                                                </div>

                                                <div className="space-y-2">
                                                    {group.users.map((user) => (
                                                        <label key={user.id} className="flex items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                                                            <input
                                                                type="radio"
                                                                name={`keep-user-${groupIndex}`}
                                                                value={user.id}
                                                                checked={userDuplicateDialog.choices[group.name]?.keepUserId === user.id}
                                                                onChange={(e) => {
                                                                    const newChoices = {
                                                                        ...userDuplicateDialog.choices,
                                                                        [group.name]: {
                                                                            keepUserId: e.target.value,
                                                                            deleteUserIds: group.users.filter(u => u.id !== e.target.value).map(u => u.id)
                                                                        }
                                                                    };
                                                                    setUserDuplicateDialog(prev => ({
                                                                        ...prev,
                                                                        choices: newChoices
                                                                    }));
                                                                }}
                                                                className="mr-3"
                                                            />
                                                            <div className="flex-1">
                                                                <div className="font-medium text-gray-900 dark:text-white">
                                                                    {user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim()}
                                                                </div>
                                                                <div className="text-sm text-gray-600 dark:text-gray-400">
                                                                    Cost Code: {formatDepartmentId(user.costCode) || 'None'} |
                                                                    Employee ID: {user.employeeId || user.employee_id || 'N/A'}
                                                                </div>
                                                                <div className="text-xs text-gray-500 dark:text-gray-500">
                                                                    Created: {user.createdAt?.toDate?.()?.toLocaleDateString() || 'Unknown'}
                                                                    {user.createdBy && ` by ${user.createdBy}`}
                                                                </div>
                                                            </div>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="mt-4 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-700">
                                        <div className="flex items-start">
                                            <span className="material-icons text-amber-600 mr-2 mt-0.5 text-sm">warning</span>
                                            <div className="text-sm text-amber-700 dark:text-amber-300">
                                                <p className="font-medium mb-1">Important:</p>
                                                <ul className="list-disc list-inside space-y-1">
                                                    <li>Merging will combine user data (keeping the most complete information)</li>
                                                    <li>All checkout history will be updated to reference the kept user</li>
                                                    <li>Duplicate users will be permanently deleted</li>
                                                    <li>This action cannot be undone</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="md-modal-actions">
                                    <button
                                        className="md-button secondary"
                                        onClick={() => setUserDuplicateDialog(prev => ({...prev, open: false}))}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        className="md-button primary"
                                        onClick={async () => {
                                            try {
                                                showSnackbar('Merging duplicate users...', 'info');

                                                let mergedCount = 0;
                                                let errorCount = 0;

                                                for (const group of userDuplicateDialog.duplicates) {
                                                    const choice = userDuplicateDialog.choices[group.name];
                                                    if (choice) {
                                                        try {
                                                            const result = await mergeUserDuplicateGroup(group, choice.keepUserId, choice.deleteUserIds);
                                                            if (result.success) {
                                                                mergedCount++;
                                                            } else {
                                                                errorCount++;
                                                            }
                                                        } catch (error) {
                                                            errorCount++;
                                                            console.error('Error merging user group:', error);
                                                        }
                                                    }
                                                }

                                                setUserDuplicateDialog({ open: false, duplicates: [], choices: {}, scanning: false });

                                                if (errorCount === 0) {
                                                    showSnackbar(`Successfully merged ${mergedCount} user duplicate groups!`, 'success');
                                                } else {
                                                    showSnackbar(`Merged ${mergedCount} groups with ${errorCount} errors. Check console for details.`, 'warning');
                                                }
                                            } catch (error) {
                                                showSnackbar(`Cleanup failed: ${error.message}`, 'error');
                                            }
                                        }}
                                    >
                                        <span className="material-icons mr-2">merge</span>
                                        Merge All User Duplicates
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Snackbar */}
                    <MaterialSnackbar snackbar={snackbar} />
                </div>
            );
        };

        // Render the Material Design Firebase app using React 18 API
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <MaterialFirebaseApp />
            </ErrorBoundary>
        );
    </script>
</body>
</html>