<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Inventory Management - Firebase Material - UPDATED</title>
    <!-- GitHub Pages Deploy: 2025-09-18 - ITEMS FIXED -->

    <!-- External CSS Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- reCAPTCHA Enterprise -->
    <script src="https://www.google.com/recaptcha/enterprise.js?render=6Ld_kNMrAAAAAIYoB4JC9Cz5dl2xAcSJZ_rlP80j"></script>

    <!-- Material Design CSS (after Tailwind to override) -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check-compat.js"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PDF Processing Libraries -->
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <!-- PDF.js Configuration -->
    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
    </script>

    <!-- Firebase Configuration (Embedded for GitHub Pages) -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCBOBb7mJPoI7cwubp12xnmjglLkuWYWYI",
            authDomain: "it-inventory-eaebc.firebaseapp.com",
            projectId: "it-inventory-eaebc",
            storageBucket: "it-inventory-eaebc.firebasestorage.app",
            messagingSenderId: "1081021280207",
            appId: "1:1081021280207:web:9619a96bff1692493aecba"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Initialize Google Auth Provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.addScope('email');
        googleProvider.addScope('profile');

        // Enable offline persistence
        db.enablePersistence({synchronizeTabs: true}).catch((err) => {
            console.warn('Firestore persistence not available:', err.code);
        });

        // Initialize App Check with reCAPTCHA Enterprise
        const appCheck = firebase.appCheck();
        appCheck.activate({
            provider: 'recaptcha-enterprise',
            siteKey: '6Ld_kNMrAAAAAIYoB4JC9Cz5dl2xAcSJZ_rlP80j'
        }, true);
        
    </script>

    <style>
        /* Material You Design System */
        :root {
            /* Material You Elevation Tokens */
            --md-elevation-1: 0px 1px 3px 1px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
            --md-elevation-2: 0px 2px 6px 2px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
            --md-elevation-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px 0px rgba(0, 0, 0, 0.3);
            --md-elevation-4: 0px 6px 10px 4px rgba(0, 0, 0, 0.15), 0px 2px 3px 0px rgba(0, 0, 0, 0.3);
            --md-elevation-5: 0px 8px 12px 6px rgba(0, 0, 0, 0.15), 0px 4px 4px 0px rgba(0, 0, 0, 0.3);

            /* Material You Shape Tokens */
            --md-sys-shape-corner-none: 0px;
            --md-sys-shape-corner-extra-small: 4px;
            --md-sys-shape-corner-small: 8px;
            --md-sys-shape-corner-medium: 12px;
            --md-sys-shape-corner-large: 16px;
            --md-sys-shape-corner-extra-large: 28px;
            --md-sys-shape-corner-full: 1000px;

            /* Material You Typography Scale */
            --md-sys-typescale-display-large: 400 57px/64px 'Roboto', sans-serif;
            --md-sys-typescale-headline-large: 400 32px/40px 'Roboto', sans-serif;
            --md-sys-typescale-headline-medium: 400 28px/36px 'Roboto', sans-serif;
            --md-sys-typescale-title-large: 400 22px/28px 'Roboto', sans-serif;
            --md-sys-typescale-title-medium: 500 16px/24px 'Roboto', sans-serif;
            --md-sys-typescale-body-large: 400 16px/24px 'Roboto', sans-serif;
            --md-sys-typescale-body-medium: 400 14px/20px 'Roboto', sans-serif;
            --md-sys-typescale-label-large: 500 14px/20px 'Roboto', sans-serif;
            --md-sys-typescale-label-medium: 500 12px/16px 'Roboto', sans-serif;

            /* Material You Color System */
            --md-sys-color-primary: #1976d2;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #d7eaff;
            --md-sys-color-on-primary-container: #001c38;

            --md-sys-color-secondary: #535f70;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #d7e3f7;
            --md-sys-color-on-secondary-container: #101c2b;

            --md-sys-color-tertiary: #6b5778;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #f2daff;
            --md-sys-color-on-tertiary-container: #251431;

            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #ffdad6;
            --md-sys-color-on-error-container: #410002;

            --md-sys-color-surface: #fefbff;
            --md-sys-color-on-surface: #1a1c1e;
            --md-sys-color-surface-variant: #dfe2eb;
            --md-sys-color-on-surface-variant: #43474e;

            --md-sys-color-surface-container-lowest: #ffffff;
            --md-sys-color-surface-container-low: #f4f0f7;
            --md-sys-color-surface-container: #eee8f5;
            --md-sys-color-surface-container-high: #e8e1ee;
            --md-sys-color-surface-container-highest: #e2dbe8;

            --md-sys-color-outline: #73777f;
            --md-sys-color-outline-variant: #c3c7cf;

            --md-sys-color-success: #006d35;
            --md-sys-color-on-success: #ffffff;
            --md-sys-color-success-container: #94f7ad;
            --md-sys-color-on-success-container: #00210a;
        }

        /* Material You Base Styles */
        * {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Material You Global Styles */
        body {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
            padding: 0;
        }

        /* Material You Elevation System */
        .md-elevation-1 { box-shadow: var(--md-elevation-1); }
        .md-elevation-2 { box-shadow: var(--md-elevation-2); }
        .md-elevation-3 { box-shadow: var(--md-elevation-3); }
        .md-elevation-4 { box-shadow: var(--md-elevation-4); }
        .md-elevation-5 { box-shadow: var(--md-elevation-5); }

        /* Material You Navigation Components */
        .md-navigation-bar {
            transition: background-color 0.3s ease;
        }

        .md-navigation-tab {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 16px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--md-sys-shape-corner-small);
            font: var(--md-sys-typescale-label-large);
            min-height: 48px;
        }

        .md-navigation-tab:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-on-surface) 8%, transparent);
        }

        .md-navigation-tab .material-icons {
            font-size: 20px;
        }

        /* Material You Badges */
        .md-badge {
            border-radius: var(--md-sys-shape-corner-full);
            padding: 2px 8px;
            font-size: 12px;
            font-weight: 500;
            min-width: 16px;
            text-align: center;
            line-height: 1;
        }

        /* Material You Theme Toggle */
        .md-theme-toggle {
            background-color: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-full);
            padding: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .md-theme-toggle:hover {
            background-color: var(--md-sys-color-surface-container-high);
            transform: scale(1.05);
        }

        /* Material You Status Indicator */
        .md-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 16px;
            background-color: var(--md-sys-color-success-container);
            color: var(--md-sys-color-on-surface-variant);
            border-radius: var(--md-sys-shape-corner-full);
            font-size: 12px;
            font-weight: 500;
        }

        .md-status-dot {
            width: 8px;
            height: 8px;
            background-color: var(--md-sys-color-success);
            border-radius: 50%;
            animation: md-pulse 2s ease-in-out infinite;
        }

        @keyframes md-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.95); }
        }

        /* Material You Modal/Popup */
        .md-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
            animation: md-fade-in 0.3s ease;
        }

        .md-modal {
            background-color: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-extra-large);
            box-shadow: var(--md-elevation-5);
            max-width: 560px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: md-scale-in 0.3s ease;
        }

        .md-modal-header {
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .md-modal-title {
            font: var(--md-sys-typescale-headline-medium);
            color: var(--md-sys-color-on-surface);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .md-modal-body {
            padding: 16px 24px;
        }

        .md-modal-actions {
            padding: 16px 24px 24px 24px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            flex-wrap: wrap;
        }

        .md-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: transparent;
            border: none;
            padding: 8px;
            border-radius: var(--md-sys-shape-corner-full);
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            transition: all 0.2s ease;
        }

        .md-modal-close:hover {
            background-color: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface);
        }

        .md-button {
            padding: 10px 24px;
            border-radius: var(--md-sys-shape-corner-full);
            border: none;
            font: var(--md-sys-typescale-label-large);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 40px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .md-button.primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .md-button.primary:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-primary) 92%, black);
            box-shadow: var(--md-elevation-1);
        }

        .md-button.secondary {
            background-color: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface);
            border: 1px solid var(--md-sys-color-outline);
        }

        .md-button.secondary:hover {
            background-color: var(--md-sys-color-surface-container-high);
        }

        .md-button.error {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-error);
        }

        .md-button.error:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-error-container) 92%, var(--md-sys-color-error));
        }

        .md-low-stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: var(--md-sys-color-warning-container);
            border-radius: var(--md-sys-shape-corner-small);
            margin: 8px 0;
        }

        .md-low-stock-item-name {
            font: var(--md-sys-typescale-body-medium);
            color: var(--md-sys-color-on-surface);
            font-weight: 500;
        }

        .md-low-stock-item-quantity {
            font: var(--md-sys-typescale-body-medium);
            color: var(--md-sys-color-warning);
            font-weight: 600;
        }

        @keyframes md-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes md-scale-in {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Material Design Ripple Effect */
        .mat-ripple {
            position: relative;
            overflow: hidden;
            transform: translate3d(0, 0, 0);
        }

        .mat-ripple:before {
            content: "";
            display: block;
            position: absolute;
            left: 50%;
            top: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transition: width 0.6s, height 0.6s, left 0.6s, top 0.6s;
            transform: translate(-50%, -50%);
        }

        .mat-ripple:active:before {
            width: 300px;
            height: 300px;
        }

        /* Material Design Input Fields */
        .mat-input {
            position: relative;
        }

        .mat-input input, .mat-input select, .mat-input textarea {
            width: 100%;
            padding: 16px 12px 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: transparent;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .mat-input input:focus, .mat-input select:focus, .mat-input textarea:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }

        .mat-input label {
            position: absolute;
            left: 12px;
            top: 16px;
            color: #757575;
            font-size: 16px;
            transition: all 0.2s ease;
            pointer-events: none;
            background: white;
            padding: 0 4px;
        }

        .mat-input input:focus + label,
        .mat-input input:not(:placeholder-shown) + label,
        .mat-input select:focus + label,
        .mat-input textarea:focus + label,
        .mat-input textarea:not(:placeholder-shown) + label {
            top: -6px;
            font-size: 12px;
            color: #1976d2;
        }

        /* Material Design FAB */
        .mat-fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .mat-fab:hover {
            transform: scale(1.1);
        }

        /* Material Design Tabs */
        .mat-tab-nav {
            border-bottom: 1px solid #e0e0e0;
        }

        .mat-tab {
            position: relative;
            padding: 16px 24px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }

        .mat-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #1976d2;
            transition: all 0.2s ease;
        }

        /* Material Design Cards */
        .mat-card {
            border-radius: 4px;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .mat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0px 3px 5px -1px rgba(0,0,0,0.2), 0px 6px 10px 0px rgba(0,0,0,0.14), 0px 1px 18px 0px rgba(0,0,0,0.12);
        }

        /* Material Design Elevation Classes */
        .mat-elevation-0 { box-shadow: none; }
        .mat-elevation-1 { box-shadow: var(--md-elevation-1); }
        .mat-elevation-2 { box-shadow: var(--md-elevation-2); }
        .mat-elevation-3 { box-shadow: var(--md-elevation-3); }
        .mat-elevation-4 { box-shadow: var(--md-elevation-4); }
        .mat-elevation-5 { box-shadow: var(--md-elevation-5); }

        /* Material Design Snackbar */
        .mat-snackbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: #323232;
            color: white;
            padding: 14px 24px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Enhanced Dark Mode Material Design */
        .dark .mat-card {
            background: #1f2937;
            border: 1px solid #374151;
        }
        .dark .mat-input input,
        .dark .mat-input select,
        .dark .mat-input textarea {
            background: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        .dark .mat-input input:focus,
        .dark .mat-input select:focus,
        .dark .mat-input textarea:focus {
            background: #374151;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .dark .mat-input label {
            background: #1f2937;
            color: #9ca3af;
        }
        .dark .mat-input input:focus + label,
        .dark .mat-input input:not(:placeholder-shown) + label,
        .dark .mat-input select:focus + label,
        .dark .mat-input textarea:focus + label,
        .dark .mat-input textarea:not(:placeholder-shown) + label {
            color: #3b82f6;
            background: #1f2937;
        }
        .dark .mat-tab-nav { border-bottom-color: #4b5563; }

        /* Dark mode enhancements */
        .dark body { background: #111827; }
        .dark .mat-snackbar {
            background: #374151;
            border: 1px solid #4b5563;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .mat-tab {
                padding: 12px 16px;
                font-size: 14px;
            }
            .mat-card {
                border-radius: 8px;
            }
            .mat-input input,
            .mat-input select,
            .mat-input textarea {
                padding: 14px 10px 6px 10px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Loading animations */
        .mat-spinner {
            animation: mat-spinner-rotate 2s linear infinite;
        }

        @keyframes mat-spinner-rotate {
            0% { transform: rotate(0); }
            100% { transform: rotate(360deg); }
        }

        /* Material Design progress bar */
        .mat-progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .mat-progress-bar-fill {
            height: 100%;
            background: #1976d2;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Utility function to format department IDs
        const formatDepartmentId = (deptId) => {
            if (!deptId) return '';
            const parts = deptId.split('-');
            if (parts.length >= 3) {
                const [first, second, third, ...rest] = parts;
                const formattedThird = third.padStart(3, '0');
                return `${first}-${second}-${formattedThird}-5770`;
            }
            return deptId;
        };

        // Material Design Hook for Snackbar
        const useSnackbar = () => {
            const [snackbar, setSnackbar] = useState(null);

            const showSnackbar = (message, type = 'info', duration = 4000) => {
                setSnackbar({ message, type });
                setTimeout(() => setSnackbar(null), duration);
            };

            return { snackbar, showSnackbar };
        };

        // Material You Theme System
        const useTheme = () => {
            const [isDarkMode, setIsDarkMode] = useState(() => {
                const saved = localStorage.getItem('materialYouTheme');
                return saved ? JSON.parse(saved) : false;
            });

            useEffect(() => {
                localStorage.setItem('materialYouTheme', JSON.stringify(isDarkMode));

                // Apply Material You color tokens
                const root = document.documentElement;

                if (isDarkMode) {
                    // Material You Dark Theme
                    root.classList.add('dark');
                    root.style.setProperty('--md-sys-color-primary', '#A6C8FF');
                    root.style.setProperty('--md-sys-color-on-primary', '#002E69');
                    root.style.setProperty('--md-sys-color-primary-container', '#004494');
                    root.style.setProperty('--md-sys-color-on-primary-container', '#D1E4FF');
                    root.style.setProperty('--md-sys-color-surface', '#101418');
                    root.style.setProperty('--md-sys-color-on-surface', '#E1E2E8');
                    root.style.setProperty('--md-sys-color-surface-variant', '#42474E');
                    root.style.setProperty('--md-sys-color-on-surface-variant', '#C2C7CF');
                    root.style.setProperty('--md-sys-color-surface-container', '#1C2024');
                    root.style.setProperty('--md-sys-color-surface-container-high', '#272A2F');
                    root.style.setProperty('--md-sys-color-surface-container-highest', '#31353A');
                    root.style.setProperty('--md-sys-color-outline', '#8C9199');
                    root.style.setProperty('--md-sys-color-outline-variant', '#42474E');
                    root.style.setProperty('--md-sys-color-error', '#FFB4AB');
                    root.style.setProperty('--md-sys-color-error-container', '#93000A');
                    root.style.setProperty('--md-sys-color-warning', '#FFB951');
                    root.style.setProperty('--md-sys-color-warning-container', '#7F4F00');
                    root.style.setProperty('--md-sys-color-success', '#4DD865');
                    root.style.setProperty('--md-sys-color-success-container', '#00390F');
                } else {
                    // Material You Light Theme
                    root.classList.remove('dark');
                    root.style.setProperty('--md-sys-color-primary', '#1B5FBF');
                    root.style.setProperty('--md-sys-color-on-primary', '#FFFFFF');
                    root.style.setProperty('--md-sys-color-primary-container', '#D1E4FF');
                    root.style.setProperty('--md-sys-color-on-primary-container', '#001D35');
                    root.style.setProperty('--md-sys-color-surface', '#FCFCFF');
                    root.style.setProperty('--md-sys-color-on-surface', '#1A1C1E');
                    root.style.setProperty('--md-sys-color-surface-variant', '#E1E2E8');
                    root.style.setProperty('--md-sys-color-on-surface-variant', '#42474E');
                    root.style.setProperty('--md-sys-color-surface-container', '#F3F4FA');
                    root.style.setProperty('--md-sys-color-surface-container-high', '#ECEEF4');
                    root.style.setProperty('--md-sys-color-surface-container-highest', '#E6E7ED');
                    root.style.setProperty('--md-sys-color-outline', '#73777F');
                    root.style.setProperty('--md-sys-color-outline-variant', '#C2C7CF');
                    root.style.setProperty('--md-sys-color-error', '#BA1A1A');
                    root.style.setProperty('--md-sys-color-error-container', '#FFDAD6');
                    root.style.setProperty('--md-sys-color-warning', '#A06500');
                    root.style.setProperty('--md-sys-color-warning-container', '#FFDDB3');
                    root.style.setProperty('--md-sys-color-success', '#146C2E');
                    root.style.setProperty('--md-sys-color-success-container', '#B7F4B7');
                }
            }, [isDarkMode]);

            return { isDarkMode, toggleDarkMode: () => setIsDarkMode(!isDarkMode) };
        };

        // Material Design Input Component
        const MaterialInput = ({ label, type = 'text', value, onChange, placeholder = ' ', ...props }) => {
            return (
                <div className="mat-input">
                    <input
                        type={type}
                        value={value}
                        onChange={onChange}
                        placeholder={placeholder}
                        {...props}
                    />
                    <label>{label}</label>
                </div>
            );
        };

        // Material Design Button Component
        const MaterialButton = ({ children, variant = 'contained', color = 'primary', onClick, disabled, className = '', ...props }) => {
            const baseClasses = 'mat-ripple inline-flex items-center justify-center px-6 py-3 font-medium text-sm rounded transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2';

            const variantClasses = {
                contained: {
                    primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500 mat-elevation-2',
                    secondary: 'bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500 mat-elevation-2',
                    success: 'bg-green-600 text-white hover:bg-green-700 focus:ring-green-500 mat-elevation-2',
                    error: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500 mat-elevation-2'
                },
                outlined: {
                    primary: 'border border-blue-600 text-blue-600 hover:bg-blue-50 focus:ring-blue-500',
                    secondary: 'border border-gray-600 text-gray-600 hover:bg-gray-50 focus:ring-gray-500',
                    success: 'border border-green-600 text-green-600 hover:bg-green-50 focus:ring-green-500',
                    error: 'border border-red-600 text-red-600 hover:bg-red-50 focus:ring-red-500'
                },
                text: {
                    primary: 'text-blue-600 hover:bg-blue-50 focus:ring-blue-500',
                    secondary: 'text-gray-600 hover:bg-gray-50 focus:ring-gray-500',
                    success: 'text-green-600 hover:bg-green-50 focus:ring-green-500',
                    error: 'text-red-600 hover:bg-red-50 focus:ring-red-500'
                }
            };

            const buttonClasses = `${baseClasses} ${variantClasses[variant][color]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`;

            return (
                <button
                    className={buttonClasses}
                    onClick={onClick}
                    disabled={disabled}
                    {...props}
                >
                    {children}
                </button>
            );
        };

        // Material Design Card Component
        const MaterialCard = ({ children, elevation = 1, className = '', ...props }) => {
            return (
                <div className={`mat-card mat-elevation-${elevation} p-6 ${className}`} {...props}>
                    {children}
                </div>
            );
        };

        // Material You Pagination Component
        const MaterialPagination = ({
            currentPage,
            totalItems,
            itemsPerPage,
            onPageChange,
            onItemsPerPageChange,
            className = ''
        }) => {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);

            const getVisiblePages = () => {
                const delta = 2;
                const range = [];
                const rangeWithDots = [];

                for (let i = Math.max(2, currentPage - delta);
                     i <= Math.min(totalPages - 1, currentPage + delta);
                     i++) {
                    range.push(i);
                }

                if (currentPage - delta > 2) {
                    rangeWithDots.push(1, '...');
                } else {
                    rangeWithDots.push(1);
                }

                rangeWithDots.push(...range);

                if (currentPage + delta < totalPages - 1) {
                    rangeWithDots.push('...', totalPages);
                } else {
                    rangeWithDots.push(totalPages);
                }

                return rangeWithDots.filter((v, i, a) => a.indexOf(v) === i);
            };

            if (totalPages <= 1) return null;

            return (
                <div className={`flex items-center justify-between flex-wrap gap-4 mt-6 ${className}`}>
                    <div className="flex items-center gap-4">
                        <div className="text-sm" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>
                            Showing {startItem}-{endItem} of {totalItems} items
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-sm" style={{ color: 'var(--md-sys-color-on-surface-variant)' }}>
                                Items per page:
                            </span>
                            <select
                                value={itemsPerPage}
                                onChange={(e) => onItemsPerPageChange(parseInt(e.target.value))}
                                className="mat-input-select"
                                style={{
                                    padding: '4px 8px',
                                    border: `1px solid var(--md-sys-color-outline)`,
                                    borderRadius: '4px',
                                    backgroundColor: 'var(--md-sys-color-surface)',
                                    color: 'var(--md-sys-color-on-surface)'
                                }}
                            >
                                <option value={50}>50</option>
                                <option value={100}>100</option>
                            </select>
                        </div>
                    </div>

                    <div className="flex items-center gap-1">
                        <MaterialButton
                            variant="text"
                            onClick={() => onPageChange(currentPage - 1)}
                            disabled={currentPage === 1}
                            className="!p-2 !min-w-0"
                        >
                            <span className="material-icons">chevron_left</span>
                        </MaterialButton>

                        {getVisiblePages().map((page, index) => (
                            page === '...' ? (
                                <span key={`dots-${index}`} className="px-2 text-gray-400">...</span>
                            ) : (
                                <MaterialButton
                                    key={page}
                                    variant={currentPage === page ? "contained" : "text"}
                                    color="primary"
                                    onClick={() => onPageChange(page)}
                                    className="!p-2 !min-w-[40px] !w-10 !h-10"
                                >
                                    {page}
                                </MaterialButton>
                            )
                        ))}

                        <MaterialButton
                            variant="text"
                            onClick={() => onPageChange(currentPage + 1)}
                            disabled={currentPage === totalPages}
                            className="!p-2 !min-w-0"
                        >
                            <span className="material-icons">chevron_right</span>
                        </MaterialButton>
                    </div>
                </div>
            );
        };

        // Error Boundary
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error('ðŸš¨ Application Error:', error);
                this.setState({ error });
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
                            <MaterialCard elevation={8} className="max-w-md">
                                <div className="flex items-center text-red-600 mb-4">
                                    <span className="material-icons mr-2">error</span>
                                    <h1 className="text-xl font-bold">Application Error</h1>
                                </div>
                                <p className="text-gray-700 dark:text-gray-300 mb-4">
                                    {this.state.error?.message || 'An unexpected error occurred'}
                                </p>
                                <MaterialButton
                                    onClick={() => window.location.reload()}
                                    variant="contained"
                                    color="primary"
                                    className="w-full"
                                >
                                    <span className="material-icons mr-2">refresh</span>
                                    Refresh Page
                                </MaterialButton>
                            </MaterialCard>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Authentication Component with Material Design
        const AuthComponent = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [showEmailForm, setShowEmailForm] = useState(false);
            const { showSnackbar } = useSnackbar();

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    setUser(user);
                    setLoading(false);
                });
                return unsubscribe;
            }, []);

            const handleSignIn = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    showSnackbar('Welcome back!', 'success');
                } catch (error) {
                    setError(error.message);
                    showSnackbar(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleGoogleSignIn = async () => {
                setError('');
                setLoading(true);

                try {
                    // Generate reCAPTCHA token for login action
                    await new Promise((resolve) => {
                        grecaptcha.enterprise.ready(async () => {
                            const token = await grecaptcha.enterprise.execute('6Ld_kNMrAAAAAIYoB4JC9Cz5dl2xAcSJZ_rlP80j', {action: 'LOGIN'});
                            console.log('reCAPTCHA token generated for LOGIN action');
                            resolve();
                        });
                    });

                    const result = await auth.signInWithPopup(googleProvider);
                    const user = result.user;
                    showSnackbar(`Welcome ${user.displayName || user.email}!`, 'success');
                } catch (error) {
                    console.error('Google Sign-In Error:', error);
                    if (error.code === 'auth/popup-closed-by-user') {
                        showSnackbar('Sign-in was cancelled', 'warning');
                    } else if (error.code === 'auth/popup-blocked') {
                        showSnackbar('Pop-up blocked. Please allow pop-ups for this site.', 'error');
                    } else {
                        setError(error.message);
                        showSnackbar(`Google Sign-In failed: ${error.message}`, 'error');
                    }
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
                        <div className="text-center">
                            <div className="mat-spinner w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                            <p className="text-gray-600 dark:text-gray-400">Loading Firebase...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return (
                    <div className="min-h-screen relative bg-gradient-to-br from-blue-50 via-white to-indigo-50 dark:from-gray-900 dark:via-gray-800 dark:to-indigo-900">
                        {/* Email Sign-In Toggle - Small corner button */}
                        <div className="absolute top-4 right-4 z-10">
                            <MaterialButton
                                onClick={() => setShowEmailForm(!showEmailForm)}
                                variant="text"
                                className="!p-2 !min-w-0 !text-xs opacity-60 hover:opacity-100 transition-opacity"
                            >
                                <span className="material-icons text-sm">alternate_email</span>
                            </MaterialButton>
                        </div>

                        {/* Email Form Overlay */}
                        {showEmailForm && (
                            <div className="absolute inset-0 bg-black/50 backdrop-blur-sm z-20 flex items-center justify-center p-4">
                                <MaterialCard elevation={16} className="w-full max-w-sm relative">
                                    <MaterialButton
                                        onClick={() => setShowEmailForm(false)}
                                        variant="text"
                                        className="!absolute !top-2 !right-2 !p-2 !min-w-0"
                                    >
                                        <span className="material-icons text-sm">close</span>
                                    </MaterialButton>

                                    <h3 className="text-lg font-medium mb-4 dark:text-white">Email Sign-In</h3>

                                    <form onSubmit={handleSignIn} className="space-y-4">
                                        <MaterialInput
                                            label="Email Address"
                                            type="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            required
                                        />

                                        <MaterialInput
                                            label="Password"
                                            type="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            required
                                        />

                                        {error && (
                                            <div className="flex items-center text-red-600 text-sm bg-red-50 dark:bg-red-900/20 p-3 rounded">
                                                <span className="material-icons mr-2 text-sm">error</span>
                                                {error}
                                            </div>
                                        )}

                                        <MaterialButton
                                            type="submit"
                                            variant="contained"
                                            color="primary"
                                            disabled={loading}
                                            className="w-full"
                                        >
                                            {loading ? (
                                                <>
                                                    <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                    Signing in...
                                                </>
                                            ) : (
                                                <>
                                                    <span className="material-icons mr-2">login</span>
                                                    Sign In
                                                </>
                                            )}
                                        </MaterialButton>
                                    </form>
                                </MaterialCard>
                            </div>
                        )}

                        {/* Main Sign-In Interface - Google Only */}
                        <div className="flex items-center justify-center min-h-screen p-4">
                            <div className="text-center max-w-md">
                                {/* Logo and Branding */}
                                <div className="mb-12">
                                    <div className="inline-flex items-center justify-center w-20 h-20 bg-white dark:bg-gray-800 rounded-3xl shadow-lg mb-6">
                                        <span className="material-icons text-4xl text-blue-600 dark:text-blue-400">inventory</span>
                                    </div>
                                    <h1 className="text-4xl font-bold text-gray-900 dark:text-white mb-2">
                                        IT Inventory
                                    </h1>
                                    <p className="text-gray-600 dark:text-gray-300 text-lg">
                                        Enterprise Inventory Management
                                    </p>
                                    <p className="text-gray-500 dark:text-gray-400 text-sm mt-2">
                                        Real-time tracking â€¢ Material Design â€¢ Firebase powered
                                    </p>
                                </div>

                                {/* Primary Google Sign-In */}
                                <div className="space-y-4">
                                    <MaterialButton
                                        onClick={handleGoogleSignIn}
                                        variant="contained"
                                        disabled={loading}
                                        className="w-full !bg-white hover:!bg-gray-50 !text-gray-700 !border !border-gray-300 shadow-lg hover:shadow-xl transition-all duration-200 !py-4 !text-lg"
                                    >
                                        {loading ? (
                                            <>
                                                <div className="mat-spinner w-5 h-5 border-2 border-gray-600 border-t-transparent rounded-full mr-3"></div>
                                                Signing in...
                                            </>
                                        ) : (
                                            <>
                                                <svg className="w-6 h-6 mr-3" viewBox="0 0 24 24">
                                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                                </svg>
                                                Continue with Google
                                            </>
                                        )}
                                    </MaterialButton>

                                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-6">
                                        Secure authentication powered by Google<br/>
                                        Your data is protected and never shared
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <header className="bg-blue-600 dark:bg-blue-800 text-white mat-elevation-4">
                    <div className="max-w-7xl mx-auto px-4">
                        <div className="flex items-center justify-between h-16">
                            <div className="flex items-center space-x-4">
                                <span className="material-icons text-2xl">inventory</span>
                                <div>
                                    <h1 className="font-semibold">IT Inventory System</h1>
                                    <p className="text-xs text-blue-100">Firebase powered</p>
                                </div>
                            </div>

                            <div className="flex items-center space-x-4">
                                <div className="flex items-center space-x-2 text-sm">
                                    <span className="material-icons text-sm">account_circle</span>
                                    <span>{user.email}</span>
                                    <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                </div>

                                <MaterialButton
                                    onClick={() => auth.signOut()}
                                    variant="text"
                                    className="text-white hover:bg-blue-700 dark:hover:bg-blue-900"
                                >
                                    <span className="material-icons mr-1">logout</span>
                                    Sign Out
                                </MaterialButton>
                            </div>
                        </div>
                    </div>
                </header>
            );
        };

        // Shopping Cart Component with Material Design
        const MaterialShoppingCart = ({ cart, addToCart, removeFromCart, clearCart, users, onCheckout }) => {
            const [isCheckingOut, setIsCheckingOut] = useState(false);
            const [checkoutMethod, setCheckoutMethod] = useState('user');
            const [selectedUser, setSelectedUser] = useState('');
            const [jobNumber, setJobNumber] = useState('');
            const [notes, setNotes] = useState('');
            const { showSnackbar } = useSnackbar();

            const cartTotal = cart.reduce((sum, item) => sum + (item.price || 0) * item.cartQuantity, 0);

            const handleCheckout = async () => {
                if (cart.length === 0) return;

                if (checkoutMethod === 'user' && !selectedUser) {
                    showSnackbar('Please select a user for checkout', 'error');
                    return;
                }

                if (checkoutMethod === 'job' && !jobNumber.trim()) {
                    showSnackbar('Please enter a job number', 'error');
                    return;
                }

                setIsCheckingOut(true);

                try {
                    const user = users.find(u => u.id === selectedUser);

                    for (const cartItem of cart) {
                        // Update inventory
                        const itemRef = db.collection('items').doc(cartItem.id);
                        await db.runTransaction(async (transaction) => {
                            const doc = await transaction.get(itemRef);
                            const currentQty = doc.data().quantity || 0;
                            const newQty = Math.max(0, currentQty - cartItem.cartQuantity);

                            transaction.update(itemRef, {
                                quantity: newQty,
                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            });

                            // Create checkout record
                            const checkoutRef = db.collection('checkoutHistory').doc();
                            transaction.set(checkoutRef, {
                                itemId: cartItem.id,
                                itemName: cartItem.name,
                                userId: checkoutMethod === 'user' ? selectedUser : '',
                                userName: checkoutMethod === 'user' ? (user?.name || `${user?.firstName} ${user?.lastName}`) : 'Job Checkout',
                                quantity: cartItem.cartQuantity,
                                departmentId: checkoutMethod === 'user' ? formatDepartmentId(user?.costCode || user?.cost_code) : jobNumber,
                                jobNumber: checkoutMethod === 'job' ? jobNumber : '',
                                notes: notes,
                                status: 'active',
                                dateEntered: firebase.firestore.FieldValue.serverTimestamp(),
                                createdBy: auth.currentUser?.email || 'unknown'
                            });
                        });
                    }

                    // Clear cart and form
                    clearCart();
                    setSelectedUser('');
                    setJobNumber('');
                    setNotes('');
                    showSnackbar(`Checkout completed! ${cart.length} items processed.`, 'success');

                    if (onCheckout) onCheckout();

                } catch (error) {
                    console.error('Checkout error:', error);
                    showSnackbar(`Checkout failed: ${error.message}`, 'error');
                } finally {
                    setIsCheckingOut(false);
                }
            };

            return (
                <MaterialCard elevation={2} className="sticky top-6">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center">
                            <span className="material-icons text-xl mr-2 text-blue-600">shopping_cart</span>
                            <h3 className="text-lg font-medium dark:text-white">Shopping Cart</h3>
                        </div>
                        <div className="flex items-center space-x-2">
                            {cart.length > 0 && (
                                <div className="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full text-sm font-medium">
                                    {cart.length} items
                                </div>
                            )}
                            {cartTotal > 0 && (
                                <div className="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-3 py-1 rounded-full text-sm font-medium">
                                    ${cartTotal.toFixed(2)}
                                </div>
                            )}
                        </div>
                    </div>

                    {cart.length === 0 ? (
                        <div className="text-center py-12 text-gray-500 dark:text-gray-400">
                            <span className="material-icons text-6xl mb-4 opacity-50">shopping_cart</span>
                            <p className="font-medium">Your cart is empty</p>
                            <p className="text-sm">Add items to get started</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            <div className="space-y-3 max-h-60 overflow-y-auto">
                                {cart.map(item => (
                                    <div key={item.id} className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div className="flex-1 min-w-0">
                                            <div className="font-medium text-gray-900 dark:text-white truncate">{item.name}</div>
                                            <div className="text-sm text-gray-600 dark:text-gray-400">
                                                Qty: {item.cartQuantity}
                                                {item.price > 0 && (
                                                    <span className="ml-2 text-green-600 dark:text-green-400 font-medium">
                                                        ${(item.price * item.cartQuantity).toFixed(2)}
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex items-center space-x-2 ml-3">
                                            <MaterialButton
                                                onClick={() => addToCart(item, 1)}
                                                variant="outlined"
                                                color="primary"
                                                className="!p-2 !min-w-0 !w-8 !h-8"
                                            >
                                                <span className="material-icons text-sm">add</span>
                                            </MaterialButton>
                                            <MaterialButton
                                                onClick={() => removeFromCart(item.id)}
                                                variant="outlined"
                                                color="error"
                                                className="!p-2 !min-w-0 !w-8 !h-8"
                                            >
                                                <span className="material-icons text-sm">remove</span>
                                            </MaterialButton>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="border-t dark:border-gray-600 pt-4 space-y-4">
                                {/* Checkout Method */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                                        Checkout Method
                                    </label>
                                    <div className="flex space-x-4">
                                        <label className="flex items-center cursor-pointer">
                                            <input
                                                type="radio"
                                                value="user"
                                                checked={checkoutMethod === 'user'}
                                                onChange={(e) => setCheckoutMethod(e.target.value)}
                                                className="mr-2 text-blue-600"
                                            />
                                            <span className="material-icons mr-1 text-sm">person</span>
                                            <span className="text-sm">User Checkout</span>
                                        </label>
                                        <label className="flex items-center cursor-pointer">
                                            <input
                                                type="radio"
                                                value="job"
                                                checked={checkoutMethod === 'job'}
                                                onChange={(e) => setCheckoutMethod(e.target.value)}
                                                className="mr-2 text-blue-600"
                                            />
                                            <span className="material-icons mr-1 text-sm">work</span>
                                            <span className="text-sm">Job Checkout</span>
                                        </label>
                                    </div>
                                </div>

                                {/* User Selection */}
                                {checkoutMethod === 'user' && (
                                    <div className="mat-input">
                                        <select
                                            value={selectedUser}
                                            onChange={(e) => setSelectedUser(e.target.value)}
                                            required
                                        >
                                            <option value="">Choose a user...</option>
                                            {users.slice(0, 50).map(user => (
                                                <option key={user.id} value={user.id}>
                                                    {user.name || `${user.firstName} ${user.lastName}`} - {formatDepartmentId(user.costCode || user.cost_code)}
                                                </option>
                                            ))}
                                        </select>
                                        <label>Select User</label>
                                    </div>
                                )}

                                {/* Job Number */}
                                {checkoutMethod === 'job' && (
                                    <MaterialInput
                                        label="Job Number"
                                        value={jobNumber}
                                        onChange={(e) => setJobNumber(e.target.value)}
                                        required
                                    />
                                )}

                                {/* Notes */}
                                <div className="mat-input">
                                    <textarea
                                        value={notes}
                                        onChange={(e) => setNotes(e.target.value)}
                                        rows={2}
                                        placeholder=" "
                                    />
                                    <label>Notes (Optional)</label>
                                </div>

                                {/* Checkout Buttons */}
                                <div className="flex space-x-3">
                                    <MaterialButton
                                        onClick={handleCheckout}
                                        disabled={isCheckingOut}
                                        variant="contained"
                                        color="success"
                                        className="flex-1"
                                    >
                                        {isCheckingOut ? (
                                            <>
                                                <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                Processing...
                                            </>
                                        ) : (
                                            <>
                                                <span className="material-icons mr-2">check_circle</span>
                                                Checkout
                                            </>
                                        )}
                                    </MaterialButton>
                                    <MaterialButton
                                        onClick={clearCart}
                                        variant="outlined"
                                        color="secondary"
                                        className="px-4"
                                    >
                                        <span className="material-icons">clear</span>
                                    </MaterialButton>
                                </div>
                            </div>
                        </div>
                    )}
                </MaterialCard>
            );
        };

        // Barcode Scanner Component with Material Design
        const MaterialBarcodeScanner = ({ items, onItemScanned }) => {
            const [scanInput, setScanInput] = useState('');
            const [recentScans, setRecentScans] = useState([]);
            const [feedback, setFeedback] = useState('');
            const [isScanning, setIsScanning] = useState(false);
            const [cameraMode, setCameraMode] = useState(false);
            const [cameraStream, setCameraStream] = useState(null);
            const { showSnackbar } = useSnackbar();
            const inputRef = useRef(null);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            const handleItemScanned = async (itemIdentifier, quantity = 1) => {
                setIsScanning(true);

                try {
                    // Enhanced search: exact match first, then partial matches
                    let item = items.find(i =>
                        i.asin === itemIdentifier ||
                        i.id === itemIdentifier
                    );

                    // If no exact match, try partial name search
                    if (!item) {
                        const searchLower = itemIdentifier.toLowerCase().trim();
                        item = items.find(i =>
                            i.name.toLowerCase() === searchLower ||
                            i.name.toLowerCase().includes(searchLower) ||
                            (i.category && i.category.toLowerCase().includes(searchLower))
                        );
                    }

                    if (!item) {
                        showSnackbar(`Item not found: ${itemIdentifier}`, 'error');
                        setIsScanning(false);
                        return;
                    }

                    // Update inventory in Firebase
                    await db.collection('items').doc(item.id).update({
                        quantity: firebase.firestore.FieldValue.increment(quantity),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Add to recent scans
                    const scanRecord = {
                        id: Date.now(),
                        item: item,
                        quantity: quantity,
                        timestamp: new Date()
                    };

                    setRecentScans(prev => [scanRecord, ...prev.slice(0, 4)]);
                    showSnackbar(`${item.name} +${quantity}`, 'success');

                    if (onItemScanned) {
                        onItemScanned(item, quantity);
                    }

                    setScanInput('');

                } catch (error) {
                    showSnackbar(`Scan error: ${error.message}`, 'error');
                } finally {
                    setIsScanning(false);
                    if (inputRef.current) {
                        setTimeout(() => inputRef.current.focus(), 100);
                    }
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && scanInput.trim() && !isScanning) {
                    e.preventDefault();
                    handleItemScanned(scanInput.trim());
                }
            };

            const handleScanClick = () => {
                if (scanInput.trim()) {
                    handleItemScanned(scanInput.trim());
                }
            };

            const startVoiceSearch = () => {
                if (!('webkitSpeechRecognition' in window)) {
                    showSnackbar('Voice recognition not supported', 'error');
                    return;
                }

                const recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    setFeedback('ðŸŽ¤ Listening...');
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    setScanInput(transcript);
                    handleItemScanned(transcript);
                };

                recognition.onerror = () => {
                    showSnackbar('Voice recognition failed', 'error');
                    setFeedback('');
                };

                recognition.start();
            };

            // Check camera permissions and capabilities
            const checkCameraSupport = async () => {
                try {
                    // Check if getUserMedia is supported
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        return { supported: false, message: 'Camera API not supported' };
                    }

                    // Check permissions
                    if (navigator.permissions && navigator.permissions.query) {
                        try {
                            const permission = await navigator.permissions.query({ name: 'camera' });
                            console.log('Camera permission status:', permission.state);
                            if (permission.state === 'denied') {
                                return { supported: false, message: 'Camera permission denied' };
                            }
                        } catch (permError) {
                            console.warn('Permission query failed:', permError);
                        }
                    }

                    // Check available devices
                    if (navigator.mediaDevices.enumerateDevices) {
                        try {
                            const devices = await navigator.mediaDevices.enumerateDevices();
                            const videoDevices = devices.filter(device => device.kind === 'videoinput');
                            console.log('Available video devices:', videoDevices.length);
                            if (videoDevices.length === 0) {
                                return { supported: false, message: 'No cameras found' };
                            }
                        } catch (enumError) {
                            console.warn('Device enumeration failed:', enumError);
                        }
                    }

                    return { supported: true, message: 'Camera supported' };
                } catch (error) {
                    return { supported: false, message: error.message };
                }
            };

            // Camera barcode scanning functions
            const startCamera = async () => {
                try {
                    setIsScanning(true);
                    showSnackbar('Checking camera support...', 'info');

                    // Check camera support first
                    const supportCheck = await checkCameraSupport();
                    if (!supportCheck.supported) {
                        throw new Error(supportCheck.message);
                    }

                    showSnackbar('Requesting camera access...', 'info');

                    // iOS-optimized constraints
                    const constraints = {
                        video: {
                            facingMode: { ideal: 'environment' },
                            width: { min: 320, ideal: 640, max: 1920 },
                            height: { min: 240, ideal: 480, max: 1080 },
                            frameRate: { ideal: 30, max: 30 }
                        },
                        audio: false
                    };

                    let stream;
                    try {
                        // Try with environment camera first
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (envError) {
                        console.warn('Environment camera failed, trying any camera:', envError);
                        // Fallback to any available camera
                        try {
                            stream = await navigator.mediaDevices.getUserMedia({
                                video: {
                                    width: { min: 320, ideal: 640 },
                                    height: { min: 240, ideal: 480 }
                                },
                                audio: false
                            });
                        } catch (anyError) {
                            throw new Error(`Camera access denied: ${anyError.message}`);
                        }
                    }

                    setCameraStream(stream);
                    setCameraMode(true);

                    if (videoRef.current) {
                        const video = videoRef.current;

                        // iOS-specific video setup
                        video.setAttribute('playsinline', 'true');
                        video.setAttribute('webkit-playsinline', 'true');
                        video.muted = true;
                        video.autoplay = true;

                        video.srcObject = stream;

                        // Wait for video to be ready
                        video.addEventListener('loadedmetadata', () => {
                            console.log('Video metadata loaded:', video.videoWidth, 'x', video.videoHeight);
                            startBarcodeDetection();
                        });

                        video.addEventListener('canplay', () => {
                            console.log('Video can play');
                            video.play().catch(playError => {
                                console.error('Video play failed:', playError);
                                showSnackbar('Video playback failed', 'error');
                            });
                        });

                        // Force play for iOS
                        const playPromise = video.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(error => {
                                console.error('Play promise failed:', error);
                                // Try again after a short delay
                                setTimeout(() => {
                                    video.play().catch(retryError => {
                                        console.error('Retry play failed:', retryError);
                                        showSnackbar('Unable to start video on this device', 'error');
                                    });
                                }, 100);
                            });
                        }
                    }

                    showSnackbar('Camera started - point at barcode', 'success');
                } catch (error) {
                    console.error('Camera start error:', error);
                    showSnackbar(`Camera failed: ${error.message}`, 'error');
                    setIsScanning(false);
                    setCameraMode(false);
                }
            };

            const stopCamera = () => {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    setCameraStream(null);
                }
                setCameraMode(false);
                setIsScanning(false);
            };

            const startBarcodeDetection = async () => {
                if (!videoRef.current || !canvasRef.current) return;

                const video = videoRef.current;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');

                // Check for BarcodeDetector API support
                if ('BarcodeDetector' in window) {
                    const detector = new BarcodeDetector({ formats: ['code_128', 'code_39', 'ean_13', 'ean_8', 'upc_a', 'upc_e'] });

                    const detectBarcodes = async () => {
                        if (!cameraMode || !video.videoWidth || !video.videoHeight) return;

                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        ctx.drawImage(video, 0, 0);

                        try {
                            const barcodes = await detector.detect(canvas);
                            if (barcodes.length > 0) {
                                const barcode = barcodes[0];
                                showSnackbar(`Barcode detected: ${barcode.rawValue}`, 'info');
                                await handleItemScanned(barcode.rawValue);
                                stopCamera();
                                return;
                            }
                        } catch (error) {
                            console.warn('Barcode detection error:', error);
                        }

                        // Continue scanning
                        if (cameraMode) {
                            requestAnimationFrame(detectBarcodes);
                        }
                    };

                    // Start detection when video is ready
                    video.addEventListener('loadedmetadata', () => {
                        detectBarcodes();
                    });

                    if (video.readyState >= video.HAVE_METADATA) {
                        detectBarcodes();
                    }
                } else {
                    // Fallback: Manual capture for browsers without BarcodeDetector
                    showSnackbar('Automatic scanning not supported - use manual input', 'warning');
                }
            };

            // Cleanup effect
            useEffect(() => {
                return () => {
                    if (cameraStream) {
                        cameraStream.getTracks().forEach(track => track.stop());
                    }
                };
            }, [cameraStream]);

            return (
                <MaterialCard elevation={2}>
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center">
                            <span className="material-icons text-xl mr-2 text-blue-600">qr_code_scanner</span>
                            <h3 className="text-lg font-medium dark:text-white">Barcode Scanner</h3>
                        </div>
                        <div className="flex items-center space-x-2">
                            <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                            <span className="text-sm text-gray-600 dark:text-gray-400">Ready</span>
                        </div>
                    </div>

                    <div className="space-y-4">
                        <MaterialInput
                            ref={inputRef}
                            label="Scan barcode or type item name"
                            value={scanInput}
                            onChange={(e) => setScanInput(e.target.value)}
                            onKeyDown={handleKeyPress}
                            disabled={isScanning}
                            autoFocus
                            placeholder="Enter item name, ASIN, or scan barcode..."
                        />

                        <div className="flex space-x-2">
                            <MaterialButton
                                onClick={cameraMode ? stopCamera : startCamera}
                                disabled={false}
                                variant={cameraMode ? "contained" : "outlined"}
                                color={cameraMode ? "error" : "primary"}
                                className="flex-1"
                            >
                                <span className="material-icons mr-2">
                                    {cameraMode ? 'videocam_off' : 'videocam'}
                                </span>
                                {cameraMode ? 'Stop Camera' : 'Start Camera'}
                            </MaterialButton>
                            <MaterialButton
                                onClick={startVoiceSearch}
                                disabled={isScanning || cameraMode}
                                variant="outlined"
                                color="primary"
                                className="flex-1"
                            >
                                <span className="material-icons mr-2">mic</span>
                                Voice
                            </MaterialButton>
                            <MaterialButton
                                onClick={handleScanClick}
                                disabled={isScanning || !scanInput.trim() || cameraMode}
                                variant="contained"
                                color="primary"
                                className="flex-1"
                            >
                                {isScanning && !cameraMode ? (
                                    <>
                                        <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                        Scanning...
                                    </>
                                ) : (
                                    <>
                                        <span className="material-icons mr-2">search</span>
                                        Manual
                                    </>
                                )}
                            </MaterialButton>
                        </div>

                        {/* Debug Info */}
                        <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 text-xs">
                            <div className="font-medium text-blue-800 dark:text-blue-200 mb-2">Camera Debug Info:</div>
                            <div className="space-y-1 text-blue-700 dark:text-blue-300">
                                <div>HTTPS: {location.protocol === 'https:' ? 'âœ…' : 'âŒ'}</div>
                                <div>MediaDevices: {navigator.mediaDevices ? 'âœ…' : 'âŒ'}</div>
                                <div>getUserMedia: {navigator.mediaDevices?.getUserMedia ? 'âœ…' : 'âŒ'}</div>
                                <div>User Agent: {navigator.userAgent.includes('iPhone') ? 'iPhone' : navigator.userAgent.includes('iPad') ? 'iPad' : 'Other'}</div>
                                <div>BarcodeDetector: {'BarcodeDetector' in window ? 'âœ…' : 'âŒ'}</div>
                            </div>
                        </div>

                        {/* Camera View */}
                        {cameraMode && (
                            <div className="bg-black rounded-lg overflow-hidden relative">
                                <video
                                    ref={videoRef}
                                    autoPlay
                                    playsInline
                                    webkitPlaysinline="true"
                                    muted
                                    controls={false}
                                    className="w-full h-64 object-cover"
                                    style={{ backgroundColor: '#000' }}
                                />
                                <canvas
                                    ref={canvasRef}
                                    className="hidden"
                                />
                                <div className="absolute inset-0 border-2 border-red-500 border-dashed rounded-lg pointer-events-none">
                                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-24 border-2 border-red-500 rounded-lg bg-red-500/10">
                                        <div className="text-white text-center mt-8 text-sm font-medium">
                                            Position barcode here
                                        </div>
                                    </div>
                                </div>
                                <div className="absolute top-2 right-2 bg-black/50 text-white px-2 py-1 rounded text-xs">
                                    {isScanning ? (
                                        <div className="flex items-center">
                                            <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse mr-2"></div>
                                            Scanning...
                                        </div>
                                    ) : (
                                        'Ready'
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Recent Scans */}
                        {recentScans.length > 0 && (
                            <div>
                                <h4 className="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                                    <span className="material-icons mr-2 text-sm">history</span>
                                    Recent Scans
                                </h4>
                                <div className="space-y-2 max-h-32 overflow-y-auto">
                                    {recentScans.map((scan, index) => (
                                        <div
                                            key={scan.id}
                                            className={`flex justify-between items-center p-3 rounded-lg transition-all ${
                                                index === 0
                                                    ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800'
                                                    : 'bg-gray-50 dark:bg-gray-700'
                                            }`}
                                        >
                                            <div className="flex-1 min-w-0">
                                                <div className="font-medium text-gray-900 dark:text-white truncate">
                                                    {scan.item.name}
                                                </div>
                                                <div className="text-sm text-gray-600 dark:text-gray-400">
                                                    {scan.timestamp.toLocaleTimeString()}
                                                </div>
                                            </div>
                                            <div className="flex items-center space-x-2 ml-3">
                                                <span className="text-green-600 dark:text-green-400 font-bold">
                                                    +{scan.quantity}
                                                </span>
                                                <MaterialButton
                                                    onClick={() => handleItemScanned(scan.item.name)}
                                                    variant="text"
                                                    color="primary"
                                                    className="!p-2 !min-w-0 !text-xs"
                                                >
                                                    <span className="material-icons text-sm">refresh</span>
                                                </MaterialButton>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </MaterialCard>
            );
        };

        // Snackbar Component
        const MaterialSnackbar = ({ snackbar }) => {
            if (!snackbar) return null;

            const iconMap = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };

            return (
                <div className="mat-snackbar flex items-center">
                    <span className="material-icons mr-2 text-sm">
                        {iconMap[snackbar.type] || 'info'}
                    </span>
                    {snackbar.message}
                </div>
            );
        };

        // Main Firebase App with Material Design
        const MaterialFirebaseApp = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [items, setItems] = useState([]);
            const [users, setUsers] = useState([]);
            const [checkoutHistory, setCheckoutHistory] = useState([]);
            const [activeTab, setActiveTab] = useState('shop');
            const [cart, setCart] = useState([]);
            const [connectionStatus, setConnectionStatus] = useState('connecting');
            const [notifications, setNotifications] = useState([]);
            const [notificationsDismissed, setNotificationsDismissed] = useState(false);
            const [showLowStockPopup, setShowLowStockPopup] = useState(false);
            const [lowStockAlwaysHidden, setLowStockAlwaysHidden] = useState(() => {
                return localStorage.getItem('lowStockAlwaysHidden') === 'true';
            });

            // Form states for Add New Item
            const [newItemForm, setNewItemForm] = useState({
                name: '',
                price: '',
                quantity: '',
                category: ''
            });
            const [isCreatingItem, setIsCreatingItem] = useState(false);

            // Form states for Add New User
            const [newUserForm, setNewUserForm] = useState({
                firstName: '',
                lastName: '',
                costCode: '',
                department: ''
            });

            // Edit User Modal
            const [editingUser, setEditingUser] = useState(null);
            const [editUserForm, setEditUserForm] = useState({
                firstName: '',
                lastName: '',
                costCode: '',
                department: ''
            });
            const [isCreatingUser, setIsCreatingUser] = useState(false);
            const [isUpdatingUser, setIsUpdatingUser] = useState(false);

            // CSV and bulk operation states
            const [csvOperations, setCsvOperations] = useState({
                importingItems: false,
                importingUsers: false,
                exportingItems: false,
                exportingUsers: false,
                itemImportStatus: '',
                userImportStatus: ''
            });

            // Pagination states
            const [inventoryPagination, setInventoryPagination] = useState({
                currentPage: 1,
                itemsPerPage: 50,
                totalItems: 0
            });
            const [usersPagination, setUsersPagination] = useState({
                currentPage: 1,
                itemsPerPage: 50,
                totalItems: 0
            });
            const [checkoutPagination, setCheckoutPagination] = useState({
                currentPage: 1,
                itemsPerPage: 50,
                totalItems: 0
            });

            const { isDarkMode, toggleDarkMode } = useTheme();
            const { snackbar, showSnackbar } = useSnackbar();

            // Process Shipment states
            const [pdfFile, setPdfFile] = useState(null);
            const [pdfText, setPdfText] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [allocationMethod, setAllocationMethod] = useState('auto');
            const [receiptDate, setReceiptDate] = useState('');
            const [vendorName, setVendorName] = useState('');
            const [processingNotes, setProcessingNotes] = useState('');
            const [matchedItems, setMatchedItems] = useState([]);
            const [processingResults, setProcessingResults] = useState([]);

            // Process Shipment item selection states
            const [itemSearchQuery, setItemSearchQuery] = useState('');
            const [selectedShipmentItems, setSelectedShipmentItems] = useState([]);
            const [showQuantityModal, setShowQuantityModal] = useState(false);
            const [shipmentItemDetails, setShipmentItemDetails] = useState({});

            // Pagination handlers
            const handleInventoryPageChange = (page) => {
                setInventoryPagination(prev => ({ ...prev, currentPage: page }));
            };

            const handleInventoryItemsPerPageChange = (itemsPerPage) => {
                setInventoryPagination(prev => ({
                    ...prev,
                    currentPage: 1,
                    itemsPerPage
                }));
            };

            const handleUsersPageChange = (page) => {
                setUsersPagination(prev => ({ ...prev, currentPage: page }));
            };

            const handleUsersItemsPerPageChange = (itemsPerPage) => {
                setUsersPagination(prev => ({
                    ...prev,
                    currentPage: 1,
                    itemsPerPage
                }));
            };

            const handleCheckoutPageChange = (page) => {
                setCheckoutPagination(prev => ({ ...prev, currentPage: page }));
            };

            const handleCheckoutItemsPerPageChange = (itemsPerPage) => {
                setCheckoutPagination(prev => ({
                    ...prev,
                    currentPage: 1,
                    itemsPerPage
                }));
            };

            // Get paginated data
            const getPaginatedItems = () => {
                const startIndex = (inventoryPagination.currentPage - 1) * inventoryPagination.itemsPerPage;
                const endIndex = startIndex + inventoryPagination.itemsPerPage;
                return items.slice(startIndex, endIndex);
            };

            const getPaginatedUsers = () => {
                const startIndex = (usersPagination.currentPage - 1) * usersPagination.itemsPerPage;
                const endIndex = startIndex + usersPagination.itemsPerPage;
                return users.slice(startIndex, endIndex);
            };

            const getPaginatedCheckoutHistory = () => {
                const startIndex = (checkoutPagination.currentPage - 1) * checkoutPagination.itemsPerPage;
                const endIndex = startIndex + checkoutPagination.itemsPerPage;
                return checkoutHistory.slice(startIndex, endIndex);
            };

            // Process Shipment PDF handling
            const handlePdfUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if (file.type !== 'application/pdf') {
                    showSnackbar('Please select a PDF file', 'error');
                    return;
                }

                setPdfFile(file);
                setIsProcessing(true);

                try {
                    // Extract text from PDF using PDF.js
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;

                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + ' ';
                    }

                    setPdfText(fullText);
                    showSnackbar(`PDF uploaded successfully! Extracted ${fullText.length} characters.`, 'success');

                    // Auto-match items if automatic allocation is selected
                    if (allocationMethod === 'auto') {
                        await matchItemsFromPdf(fullText);
                    }
                } catch (error) {
                    console.error('Error processing PDF:', error);
                    showSnackbar(`Failed to process PDF: ${error.message}`, 'error');
                } finally {
                    setIsProcessing(false);
                }
            };

            const matchItemsFromPdf = async (text) => {
                try {
                    const matches = [];
                    const textLower = text.toLowerCase();

                    // Match against checkout history items
                    for (const record of checkoutHistory) {
                        const itemNameLower = record.itemName.toLowerCase();

                        // Simple text matching - look for item names in the PDF
                        if (textLower.includes(itemNameLower) ||
                            itemNameLower.split(' ').some(word => word.length > 3 && textLower.includes(word))) {

                            // Try to extract price and quantity from surrounding text
                            const itemIndex = textLower.indexOf(itemNameLower);
                            const surroundingText = text.substring(Math.max(0, itemIndex - 100), itemIndex + 200);

                            // Simple regex patterns for price and quantity
                            const priceMatch = surroundingText.match(/\$?(\d+\.?\d{0,2})/);
                            const quantityMatch = surroundingText.match(/(\d+)\s*(?:ea|each|qty|quantity|pcs?|pieces?)?/i);

                            matches.push({
                                ...record,
                                extractedPrice: priceMatch ? parseFloat(priceMatch[1]) : null,
                                extractedQuantity: quantityMatch ? parseInt(quantityMatch[1]) : record.quantity,
                                confidence: itemNameLower.length > 5 ? 'high' : 'medium'
                            });
                        }
                    }

                    setMatchedItems(matches);
                    showSnackbar(`Found ${matches.length} potential item matches in PDF`, matches.length > 0 ? 'success' : 'info');
                } catch (error) {
                    console.error('Error matching items:', error);
                    showSnackbar(`Error matching items: ${error.message}`, 'error');
                }
            };


            const processShipment = async () => {
                if (!pdfFile) {
                    showSnackbar('Please upload a PDF file first', 'error');
                    return;
                }

                if (matchedItems.length === 0) {
                    showSnackbar('No matched items found. Cannot generate cost allocation.', 'error');
                    return;
                }

                setIsProcessing(true);

                try {
                    // Calculate cost allocation
                    const totalItems = matchedItems.reduce((sum, item) => sum + item.quantity, 0);

                    // Extract financial data from PDF text
                    const priceMatches = pdfText.match(/\$(\d+\.?\d{0,2})/g) || [];
                    const prices = priceMatches.map(p => parseFloat(p.replace('$', ''))).filter(p => p > 0);

                    let subtotal = 0;
                    let tax = 0;
                    let fees = 0;
                    let total = 0;

                    if (prices.length > 0) {
                        // Simple heuristic: largest number is likely the total
                        total = Math.max(...prices);

                        // Look for tax patterns
                        const taxMatch = pdfText.match(/tax[:\s]*\$?(\d+\.?\d{0,2})/i);
                        tax = taxMatch ? parseFloat(taxMatch[1]) : total * 0.08; // Default 8% tax

                        // Look for fee patterns
                        const feeMatch = pdfText.match(/(?:fee|shipping|handling)[:\s]*\$?(\d+\.?\d{0,2})/i);
                        fees = feeMatch ? parseFloat(feeMatch[1]) : 0;

                        subtotal = total - tax - fees;
                    } else {
                        // Fallback: estimate from matched items
                        subtotal = matchedItems.reduce((sum, item) => sum + (item.extractedPrice || 0) * item.quantity, 0);
                        tax = subtotal * 0.08;
                        total = subtotal + tax + fees;
                    }

                    // Distribute costs across items
                    const costPerItem = subtotal / totalItems;
                    const taxPerItem = tax / totalItems;
                    const feePerItem = fees / totalItems;

                    const allocation = matchedItems.map(item => ({
                        ...item,
                        unitPrice: item.extractedPrice || costPerItem,
                        totalCost: (item.extractedPrice || costPerItem) * item.quantity +
                                   (taxPerItem * item.quantity) + (feePerItem * item.quantity),
                        taxAllocation: taxPerItem * item.quantity,
                        feeAllocation: feePerItem * item.quantity,
                        costCode: formatDepartmentId(item.departmentId)
                    }));

                    // Generate PDF report
                    await generateCostAllocationReport(allocation, { subtotal, tax, fees, total });

                    // Remove processed items from checkout history
                    await removeProcessedItems(matchedItems);

                    // Update processing results
                    setProcessingResults(prev => [...prev, {
                        timestamp: new Date().toISOString(),
                        fileName: pdfFile.name,
                        itemsProcessed: matchedItems.length,
                        totalAmount: total,
                        vendor: vendorName || 'Unknown'
                    }]);

                    showSnackbar(`Successfully processed ${matchedItems.length} items with cost allocation!`, 'success');

                    // Reset form
                    setPdfFile(null);
                    setPdfText('');
                    setMatchedItems([]);
                    document.getElementById('pdf-upload').value = '';

                } catch (error) {
                    console.error('Error processing shipment:', error);
                    showSnackbar(`Error processing shipment: ${error.message}`, 'error');
                } finally {
                    setIsProcessing(false);
                }
            };

            const generateCostAllocationReport = async (allocation, totals) => {
                try {
                    // Create new PDF document
                    const { PDFDocument, rgb, StandardFonts } = PDFLib;
                    const pdfDoc = await PDFDocument.create();
                    const page = pdfDoc.addPage([612, 792]); // Letter size
                    const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
                    const boldFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

                    let y = 750;
                    const leftMargin = 50;

                    // Title
                    page.drawText('COST ALLOCATION REPORT', {
                        x: leftMargin,
                        y,
                        size: 16,
                        font: boldFont,
                        color: rgb(0, 0, 0)
                    });
                    y -= 30;

                    // Metadata
                    page.drawText(`Date: ${new Date().toLocaleDateString()}`, { x: leftMargin, y, size: 10, font });
                    y -= 15;
                    page.drawText(`Vendor: ${vendorName || 'Unknown'}`, { x: leftMargin, y, size: 10, font });
                    y -= 15;
                    page.drawText(`Source File: ${pdfFile.name}`, { x: leftMargin, y, size: 10, font });
                    y -= 30;

                    // Table header
                    page.drawText('Item Description', { x: leftMargin, y, size: 10, font: boldFont });
                    page.drawText('Qty', { x: 250, y, size: 10, font: boldFont });
                    page.drawText('Cost Code', { x: 300, y, size: 10, font: boldFont });
                    page.drawText('Unit Price', { x: 400, y, size: 10, font: boldFont });
                    page.drawText('Total Cost', { x: 480, y, size: 10, font: boldFont });
                    y -= 20;

                    // Draw line
                    page.drawLine({
                        start: { x: leftMargin, y },
                        end: { x: 550, y },
                        thickness: 1,
                        color: rgb(0, 0, 0)
                    });
                    y -= 15;

                    // Allocation details
                    for (const item of allocation) {
                        if (y < 100) {
                            // Add new page if needed
                            const newPage = pdfDoc.addPage([612, 792]);
                            y = 750;
                        }

                        const itemName = item.itemName.length > 25 ?
                            item.itemName.substring(0, 25) + '...' : item.itemName;

                        page.drawText(itemName, { x: leftMargin, y, size: 9, font });
                        page.drawText(item.quantity.toString(), { x: 250, y, size: 9, font });
                        page.drawText(item.costCode || item.departmentId || '-', { x: 300, y, size: 9, font });
                        page.drawText(`$${item.unitPrice.toFixed(2)}`, { x: 400, y, size: 9, font });
                        page.drawText(`$${item.totalCost.toFixed(2)}`, { x: 480, y, size: 9, font });
                        y -= 15;
                    }

                    y -= 20;

                    // Financial summary
                    page.drawText('FINANCIAL SUMMARY', { x: leftMargin, y, size: 12, font: boldFont });
                    y -= 20;
                    page.drawText(`Subtotal: $${totals.subtotal.toFixed(2)}`, { x: leftMargin, y, size: 10, font });
                    y -= 15;
                    page.drawText(`Tax: $${totals.tax.toFixed(2)}`, { x: leftMargin, y, size: 10, font });
                    y -= 15;
                    page.drawText(`Fees: $${totals.fees.toFixed(2)}`, { x: leftMargin, y, size: 10, font });
                    y -= 15;
                    page.drawText(`Total: $${totals.total.toFixed(2)}`, { x: leftMargin, y, size: 12, font: boldFont });

                    // Download the PDF
                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `shipment-allocation-${Date.now()}.pdf`;
                    link.click();
                    URL.revokeObjectURL(url);

                } catch (error) {
                    console.error('Error generating PDF report:', error);
                    showSnackbar('Failed to generate PDF report', 'error');
                }
            };

            const removeProcessedItems = async (processedItems) => {
                try {
                    const batch = db.batch();

                    for (const item of processedItems) {
                        const docRef = db.collection('checkoutHistory').doc(item.id);
                        batch.delete(docRef);
                    }

                    await batch.commit();

                    // Update local state
                    setCheckoutHistory(prev =>
                        prev.filter(record => !processedItems.some(item => item.id === record.id))
                    );

                    console.log(`Removed ${processedItems.length} processed items from checkout history`);
                } catch (error) {
                    console.error('Error removing processed items:', error);
                    throw error;
                }
            };

            // Initialize Firebase with existing data if empty
            const initializeDataIfEmpty = async () => {
                try {
                    // Check if collections are empty
                    const itemsSnapshot = await db.collection('items').limit(1).get();
                    const usersSnapshot = await db.collection('users').limit(1).get();

                    if (itemsSnapshot.empty || usersSnapshot.empty) {
                        showSnackbar('Initializing database with inventory data...', 'info');

                        // Load and populate items
                        if (itemsSnapshot.empty) {
                            const itemsResponse = await fetch('./data/items.json');
                            if (itemsResponse.ok) {
                                const itemsData = await itemsResponse.json();
                                console.log(`Preparing to load ${itemsData.length} items to Firebase`);

                                // Process in batches due to Firestore 500 doc limit
                                const batchSize = 400;
                                for (let i = 0; i < itemsData.length; i += batchSize) {
                                    const batch = db.batch();
                                    const itemsBatch = itemsData.slice(i, i + batchSize);

                                    itemsBatch.forEach(item => {
                                        const docRef = db.collection('items').doc(item.id);
                                        batch.set(docRef, {
                                            ...item,
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                                            createdBy: 'auto-migration'
                                        });
                                    });

                                    await batch.commit();
                                    showSnackbar(`Loaded ${Math.min(i + batchSize, itemsData.length)} / ${itemsData.length} items`, 'info');
                                }

                                showSnackbar(`Successfully loaded all ${itemsData.length} items`, 'success');
                            }
                        }

                        // Load and populate users
                        if (usersSnapshot.empty) {
                            const usersResponse = await fetch('./data/users.json');
                            if (usersResponse.ok) {
                                const usersData = await usersResponse.json();

                                // Process in smaller batches due to Firestore 500 doc limit
                                const batchSize = 400;
                                for (let i = 0; i < usersData.length; i += batchSize) {
                                    const batch = db.batch();
                                    const usersBatch = usersData.slice(i, i + batchSize);

                                    usersBatch.forEach(user => {
                                        const docRef = db.collection('users').doc(user.id);
                                        batch.set(docRef, {
                                            ...user,
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                            createdBy: 'auto-migration',
                                            active: true
                                        });
                                    });

                                    await batch.commit();
                                    showSnackbar(`Loaded ${Math.min(i + batchSize, usersData.length)} / ${usersData.length} users`, 'info');
                                }

                                showSnackbar(`Loaded ${usersData.length} users`, 'success');
                            }
                        }

                        // Optionally load checkout history (limit to recent records due to size)
                        const historySnapshot = await db.collection('checkoutHistory').limit(1).get();
                        if (historySnapshot.empty) {
                            const historyResponse = await fetch('./data/checkoutHistory.json');
                            if (historyResponse.ok) {
                                const historyData = await historyResponse.json();

                                // Only load most recent 500 records to avoid quota issues
                                const recentHistory = historyData
                                    .sort((a, b) => new Date(b.dateEntered) - new Date(a.dateEntered))
                                    .slice(0, 500);

                                const batchSize = 400;
                                for (let i = 0; i < recentHistory.length; i += batchSize) {
                                    const batch = db.batch();
                                    const historyBatch = recentHistory.slice(i, i + batchSize);

                                    historyBatch.forEach(record => {
                                        const docRef = db.collection('checkoutHistory').doc(record.id);
                                        batch.set(docRef, {
                                            ...record,
                                            dateEntered: record.dateEntered ? new Date(record.dateEntered) : firebase.firestore.FieldValue.serverTimestamp(),
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                            createdBy: 'auto-migration'
                                        });
                                    });

                                    await batch.commit();
                                }

                                showSnackbar(`Loaded ${recentHistory.length} recent checkout records`, 'success');
                            }
                        }

                        showSnackbar('Database initialization complete!', 'success');
                    }
                } catch (error) {
                    console.error('Data initialization error:', error);
                    showSnackbar(`Data initialization failed: ${error.message}`, 'error');
                }
            };

            // Real-time data listeners
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    setUser(user);
                    setLoading(false);

                    if (user) {
                        try {
                            setConnectionStatus('connecting');

                            // Check if data needs to be initialized
                            await initializeDataIfEmpty();

                            // Set up real-time listeners with fallback data
                            const itemsUnsubscribe = db.collection('items')
                                .onSnapshot((snapshot) => {
                                    const itemsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                                    // If Firebase is empty, use default items
                                    if (itemsData.length === 0) {
                                        console.log('Firebase collection empty, using default items');
                                        const defaultItems = [
                                            { id: "item001", name: "Dell Monitor 24\"", asin: "B07CVL2D2T", quantity: 15, minThreshold: 5, category: "Electronics", price: 299.99 },
                                            { id: "item002", name: "USB-C Hub", asin: "B08HR6DSLT", quantity: 25, minThreshold: 10, category: "Accessories", price: 49.99 },
                                            { id: "item003", name: "Wireless Mouse", asin: "B07FKMDJQZ", quantity: 30, minThreshold: 15, category: "Accessories", price: 29.99 },
                                            { id: "item004", name: "Ethernet Cable 6ft", asin: "B00N2VIALK", quantity: 50, minThreshold: 20, category: "Cables", price: 12.99 },
                                            { id: "item005", name: "Laptop Stand", asin: "B075GCG36Z", quantity: 8, minThreshold: 3, category: "Accessories", price: 79.99 }
                                        ];
                                        setItems(defaultItems);
                                        checkLowStock(defaultItems);
                                        console.log(`Using ${defaultItems.length} default items`);
                                    } else {
                                        setItems(itemsData);
                                        checkLowStock(itemsData);
                                        console.log(`Loaded ${itemsData.length} items from Firebase`);
                                    }
                                }, (error) => {
                                    console.error('Firebase items error:', error);
                                    // Fallback to default items on error
                                    const defaultItems = [
                                        { id: "item001", name: "Dell Monitor 24\"", asin: "B07CVL2D2T", quantity: 15, minThreshold: 5, category: "Electronics", price: 299.99 },
                                        { id: "item002", name: "USB-C Hub", asin: "B08HR6DSLT", quantity: 25, minThreshold: 10, category: "Accessories", price: 49.99 },
                                        { id: "item003", name: "Wireless Mouse", asin: "B07FKMDJQZ", quantity: 30, minThreshold: 15, category: "Accessories", price: 29.99 },
                                        { id: "item004", name: "Ethernet Cable 6ft", asin: "B00N2VIALK", quantity: 50, minThreshold: 20, category: "Cables", price: 12.99 },
                                        { id: "item005", name: "Laptop Stand", asin: "B075GCG36Z", quantity: 8, minThreshold: 3, category: "Accessories", price: 79.99 }
                                    ];
                                    setItems(defaultItems);
                                    checkLowStock(defaultItems);
                                    console.log(`Firebase error, using ${defaultItems.length} default items`);
                                });

                            const usersUnsubscribe = db.collection('users')
                                .onSnapshot((snapshot) => {
                                    const usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                    setUsers(usersData);
                                    console.log(`Loaded ${usersData.length} users from Firebase`);
                                });

                            const historyUnsubscribe = db.collection('checkoutHistory')
                                .orderBy('dateEntered', 'desc')
                                .limit(500)
                                .onSnapshot((snapshot) => {
                                    const historyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                    setCheckoutHistory(historyData);
                                    console.log(`Loaded ${historyData.length} checkout records from Firebase`);
                                });

                            setConnectionStatus('connected');

                            return () => {
                                itemsUnsubscribe();
                                usersUnsubscribe();
                                historyUnsubscribe();
                            };

                        } catch (error) {
                            console.error('Firebase connection error:', error);
                            setConnectionStatus('error');
                            showSnackbar('Connection error: ' + error.message, 'error');
                        }
                    }
                });

                return unsubscribe;
            }, []);

            const checkLowStock = (itemList) => {
                const lowStockItems = itemList.filter(item =>
                    item.quantity <= (item.minThreshold || 5)
                );

                setNotifications(lowStockItems.map(item => ({
                    id: item.id,
                    type: 'warning',
                    message: `Low stock: ${item.name} (${item.quantity} remaining)`
                })));

                // Show popup if there are low stock items and not permanently hidden
                if (lowStockItems.length > 0 && !lowStockAlwaysHidden) {
                    setShowLowStockPopup(true);
                    setNotificationsDismissed(false);
                }
            };

            const handleNotificationClick = () => {
                // Switch to Inventory tab to show low stock items
                setActiveTab('inventory');
            };

            const dismissNotifications = () => {
                setNotificationsDismissed(true);
            };

            // Popup handlers
            const handlePopupViewInventory = () => {
                setActiveTab('inventory');
                setShowLowStockPopup(false);
            };

            const handlePopupDismiss = () => {
                setShowLowStockPopup(false);
            };

            const handlePopupAlwaysHide = () => {
                setLowStockAlwaysHidden(true);
                localStorage.setItem('lowStockAlwaysHidden', 'true');
                setShowLowStockPopup(false);
                setNotificationsDismissed(true);
            };

            const addToCart = (item, quantity = 1) => {
                const existingIndex = cart.findIndex(cartItem => cartItem.id === item.id);

                if (existingIndex >= 0) {
                    const newCart = [...cart];
                    newCart[existingIndex].cartQuantity += quantity;
                    setCart(newCart);
                } else {
                    setCart(prev => [...prev, { ...item, cartQuantity: quantity }]);
                }

                showSnackbar(`Added ${item.name} to cart`, 'success');
            };

            const removeFromCart = (itemId) => {
                setCart(prev => prev.filter(item => item.id !== itemId));
            };

            const clearCart = () => {
                setCart([]);
            };

            // Handle creating new item
            const handleCreateItem = async (e) => {
                e.preventDefault();
                if (!newItemForm.name.trim()) {
                    showSnackbar('Item name is required', 'error');
                    return;
                }

                setIsCreatingItem(true);
                try {
                    const itemData = {
                        name: newItemForm.name.trim(),
                        price: parseFloat(newItemForm.price) || 0,
                        quantity: parseInt(newItemForm.quantity) || 0,
                        category: newItemForm.category.trim() || 'Uncategorized',
                        minThreshold: 5,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: auth.currentUser?.email || 'unknown'
                    };

                    await db.collection('items').add(itemData);

                    // Reset form
                    setNewItemForm({
                        name: '',
                        price: '',
                        quantity: '',
                        category: ''
                    });

                    showSnackbar(`Item "${itemData.name}" created successfully!`, 'success');
                } catch (error) {
                    console.error('Error creating item:', error);
                    showSnackbar(`Failed to create item: ${error.message}`, 'error');
                } finally {
                    setIsCreatingItem(false);
                }
            };

            // Handle creating new user
            const handleCreateUser = async (e) => {
                e.preventDefault();
                if (!newUserForm.firstName.trim() || !newUserForm.lastName.trim()) {
                    showSnackbar('First name and last name are required', 'error');
                    return;
                }

                setIsCreatingUser(true);
                try {
                    const userData = {
                        firstName: newUserForm.firstName.trim(),
                        lastName: newUserForm.lastName.trim(),
                        name: `${newUserForm.firstName.trim()} ${newUserForm.lastName.trim()}`,
                        costCode: newUserForm.costCode.trim() || `${Date.now()}-5770`,
                        department: newUserForm.department.trim(),
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: auth.currentUser?.email || 'unknown'
                    };

                    await db.collection('users').add(userData);

                    // Reset form
                    setNewUserForm({
                        firstName: '',
                        lastName: '',
                        costCode: '',
                        department: ''
                    });

                    showSnackbar(`User "${userData.name}" created successfully!`, 'success');
                } catch (error) {
                    console.error('Error creating user:', error);
                    showSnackbar(`Failed to create user: ${error.message}`, 'error');
                } finally {
                    setIsCreatingUser(false);
                }
            };

            // Populate edit form when editing user changes
            useEffect(() => {
                if (editingUser) {
                    setEditUserForm({
                        firstName: editingUser.firstName || '',
                        lastName: editingUser.lastName || '',
                        costCode: editingUser.costCode || editingUser.cost_code || '',
                        department: editingUser.department || (editingUser.costCode || editingUser.cost_code || '').split('-')[0] || ''
                    });
                }
            }, [editingUser]);

            // Update pagination totals when data changes
            useEffect(() => {
                setInventoryPagination(prev => ({ ...prev, totalItems: items.length }));
            }, [items]);

            useEffect(() => {
                setUsersPagination(prev => ({ ...prev, totalItems: users.length }));
            }, [users]);

            useEffect(() => {
                setCheckoutPagination(prev => ({ ...prev, totalItems: checkoutHistory.length }));
            }, [checkoutHistory]);

            // Handle Edit User
            const handleUpdateUser = async (e) => {
                e.preventDefault();
                if (!editUserForm.firstName.trim() || !editUserForm.lastName.trim()) {
                    showSnackbar('First name and last name are required', 'error');
                    return;
                }

                setIsUpdatingUser(true);
                try {
                    const updatedUserData = {
                        firstName: editUserForm.firstName.trim(),
                        lastName: editUserForm.lastName.trim(),
                        name: `${editUserForm.firstName.trim()} ${editUserForm.lastName.trim()}`,
                        costCode: editUserForm.costCode.trim() || `${Date.now()}-5770`,
                        department: editUserForm.department.trim(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: user?.email || 'anonymous'
                    };

                    await db.collection('users').doc(editingUser.id).update(updatedUserData);

                    // Update local state
                    setUsers(prev => prev.map(u =>
                        u.id === editingUser.id ? { ...u, ...updatedUserData } : u
                    ));

                    setEditingUser(null);
                    setEditUserForm({
                        firstName: '',
                        lastName: '',
                        costCode: '',
                        department: ''
                    });

                    showSnackbar(`User "${updatedUserData.name}" updated successfully!`, 'success');
                } catch (error) {
                    console.error('Error updating user:', error);
                    showSnackbar(`Failed to update user: ${error.message}`, 'error');
                } finally {
                    setIsUpdatingUser(false);
                }
            };

            // CSV Export Functions
            const exportItemsToCSV = async () => {
                setCsvOperations(prev => ({ ...prev, exportingItems: true }));
                try {
                    const csvHeader = 'Item Name,Category,Quantity,Price,Min Threshold\n';
                    const csvRows = items.map(item =>
                        `"${(item.name || '').replace(/"/g, '""')}","${(item.category || '').replace(/"/g, '""')}",${item.quantity || 0},${item.price || 0},${item.minThreshold || 5}`
                    ).join('\n');

                    const csvContent = csvHeader + csvRows;
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `inventory-items-${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();

                    showSnackbar(`Exported ${items.length} items to CSV`, 'success');
                } catch (error) {
                    showSnackbar(`Export failed: ${error.message}`, 'error');
                } finally {
                    setCsvOperations(prev => ({ ...prev, exportingItems: false }));
                }
            };

            const exportUsersToCSV = async () => {
                setCsvOperations(prev => ({ ...prev, exportingUsers: true }));
                try {
                    const csvHeader = 'First Name,Last Name,Full Name,Cost Code,Department,Status\n';
                    const csvRows = users.map(user =>
                        `"${(user.firstName || '').replace(/"/g, '""')}","${(user.lastName || '').replace(/"/g, '""')}","${(user.name || '').replace(/"/g, '""')}","${formatDepartmentId(user.costCode || user.cost_code || '').replace(/"/g, '""')}","${(user.department || '').replace(/"/g, '""')}","${user.status || 'active'}"`
                    ).join('\n');

                    const csvContent = csvHeader + csvRows;
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `inventory-users-${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();

                    showSnackbar(`Exported ${users.length} users to CSV`, 'success');
                } catch (error) {
                    showSnackbar(`Export failed: ${error.message}`, 'error');
                } finally {
                    setCsvOperations(prev => ({ ...prev, exportingUsers: false }));
                }
            };

            // Manual data refresh function for troubleshooting
            const refreshDataFromFiles = async () => {
                try {
                    showSnackbar('Starting manual data refresh...', 'info');

                    // Force reload all data regardless of current state
                    const [itemsResponse, usersResponse, historyResponse] = await Promise.all([
                        fetch('./data/items.json'),
                        fetch('./data/users.json'),
                        fetch('./data/checkoutHistory.json')
                    ]);

                    if (itemsResponse.ok) {
                        const itemsData = await itemsResponse.json();
                        console.log(`Refreshing ${itemsData.length} items in Firebase`);

                        // Clear existing items first
                        const existingItems = await db.collection('items').get();
                        if (!existingItems.empty) {
                            const deleteBatch = db.batch();
                            existingItems.docs.forEach(doc => deleteBatch.delete(doc.ref));
                            await deleteBatch.commit();
                        }

                        // Add all items in batches
                        const batchSize = 400;
                        for (let i = 0; i < itemsData.length; i += batchSize) {
                            const batch = db.batch();
                            const itemsBatch = itemsData.slice(i, i + batchSize);

                            itemsBatch.forEach(item => {
                                const docRef = db.collection('items').doc(item.id);
                                batch.set(docRef, {
                                    ...item,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                                    createdBy: 'manual-refresh'
                                });
                            });

                            await batch.commit();
                            showSnackbar(`Refreshed ${Math.min(i + batchSize, itemsData.length)} / ${itemsData.length} items`, 'info');
                        }
                    }

                    if (usersResponse.ok) {
                        const usersData = await usersResponse.json();
                        console.log(`Refreshing ${usersData.length} users in Firebase`);

                        // Clear existing users first
                        const existingUsers = await db.collection('users').get();
                        if (!existingUsers.empty) {
                            const deleteBatch = db.batch();
                            existingUsers.docs.forEach(doc => deleteBatch.delete(doc.ref));
                            await deleteBatch.commit();
                        }

                        // Add all users in batches
                        const batchSize = 400;
                        for (let i = 0; i < usersData.length; i += batchSize) {
                            const batch = db.batch();
                            const usersBatch = usersData.slice(i, i + batchSize);

                            usersBatch.forEach(user => {
                                const docRef = db.collection('users').doc(user.id);
                                batch.set(docRef, {
                                    ...user,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    createdBy: 'manual-refresh',
                                    active: true
                                });
                            });

                            await batch.commit();
                            showSnackbar(`Refreshed ${Math.min(i + batchSize, usersData.length)} / ${usersData.length} users`, 'info');
                        }
                    }

                    showSnackbar('Manual data refresh completed successfully!', 'success');
                } catch (error) {
                    console.error('Manual refresh error:', error);
                    showSnackbar(`Manual refresh failed: ${error.message}`, 'error');
                }
            };

            // CSV Import Functions
            const handleItemsImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setCsvOperations(prev => ({ ...prev, importingItems: true, itemImportStatus: 'Reading file...' }));
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());

                        let successCount = 0;
                        let errorCount = 0;

                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;

                            try {
                                const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                                const item = {};

                                headers.forEach((header, index) => {
                                    switch(header.toLowerCase()) {
                                        case 'item name':
                                        case 'name':
                                            item.name = values[index];
                                            break;
                                        case 'category':
                                            item.category = values[index] || 'Uncategorized';
                                            break;
                                        case 'quantity':
                                            item.quantity = parseInt(values[index]) || 0;
                                            break;
                                        case 'price':
                                            item.price = parseFloat(values[index]) || 0;
                                            break;
                                        case 'min threshold':
                                            item.minThreshold = parseInt(values[index]) || 5;
                                            break;
                                    }
                                });

                                if (!item.name) {
                                    errorCount++;
                                    continue;
                                }

                                item.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                                item.lastUpdated = firebase.firestore.FieldValue.serverTimestamp();
                                item.createdBy = auth.currentUser?.email || 'csv-import';

                                await db.collection('items').add(item);
                                successCount++;
                            } catch (itemError) {
                                errorCount++;
                                console.error('Error importing item:', itemError);
                            }
                        }

                        showSnackbar(`Import completed: ${successCount} items added, ${errorCount} errors`, successCount > 0 ? 'success' : 'warning');
                    } catch (error) {
                        showSnackbar(`Import failed: ${error.message}`, 'error');
                    } finally {
                        setCsvOperations(prev => ({ ...prev, importingItems: false }));
                        event.target.value = ''; // Reset file input
                    }
                };

                reader.readAsText(file);
            };

            const handleUsersImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setCsvOperations(prev => ({ ...prev, importingUsers: true, userImportStatus: 'Reading file...' }));
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());

                        let successCount = 0;
                        let errorCount = 0;

                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;

                            try {
                                const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                                const user = {};

                                headers.forEach((header, index) => {
                                    switch(header.toLowerCase()) {
                                        case 'first name':
                                        case 'firstname':
                                            user.firstName = values[index];
                                            break;
                                        case 'last name':
                                        case 'lastname':
                                            user.lastName = values[index];
                                            break;
                                        case 'cost code':
                                        case 'costcode':
                                            user.costCode = values[index];
                                            break;
                                        case 'department':
                                            user.department = values[index];
                                            break;
                                    }
                                });

                                if (!user.firstName || !user.lastName) {
                                    errorCount++;
                                    continue;
                                }

                                user.name = `${user.firstName} ${user.lastName}`;
                                user.status = 'active';
                                user.costCode = user.costCode || `${Date.now()}-${Math.floor(Math.random() * 1000)}-5770`;
                                user.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                                user.createdBy = auth.currentUser?.email || 'csv-import';

                                await db.collection('users').add(user);
                                successCount++;
                            } catch (userError) {
                                errorCount++;
                                console.error('Error importing user:', userError);
                            }
                        }

                        showSnackbar(`Import completed: ${successCount} users added, ${errorCount} errors`, successCount > 0 ? 'success' : 'warning');
                    } catch (error) {
                        showSnackbar(`Import failed: ${error.message}`, 'error');
                    } finally {
                        setCsvOperations(prev => ({ ...prev, importingUsers: false }));
                        event.target.value = ''; // Reset file input
                    }
                };

                reader.readAsText(file);
            };

            // Bulk Operations
            const handleResetAllQuantities = async () => {
                if (!confirm('Are you sure you want to reset ALL item quantities to zero? This cannot be undone.')) {
                    return;
                }

                try {
                    const batch = db.batch();
                    items.forEach(item => {
                        const itemRef = db.collection('items').doc(item.id);
                        batch.update(itemRef, {
                            quantity: 0,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });

                    await batch.commit();
                    showSnackbar(`Reset quantities for ${items.length} items`, 'success');
                } catch (error) {
                    showSnackbar(`Bulk reset failed: ${error.message}`, 'error');
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
                        <div className="text-center">
                            <div className="mat-spinner w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                            <p className="text-gray-600 dark:text-gray-400">Loading Firebase App...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return (
                    <>
                        <AuthComponent />
                        <MaterialSnackbar snackbar={snackbar} />
                    </>
                );
            }

            const tabs = [
                { id: 'shop', name: 'Shop', icon: 'storefront', count: cart.length },
                { id: 'scanner', name: 'Scanner', icon: 'qr_code_scanner' },
                { id: 'inventory', name: 'Inventory', icon: 'inventory_2', count: items.length },
                { id: 'users', name: 'Users', icon: 'people', count: users.length },
                { id: 'admin', name: 'Admin', icon: 'admin_panel_settings' },
                { id: 'shipment', name: 'Process Shipment', icon: 'local_shipping' },
                { id: 'history', name: 'History', icon: 'history', count: checkoutHistory.length }
            ];

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
                    <AuthComponent />

                    {/* Connection Status */}
                    <div className={`px-4 py-2 text-center text-sm transition-colors duration-300 ${
                        connectionStatus === 'connected'
                            ? 'bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300'
                            : connectionStatus === 'error'
                            ? 'bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300'
                            : 'bg-yellow-50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-300'
                    }`}>
                        <div className="flex items-center justify-center space-x-2">
                            <span className="material-icons text-sm">
                                {connectionStatus === 'connected' ? 'cloud_done' :
                                 connectionStatus === 'error' ? 'cloud_off' : 'cloud_sync'}
                            </span>
                            <span>
                                {connectionStatus === 'connected' ? 'Firebase Connected - Real-time sync active' :
                                 connectionStatus === 'error' ? 'Firebase Connection Error' :
                                 'Connecting to Firebase...'}
                            </span>
                        </div>
                    </div>


                    {/* Material You Navigation */}
                    <nav className="md-navigation-bar md-elevation-2" style={{
                        backgroundColor: 'var(--md-sys-color-surface-container)',
                        borderBottom: '1px solid var(--md-sys-color-outline-variant)'
                    }}>
                        <div className="max-w-7xl mx-auto">
                            {/* Desktop Navigation */}
                            <div className="hidden lg:flex justify-between items-center px-4">
                                <div className="flex">
                                    {tabs.map(tab => (
                                        <button
                                            key={tab.id}
                                            onClick={() => setActiveTab(tab.id)}
                                            className={`md-navigation-tab ${activeTab === tab.id ? 'active' : ''}`}
                                            style={{
                                                backgroundColor: activeTab === tab.id
                                                    ? 'var(--md-sys-color-primary-container)'
                                                    : 'transparent',
                                                color: activeTab === tab.id
                                                    ? 'var(--md-sys-color-on-primary-container)'
                                                    : 'var(--md-sys-color-on-surface-variant)'
                                            }}
                                        >
                                            <span className="material-icons text-lg">{tab.icon}</span>
                                            <span>{tab.name}</span>
                                            {tab.count !== undefined && tab.count > 0 && (
                                                <div
                                                    className="md-badge"
                                                    style={{
                                                        backgroundColor: tab.id === 'shop'
                                                            ? 'var(--md-sys-color-primary)'
                                                            : 'var(--md-sys-color-surface-variant)',
                                                        color: tab.id === 'shop'
                                                            ? 'var(--md-sys-color-on-primary)'
                                                            : 'var(--md-sys-color-on-surface-variant)'
                                                    }}
                                                >
                                                    {tab.count}
                                                </div>
                                            )}
                                        </button>
                                    ))}
                                </div>

                                <div className="flex items-center gap-3">
                                    <div className="md-status-indicator">
                                        <div className="md-status-dot"></div>
                                        <span>Connected</span>
                                    </div>

                                    <button
                                        onClick={toggleDarkMode}
                                        className="md-theme-toggle"
                                        title={isDarkMode ? 'Switch to light mode' : 'Switch to dark mode'}
                                    >
                                        <span className="material-icons text-lg">
                                            {isDarkMode ? 'light_mode' : 'dark_mode'}
                                        </span>
                                    </button>
                                </div>
                            </div>

                            {/* Mobile Navigation */}
                            <div className="lg:hidden">
                                {/* Mobile Header */}
                                <div className="flex justify-between items-center p-4">
                                    <h2 className="font-medium text-xl" style={{
                                        color: 'var(--md-sys-color-on-surface)',
                                        font: 'var(--md-sys-typescale-title-large)'
                                    }}>
                                        {tabs.find(t => t.id === activeTab)?.name || 'IT Inventory'}
                                    </h2>
                                    <div className="flex items-center gap-2">
                                        <div className="md-status-indicator" style={{ padding: '4px 12px', fontSize: '11px' }}>
                                            <div className="md-status-dot" style={{ width: '6px', height: '6px' }}></div>
                                            <span>Live</span>
                                        </div>
                                        <button
                                            onClick={toggleDarkMode}
                                            className="md-theme-toggle"
                                            style={{ padding: '6px' }}
                                        >
                                            <span className="material-icons text-base">
                                                {isDarkMode ? 'light_mode' : 'dark_mode'}
                                            </span>
                                        </button>
                                    </div>
                                </div>

                                {/* Mobile Tab Scrollable */}
                                <div className="overflow-x-auto">
                                    <div className="flex gap-1 px-4 pb-3">
                                        {tabs.map(tab => (
                                            <button
                                                key={tab.id}
                                                onClick={() => setActiveTab(tab.id)}
                                                className="flex-shrink-0 flex items-center gap-2 px-4 py-2 rounded-full text-sm transition-all whitespace-nowrap"
                                                style={{
                                                    backgroundColor: activeTab === tab.id
                                                        ? 'var(--md-sys-color-primary-container)'
                                                        : 'var(--md-sys-color-surface-container-highest)',
                                                    color: activeTab === tab.id
                                                        ? 'var(--md-sys-color-on-primary-container)'
                                                        : 'var(--md-sys-color-on-surface-variant)',
                                                    border: activeTab === tab.id
                                                        ? 'none'
                                                        : '1px solid var(--md-sys-color-outline-variant)'
                                                }}
                                            >
                                                <span className="material-icons text-sm">{tab.icon}</span>
                                                <span className="font-medium">{tab.name}</span>
                                                {tab.count !== undefined && tab.count > 0 && (
                                                    <div
                                                        className="md-badge"
                                                        style={{
                                                            backgroundColor: tab.id === 'shop'
                                                                ? 'var(--md-sys-color-primary)'
                                                                : 'var(--md-sys-color-surface-variant)',
                                                            color: tab.id === 'shop'
                                                                ? 'var(--md-sys-color-on-primary)'
                                                                : 'var(--md-sys-color-on-surface-variant)',
                                                            fontSize: '10px',
                                                            padding: '1px 6px'
                                                        }}
                                                    >
                                                        {tab.count}
                                                    </div>
                                                )}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto p-3 sm:p-6">
                        {activeTab === 'shop' && (
                            <div className="grid grid-cols-1 xl:grid-cols-3 gap-4 lg:gap-6">
                                {/* Shop Items */}
                                <div className="xl:col-span-2 space-y-4 lg:space-y-6 order-2 xl:order-1">
                                    {/* Barcode Scanner */}
                                    <MaterialBarcodeScanner
                                        items={items}
                                        onItemScanned={(item, quantity) => {
                                            console.log(`Scanned: ${item.name} +${quantity}`);
                                        }}
                                    />

                                    {/* Items Grid */}
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                                            <span className="material-icons mr-2">storefront</span>
                                            Shop Items
                                        </h2>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-3 lg:gap-4">
                                            {getPaginatedItems().map(item => (
                                                <MaterialCard key={item.id} elevation={1} className="!p-3 lg:!p-4 hover:mat-elevation-4">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <h3 className="font-medium text-sm text-gray-900 dark:text-white line-clamp-2">
                                                            {item.name}
                                                        </h3>
                                                        <div className={`px-2 py-1 rounded-full text-xs font-medium ${
                                                            item.quantity <= (item.minThreshold || 5)
                                                                ? 'bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300'
                                                                : 'bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300'
                                                        }`}>
                                                            {item.quantity}
                                                        </div>
                                                    </div>
                                                    <div className="text-xs text-gray-600 dark:text-gray-400 mb-4">
                                                        <div className="flex items-center">
                                                            <span className="material-icons text-xs mr-1">category</span>
                                                            {item.category}
                                                        </div>
                                                        {item.price > 0 && (
                                                            <div className="flex items-center mt-1 text-green-600 dark:text-green-400 font-medium">
                                                                <span className="material-icons text-xs mr-1">attach_money</span>
                                                                ${item.price}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <MaterialButton
                                                        onClick={() => addToCart(item)}
                                                        disabled={item.quantity === 0}
                                                        variant="contained"
                                                        color="primary"
                                                        className="w-full !py-2"
                                                    >
                                                        {item.quantity === 0 ? (
                                                            <>
                                                                <span className="material-icons mr-2 text-sm">block</span>
                                                                Out of Stock
                                                            </>
                                                        ) : (
                                                            <>
                                                                <span className="material-icons mr-2 text-sm">add_shopping_cart</span>
                                                                Add to Cart
                                                            </>
                                                        )}
                                                    </MaterialButton>
                                                </MaterialCard>
                                            ))}
                                        </div>

                                        {/* Inventory Pagination */}
                                        <MaterialPagination
                                            currentPage={inventoryPagination.currentPage}
                                            totalItems={inventoryPagination.totalItems}
                                            itemsPerPage={inventoryPagination.itemsPerPage}
                                            onPageChange={handleInventoryPageChange}
                                            onItemsPerPageChange={handleInventoryItemsPerPageChange}
                                        />
                                    </div>
                                </div>

                                {/* Shopping Cart - Mobile First, Desktop Sticky */}
                                <div className="order-1 xl:order-2">
                                    <div className="xl:sticky xl:top-6">
                                        <MaterialShoppingCart
                                            cart={cart}
                                            addToCart={addToCart}
                                            removeFromCart={removeFromCart}
                                            clearCart={clearCart}
                                            users={users}
                                            onCheckout={() => {
                                                showSnackbar('Checkout completed successfully!', 'success');
                                            }}
                                        />
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'scanner' && (
                            <div className="max-w-2xl mx-auto">
                                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                                    <span className="material-icons mr-2">qr_code_scanner</span>
                                    Barcode Scanner
                                </h2>
                                <MaterialBarcodeScanner
                                    items={items}
                                    onItemScanned={(item, quantity) => {
                                        showSnackbar(`Scanned: ${item.name} +${quantity}`, 'success');
                                    }}
                                />
                            </div>
                        )}

                        {activeTab === 'inventory' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                                    <span className="material-icons mr-2">inventory_2</span>
                                    Inventory Management
                                </h2>
                                <MaterialCard elevation={1}>
                                    <div className="mb-4 flex justify-between items-center">
                                        <p className="text-sm text-gray-600 dark:text-gray-400">
                                            Comprehensive inventory management with pagination
                                        </p>
                                        <div className="flex items-center space-x-2">
                                            <span className="material-icons text-green-500">trending_up</span>
                                            <span className="text-sm text-gray-600 dark:text-gray-400">Real-time sync</span>
                                        </div>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full">
                                            <thead className="bg-gray-50 dark:bg-gray-700">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">inventory</span>
                                                            Item
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">numbers</span>
                                                            Quantity
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">category</span>
                                                            Category
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">attach_money</span>
                                                            Price
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                {getPaginatedItems().map(item => (
                                                    <tr key={item.id} className="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                                        <td className="px-6 py-4">
                                                            <div className="font-medium text-gray-900 dark:text-white">{item.name}</div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                                                                item.quantity <= (item.minThreshold || 5)
                                                                    ? 'bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300'
                                                                    : 'bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300'
                                                            }`}>
                                                                {item.quantity}
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                                            {item.category}
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            {item.price > 0 ? (
                                                                <span className="text-green-600 dark:text-green-400 font-medium">
                                                                    ${item.price}
                                                                </span>
                                                            ) : (
                                                                <span className="text-gray-400">-</span>
                                                            )}
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <MaterialButton
                                                                onClick={() => addToCart(item)}
                                                                variant="text"
                                                                color="primary"
                                                                className="!p-2"
                                                            >
                                                                <span className="material-icons text-sm">add_shopping_cart</span>
                                                            </MaterialButton>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* Inventory Management Pagination */}
                                    <MaterialPagination
                                        currentPage={inventoryPagination.currentPage}
                                        totalItems={inventoryPagination.totalItems}
                                        itemsPerPage={inventoryPagination.itemsPerPage}
                                        onPageChange={handleInventoryPageChange}
                                        onItemsPerPageChange={handleInventoryItemsPerPageChange}
                                    />
                                </MaterialCard>
                            </div>
                        )}

                        {activeTab === 'users' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                                    <span className="material-icons mr-2">people</span>
                                    Users Management
                                </h2>
                                <MaterialCard elevation={1}>
                                    <div className="mb-4">
                                        <p className="text-sm text-gray-600 dark:text-gray-400">
                                            Manage user accounts with pagination for better performance
                                        </p>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full">
                                            <thead className="bg-gray-50 dark:bg-gray-700">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">person</span>
                                                            Name
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">badge</span>
                                                            Cost Code
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">business</span>
                                                            Department
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                {getPaginatedUsers().map(user => (
                                                    <tr key={user.id} className="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                                        <td className="px-6 py-4">
                                                            <div className="font-medium text-gray-900 dark:text-white">
                                                                {user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim()}
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <code className="text-sm bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">
                                                                {formatDepartmentId(user.costCode || user.cost_code)}
                                                            </code>
                                                        </td>
                                                        <td className="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                                            {(formatDepartmentId(user.costCode || user.cost_code) || '').split('-')[0] || 'Unknown'}
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-300">
                                                                <span className="material-icons mr-1 text-xs">check_circle</span>
                                                                Active
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <MaterialButton
                                                                onClick={() => setEditingUser(user)}
                                                                variant="text"
                                                                color="primary"
                                                                className="!p-2"
                                                            >
                                                                <span className="material-icons text-sm">edit</span>
                                                            </MaterialButton>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* Users Pagination */}
                                    <MaterialPagination
                                        currentPage={usersPagination.currentPage}
                                        totalItems={usersPagination.totalItems}
                                        itemsPerPage={usersPagination.itemsPerPage}
                                        onPageChange={handleUsersPageChange}
                                        onItemsPerPageChange={handleUsersItemsPerPageChange}
                                    />
                                </MaterialCard>
                            </div>
                        )}

                        {activeTab === 'admin' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                                    <span className="material-icons mr-2">admin_panel_settings</span>
                                    Administration
                                </h2>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
                                    {/* Add New Item */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-blue-600">add_box</span>
                                            Add New Item
                                        </h3>
                                        <form onSubmit={handleCreateItem} className="space-y-4">
                                            <MaterialInput
                                                label="Item Name"
                                                value={newItemForm.name}
                                                onChange={(e) => setNewItemForm(prev => ({ ...prev, name: e.target.value }))}
                                                required
                                            />
                                            <div className="grid grid-cols-2 gap-4">
                                                <MaterialInput
                                                    label="Price"
                                                    type="number"
                                                    step="0.01"
                                                    value={newItemForm.price}
                                                    onChange={(e) => setNewItemForm(prev => ({ ...prev, price: e.target.value }))}
                                                    placeholder="0.00"
                                                />
                                                <MaterialInput
                                                    label="Quantity"
                                                    type="number"
                                                    value={newItemForm.quantity}
                                                    onChange={(e) => setNewItemForm(prev => ({ ...prev, quantity: e.target.value }))}
                                                    placeholder="0"
                                                />
                                            </div>
                                            <div className="mat-input">
                                                <select
                                                    value={newItemForm.category}
                                                    onChange={(e) => setNewItemForm(prev => ({ ...prev, category: e.target.value }))}
                                                >
                                                    <option value="">Choose category...</option>
                                                    <option value="Electronics">Electronics</option>
                                                    <option value="Accessories">Accessories</option>
                                                    <option value="Cables">Cables</option>
                                                    <option value="Office">Office</option>
                                                    <option value="Hardware">Hardware</option>
                                                    <option value="Software">Software</option>
                                                    <option value="Supplies">Supplies</option>
                                                </select>
                                                <label>Category</label>
                                            </div>
                                            <MaterialButton
                                                type="submit"
                                                variant="contained"
                                                color="primary"
                                                className="w-full"
                                                disabled={isCreatingItem}
                                            >
                                                {isCreatingItem ? (
                                                    <>
                                                        <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                        Creating...
                                                    </>
                                                ) : (
                                                    <>
                                                        <span className="material-icons mr-2">add</span>
                                                        Create Item
                                                    </>
                                                )}
                                            </MaterialButton>
                                        </form>
                                    </MaterialCard>

                                    {/* Add New User */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-green-600">person_add</span>
                                            Add New User
                                        </h3>
                                        <form onSubmit={handleCreateUser} className="space-y-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <MaterialInput
                                                    label="First Name"
                                                    value={newUserForm.firstName}
                                                    onChange={(e) => setNewUserForm(prev => ({ ...prev, firstName: e.target.value }))}
                                                    required
                                                />
                                                <MaterialInput
                                                    label="Last Name"
                                                    value={newUserForm.lastName}
                                                    onChange={(e) => setNewUserForm(prev => ({ ...prev, lastName: e.target.value }))}
                                                    required
                                                />
                                            </div>
                                            <MaterialInput
                                                label="Cost Code"
                                                value={newUserForm.costCode}
                                                onChange={(e) => setNewUserForm(prev => ({ ...prev, costCode: e.target.value }))}
                                                placeholder="e.g., 1-10-100-5770 (auto-generated if empty)"
                                            />
                                            <MaterialInput
                                                label="Department"
                                                value={newUserForm.department}
                                                onChange={(e) => setNewUserForm(prev => ({ ...prev, department: e.target.value }))}
                                                placeholder="e.g., IT, Finance, Operations"
                                            />
                                            <MaterialButton
                                                type="submit"
                                                variant="contained"
                                                color="success"
                                                className="w-full"
                                                disabled={isCreatingUser}
                                            >
                                                {isCreatingUser ? (
                                                    <>
                                                        <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                        Creating...
                                                    </>
                                                ) : (
                                                    <>
                                                        <span className="material-icons mr-2">person_add</span>
                                                        Create User
                                                    </>
                                                )}
                                            </MaterialButton>
                                        </form>
                                    </MaterialCard>

                                    {/* CSV Import/Export */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-purple-600">import_export</span>
                                            CSV Import/Export
                                        </h3>
                                        <div className="space-y-4">
                                            <div>
                                                <h4 className="font-medium mb-2">Import Data</h4>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <input
                                                            type="file"
                                                            accept=".csv"
                                                            onChange={handleItemsImport}
                                                            className="hidden"
                                                            id="items-csv-import"
                                                        />
                                                        <MaterialButton
                                                            onClick={() => document.getElementById('items-csv-import').click()}
                                                            variant="outlined"
                                                            color="primary"
                                                            className="w-full"
                                                            disabled={csvOperations.importingItems}
                                                        >
                                                            {csvOperations.importingItems ? (
                                                                <>
                                                                    <div className="mat-spinner w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full mr-2"></div>
                                                                    Importing...
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <span className="material-icons mr-2">upload_file</span>
                                                                    Import Items
                                                                </>
                                                            )}
                                                        </MaterialButton>
                                                    </div>
                                                    <div>
                                                        <input
                                                            type="file"
                                                            accept=".csv"
                                                            onChange={handleUsersImport}
                                                            className="hidden"
                                                            id="users-csv-import"
                                                        />
                                                        <MaterialButton
                                                            onClick={() => document.getElementById('users-csv-import').click()}
                                                            variant="outlined"
                                                            color="primary"
                                                            className="w-full"
                                                            disabled={csvOperations.importingUsers}
                                                        >
                                                            {csvOperations.importingUsers ? (
                                                                <>
                                                                    <div className="mat-spinner w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full mr-2"></div>
                                                                    Importing...
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <span className="material-icons mr-2">upload_file</span>
                                                                    Import Users
                                                                </>
                                                            )}
                                                        </MaterialButton>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="border-t dark:border-gray-600 pt-4">
                                                <h4 className="font-medium mb-2">Export Data</h4>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <MaterialButton
                                                        onClick={exportItemsToCSV}
                                                        variant="outlined"
                                                        color="secondary"
                                                        className="w-full"
                                                        disabled={csvOperations.exportingItems}
                                                    >
                                                        {csvOperations.exportingItems ? (
                                                            <>
                                                                <div className="mat-spinner w-4 h-4 border-2 border-gray-600 border-t-transparent rounded-full mr-2"></div>
                                                                Exporting...
                                                            </>
                                                        ) : (
                                                            <>
                                                                <span className="material-icons mr-2">download</span>
                                                                Export Items ({items.length})
                                                            </>
                                                        )}
                                                    </MaterialButton>
                                                    <MaterialButton
                                                        onClick={exportUsersToCSV}
                                                        variant="outlined"
                                                        color="secondary"
                                                        className="w-full"
                                                        disabled={csvOperations.exportingUsers}
                                                    >
                                                        {csvOperations.exportingUsers ? (
                                                            <>
                                                                <div className="mat-spinner w-4 h-4 border-2 border-gray-600 border-t-transparent rounded-full mr-2"></div>
                                                                Exporting...
                                                            </>
                                                        ) : (
                                                            <>
                                                                <span className="material-icons mr-2">download</span>
                                                                Export Users ({users.length})
                                                            </>
                                                        )}
                                                    </MaterialButton>
                                                </div>
                                            </div>
                                            <div className="text-xs text-gray-600 dark:text-gray-400 mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                                <p className="font-medium mb-1">ðŸ“‹ CSV Format Tips:</p>
                                                <p><strong>Items:</strong> Item Name, Category, Quantity, Price, ASIN, Min Threshold</p>
                                                <p><strong>Users:</strong> First Name, Last Name, Cost Code, Email, Department</p>
                                            </div>
                                        </div>
                                    </MaterialCard>

                                    {/* Bulk Operations */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-orange-600">batch_prediction</span>
                                            Bulk Operations
                                        </h3>
                                        <div className="space-y-4">
                                            <div>
                                                <h4 className="font-medium mb-2">Inventory Management</h4>
                                                <div className="space-y-3">
                                                    <MaterialButton
                                                        onClick={exportItemsToCSV}
                                                        variant="outlined"
                                                        color="primary"
                                                        className="w-full"
                                                    >
                                                        <span className="material-icons mr-2">edit</span>
                                                        Bulk Edit via CSV Export/Import
                                                    </MaterialButton>
                                                    <MaterialButton
                                                        onClick={() => showSnackbar('Price bulk update: Export CSV, edit prices, then import back', 'info')}
                                                        variant="outlined"
                                                        color="primary"
                                                        className="w-full"
                                                    >
                                                        <span className="material-icons mr-2">attach_money</span>
                                                        Update Prices via CSV
                                                    </MaterialButton>
                                                    <MaterialButton
                                                        onClick={handleResetAllQuantities}
                                                        variant="outlined"
                                                        color="error"
                                                        className="w-full"
                                                    >
                                                        <span className="material-icons mr-2">restore</span>
                                                        Reset All Quantities to Zero
                                                    </MaterialButton>
                                                    <MaterialButton
                                                        onClick={refreshDataFromFiles}
                                                        variant="contained"
                                                        color="primary"
                                                        className="w-full"
                                                    >
                                                        <span className="material-icons mr-2">refresh</span>
                                                        Force Refresh All Data from Files
                                                    </MaterialButton>
                                                </div>
                                            </div>
                                            <div className="text-xs text-gray-600 dark:text-gray-400 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
                                                <p className="font-medium mb-1">âš ï¸ Bulk Operations:</p>
                                                <p><strong>Edit/Prices:</strong> Use CSV export â†’ edit â†’ import workflow</p>
                                                <p><strong>Reset:</strong> Sets ALL item quantities to zero (permanent!)</p>
                                            </div>
                                        </div>
                                    </MaterialCard>

                                    {/* System Stats */}
                                    <MaterialCard elevation={2} className="lg:col-span-2">
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-indigo-600">analytics</span>
                                            System Statistics
                                        </h3>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <div className="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                                <div className="text-2xl font-bold text-blue-600 dark:text-blue-400">{items.length}</div>
                                                <div className="text-sm text-gray-600 dark:text-gray-400">Total Items</div>
                                            </div>
                                            <div className="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                                <div className="text-2xl font-bold text-green-600 dark:text-green-400">{users.length}+</div>
                                                <div className="text-sm text-gray-600 dark:text-gray-400">Active Users</div>
                                            </div>
                                            <div className="text-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                                <div className="text-2xl font-bold text-purple-600 dark:text-purple-400">{checkoutHistory.length}</div>
                                                <div className="text-sm text-gray-600 dark:text-gray-400">Recent Checkouts</div>
                                            </div>
                                            <div className="text-center p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
                                                <div className="text-2xl font-bold text-amber-600 dark:text-amber-400">{notifications.length}</div>
                                                <div className="text-sm text-gray-600 dark:text-gray-400">Low Stock Alerts</div>
                                            </div>
                                        </div>
                                    </MaterialCard>
                                </div>
                            </div>
                        )}

                        {activeTab === 'shipment' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                                    <span className="material-icons mr-2">local_shipping</span>
                                    Process Shipment
                                </h2>

                                <div className="space-y-6">
                                    {/* Item Selection */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-purple-600">search</span>
                                            Select Items for Processing
                                        </h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Search and Add Items
                                                </label>
                                                <div className="relative">
                                                    <input
                                                        type="text"
                                                        placeholder="Type item name to search..."
                                                        value={itemSearchQuery || ''}
                                                        onChange={(e) => setItemSearchQuery(e.target.value)}
                                                        className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                    />
                                                    <span className="material-icons absolute right-3 top-2.5 text-gray-400">search</span>
                                                </div>

                                                {/* Search Results */}
                                                {itemSearchQuery && itemSearchQuery.length > 0 && (
                                                    <div className="mt-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                        {items
                                                            .filter(item => item.name.toLowerCase().includes(itemSearchQuery.toLowerCase()))
                                                            .slice(0, 10)
                                                            .map(item => (
                                                                <div
                                                                    key={item.id}
                                                                    onClick={() => {
                                                                        if (!selectedShipmentItems.includes(item.name)) {
                                                                            setSelectedShipmentItems(prev => [...prev, item.name]);
                                                                        }
                                                                        setItemSearchQuery('');
                                                                    }}
                                                                    className="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer border-b border-gray-200 dark:border-gray-600 last:border-b-0"
                                                                >
                                                                    <div className="font-medium text-gray-900 dark:text-white">{item.name}</div>
                                                                    <div className="text-sm text-gray-600 dark:text-gray-400">
                                                                        Qty: {item.quantity} | Category: {item.category}
                                                                        {item.price > 0 && <span className="ml-2 text-green-600">${item.price}</span>}
                                                                    </div>
                                                                </div>
                                                            ))
                                                        }
                                                        {items.filter(item => item.name.toLowerCase().includes(itemSearchQuery.toLowerCase())).length === 0 && (
                                                            <div className="px-4 py-2 text-gray-500 dark:text-gray-400">No items found</div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>

                                            {/* Selected Items List */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Selected Items ({selectedShipmentItems?.length || 0})
                                                </label>
                                                <div className="space-y-2 max-h-32 overflow-y-auto">
                                                    {selectedShipmentItems?.length > 0 ? (
                                                        selectedShipmentItems.map(itemName => (
                                                            <div key={itemName} className="flex items-center justify-between bg-blue-50 dark:bg-blue-900/20 px-3 py-2 rounded-lg">
                                                                <span className="text-sm font-medium text-gray-900 dark:text-white">{itemName}</span>
                                                                <button
                                                                    onClick={() => setSelectedShipmentItems(prev => prev.filter(name => name !== itemName))}
                                                                    className="text-red-600 hover:text-red-800 dark:text-red-400"
                                                                >
                                                                    <span className="material-icons text-sm">close</span>
                                                                </button>
                                                            </div>
                                                        ))
                                                    ) : (
                                                        <div className="text-sm text-gray-500 dark:text-gray-400 italic">No items selected</div>
                                                    )}
                                                </div>
                                            </div>

                                            {selectedShipmentItems?.length > 0 && (
                                                <MaterialButton
                                                    onClick={() => setShowQuantityModal(true)}
                                                    variant="contained"
                                                    color="primary"
                                                    className="w-full"
                                                >
                                                    <span className="material-icons mr-2">edit</span>
                                                    Set Quantities & Prices ({selectedShipmentItems.length} items)
                                                </MaterialButton>
                                            )}
                                        </div>
                                    </MaterialCard>

                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        {/* PDF Upload */}
                                        <MaterialCard elevation={2}>
                                            <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-blue-600">upload_file</span>
                                            Upload Receipt PDF
                                        </h3>
                                            <div className="space-y-4">
                                            <div className="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-blue-400 transition-colors">
                                                <span className="material-icons text-4xl text-gray-400 mb-2">picture_as_pdf</span>
                                                <p className="text-gray-600 dark:text-gray-400 mb-4">
                                                    Drop PDF receipt here or click to upload
                                                </p>
                                                <input
                                                    type="file"
                                                    accept=".pdf"
                                                    className="hidden"
                                                    id="pdf-upload"
                                                    onChange={handlePdfUpload}
                                                />
                                                <MaterialButton
                                                    onClick={() => document.getElementById('pdf-upload').click()}
                                                    variant="outlined"
                                                    color="primary"
                                                    disabled={isProcessing}
                                                >
                                                    <span className="material-icons mr-2">file_upload</span>
                                                    {pdfFile ? pdfFile.name : 'Choose PDF File'}
                                                </MaterialButton>
                                            </div>
                                            <div className="text-sm text-gray-600 dark:text-gray-400">
                                                <p className="font-medium mb-2">Supported formats:</p>
                                                <ul className="list-disc list-inside space-y-1">
                                                    <li>PDF receipts from vendors</li>
                                                    <li>Purchase orders with itemized costs</li>
                                                    <li>Invoices with line items</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </MaterialCard>

                                    {/* Processing Options */}
                                    <MaterialCard elevation={2}>
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-green-600">settings</span>
                                            Processing Options
                                        </h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Cost Allocation Method
                                                </label>
                                                <div className="space-y-2">
                                                    <label className="flex items-center">
                                                        <input
                                                            type="radio"
                                                            name="allocation"
                                                            value="auto"
                                                            className="mr-2"
                                                            checked={allocationMethod === 'auto'}
                                                            onChange={(e) => setAllocationMethod(e.target.value)}
                                                        />
                                                        <span className="text-sm">Automatic - Match against checkout history</span>
                                                    </label>
                                                    <label className="flex items-center">
                                                        <input
                                                            type="radio"
                                                            name="allocation"
                                                            value="manual"
                                                            className="mr-2"
                                                            checked={allocationMethod === 'manual'}
                                                            onChange={(e) => setAllocationMethod(e.target.value)}
                                                        />
                                                        <span className="text-sm">Manual - Review and assign costs</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <div className="mat-input">
                                                <input
                                                    type="date"
                                                    value={receiptDate}
                                                    onChange={(e) => setReceiptDate(e.target.value)}
                                                />
                                                <label>Receipt Date</label>
                                            </div>

                                            <div className="mat-input">
                                                <input
                                                    type="text"
                                                    placeholder="Optional vendor name"
                                                    value={vendorName}
                                                    onChange={(e) => setVendorName(e.target.value)}
                                                />
                                                <label>Vendor Name</label>
                                            </div>

                                            <div className="mat-input">
                                                <textarea
                                                    rows={3}
                                                    placeholder="Processing notes or special instructions"
                                                    value={processingNotes}
                                                    onChange={(e) => setProcessingNotes(e.target.value)}
                                                />
                                                <label>Notes</label>
                                            </div>

                                            <MaterialButton
                                                variant="contained"
                                                color="success"
                                                className="w-full"
                                                disabled={!pdfFile || isProcessing}
                                                onClick={processShipment}
                                            >
                                                {isProcessing ? (
                                                    <>
                                                        <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                        Processing...
                                                    </>
                                                ) : (
                                                    <>
                                                        <span className="material-icons mr-2">process</span>
                                                        Process Receipt
                                                    </>
                                                )}
                                            </MaterialButton>
                                        </div>
                                    </MaterialCard>

                                    {/* Matched Items Preview */}
                                    {matchedItems.length > 0 && (
                                        <MaterialCard elevation={1} className="lg:col-span-2">
                                            <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                                <span className="material-icons mr-2 text-orange-600">assignment_turned_in</span>
                                                Matched Items ({matchedItems.length})
                                            </h3>
                                            <div className="overflow-x-auto">
                                                <table className="min-w-full">
                                                    <thead className="bg-gray-50 dark:bg-gray-700">
                                                        <tr>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300">Item</th>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300">User</th>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300">Qty</th>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300">Dept</th>
                                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300">Confidence</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                        {matchedItems.slice(0, 5).map((item, index) => (
                                                            <tr key={index} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                                                                <td className="px-4 py-2 text-sm font-medium text-gray-900 dark:text-white">
                                                                    {item.itemName.length > 30 ? item.itemName.substring(0, 30) + '...' : item.itemName}
                                                                </td>
                                                                <td className="px-4 py-2 text-sm text-gray-600 dark:text-gray-400">{item.userName}</td>
                                                                <td className="px-4 py-2 text-sm text-gray-600 dark:text-gray-400">{item.quantity}</td>
                                                                <td className="px-4 py-2 text-sm text-gray-600 dark:text-gray-400">{item.departmentId || '-'}</td>
                                                                <td className="px-4 py-2">
                                                                    <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                                                                        item.confidence === 'high' ? 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300' :
                                                                        'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300'
                                                                    }`}>
                                                                        {item.confidence}
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                                {matchedItems.length > 5 && (
                                                    <div className="text-center py-2 text-sm text-gray-500 dark:text-gray-400">
                                                        and {matchedItems.length - 5} more items...
                                                    </div>
                                                )}
                                            </div>
                                        </MaterialCard>
                                    )}

                                    {/* Recent Processing */}
                                    <MaterialCard elevation={1} className="lg:col-span-2">
                                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                                            <span className="material-icons mr-2 text-purple-600">history</span>
                                            Recent Shipment Processing
                                        </h3>
                                        {processingResults.length === 0 ? (
                                            <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                                                <span className="material-icons text-6xl mb-4 opacity-50">receipt_long</span>
                                                <p className="font-medium">No shipments processed yet</p>
                                                <p className="text-sm">Upload a PDF receipt to get started</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                {processingResults.slice(-5).reverse().map((result, index) => (
                                                    <div key={index} className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                                        <div className="flex items-center space-x-3">
                                                            <span className="material-icons text-green-600">check_circle</span>
                                                            <div>
                                                                <p className="font-medium text-gray-900 dark:text-white">{result.fileName}</p>
                                                                <p className="text-sm text-gray-600 dark:text-gray-400">
                                                                    {result.itemsProcessed} items â€¢ ${result.totalAmount.toFixed(2)} â€¢ {result.vendor}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div className="text-sm text-gray-500 dark:text-gray-400">
                                                            {new Date(result.timestamp).toLocaleDateString()}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )})
                                    </MaterialCard>
                                </div>
                            </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                                    <span className="material-icons mr-2">history</span>
                                    Checkout History
                                </h2>
                                <MaterialCard elevation={1}>
                                    <div className="mb-4">
                                        <p className="text-sm text-gray-600 dark:text-gray-400">
                                            View checkout history with pagination for better performance
                                        </p>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full">
                                            <thead className="bg-gray-50 dark:bg-gray-700">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">inventory</span>
                                                            Item
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">person</span>
                                                            User
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">numbers</span>
                                                            Quantity
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">business</span>
                                                            Department
                                                        </div>
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                        <div className="flex items-center">
                                                            <span className="material-icons mr-1 text-sm">schedule</span>
                                                            Date
                                                        </div>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                {getPaginatedCheckoutHistory().map(record => (
                                                    <tr key={record.id} className="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                                        <td className="px-6 py-4 font-medium text-gray-900 dark:text-white">
                                                            {record.itemName}
                                                        </td>
                                                        <td className="px-6 py-4 text-gray-600 dark:text-gray-400">
                                                            {record.userName}
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300">
                                                                {record.quantity}
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                                            {formatDepartmentId(record.departmentId || record.costCode) || '-'}
                                                        </td>
                                                        <td className="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                                                            {record.dateEntered?.toDate?.()?.toLocaleDateString() ||
                                                             (typeof record.dateEntered === 'string' ? new Date(record.dateEntered).toLocaleDateString() : 'Unknown')}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* Checkout History Pagination */}
                                    <MaterialPagination
                                        currentPage={checkoutPagination.currentPage}
                                        totalItems={checkoutPagination.totalItems}
                                        itemsPerPage={checkoutPagination.itemsPerPage}
                                        onPageChange={handleCheckoutPageChange}
                                        onItemsPerPageChange={handleCheckoutItemsPerPageChange}
                                    />
                                </MaterialCard>
                            </div>
                        )}
                    </main>

                    {/* Material Design FAB */}
                    <button
                        onClick={() => setActiveTab('shop')}
                        className="mat-fab bg-blue-600 hover:bg-blue-700 text-white mat-elevation-8"
                    >
                        <span className="material-icons">add_shopping_cart</span>
                    </button>

                    {/* Low Stock Popup Modal */}
                    {showLowStockPopup && notifications.length > 0 && (
                        <div className="md-modal-overlay" onClick={handlePopupDismiss}>
                            <div className="md-modal" onClick={(e) => e.stopPropagation()}>
                                <button className="md-modal-close" onClick={handlePopupDismiss}>
                                    <span className="material-icons">close</span>
                                </button>

                                <div className="md-modal-header">
                                    <h2 className="md-modal-title">
                                        <span className="material-icons" style={{ color: 'var(--md-sys-color-warning)' }}>
                                            warning
                                        </span>
                                        Low Stock Alert
                                    </h2>
                                </div>

                                <div className="md-modal-body">
                                    <p style={{
                                        color: 'var(--md-sys-color-on-surface-variant)',
                                        marginBottom: '16px',
                                        font: 'var(--md-sys-typescale-body-large)'
                                    }}>
                                        {notifications.length} item{notifications.length > 1 ? 's' : ''} {notifications.length > 1 ? 'need' : 'needs'} immediate attention due to low stock levels.
                                    </p>

                                    <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                                        {notifications.slice(0, 5).map((notif, index) => {
                                            const item = items.find(i => i.id === notif.id);
                                            return (
                                                <div key={notif.id} className="md-low-stock-item">
                                                    <div className="md-low-stock-item-name">
                                                        {item?.name || 'Unknown Item'}
                                                    </div>
                                                    <div className="md-low-stock-item-quantity">
                                                        {item?.quantity || 0} remaining
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {notifications.length > 5 && (
                                            <p style={{
                                                color: 'var(--md-sys-color-on-surface-variant)',
                                                textAlign: 'center',
                                                margin: '12px 0',
                                                font: 'var(--md-sys-typescale-body-medium)'
                                            }}>
                                                ... and {notifications.length - 5} more items
                                            </p>
                                        )}
                                    </div>
                                </div>

                                <div className="md-modal-actions">
                                    <button className="md-button error" onClick={handlePopupAlwaysHide}>
                                        <span className="material-icons">visibility_off</span>
                                        Don't show again
                                    </button>
                                    <button className="md-button secondary" onClick={handlePopupDismiss}>
                                        Dismiss
                                    </button>
                                    <button className="md-button primary" onClick={handlePopupViewInventory}>
                                        <span className="material-icons">inventory_2</span>
                                        View Inventory
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit User Modal */}
                    {editingUser && (
                        <div className="md-modal-overlay" onClick={() => setEditingUser(null)}>
                            <div className="md-modal" onClick={(e) => e.stopPropagation()}>
                                <button className="md-modal-close" onClick={() => setEditingUser(null)}>
                                    <span className="material-icons">close</span>
                                </button>

                                <div className="md-modal-header">
                                    <h2 className="md-modal-title">
                                        <span className="material-icons" style={{ color: 'var(--md-sys-color-primary)' }}>
                                            person
                                        </span>
                                        Edit User
                                    </h2>
                                </div>

                                <form onSubmit={handleUpdateUser}>
                                    <div className="md-modal-body">
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <MaterialInput
                                                    label="First Name"
                                                    value={editUserForm.firstName}
                                                    onChange={(e) => setEditUserForm(prev => ({ ...prev, firstName: e.target.value }))}
                                                    required
                                                />
                                                <MaterialInput
                                                    label="Last Name"
                                                    value={editUserForm.lastName}
                                                    onChange={(e) => setEditUserForm(prev => ({ ...prev, lastName: e.target.value }))}
                                                    required
                                                />
                                            </div>
                                            <MaterialInput
                                                label="Cost Code"
                                                value={editUserForm.costCode}
                                                onChange={(e) => setEditUserForm(prev => ({ ...prev, costCode: e.target.value }))}
                                                placeholder="e.g., 1-10-100-5770"
                                            />
                                            <MaterialInput
                                                label="Department"
                                                value={editUserForm.department}
                                                onChange={(e) => setEditUserForm(prev => ({ ...prev, department: e.target.value }))}
                                                placeholder="e.g., IT, Finance, Operations"
                                            />
                                        </div>
                                    </div>

                                    <div className="md-modal-actions">
                                        <button
                                            type="button"
                                            className="md-button secondary"
                                            onClick={() => setEditingUser(null)}
                                        >
                                            Cancel
                                        </button>
                                        <MaterialButton
                                            type="submit"
                                            variant="contained"
                                            color="primary"
                                            disabled={isUpdatingUser}
                                        >
                                            {isUpdatingUser ? (
                                                <>
                                                    <div className="mat-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                                                    Updating...
                                                </>
                                            ) : (
                                                <>
                                                    <span className="material-icons mr-2">save</span>
                                                    Update User
                                                </>
                                            )}
                                        </MaterialButton>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Quantity/Price Modal for Process Shipment */}
                    {showQuantityModal && (
                        <div className="md-modal-overlay" onClick={() => setShowQuantityModal(false)}>
                            <div className="md-modal" onClick={(e) => e.stopPropagation()}>
                                <button className="md-modal-close" onClick={() => setShowQuantityModal(false)}>
                                    <span className="material-icons">close</span>
                                </button>

                                <div className="md-modal-header">
                                    <h2 className="md-modal-title">
                                        <span className="material-icons" style={{ color: 'var(--md-sys-color-primary)' }}>
                                            edit
                                        </span>
                                        Set Quantities & Prices
                                    </h2>
                                </div>

                                <div className="md-modal-body">
                                    <div className="space-y-4 max-h-96 overflow-y-auto">
                                        {selectedShipmentItems?.map((itemName, index) => {
                                            const item = items.find(i => i.name === itemName);
                                            return (
                                                <div key={itemName} className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                                    <h4 className="font-medium text-gray-900 dark:text-white mb-3">{itemName}</h4>
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <MaterialInput
                                                            type="number"
                                                            label="Quantity"
                                                            value={shipmentItemDetails[itemName]?.quantity || ''}
                                                            onChange={(e) => setShipmentItemDetails(prev => ({
                                                                ...prev,
                                                                [itemName]: {
                                                                    ...prev[itemName],
                                                                    quantity: parseInt(e.target.value) || 0
                                                                }
                                                            }))}
                                                            min="1"
                                                            required
                                                        />
                                                        <MaterialInput
                                                            type="number"
                                                            label="Unit Price"
                                                            value={shipmentItemDetails[itemName]?.price || ''}
                                                            onChange={(e) => setShipmentItemDetails(prev => ({
                                                                ...prev,
                                                                [itemName]: {
                                                                    ...prev[itemName],
                                                                    price: parseFloat(e.target.value) || 0
                                                                }
                                                            }))}
                                                            step="0.01"
                                                            placeholder="0.00"
                                                        />
                                                    </div>
                                                    {item && (
                                                        <div className="text-sm text-gray-600 dark:text-gray-400 mt-2">
                                                            Current stock: {item.quantity} | Category: {item.category}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                <div className="md-modal-actions">
                                    <button
                                        type="button"
                                        className="md-button secondary"
                                        onClick={() => setShowQuantityModal(false)}
                                    >
                                        Cancel
                                    </button>
                                    <MaterialButton
                                        variant="contained"
                                        color="primary"
                                        onClick={() => {
                                            setShowQuantityModal(false);
                                            showSnackbar('Item details saved successfully', 'success');
                                        }}
                                    >
                                        <span className="material-icons mr-2">save</span>
                                        Save Details
                                    </MaterialButton>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Snackbar */}
                    <MaterialSnackbar snackbar={snackbar} />
                </div>
            );
        };

        // Render the Material Design Firebase app using React 18 API
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <MaterialFirebaseApp />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
